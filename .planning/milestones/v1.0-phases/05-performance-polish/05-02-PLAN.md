---
phase: 05-performance-polish
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/commands/features.js
  - src/lib/constants.js
  - bin/gsd-tools.test.cjs
autonomous: true
requirements:
  - PERF-03

must_haves:
  truths:
    - "cmdContextBudget reads context_window from config.json when present"
    - "cmdContextBudget reads context_target_percent from config.json when present"
    - "cmdContextBudget falls back to 200000/50 defaults when config keys are absent"
    - "CONFIG_SCHEMA includes context_window and context_target_percent entries"
  artifacts:
    - path: "src/lib/constants.js"
      provides: "CONFIG_SCHEMA entries for context_window and context_target_percent"
      contains: "context_window"
    - path: "src/commands/features.js"
      provides: "cmdContextBudget reading from config"
      contains: "loadConfig"
    - path: "bin/gsd-tools.test.cjs"
      provides: "Tests for configurable context window"
  key_links:
    - from: "src/commands/features.js"
      to: "src/lib/config.js"
      via: "loadConfig() call in cmdContextBudget"
      pattern: "loadConfig.*context_window"
    - from: "src/lib/constants.js"
      to: "src/lib/config.js"
      via: "CONFIG_SCHEMA used by loadConfig to derive defaults"
      pattern: "context_window.*200000"
---

<objective>
Make context budget calculations configurable by reading context_window and context_target_percent from config.json instead of hardcoding 200K/50%.

Purpose: Different users may have different Claude model context windows (100K for Haiku, 200K for Sonnet/Opus) and different target utilization. Making this configurable lets the tool give accurate warnings.
Output: Updated CONFIG_SCHEMA with new fields, updated cmdContextBudget to read from config, tests.
</objective>

<execution_context>
@/home/cam/.config/Claude/get-shit-done/workflows/execute-plan.md
@/home/cam/.config/Claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/lib/constants.js
@src/commands/features.js
@src/lib/config.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add context_window and context_target_percent to CONFIG_SCHEMA</name>
  <files>src/lib/constants.js</files>
  <action>
Add two new entries to CONFIG_SCHEMA in src/lib/constants.js:

```javascript
context_window:         { type: 'number', default: 200000,  description: 'Context window size in tokens',              aliases: [], nested: null },
context_target_percent: { type: 'number', default: 50,      description: 'Target context utilization percent (1-100)',  aliases: [], nested: null },
```

Place them after the existing `test_gate` entry (end of the schema object). This automatically makes them:
1. Available via `loadConfig()` (it iterates CONFIG_SCHEMA for defaults)
2. Validated by `cmdValidateConfig()` (it checks CONFIG_SCHEMA for known keys)
3. Available via `config-get` command
4. Settable via `config-set` command
5. Included in `cmdConfigMigrate()` output

No aliases needed — these are new keys with no legacy names.
  </action>
  <verify>
`npm run build` succeeds. `node bin/gsd-tools.cjs validate-config --raw 2>/dev/null | python3 -c "import json,sys; d=json.load(sys.stdin); print('context_window' in str(d['effective_config']))"` prints True.
  </verify>
  <done>
CONFIG_SCHEMA has context_window (default 200000) and context_target_percent (default 50) entries.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update cmdContextBudget to read from config</name>
  <files>src/commands/features.js</files>
  <action>
In `cmdContextBudget()` function (around line 94), replace the hardcoded values:

Current (lines 140-141):
```javascript
const contextWindow = 200000;
const targetPercent = 50;
```

Replace with:
```javascript
const config = loadConfig(cwd);
const contextWindow = config.context_window || 200000;
const targetPercent = config.context_target_percent || 50;
```

`loadConfig` is already imported at the top of features.js (line 7). No new imports needed.

Also update the output object to include the source of the values so users know whether they're seeing defaults or configured values:

In the `estimates` object of the output (around line 178-179), the `target_percent` is already there. Add `context_window` to the output:

```javascript
estimates: {
  ...existing fields...,
  context_window: contextWindow,    // ADD THIS
  target_percent: targetPercent,
},
```

This makes the output self-documenting — users can see what context window size is being assumed.
  </action>
  <verify>
`npm run build` succeeds. `npm test` passes. `node bin/gsd-tools.cjs context-budget .planning/phases/05-performance-polish/05-01-PLAN.md --raw 2>/dev/null | python3 -c "import json,sys; d=json.load(sys.stdin); print(d['estimates']['context_window'])"` prints 200000.
  </verify>
  <done>
cmdContextBudget reads context_window and context_target_percent from config.json via loadConfig(), with 200000/50 fallback defaults. Output includes context_window value.
  </done>
</task>

<task type="auto">
  <name>Task 3: Tests for configurable context window</name>
  <files>bin/gsd-tools.test.cjs</files>
  <action>
Add tests to bin/gsd-tools.test.cjs for the configurable context window feature:

1. "context-budget uses default context window" — Run `context-budget` against a real plan file, verify output JSON has `estimates.context_window === 200000` and `estimates.target_percent === 50` (since our config.json doesn't set these keys).

2. "context-budget output includes context_window field" — Run `context-budget` against a plan, verify the `estimates` object contains the `context_window` key.

3. "validate-config recognizes context_window as known key" — Run `validate-config`, verify no warning for `context_window` in the effective config output.

4. "validate-config recognizes context_target_percent as known key" — Same check for `context_target_percent`.

Use the same pattern as existing tests: `execSync` calling `node bin/gsd-tools.cjs <command> --raw`, parsing JSON, asserting values. Use a real plan path like `.planning/phases/05-performance-polish/05-01-PLAN.md` for the context-budget tests.
  </action>
  <verify>
`npm test` passes with new tests (expect ~151+ pass, 1 pre-existing failure unchanged).
  </verify>
  <done>
At least 4 new tests covering configurable context window. All pass. Total passing tests ≥ 151.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` completes in under 500ms
2. `npm test` shows 151+ passing tests with only the 1 pre-existing failure
3. `node bin/gsd-tools.cjs context-budget <plan-path> --raw` output includes `context_window` in estimates
4. `node bin/gsd-tools.cjs validate-config --raw` shows context_window and context_target_percent in effective config with no warnings
</verification>

<success_criteria>
- CONFIG_SCHEMA has context_window (number, default 200000) and context_target_percent (number, default 50)
- cmdContextBudget reads from config via loadConfig() instead of hardcoding
- Output JSON includes context_window in estimates object
- 4+ new passing tests
- All existing tests still pass
</success_criteria>

<output>
After completion, create `.planning/phases/05-performance-polish/05-02-SUMMARY.md`
</output>
