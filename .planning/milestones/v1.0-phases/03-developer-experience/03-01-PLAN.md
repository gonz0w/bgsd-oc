---
phase: 03-developer-experience
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [bin/gsd-tools.cjs, bin/gsd-tools.test.cjs]
autonomous: true
requirements: [DX-01, DX-03]

must_haves:
  truths:
    - "Running any command with --help prints usage text to stderr"
    - "cmdConfigMigrate reads existing config, merges defaults for missing keys, writes back"
    - "Existing config values are never overwritten by migration"
  artifacts:
    - path: "bin/gsd-tools.cjs"
      provides: "COMMAND_HELP map, --help check in router, cmdConfigMigrate function"
      contains: "COMMAND_HELP"
    - path: "bin/gsd-tools.test.cjs"
      provides: "Tests for --help and config migration"
      contains: "COMMAND_HELP"
  key_links:
    - from: "main() router"
      to: "COMMAND_HELP"
      via: "--help flag check before command dispatch"
      pattern: "args\\.includes\\('--help'\\)"
---

<objective>
Add per-command --help support and a config migration command to the CLI.

Purpose: Currently there's no way to discover command usage without reading source code. --help support makes all 79+ commands self-documenting. Config migration ensures users get new config keys without losing existing values.

Output: COMMAND_HELP map with help text for all commands, --help routing in main(), cmdConfigMigrate function, tests.
</objective>

<execution_context>
@/home/cam/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/cam/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/CONVENTIONS.md
@.planning/codebase/ARCHITECTURE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add COMMAND_HELP map and --help routing</name>
  <files>bin/gsd-tools.cjs</files>
  <action>
1. Define a `COMMAND_HELP` object near the top of the file (after CONFIG_SCHEMA, before helpers). Each key is a command name (matching the switch cases in main()), each value is a help string. Structure:

```javascript
const COMMAND_HELP = {
  'state': `Usage: gsd-tools state <subcommand> [options] [--raw]

Subcommands:
  load                      Load all state from STATE.md
  get <field>               Get a specific field value
  update <field> <value>    Update a specific field
  patch --key value ...     Update multiple fields
  advance-plan              Increment plan counter
  record-metric --phase P --plan N --duration D --tasks T --files F
  update-progress           Recalculate progress bar
  add-decision --phase P --summary S [--rationale R]
  add-blocker --description D [--impact I]
  resolve-blocker --description D --resolution R
  record-session --date D --stopped-at S`,
  'current-timestamp': `Usage: gsd-tools current-timestamp [--raw]

Returns the current UTC timestamp in ISO 8601 format.
With --raw: returns just the timestamp string.`,
  // ... more commands
};
```

2. Provide help text for ALL major commands — at minimum the top-level ones:
   - `state`, `frontmatter`, `verify`, `roadmap`, `phase`, `milestone`, `init`
   - `commit`, `template`, `config-ensure-section`, `config-set`, `config-get`
   - `generate-slug`, `current-timestamp`, `list-todos`, `verify-path-exists`
   - `session-diff`, `context-budget`, `test-run`, `search-decisions`
   - `validate-dependencies`, `search-lessons`, `codebase-impact`, `rollback-info`
   - `velocity`, `trace-requirement`, `validate-config`, `quick-summary`
   - `config-migrate` (new command from Task 2)

   Each help text should include: Usage line, brief description, arguments/options, example if helpful. Write to stderr (not stdout) to avoid contaminating JSON output.

3. In `main()`, right after extracting `command` and `raw`, add a --help check BEFORE the switch statement:

```javascript
if (args.includes('--help') || args.includes('-h')) {
  const helpKey = command || '';
  const helpText = COMMAND_HELP[helpKey];
  if (helpText) {
    process.stderr.write(helpText + '\n');
  } else {
    process.stderr.write(`No help available for "${helpKey}". Available commands:\n`);
    process.stderr.write(Object.keys(COMMAND_HELP).sort().join(', ') + '\n');
  }
  process.exit(0);
}
```

4. Help text goes to stderr (like debug logging) so it doesn't contaminate JSON stdout for scripts that pipe output.
  </action>
  <verify>
Run: `node bin/gsd-tools.cjs state --help 2>&1` — should print state command help.
Run: `node bin/gsd-tools.cjs session-diff --help 2>&1` — should print session-diff help.
Run: `node bin/gsd-tools.cjs nonexistent --help 2>&1` — should say "no help available" and list commands.
Run: `node bin/gsd-tools.cjs current-timestamp --help 2>/dev/null` — stdout should be empty (help goes to stderr).
  </verify>
  <done>Every command has --help support. Help text prints to stderr. Unknown commands list available commands.</done>
</task>

<task type="auto">
  <name>Task 2: Add config migration command and tests</name>
  <files>bin/gsd-tools.cjs, bin/gsd-tools.test.cjs</files>
  <action>
1. Add `cmdConfigMigrate(cwd, raw)` function in the commands section:
   - Read existing `.planning/config.json`
   - Compare with CONFIG_SCHEMA to find missing keys
   - For each missing key, add it with the schema default value
   - Handle nested keys properly (e.g., `workflow.research` lives inside `workflow: { research: true }`)
   - Write back the merged config, preserving all existing values
   - Return JSON: `{ migrated_keys: [...], unchanged_keys: [...], config_path, backup_path }`
   - Before writing, create a backup at `.planning/config.json.bak`

2. Add routing in main() switch:
   ```javascript
   case 'config-migrate': {
     cmdConfigMigrate(cwd, raw);
     break;
   }
   ```

3. Add tests in `bin/gsd-tools.test.cjs`:
   - Test that migration adds missing keys with defaults
   - Test that existing values are preserved (not overwritten)
   - Test that backup file is created
   - Test that already-complete config returns empty migrated_keys

4. Add help text for `config-migrate` in COMMAND_HELP.
  </action>
  <verify>
Run: `npm test` — all tests pass.
Run: `node bin/gsd-tools.cjs config-migrate --help 2>&1` — prints help text.
  </verify>
  <done>config-migrate command exists, merges schema defaults for missing keys, preserves existing values, creates backup, has tests and help text.</done>
</task>

</tasks>

<verification>
1. `npm test` passes
2. `node bin/gsd-tools.cjs state --help 2>&1` prints usage text
3. `node bin/gsd-tools.cjs config-migrate --help 2>&1` prints usage text
4. `grep -c 'COMMAND_HELP' bin/gsd-tools.cjs` shows the map and references
</verification>

<success_criteria>
- COMMAND_HELP map covers all major commands (30+)
- --help flag intercepted before command dispatch, prints to stderr
- cmdConfigMigrate merges defaults without overwriting existing values
- Tests verify both --help behavior and config migration
</success_criteria>

<output>
After completion, create `.planning/phases/03-developer-experience/03-01-SUMMARY.md`
</output>
