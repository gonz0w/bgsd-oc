---
phase: 03-developer-experience
plan: 03
type: execute
wave: 2
depends_on: [03-01]
files_modified: [workflows/execute-phase.md, workflows/plan-phase.md, workflows/execute-plan.md]
autonomous: true
requirements: [WFLOW-01, WFLOW-02, WFLOW-03]

must_haves:
  truths:
    - "execute-phase workflow validates phase dependencies before execution"
    - "plan-phase workflow surfaces relevant lessons from completed phases"
    - "execute-plan workflow warns when plan content exceeds context window"
  artifacts:
    - path: "workflows/execute-phase.md"
      provides: "Pre-flight dependency validation step"
      contains: "validate-dependencies"
    - path: "workflows/plan-phase.md"
      provides: "Lesson surfacing step"
      contains: "search-lessons"
    - path: "workflows/execute-plan.md"
      provides: "Context budget warning step"
      contains: "context-budget"
  key_links:
    - from: "workflows/execute-phase.md"
      to: "gsd-tools.cjs validate-dependencies"
      via: "CLI invocation in pre-flight step"
      pattern: "validate-dependencies"
    - from: "workflows/plan-phase.md"
      to: "gsd-tools.cjs search-lessons"
      via: "CLI invocation in context gathering step"
      pattern: "search-lessons"
    - from: "workflows/execute-plan.md"
      to: "gsd-tools.cjs context-budget"
      via: "CLI invocation in pre-execution check"
      pattern: "context-budget"
---

<objective>
Wire three existing gsd-tools.cjs commands into their respective workflow files as automatic pre-flight checks.

Purpose: validate-dependencies, search-lessons, and context-budget exist as CLI commands but are never automatically invoked. Wiring them into workflows makes them useful without manual invocation — dependencies are checked before execution, lessons inform planning, and large plans trigger warnings.

Output: Updated execute-phase.md, plan-phase.md, and execute-plan.md with new integration steps.
</objective>

<execution_context>
@/home/cam/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/cam/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/ARCHITECTURE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire validate-dependencies into execute-phase workflow</name>
  <files>workflows/execute-phase.md</files>
  <action>
In `workflows/execute-phase.md`, add a pre-flight validation step AFTER the phase is identified but BEFORE plans are dispatched for execution.

Add a step that runs:
```bash
DEPS=$(node {gsd-tools-path} validate-dependencies {phase} --raw 2>/dev/null)
```

Parse the result. If there are unmet dependencies (issues array is non-empty):
- In interactive mode: Display the dependency issues and ask user whether to proceed anyway
- In yolo mode: Display a warning but continue execution

The step should:
1. Be clearly labeled as a "Pre-flight Dependency Check"
2. Show which dependencies are satisfied vs unmet
3. Not block execution in yolo mode (soft warning only)
4. Be positioned after `init execute-phase` returns context but before wave execution begins

Look for the existing flow in the workflow: it calls `init execute-phase`, then groups plans into waves, then dispatches. Insert the dependency check between init and wave grouping.
  </action>
  <verify>
Read workflows/execute-phase.md and confirm the validate-dependencies step exists with proper conditional handling.
  </verify>
  <done>execute-phase workflow runs validate-dependencies as a pre-flight check, showing warnings for unmet dependencies.</done>
</task>

<task type="auto">
  <name>Task 2: Wire search-lessons into plan-phase and context-budget into execute-plan</name>
  <files>workflows/plan-phase.md, workflows/execute-plan.md</files>
  <action>
1. In `workflows/plan-phase.md`, add a step during context gathering that runs:
```bash
LESSONS=$(node {gsd-tools-path} search-lessons "{phase-keywords}" --raw 2>/dev/null)
```

This should:
- Run after the phase is identified but before the planner agent is spawned
- Extract keywords from the phase name/goal
- If lessons are found, include them in the context passed to the planner
- If no lessons found, skip silently (don't create noise for new projects)
- Be labeled "Surface Relevant Lessons"

2. In `workflows/execute-plan.md`, add a step at the beginning that runs:
```bash
BUDGET=$(node {gsd-tools-path} context-budget {plan-path} --raw 2>/dev/null)
```

This should:
- Run before plan execution begins
- Parse the result for `estimated_percent` and `warning` fields
- If the estimated context usage exceeds the configured threshold (typically 50%):
  - Display a warning: "⚠️ Plan may use {X}% of context window — consider splitting"
  - In yolo mode: continue with warning
  - In interactive mode: ask user whether to proceed or split the plan
- Be labeled "Context Budget Check"
  </action>
  <verify>
Read workflows/plan-phase.md and confirm search-lessons step exists.
Read workflows/execute-plan.md and confirm context-budget step exists.
  </verify>
  <done>plan-phase surfaces relevant lessons during planning. execute-plan warns when plans exceed context budget threshold.</done>
</task>

</tasks>

<verification>
1. `grep 'validate-dependencies' workflows/execute-phase.md` shows the integration
2. `grep 'search-lessons' workflows/plan-phase.md` shows the integration
3. `grep 'context-budget' workflows/execute-plan.md` shows the integration
4. All three integrations are non-blocking (warnings, not hard stops)
</verification>

<success_criteria>
- execute-phase checks dependencies before executing plans
- plan-phase surfaces lessons from completed phases
- execute-plan warns when plan exceeds context budget
- All integrations are soft warnings (don't block in yolo mode)
</success_criteria>

<output>
After completion, create `.planning/phases/03-developer-experience/03-03-SUMMARY.md`
</output>
