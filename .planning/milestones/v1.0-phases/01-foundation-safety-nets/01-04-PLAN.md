---
phase: 01-foundation-safety-nets
plan: 04
type: execute
wave: 3
depends_on:
  - 01-03
files_modified:
  - bin/gsd-tools.test.cjs
autonomous: true
requirements:
  - FOUND-04

must_haves:
  truths:
    - "Frontmatter with simple key-value pairs survives extract-reconstruct round-trip losslessly"
    - "Frontmatter with inline arrays `[a, b, c]` survives round-trip losslessly"
    - "Frontmatter with nested objects survives round-trip losslessly"
    - "Frontmatter with quoted strings containing colons (e.g., `name: \"Phase: Setup\"`) survives round-trip losslessly"
    - "Frontmatter with empty arrays `[]` survives round-trip losslessly"
    - "Frontmatter with multi-level nesting (3 levels deep) survives round-trip losslessly"
    - "The `frontmatter-get` and `frontmatter-merge` CLI commands correctly read and write frontmatter"
  artifacts:
    - path: "bin/gsd-tools.test.cjs"
      provides: "Frontmatter round-trip test suite"
      contains: "frontmatter round-trip"
  key_links:
    - from: "bin/gsd-tools.test.cjs"
      to: "bin/gsd-tools.cjs"
      via: "CLI invocation of frontmatter-get and frontmatter-merge commands"
      pattern: "runGsdTools.*frontmatter"
---

<objective>
Add round-trip tests for the frontmatter extract-reconstruct cycle — verifying lossless handling of edge cases that are known fragility points.

Purpose: The custom YAML parser (`extractFrontmatter()`) and serializer (`reconstructFrontmatter()`) handle a subset of YAML. The project's CONCERNS.md identifies several edge cases where data could be silently lost. These tests verify lossless round-trips for all documented edge cases, providing a safety net before any future frontmatter changes.
Output: New test suite in `bin/gsd-tools.test.cjs`
</objective>

<execution_context>
@/home/cam/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/cam/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-safety-nets/01-RESEARCH.md
@.planning/codebase/TESTING.md
@.planning/codebase/CONCERNS.md
@bin/gsd-tools.test.cjs
@bin/gsd-tools.cjs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add frontmatter round-trip tests for basic types and edge cases</name>
  <files>bin/gsd-tools.test.cjs</files>
  <action>
Add a new `describe` block for frontmatter round-trip tests. The testing strategy uses BLACK-BOX CLI testing via `frontmatter-get` and `frontmatter-merge` commands (consistent with the project's established pattern of never importing internal functions).

**Round-trip test pattern:**
1. Write a file with known frontmatter content
2. Run `frontmatter-get <file> --raw` to extract → parse JSON output
3. Run `frontmatter-merge <file> --data '<json>'` to write back the extracted values (or modify a value and write back)
4. Re-read file and compare frontmatter with original

First, read the `frontmatter-get` and `frontmatter-merge` command implementations in `bin/gsd-tools.cjs` to understand their exact CLI interfaces and argument formats. The `frontmatter-get` command is around line 2177 and `frontmatter-merge` around line 2230. Adapt the test patterns to match the actual argument format.

**Test cases for the `frontmatter round-trip` describe block:**

1. **Simple key-value pairs:**
   ```markdown
   ---
   title: My Plan
   phase: 03
   status: active
   ---
   # Content body
   ```
   Extract → verify keys match → merge back → verify file unchanged

2. **Inline arrays:**
   ```markdown
   ---
   tags: [foo, bar, baz]
   depends_on: [01-01, 01-02]
   ---
   # Body
   ```
   Extract → verify arrays parsed correctly → merge back → verify arrays survive

3. **Nested objects (2 levels):**
   ```markdown
   ---
   must_haves:
     truths:
       - "User can login"
       - "User can logout"
     artifacts:
       - path: "src/auth.ts"
         provides: "Authentication"
   ---
   # Body
   ```
   Extract → verify nested structure → merge back → verify nesting preserved

4. **Quoted strings with colons:**
   ```markdown
   ---
   name: "Phase: Setup and Config"
   description: "Goal: Build the safety net"
   ---
   # Body
   ```
   Extract → verify colon-containing values are preserved → merge back → verify values intact

5. **Empty arrays:**
   ```markdown
   ---
   depends_on: []
   files_modified: []
   tags: [one]
   ---
   # Body
   ```
   Extract → verify empty arrays are `[]` not `null` → merge back → verify empty arrays survive

6. **Boolean and mixed types:**
   ```markdown
   ---
   autonomous: true
   wave: 1
   plan: 02
   type: execute
   ---
   # Body
   ```
   Extract → verify booleans and numbers are correct types → merge back → verify types preserved

7. **Multi-level nesting (3 levels — the parser's limit):**
   ```markdown
   ---
   config:
     database:
       host: localhost
       port: 5432
     cache:
       enabled: true
   ---
   # Body
   ```
   Extract → verify 3-level nesting → merge back → verify structure preserved

8. **Body content preservation:**
   After any frontmatter merge operation, verify that the markdown body content below the closing `---` is completely unchanged.

CRITICAL: The exact round-trip verification depends on how `frontmatter-merge` works. It may not produce byte-identical output (e.g., whitespace normalization). The tests should verify SEMANTIC equivalence: same keys, same values, same structure. If `frontmatter-merge` changes formatting (e.g., `[foo, bar]` → `[foo,bar]`), that's acceptable as long as the data round-trips through `frontmatter-get` identically.

Use this verification pattern:
```javascript
// Write original file
// Extract with frontmatter-get → get JSON A
// Merge JSON A back with frontmatter-merge
// Extract again with frontmatter-get → get JSON B
// assert.deepStrictEqual(A, B) — semantic round-trip
```
  </action>
  <verify>
Run `node --test bin/gsd-tools.test.cjs` — all tests pass.
Run `node --test --test-name-pattern="frontmatter" bin/gsd-tools.test.cjs` — frontmatter tests pass.
  </verify>
  <done>
Frontmatter round-trip test suite exists with 8+ test cases covering: simple key-value, inline arrays, nested objects, quoted strings with colons, empty arrays, booleans/numbers, multi-level nesting, and body preservation. All tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add frontmatter edge case tests for known fragility points</name>
  <files>bin/gsd-tools.test.cjs</files>
  <action>
Add additional test cases to the frontmatter describe block (or a nested describe) targeting the specific fragility points identified in CONCERNS.md:

**Edge case 1: Frontmatter with `must_haves` block (real plan format):**
Use a frontmatter structure that matches the actual PLAN.md format produced by the planner:
```markdown
---
phase: 01-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - AGENTS.md
autonomous: true
requirements:
  - FOUND-05
  - DOC-01
must_haves:
  truths:
    - "npm test runs the existing test suite"
    - "AGENTS.md shows accurate line count"
  artifacts:
    - path: "package.json"
      provides: "Project manifest"
      contains: "engines"
  key_links:
    - from: "package.json"
      to: "bin/gsd-tools.test.cjs"
      via: "scripts.test"
      pattern: "node --test"
---
# Plan content
```
This is the most complex real-world frontmatter format. Verify it round-trips.

**Edge case 2: Array items with nested objects (YAML array of objects):**
```yaml
artifacts:
  - path: "src/auth.ts"
    provides: "Auth module"
    exports: ["login", "logout"]
  - path: "src/api.ts"
    provides: "API routes"
```
Verify each array item's nested keys survive.

**Edge case 3: Values that look like YAML special values:**
```yaml
status: "true"
count: "42"
name: "null"
```
Verify quoted strings that look like booleans/numbers/null remain as strings.

**Edge case 4: Frontmatter-merge with new keys (additive merge):**
Write a file with `{phase: "01", plan: "01"}`, then merge `{wave: 1}` → verify original keys preserved AND new key added.

**Edge case 5: Frontmatter-merge with updated keys (update merge):**
Write a file with `{status: "draft"}`, then merge `{status: "active"}` → verify status updated.

CRITICAL: Read the actual `cmdFrontmatterMerge()` implementation to understand merge behavior (does it deep merge or shallow merge? Does it preserve keys not in the merge data?). Write tests to match actual behavior, then document any surprising behavior as test comments.
  </action>
  <verify>
Run `node --test bin/gsd-tools.test.cjs` — ALL tests pass (existing + state mutation + frontmatter).
Run `node --test --test-name-pattern="frontmatter" bin/gsd-tools.test.cjs` — all frontmatter tests pass.
Total new frontmatter test cases: 12+ (8 from Task 1 + 5 from Task 2).
  </verify>
  <done>
Frontmatter test suite covers all edge cases from CONCERNS.md: nested must_haves blocks, array items with nested objects, YAML special value strings, additive merge, and update merge. All tests pass. The frontmatter extract→reconstruct cycle is verified lossless for the project's YAML subset.
  </done>
</task>

</tasks>

<verification>
1. `node --test bin/gsd-tools.test.cjs` — all tests pass (0 failures)
2. `node --test --test-name-pattern="frontmatter" bin/gsd-tools.test.cjs` — frontmatter suite passes
3. At least 12 new frontmatter test cases exist
4. Tests cover all edge cases documented in CONCERNS.md: nested objects, inline arrays, quoted strings with colons, empty arrays, multi-level nesting
5. Tests verify semantic equivalence (extract → merge → extract produces same JSON)
</verification>

<success_criteria>
- Frontmatter round-trip test suite exists with 12+ test cases
- All documented edge cases from CONCERNS.md are covered
- Tests use black-box CLI pattern (frontmatter-get / frontmatter-merge commands)
- Semantic round-trip verified: extract → merge → extract produces identical JSON
- Body content preserved through round-trips
- All existing + new tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-safety-nets/01-04-SUMMARY.md`
</output>
