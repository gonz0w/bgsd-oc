---
phase: 01-foundation-safety-nets
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - bin/gsd-tools.cjs
autonomous: true
requirements:
  - FOUND-02

must_haves:
  truths:
    - "A single `CONFIG_SCHEMA` constant is the canonical source for all config field definitions"
    - "`loadConfig()` derives its defaults from `CONFIG_SCHEMA` instead of hardcoded values"
    - "`cmdConfigEnsureSection()` derives its defaults from `CONFIG_SCHEMA` instead of hardcoded values"
    - "`cmdValidateConfig()` derives its `knownKeys` from `CONFIG_SCHEMA` instead of a separate inline schema"
    - "Existing config.json files using flat keys, nested keys, or alias names all produce identical results to pre-refactor behavior"
  artifacts:
    - path: "bin/gsd-tools.cjs"
      provides: "CONFIG_SCHEMA constant and refactored config functions"
      contains: "CONFIG_SCHEMA"
  key_links:
    - from: "CONFIG_SCHEMA"
      to: "loadConfig()"
      via: "defaults derivation loop"
      pattern: "CONFIG_SCHEMA"
    - from: "CONFIG_SCHEMA"
      to: "cmdConfigEnsureSection()"
      via: "hardcoded defaults derivation"
      pattern: "CONFIG_SCHEMA"
    - from: "CONFIG_SCHEMA"
      to: "cmdValidateConfig()"
      via: "knownKeys derivation"
      pattern: "CONFIG_SCHEMA"
---

<objective>
Extract a single CONFIG_SCHEMA constant that replaces three independent config definitions — eliminating field drift between `loadConfig()`, `cmdConfigEnsureSection()`, and `cmdValidateConfig()`.

Purpose: The three current config sources use different field names (e.g., `research` vs `workflow.research` vs `research_enabled`, `plan_checker` vs `plan_check`) and different structures (flat vs nested vs schema-with-metadata). A single canonical schema eliminates drift and false "unknown key" warnings. This is prerequisite for clean config testing and for Phase 2's config migration command.
Output: Modified `bin/gsd-tools.cjs` with `CONFIG_SCHEMA` constant and refactored functions
</objective>

<execution_context>
@/home/cam/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/cam/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-safety-nets/01-RESEARCH.md
@bin/gsd-tools.cjs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Define CONFIG_SCHEMA constant at module level</name>
  <files>bin/gsd-tools.cjs</files>
  <action>
Add the `CONFIG_SCHEMA` constant at module level, BEFORE `loadConfig()` (around line 148, after the `MODEL_PROFILES` constant block). This constant is the single source of truth for all config fields.

The schema must include ALL fields from all three current sources (see field mapping table in 01-RESEARCH.md). Each entry has:
- `type`: string, boolean, or object
- `default`: default value
- `description`: human-readable description
- `aliases`: array of alternative field names that should be recognized (e.g., `['research_enabled']` for the `research` field)
- `nested`: object `{ section, field }` or null — describes where this field lives in nested config.json format
- `coerce`: optional string indicating special coercion logic (only used for `parallelization`)

Complete schema fields (from research field mapping table):

```javascript
const CONFIG_SCHEMA = {
  model_profile:             { type: 'string',  default: 'balanced',                     description: 'Active model profile (quality/balanced/budget)', aliases: [], nested: null },
  commit_docs:               { type: 'boolean', default: true,                            description: 'Auto-commit planning docs',                      aliases: [], nested: { section: 'planning', field: 'commit_docs' } },
  search_gitignored:         { type: 'boolean', default: false,                           description: 'Include gitignored files in searches',            aliases: [], nested: { section: 'planning', field: 'search_gitignored' } },
  branching_strategy:        { type: 'string',  default: 'none',                          description: 'Git branching strategy',                          aliases: [], nested: { section: 'git', field: 'branching_strategy' } },
  phase_branch_template:     { type: 'string',  default: 'gsd/phase-{phase}-{slug}',      description: 'Phase branch name template',                      aliases: [], nested: { section: 'git', field: 'phase_branch_template' } },
  milestone_branch_template: { type: 'string',  default: 'gsd/{milestone}-{slug}',        description: 'Milestone branch name template',                  aliases: [], nested: { section: 'git', field: 'milestone_branch_template' } },
  research:                  { type: 'boolean', default: true,                            description: 'Enable research phase',                           aliases: ['research_enabled'], nested: { section: 'workflow', field: 'research' } },
  plan_checker:              { type: 'boolean', default: true,                            description: 'Enable plan checking',                            aliases: [], nested: { section: 'workflow', field: 'plan_check' } },
  verifier:                  { type: 'boolean', default: true,                            description: 'Enable verification phase',                       aliases: [], nested: { section: 'workflow', field: 'verifier' } },
  parallelization:           { type: 'boolean', default: true,                            description: 'Enable parallel plan execution',                  aliases: [], nested: null, coerce: 'parallelization' },
  brave_search:              { type: 'boolean', default: false,                           description: 'Enable Brave Search API',                         aliases: [], nested: null },
  mode:                      { type: 'string',  default: 'interactive',                   description: 'Execution mode (interactive or yolo)',             aliases: [], nested: null },
  model_profiles:            { type: 'object',  default: {},                              description: 'Model assignments per agent',                     aliases: [], nested: null },
  depth:                     { type: 'string',  default: 'standard',                      description: 'Planning depth',                                  aliases: [], nested: null },
  test_commands:             { type: 'object',  default: {},                              description: 'Test commands by framework',                      aliases: [], nested: null },
  test_gate:                 { type: 'boolean', default: true,                            description: 'Block plan completion on test failure',            aliases: [], nested: null },
};
```

CRITICAL RULES:
- This MUST be a `const` — never mutated at runtime
- Place it between the existing `MODEL_PROFILES` constant and `loadConfig()` with an ASCII section divider: `// --- Config Schema ---------------------------------------------------------------`
- Do NOT modify any function behavior yet — this task only adds the constant
- Verify the constant is syntactically valid by checking the file can be loaded: `node -e "require('./bin/gsd-tools.cjs')"`... actually, the file calls `main()` on load, so instead verify syntax with `node --check bin/gsd-tools.cjs`
  </action>
  <verify>
`node --check bin/gsd-tools.cjs` exits with code 0 (no syntax errors).
`grep -c "CONFIG_SCHEMA" bin/gsd-tools.cjs` returns at least 1 (the constant exists).
Run `node --test bin/gsd-tools.test.cjs` — all 81 existing tests still pass (no behavioral change).
  </verify>
  <done>
`CONFIG_SCHEMA` constant exists at module level with all 16 fields documented in the research field mapping table. No behavioral change — all existing tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Rewire loadConfig(), cmdConfigEnsureSection(), and cmdValidateConfig() to derive from CONFIG_SCHEMA</name>
  <files>bin/gsd-tools.cjs</files>
  <action>
Rewire all three config functions to derive their values from `CONFIG_SCHEMA` instead of inline hardcoded definitions. This must be BEHAVIOR-PRESERVING — the exact same config.json inputs must produce the exact same outputs.

**Step 1: Rewire `loadConfig()` (around line 158)**

Current pattern: `loadConfig()` has hardcoded defaults like `{ model_profile: 'balanced', commit_docs: true, ... }` and a `get()` helper that checks flat keys then nested paths.

New pattern:
```javascript
// Build defaults from schema
const defaults = {};
for (const [key, def] of Object.entries(CONFIG_SCHEMA)) {
  defaults[key] = def.default;
}
```

The `get()` helper inside `loadConfig()` must also check aliases. For each key lookup:
1. Check flat `cfg[key]` (current behavior)
2. Check `cfg[nested.section]?.[nested.field]` if `nested` is defined (current behavior)
3. Check `cfg[alias]` for each alias in `def.aliases` (NEW — handles `research_enabled` → `research`)
4. Apply coercion if `def.coerce === 'parallelization'` (current behavior for `{enabled: true}` → `true`)

The `get()` helper's priority order for lookups: flat key → nested path → aliases. This preserves backward compatibility with all existing config.json formats.

**Step 2: Rewire `cmdConfigEnsureSection()` (around line 616)**

Current pattern: Has hardcoded `hardcoded` object with nested structure.

New pattern:
```javascript
const hardcoded = {};
for (const [key, def] of Object.entries(CONFIG_SCHEMA)) {
  if (def.nested) {
    if (!hardcoded[def.nested.section]) hardcoded[def.nested.section] = {};
    hardcoded[def.nested.section][def.nested.field] = def.default;
  } else {
    hardcoded[key] = def.default;
  }
}
```

IMPORTANT: Keep the existing `brave_search` auto-detection logic (checks env var + file). The schema's `default: false` is just the static default; the runtime auto-detection in `cmdConfigEnsureSection()` overrides it at write time. Do NOT remove this runtime behavior.

**Step 3: Rewire `cmdValidateConfig()` (around line 5932)**

Current pattern: Has its own inline `knownKeys` object with type/default/description.

New pattern:
```javascript
const knownKeys = {};
for (const [key, def] of Object.entries(CONFIG_SCHEMA)) {
  knownKeys[key] = { type: def.type, default: def.default, description: def.description };
  // Also register aliases as known keys pointing to the same definition
  for (const alias of def.aliases) {
    knownKeys[alias] = { type: def.type, default: def.default, description: `Alias for ${key}: ${def.description}` };
  }
}
// Also register section container keys as known (workflow, planning, git)
const sectionNames = new Set();
for (const [, def] of Object.entries(CONFIG_SCHEMA)) {
  if (def.nested) sectionNames.add(def.nested.section);
}
for (const section of sectionNames) {
  knownKeys[section] = { type: 'object', default: {}, description: `${section} configuration section` };
}
```

This ensures `cmdValidateConfig()` no longer reports false "unknown key" warnings for:
- `search_gitignored`, `branching_strategy`, `phase_branch_template`, `milestone_branch_template`, `brave_search` (5 fields previously missing from validate schema)
- `research_enabled` (alias for `research`)
- `workflow`, `planning`, `git` (section containers)

**Verification strategy:**
After each function rewire, run the existing test suite to confirm no behavioral change. Also manually test with the real event-pipeline config:
```bash
cd /mnt/raid/DEV/event-pipeline && node /mnt/raid/DEV/gsd-opencode/bin/gsd-tools.cjs validate-config --raw
```
This should show fewer/no "unknown key" warnings than before (the fix is intentional — the old code had false positives).
  </action>
  <verify>
Run `node --test bin/gsd-tools.test.cjs` — all 81 existing tests pass (behavior-preserving refactor).
Run `cd /mnt/raid/DEV/event-pipeline && node /mnt/raid/DEV/gsd-opencode/bin/gsd-tools.cjs validate-config --raw 2>/dev/null` — should return valid JSON with fewer unknown key warnings.
Run `cd /mnt/raid/DEV/event-pipeline && node /mnt/raid/DEV/gsd-opencode/bin/gsd-tools.cjs init progress --raw 2>/dev/null | python3 -c "import json,sys; d=json.load(sys.stdin); print('OK')"` — config loading still works for real project.
Run `grep -c "CONFIG_SCHEMA" bin/gsd-tools.cjs` — should be 4+ (definition + 3 derivation sites).
  </verify>
  <done>
All three config functions (`loadConfig`, `cmdConfigEnsureSection`, `cmdValidateConfig`) derive from the single `CONFIG_SCHEMA` constant. No inline hardcoded config definitions remain. All existing tests pass. Real event-pipeline config loads correctly. False "unknown key" warnings eliminated.
  </done>
</task>

</tasks>

<verification>
1. `node --test bin/gsd-tools.test.cjs` — all 81 tests pass
2. `grep "CONFIG_SCHEMA" bin/gsd-tools.cjs | head -5` — constant exists and is referenced by all three functions
3. Manual test against event-pipeline: config loads, validate-config produces correct output
4. The three functions no longer contain inline config field definitions (only derivation from CONFIG_SCHEMA)
</verification>

<success_criteria>
- A single `CONFIG_SCHEMA` constant defines all 16 config fields with types, defaults, aliases, and nested paths
- `loadConfig()`, `cmdConfigEnsureSection()`, and `cmdValidateConfig()` all derive from it
- Zero behavioral regression — all existing tests pass, real project configs work
- False "unknown key" warnings in `cmdValidateConfig()` are eliminated for previously unrecognized fields
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-safety-nets/01-02-SUMMARY.md`
</output>
