---
phase: 02-error-handling-hardening
plan: 02
type: execute
wave: 1
depends_on: []
files_modified: [bin/gsd-tools.cjs, bin/gsd-tools.test.cjs]
autonomous: true
requirements: [FOUND-06, FOUND-07]

must_haves:
  truths:
    - "Git command arguments with shell metacharacters are safely escaped and do not execute arbitrary commands"
    - "No gsd-*.json temp files remain in tmpdir after CLI process exits"
    - "Existing behavior is preserved — all commands produce same output as before"
  artifacts:
    - path: "bin/gsd-tools.cjs"
      provides: "sanitizeShellArg() function, strict date validation, temp cleanup handler"
      contains: "sanitizeShellArg"
    - path: "bin/gsd-tools.test.cjs"
      provides: "Tests for shell sanitization and temp file cleanup"
      contains: "sanitizeShellArg"
  key_links:
    - from: "execSync calls with user-derived strings"
      to: "sanitizeShellArg()"
      via: "argument sanitization before shell interpolation"
      pattern: "sanitizeShellArg\\("
    - from: "output() tmpfile creation"
      to: "process.on('exit')"
      via: "cleanup handler removes temp files"
      pattern: "process\\.on\\('exit'"
---

<objective>
Harden the CLI against shell injection in git/grep commands and ensure temp files are cleaned up on exit.

Purpose: While the risk is low (CLI tool run by developer, not a server), shell metacharacters in STATE.md dates or module names could theoretically execute arbitrary code via `execSync()`. Temp files accumulate indefinitely in tmpdir. These are straightforward hardening improvements.

Output: `sanitizeShellArg()` helper, strict date regex validation, `--fixed-strings` for grep, temp file cleanup handler, tests.
</objective>

<execution_context>
@/home/cam/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/cam/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/CONCERNS.md
@.planning/codebase/CONVENTIONS.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add shell sanitization and strict date validation</name>
  <files>bin/gsd-tools.cjs</files>
  <action>
1. Add a `sanitizeShellArg(arg)` helper function near the other helpers (after `debugLog`):
   - Escape shell metacharacters by wrapping in single quotes and escaping internal single quotes: `"'" + String(arg).replace(/'/g, "'\\''") + "'"`
   - This is the same pattern used in `execGit()` — extract it to a reusable function

2. Add a `isValidDateString(str)` helper function:
   - Validate against strict regex: `/^\d{4}-\d{2}-\d{2}$/`
   - Return boolean
   - This prevents any non-date string from being interpolated into `--since` git args

3. Fix the 5 unguarded `execSync` sites identified in CONCERNS.md:

   a. **`getSessionDiffSummary()` (~line 5009)**: `git log --since="${since}"` — validate `since` with `isValidDateString()` before interpolation. If invalid, return null instead of executing with unsanitized input.

   b. **`cmdSessionDiff()` (~line 5041)**: Same pattern — validate `since` before `git log --since="${since}"`.

   c. **`cmdSessionDiff()` (~line 5055)**: `git diff --name-only --since="${since}"` — same fix.

   d. **`cmdSessionDiff()` (~line 5064)**: `git log --since="${since}" --name-only` — same fix.

   e. **`cmdCodebaseImpact()` (~line 5635)**: `grep -rl "${pattern}"` — use `sanitizeShellArg(pattern)` and add `--fixed-strings` flag (changes regex grep to literal string match, which is both safer and more correct for module name searches).

4. Also update the `find` command at ~line 4467 to use the array-of-strings pattern instead of shell string interpolation (it's currently hardcoded so low risk, but consistency is good).

5. Do NOT modify the `execGit()` function — it already has proper escaping. Do NOT modify `cmdTestRun()` — it intentionally executes user-configured commands from config.json.
  </action>
  <verify>
Run: `npm test` — all existing tests pass.
Run: `grep -c 'sanitizeShellArg' bin/gsd-tools.cjs` — should appear in the helper definition + at usage sites.
Run: `grep -c 'isValidDateString' bin/gsd-tools.cjs` — should appear at helper definition + validation sites.
Run: `grep 'fixed-strings' bin/gsd-tools.cjs` — should appear in cmdCodebaseImpact grep call.
  </verify>
  <done>All execSync calls with user-derived strings are sanitized. Date strings are validated before shell interpolation. Grep patterns use --fixed-strings for literal matching.</done>
</task>

<task type="auto">
  <name>Task 2: Add temp file cleanup and tests for hardening</name>
  <files>bin/gsd-tools.cjs, bin/gsd-tools.test.cjs</files>
  <action>
1. In `bin/gsd-tools.cjs`, add a temp file tracking and cleanup mechanism:

   a. Near the top of the file (after requires), create a `const _tmpFiles = [];` array to track created temp files.

   b. In the `output()` function where the tmpfile is created (~line 484), push the path to `_tmpFiles`:
      ```
      _tmpFiles.push(tmpPath);
      ```

   c. Add a cleanup handler near the top of `main()` or at module level:
      ```
      process.on('exit', () => {
        for (const f of _tmpFiles) {
          try { fs.unlinkSync(f); } catch {}
        }
      });
      ```

   d. This handles both normal exit (via `process.exit(0)`) and error exit (via `process.exit(1)`). The 'exit' event fires for both.

2. In `bin/gsd-tools.test.cjs`, add a `describe('shell sanitization')` block:

   a. Test `sanitizeShellArg` handles metacharacters: test that strings containing `$(whoami)`, backticks, semicolons, and pipe characters are safely escaped.

   b. Test date validation: test that `isValidDateString` accepts valid dates like `2026-01-15` and rejects strings like `2026-01-15; rm -rf /` or `$(date)`.

3. In `bin/gsd-tools.test.cjs`, add a `describe('temp file cleanup')` block:

   a. Test that after a CLI invocation that produces large output (>50KB), no gsd-*.json temp files remain in tmpdir. This may require mocking or generating large output — if the test is impractical, test the cleanup mechanism by checking that `_tmpFiles` array is populated and the exit handler is registered.

Note: The sanitizeShellArg and isValidDateString functions are internal to gsd-tools.cjs (no exports). Test them via CLI invocations that exercise the code paths, OR use the same `runGsdTools` helper pattern from existing tests.
  </action>
  <verify>
Run: `npm test` — all tests pass including new sanitization and cleanup tests.
Run: `grep 'process.on.*exit' bin/gsd-tools.cjs` — cleanup handler is registered.
Run: `ls /tmp/gsd-*.json 2>/dev/null | wc -l` — after running commands, no temp files should accumulate (existing ones may still exist from before this change).
  </verify>
  <done>Temp files are tracked and cleaned up on process exit. Shell sanitization is tested. Date validation is tested. No regressions in existing tests.</done>
</task>

</tasks>

<verification>
1. `npm test` passes (all existing tests + new hardening tests)
2. `grep -c 'sanitizeShellArg' bin/gsd-tools.cjs` shows the function defined and used
3. `grep 'fixed-strings' bin/gsd-tools.cjs` shows grep uses literal matching
4. `grep 'process.on.*exit' bin/gsd-tools.cjs` shows cleanup handler registered
5. Shell metacharacters in inputs don't execute arbitrary commands
</verification>

<success_criteria>
- sanitizeShellArg() helper wraps user-derived strings before shell interpolation
- isValidDateString() validates --since dates against strict regex before use
- grep patterns in cmdCodebaseImpact use --fixed-strings flag
- Temp files created by output() are cleaned up on process exit
- All existing tests pass with no behavioral changes
- New tests verify sanitization and cleanup behavior
</success_criteria>

<output>
After completion, create `.planning/phases/02-error-handling-hardening/02-02-SUMMARY.md`
</output>
