---
phase: 20-structured-requirements
plan: 03
type: execute
wave: 2
depends_on:
  - 20-01
files_modified:
  - workflows/plan-phase.md
  - templates/assertions.md
  - templates/requirements.md
autonomous: true
requirements:
  - SREQ-02
  - SREQ-05
intent:
  outcome_ids:
    - DO-04
  rationale: "Plans trace back to desired outcomes via auto-populated assertions"

must_haves:
  truths:
    - "plan-phase workflow instructs planner to read ASSERTIONS.md and derive must_haves.truths from assertions"
    - "Planner agent prompt includes assertion reading and must_haves population instructions"
    - "REQUIREMENTS.md template shows assertion reference pattern for new projects"
    - "Assertions are auto-derived during planning, not a separate workflow step"
  artifacts:
    - path: "workflows/plan-phase.md"
      provides: "Updated planner spawn with assertion reading instructions"
      contains: "ASSERTIONS.md"
    - path: "templates/requirements.md"
      provides: "Updated template showing assertion reference"
      contains: "ASSERTIONS.md"
  key_links:
    - from: "workflows/plan-phase.md"
      to: "templates/assertions.md"
      via: "planner reads assertion file"
      pattern: "ASSERTIONS"
---

<objective>
Wire assertion reading into the planning workflow so planners auto-populate must_haves.truths from requirement assertions, and update templates so new projects get the assertion pattern from the start.

Purpose: SREQ-02 requires workflows to generate structured requirements with assertions. SREQ-05 requires must_haves.truths auto-population from assertions. Together these ensure the planning pipeline consumes assertions automatically without new user ceremony.

Output: Updated plan-phase workflow, updated templates, planner agent instructions for assertion handling.
</objective>

<execution_context>
@/home/cam/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/cam/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/INTENT.md
@.planning/phases/20-structured-requirements/20-CONTEXT.md
@.planning/phases/20-structured-requirements/20-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire assertion reading into plan-phase workflow and planner agent</name>
  <files>
workflows/plan-phase.md
  </files>
  <action>
**Update `workflows/plan-phase.md`** to inject assertion context into the planner:

1. **In Step 7 (Use Context Paths from INIT)**, add assertion path discovery:
   ```
   Check for .planning/ASSERTIONS.md existence.
   If present, include in planner context as assertions_path.
   ```

2. **In Step 9 (Spawn Planner)**, update the planner Task prompt to include assertion reading:
   
   Add to the planner prompt (after the existing "Read:" line):
   ```
   Read: {assertions_path} (if exists — structured acceptance criteria for requirements)
   For each requirement this phase covers (Requirement IDs: {phase_req_ids}):
     - Find the requirement's assertions in ASSERTIONS.md
     - Use must-have assertions as the source for must_haves.truths in PLAN.md frontmatter
     - Each must_haves.truths entry should correspond to a must-have assertion from the mapped requirements
     - If ASSERTIONS.md doesn't exist or has no assertions for a requirement, derive truths from requirement text + context (existing behavior)
   ```

3. **In Step 5 (Handle Research)**, update the researcher spawn prompt to mention assertions:
   
   Add to researcher prompt:
   ```
   If .planning/ASSERTIONS.md exists, note existing assertions for this phase's requirements.
   Research should inform whether existing assertions are sufficient or need additions.
   ```

4. **Add a new Step 8.5 (Surface Assertions)** between lessons (Step 8) and planner spawn (Step 9):
   ```
   ## 8.5. Surface Assertions
   
   If .planning/ASSERTIONS.md exists:
     Run: `node gsd-tools.cjs assertions list --req {phase_req_ids} --raw`
     Display assertion count and coverage to user.
     If no assertions exist for this phase's requirements:
       Note: "No assertions found for {req_ids}. Planner will derive must_haves from requirement text."
   ```

**Per CONTEXT.md decisions:**
- Agent derives assertions automatically during plan-phase from requirements + context — no new workflow step
- User only involved when agent can't determine what "done" looks like (collaborative fallback)
- Must-have assertions get a review gate — user approves before plans finalize (this happens naturally in the existing plan-checker loop)
- Nice-to-have assertions get summary only — informational, doesn't block

**IMPORTANT:** Keep the workflow file compact. The plan-phase.md is already compressed. Add minimal lines — integrate into existing steps rather than creating verbose new sections. Target: net addition of <20 lines to the workflow.
  </action>
  <verify>
Read the updated workflows/plan-phase.md and verify:
1. Step 9 planner prompt mentions ASSERTIONS.md
2. Step 8.5 surfaces assertion count
3. The additions are compact (< 20 net new lines)
4. No existing steps broken or removed
  </verify>
  <done>
- plan-phase.md planner spawn reads ASSERTIONS.md for assertion-aware must_haves derivation
- Assertion count surfaced to user before planning
- Compact integration: <20 new lines added to existing workflow
  </done>
</task>

<task type="auto">
  <name>Task 2: Update templates for assertion-aware projects</name>
  <files>
templates/requirements.md
templates/assertions.md
  </files>
  <action>
**1. Update `templates/requirements.md`:**

Add a reference to ASSERTIONS.md in the template so new projects know about structured assertions:

In the `<guidelines>` section, add after the "Requirement Format" block:
```markdown
**Structured Assertions:**
- Each requirement can have testable assertions in `.planning/ASSERTIONS.md`
- Assertions are auto-generated during phase planning (see ASSERTIONS.md template)
- Must-have assertions drive verification; nice-to-have are advisory
- Coverage tracked: `assertions validate` reports requirements with/without assertions
```

In the `<evolution>` section, add to "After each phase completes":
```markdown
4. Update ASSERTIONS.md: add assertions for newly-touched requirements if missing
```

In the traceability table template, add the test-command column:
```markdown
| Requirement | Phase | Status | Test Command |
|-------------|-------|--------|--------------|
| AUTH-01 | Phase 1 | Pending | npm test -- --grep auth |
```

Update the example section's traceability table to include the test-command column too.

**2. Update `templates/assertions.md`** (created in Plan 01):

Add a section on how assertions flow into planning:
```markdown
## Assertion → Plan Flow

During `/gsd-plan-phase`, the planner:
1. Reads ASSERTIONS.md for the phase's requirements
2. Uses must-have assertions as the source for `must_haves.truths` in PLAN.md frontmatter
3. Each plan's truths map back to specific assertions
4. During verification, each truth is checked against the original assertion

This creates full traceability: Requirement → Assertion → Plan Truth → Verification Result
```

Add a section on gradual migration:
```markdown
## Migration

Assertions are added gradually — when a phase touches a requirement, assertions for that requirement should be created. There is no need for a big-bang backfill.

`assertions validate` will report coverage: how many requirements have assertions vs. how many don't.
```

**Per CONTEXT.md decisions:**
- Nice-to-have assertions get summary only ("N assertions generated for M requirements") — informational, doesn't block
- Gradual migration for existing requirements — add assertions when a phase touches an old requirement, no big-bang backfill
  </action>
  <verify>
Read both template files and verify:
1. requirements.md references ASSERTIONS.md in guidelines and evolution sections
2. Traceability table template includes test-command column
3. assertions.md explains the assertion → plan flow
4. Both files are well-formatted with no broken markdown
  </verify>
  <done>
- requirements.md template references assertion system in guidelines and evolution
- Traceability table template has test-command column
- assertions.md template explains assertion → plan flow and gradual migration
- New projects created with `/gsd-new-project` will get assertion awareness from templates
  </done>
</task>

</tasks>

<verification>
1. workflows/plan-phase.md planner spawn includes ASSERTIONS.md reading instructions
2. templates/requirements.md references assertion system and has test-command column
3. templates/assertions.md explains the full assertion → plan → verification flow
4. No existing workflow behavior broken (plan-phase still works without ASSERTIONS.md)
5. Total additions are compact and don't bloat workflow context
</verification>

<success_criteria>
- Planning workflow automatically reads and uses assertions when available
- Templates guide new projects to use assertions from the start
- Gradual migration: existing projects work unchanged, assertions added incrementally
- No new ceremony required — assertions derived automatically during planning
</success_criteria>

<output>
After completion, create `.planning/phases/20-structured-requirements/20-03-SUMMARY.md`
</output>
