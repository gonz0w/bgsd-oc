---
phase: 20-structured-requirements
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - templates/assertions.md
  - src/commands/verify.js
  - src/router.js
  - src/lib/helpers.js
autonomous: true
requirements:
  - SREQ-01
intent:
  outcome_ids:
    - DO-04
  rationale: "Structured assertions create the foundation for traceability from intent to delivered code"

must_haves:
  truths:
    - "ASSERTIONS.md template defines the assertion schema with assert, when, then, type fields"
    - "parseAssertionsMd() parses ASSERTIONS.md and returns structured assertion objects keyed by requirement ID"
    - "assertions list command outputs all assertions grouped by requirement ID with pass/fail counts"
    - "assertions validate command checks assertion format and reports issues"
    - "Bundle stays within 525KB budget after all additions"
  artifacts:
    - path: "templates/assertions.md"
      provides: "ASSERTIONS.md template with schema definition, examples, and guidelines"
      min_lines: 50
    - path: "src/commands/verify.js"
      provides: "parseAssertionsMd helper and cmdAssertionsList, cmdAssertionsValidate commands"
      contains: "parseAssertionsMd"
    - path: "src/router.js"
      provides: "assertions CLI routing"
      contains: "assertions"
  key_links:
    - from: "src/commands/verify.js"
      to: "src/lib/helpers.js"
      via: "shared helper imports"
      pattern: "require.*helpers"
    - from: "src/router.js"
      to: "src/commands/verify.js"
      via: "command routing"
      pattern: "cmdAssertions"
---

<objective>
Create the ASSERTIONS.md schema, parser, and CLI commands — the foundation that all other Phase 20 work depends on.

Purpose: SREQ-01 requires structured acceptance criteria per requirement. This plan establishes the file format (ASSERTIONS.md), the parser that reads it, and basic CLI commands to list/validate assertions. Every subsequent plan (verification, traceability, planner integration) depends on this parser.

Output: ASSERTIONS.md template, parseAssertionsMd() helper, `assertions list` and `assertions validate` CLI commands.
</objective>

<execution_context>
@__OPENCODE_CONFIG__/get-shit-done/workflows/execute-plan.md
@__OPENCODE_CONFIG__/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/INTENT.md
@.planning/phases/20-structured-requirements/20-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ASSERTIONS.md template and parser</name>
  <files>
templates/assertions.md
src/commands/verify.js
src/lib/helpers.js
  </files>
  <action>
**1. Create `templates/assertions.md`** — the template for `.planning/ASSERTIONS.md`:

Schema format (per CONTEXT.md decisions — flexible schema with `assert` required, `when`/`then`/`type` optional):

```markdown
# Assertions: [Project Name]

**Defined:** [date]
**Source:** REQUIREMENTS.md

## [CATEGORY]-[NN]: [Requirement description]

- assert: "[Testable statement]"
  when: "[Precondition or trigger]"
  then: "[Expected outcome]"
  type: [api|cli|file|behavior]
  priority: [must-have|nice-to-have]

- assert: "[Another testable statement]"
  priority: must-have
```

Include guidelines section explaining:
- `assert` field required, others optional (use when they add clarity)
- 2-5 assertions per requirement
- `priority: must-have` triggers gap closure on failure; `nice-to-have` is advisory
- Assertions back-reference requirement IDs via the `## REQ-ID:` heading format
- Gradual migration: add assertions when a phase touches a requirement, no big-bang backfill

Include a complete example section showing assertions for real requirement patterns (CLI command, file existence, behavioral).

**2. Add `parseAssertionsMd(content)` to `src/commands/verify.js`** (keep it with verification logic since it's used by verifier):

Parser logic:
- Split on `## ` headings to find requirement-assertion groups
- Extract requirement ID from heading: `## SREQ-01: ...` → `SREQ-01`
- Parse each `- assert:` block as a YAML-like structure:
  - `assert:` (required) — the testable statement
  - `when:` (optional) — precondition
  - `then:` (optional) — expected outcome  
  - `type:` (optional) — one of: api, cli, file, behavior
  - `priority:` (optional, default: must-have) — must-have or nice-to-have
- Return: `{ [reqId]: { description, assertions: [{assert, when, then, type, priority}] } }`
- Handle edge cases: missing priority defaults to must-have, empty assertions array valid, unknown fields ignored

Use the same indentation-based parsing style as `extractFrontmatter()` — no external YAML library.

**3. Export `parseAssertionsMd` from verify.js** and add it to the module exports at the bottom of the file.

**IMPORTANT — Bundle budget:** Current bundle is ~501KB against 500KB. Raise BUNDLE_BUDGET_KB in build.js from 500 to 525 to accommodate Phase 20 additions. This follows the precedent from Phase 14 (400→450KB) and Phase 18 (450→500KB). The parser should be compact — target <80 lines for parseAssertionsMd.
  </action>
  <verify>
```bash
npm run build && node bin/gsd-tools.cjs current-timestamp --raw
```
Build succeeds and smoke test passes. Check bundle size stays under 525KB.
  </verify>
  <done>
- templates/assertions.md exists with schema definition, guidelines, and example
- parseAssertionsMd() parses ASSERTIONS.md content and returns structured assertion map
- Build passes with bundle under 525KB
  </done>
</task>

<task type="auto">
  <name>Task 2: Add assertions CLI commands and routing</name>
  <files>
src/commands/verify.js
src/router.js
bin/gsd-tools.test.cjs
  </files>
  <action>
**1. Add `cmdAssertionsList(cwd, options, raw)` to `src/commands/verify.js`:**

- Read `.planning/ASSERTIONS.md` using `safeReadFile`
- Parse with `parseAssertionsMd()`
- If `options.reqId`: filter to specific requirement
- For each requirement, count total assertions, must-have count, nice-to-have count
- Output JSON:
  ```json
  {
    "total_requirements": 5,
    "total_assertions": 18,
    "must_have_count": 12,
    "nice_to_have_count": 6,
    "requirements": {
      "SREQ-01": {
        "description": "...",
        "assertion_count": 3,
        "assertions": [{"assert": "...", "priority": "must-have"}]
      }
    }
  }
  ```
- `rawValue`: `"5 requirements, 18 assertions (12 must-have, 6 nice-to-have)"`
- If no ASSERTIONS.md: soft error with `{ error: "ASSERTIONS.md not found" }`

**2. Add `cmdAssertionsValidate(cwd, raw)` to `src/commands/verify.js`:**

- Parse ASSERTIONS.md
- Check: every requirement ID in ASSERTIONS.md exists in REQUIREMENTS.md
- Check: each requirement has 2-5 assertions
- Check: every assertion has non-empty `assert` field
- Check: `priority` is either `must-have` or `nice-to-have` (if present)
- Check: `type` is one of: api, cli, file, behavior (if present)
- Return: `{ valid, issues: [{reqId, issue, severity}], stats: {total_reqs, total_assertions, coverage_percent} }`
- `coverage_percent` = requirements with assertions / total requirements in REQUIREMENTS.md × 100
- `rawValue`: `"valid"` or `"N issues found"`

**3. Add routing in `src/router.js`:**

- Import `cmdAssertionsList` and `cmdAssertionsValidate` from verify.js
- Add case `'assertions'` in the switch, with subcommands:
  - `assertions list [--req SREQ-01]` → cmdAssertionsList
  - `assertions validate` → cmdAssertionsValidate
- Add COMMAND_HELP entries for both commands

**4. Add tests in `bin/gsd-tools.test.cjs`:**

- Test parseAssertionsMd with sample content (3 requirements, mixed priorities)
- Test assertions list command output format
- Test assertions validate catches missing assert field, wrong type value, req not in REQUIREMENTS.md
- Test empty/missing ASSERTIONS.md handling
- Target: 8-12 new tests

**5. Export new functions** from verify.js module.exports: `cmdAssertionsList`, `cmdAssertionsValidate`, `parseAssertionsMd`
  </action>
  <verify>
```bash
npm run build && npm test
```
All tests pass (existing 436 + new assertion tests). Build succeeds under 525KB.
  </verify>
  <done>
- `assertions list` outputs structured assertion data grouped by requirement
- `assertions validate` checks format, coverage, and consistency with REQUIREMENTS.md
- Router wires both commands with help entries
- 8+ new tests pass
- All existing 436 tests still pass
  </done>
</task>

</tasks>

<verification>
1. `node bin/gsd-tools.cjs assertions list --raw` returns structured assertion data (or soft error if no ASSERTIONS.md)
2. `node bin/gsd-tools.cjs assertions validate --raw` checks ASSERTIONS.md format and reports issues
3. `npm test` passes with zero regressions and new assertion tests
4. `npm run build` succeeds with bundle under 525KB
5. `templates/assertions.md` has complete schema definition with examples
</verification>

<success_criteria>
- ASSERTIONS.md template defines the canonical assertion schema
- Parser handles real-world assertion files without crashing
- CLI commands provide list and validate operations
- Foundation is solid for Plans 02 and 03 to build on
</success_criteria>

<output>
After completion, create `.planning/phases/20-structured-requirements/20-01-SUMMARY.md`
</output>
