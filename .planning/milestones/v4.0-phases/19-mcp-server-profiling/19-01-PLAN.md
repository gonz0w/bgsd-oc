---
phase: 19-mcp-server-profiling
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/commands/mcp.js
  - src/router.js
  - src/lib/constants.js
  - bin/gsd-tools.cjs
  - bin/gsd-tools.test.cjs
autonomous: true
requirements: [MCP-01, MCP-02]

must_haves:
  truths:
    - "mcp-profile lists all configured servers from .mcp.json and opencode.json"
    - "mcp-profile shows per-server token cost estimate and total context window percentage"
    - "Servers from both config formats are merged and deduplicated"
    - "Unknown servers get a reasonable default token estimate"
  artifacts:
    - path: "src/commands/mcp.js"
      provides: "MCP profiling command module"
      exports: ["cmdMcpProfile", "MCP_KNOWN_SERVERS", "discoverMcpServers", "estimateTokenCost"]
    - path: "src/router.js"
      provides: "mcp-profile command routing"
      contains: "mcp-profile"
    - path: "src/lib/constants.js"
      provides: "COMMAND_HELP entry for mcp-profile"
      contains: "mcp-profile"
  key_links:
    - from: "src/commands/mcp.js"
      to: ".mcp.json"
      via: "fs.readFileSync + JSON.parse"
      pattern: "mcpServers"
    - from: "src/commands/mcp.js"
      to: "opencode.json"
      via: "fs.readFileSync + JSON.parse"
      pattern: "\\.mcp\\b"
    - from: "src/router.js"
      to: "src/commands/mcp.js"
      via: "require + case dispatch"
      pattern: "cmdMcpProfile"
---

<objective>
Build the MCP server discovery engine and token cost estimation database.

Purpose: Users need to see which MCP servers are configured across their project and user-level configs, and how many tokens each server consumes from their context window. This is the foundation that relevance scoring (Plan 02) and auto-disable (Plan 03) build on.

Output: `mcp-profile` CLI command that discovers servers from `.mcp.json` and `opencode.json` (OpenCode format), merges them with deduplication, estimates token cost from a known-server database, and outputs a structured JSON report with per-server and total context cost.
</objective>

<execution_context>
@__OPENCODE_CONFIG__/get-shit-done/workflows/execute-plan.md
@__OPENCODE_CONFIG__/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/18-environment-awareness/18-01-SUMMARY.md

Key reference: Phase 18's env.js module follows the exact same pattern (new command module + router wiring + tests). Use it as the structural template.

Existing code: `src/commands/env.js` has a lightweight `detectMcpServers()` that reads `.mcp.json` server names only — Phase 19 builds a proper profiling system that reads both config formats with full server metadata.

Config formats discovered from real projects:
- `.mcp.json`: `{ mcpServers: { name: { command, args, env } } }` (standard MCP format)
- `opencode.json`: `{ mcp: { name: { type, command, environment } } }` (OpenCode format)
- User-level: `~/.config/opencode/opencode.json` (same OpenCode format)

Decision from ROADMAP: "Static MCP profiling over runtime connection — known-server database sufficient" (no spawning servers).
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build MCP server discovery and token estimation engine</name>
  <files>src/commands/mcp.js, src/router.js, src/lib/constants.js, build.js, bin/gsd-tools.cjs</files>
  <action>
Create `src/commands/mcp.js` with the following functions:

**`discoverMcpServers(cwd)`** — Discovers servers from 3 locations:
1. Project `.mcp.json` (standard MCP format): key `mcpServers` → object of `{ name: { command, args?, env? } }`
2. Project `opencode.json` (OpenCode format): key `mcp` → object of `{ name: { type, command, environment? } }`
3. User-level `~/.config/opencode/opencode.json` (same OpenCode format, lower priority)

For each server, extract:
- `name`: server name (object key)
- `source`: which config file it came from (e.g., ".mcp.json", "opencode.json", "~/.config/opencode/opencode.json")
- `transport`: "stdio" (if command array/string) or "remote" (if type: "remote" with url)
- `command`: the command string (first element of command array, or command field)
- `args`: remaining command array elements or args field

Deduplication: If same server name appears in multiple configs, project-level wins over user-level. `.mcp.json` and `opencode.json` are both project-level — include both but mark source. If same name in both project configs, merge (opencode.json provides `type` field that .mcp.json lacks).

Return array of server objects sorted by name.

**`MCP_KNOWN_SERVERS`** — Static lookup table mapping server identifiers to approximate token cost data. Each entry has:
- `pattern`: regex or string to match server name/command (e.g., "postgres", "brave-search", "github")
- `tool_count`: approximate number of tools the server exposes
- `tokens_per_tool`: average tokens per tool definition (~150 default)
- `base_tokens`: fixed overhead tokens (server description, etc.)
- `total_estimate`: pre-calculated total token estimate

Cover these 15+ well-known servers:
| Server | Est. Tools | Est. Tokens |
|--------|-----------|-------------|
| postgres/toolbox | 12 | ~4,500 |
| github | 30 | ~46,000 |
| brave-search | 3 | ~2,500 |
| context7 | 2 | ~1,500 |
| terraform | 8 | ~6,000 |
| docker/podman | 10 | ~5,000 |
| filesystem | 8 | ~3,000 |
| puppeteer | 12 | ~8,000 |
| sqlite | 6 | ~3,000 |
| redis | 8 | ~3,500 |
| rabbitmq/queue-pilot | 6 | ~3,000 |
| pulsar/snmcp | 8 | ~4,000 |
| consul | 5 | ~2,500 |
| vault | 8 | ~4,000 |
| slack | 15 | ~12,000 |

Token estimates are approximations based on typical tool definition sizes. Use `150 tokens/tool` as the default for unknown servers.

**`estimateTokenCost(server, knownServers)`** — Given a discovered server, looks up in MCP_KNOWN_SERVERS by matching name or command against patterns. Returns `{ matched: bool, server_name, tool_count, token_estimate, source: "known-db" | "default-estimate" }`.

**`cmdMcpProfile(cwd, args, raw)`** — Main command function:
1. Call `discoverMcpServers(cwd)` to get all servers
2. For each server, call `estimateTokenCost()` to get token data
3. Calculate total tokens and context window percentage (assume 200K window by default, allow `--window <size>` flag override)
4. Build result object:
```json
{
  "servers": [
    {
      "name": "postgres",
      "source": ".mcp.json",
      "transport": "stdio",
      "command": "/home/cam/.local/bin/toolbox",
      "tool_count": 12,
      "token_estimate": 4500,
      "token_source": "known-db",
      "context_percent": "2.3%"
    }
  ],
  "total_tokens": 25000,
  "total_context_percent": "12.5%",
  "context_window": 200000,
  "server_count": 5,
  "known_count": 4,
  "unknown_count": 1
}
```
5. Call `output(result, raw)`

Wire in `src/router.js`: Add `case 'mcp-profile':` that imports and calls `cmdMcpProfile`. Also add `case 'mcp':` that checks `args[1] === 'profile'` for subcommand syntax.

Add COMMAND_HELP entry in `src/lib/constants.js` for `mcp-profile`.

Build with `npm run build`. Verify bundle stays under 500KB budget.
  </action>
  <verify>
Run `npm run build` — bundle under 500KB.
Run `node bin/gsd-tools.cjs mcp-profile --raw` from a project with MCP config — should list servers from both `.mcp.json` and `opencode.json`.
Run `node bin/gsd-tools.cjs mcp-profile --help` — should show help text.
  </verify>
  <done>
`mcp-profile` discovers servers from `.mcp.json` and `opencode.json` (project + user level), estimates token cost per server from known-server DB, reports total context window usage. Build passes, bundle under 500KB.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add comprehensive tests for discovery and estimation</name>
  <files>bin/gsd-tools.test.cjs</files>
  <action>
Add `describe('mcp-profile')` test suite in `bin/gsd-tools.test.cjs` with these test cases:

1. **Discovers servers from .mcp.json** — Create temp dir with `.mcp.json` containing 2 servers (postgres, consul). Run `mcp-profile --raw`. Verify 2 servers found with correct names, transport "stdio", and commands.

2. **Discovers servers from opencode.json** — Create temp dir with `opencode.json` containing `{ mcp: { "brave-search": { type: "local", command: ["npx", "brave-search"] } } }`. Run `mcp-profile --raw`. Verify server found with transport "stdio" and correct command.

3. **Discovers remote MCP servers** — Create temp dir with `opencode.json` containing `{ mcp: { "context7": { type: "remote", url: "https://mcp.context7.com" } } }`. Verify transport is "remote".

4. **Merges servers from both configs** — Create temp dir with both `.mcp.json` (2 servers) and `opencode.json` (2 servers, 1 overlapping). Verify merged list with correct deduplication (project-level both present but deduplicated by name).

5. **Known server token estimation** — Verify `estimateTokenCost` returns known-db values for "postgres" and "brave-search". Verify it returns default estimate for "my-custom-server".

6. **Total context calculation** — Create temp dir with known servers. Verify `total_tokens` is sum of individual estimates, and `total_context_percent` is calculated correctly.

7. **Custom window size** — Run with `--window 100000`. Verify `context_window` is 100000 and percentages are recalculated.

8. **Empty config** — Create temp dir with no MCP configs. Verify `servers: [], server_count: 0, total_tokens: 0`.

9. **Malformed config** — Create temp dir with invalid JSON in `.mcp.json`. Verify graceful degradation (empty servers, no crash).

10. **User-level config discovery** — Verify the function attempts to read `~/.config/opencode/opencode.json` (mock or skip if not testable in isolation).

Run `npm test` — all tests pass including existing ones.
  </action>
  <verify>
Run `npm test` — all tests pass (existing + new).
Verify no test regressions by checking total test count increased.
  </verify>
  <done>
10+ test cases covering discovery from both config formats, merging, token estimation (known + unknown), context calculation, edge cases (empty, malformed). All existing tests still pass.
  </done>
</task>

</tasks>

<verification>
- `npm run build` passes, bundle under 500KB
- `npm test` passes with all existing + new tests
- `node bin/gsd-tools.cjs mcp-profile --raw` from a project with MCP servers returns valid JSON
- Token estimates are reasonable (within 2x of actual for known servers)
- Empty project returns `{ servers: [], server_count: 0, total_tokens: 0 }`
</verification>

<success_criteria>
- MCP-01: `mcp-profile` discovers servers from `.mcp.json` and `opencode.json` with transport type and command
- MCP-02: Per-server token cost shown from known-server DB, unknowns estimated at 150 tokens/tool average
- All tests pass, bundle under 500KB, no regressions
</success_criteria>

<output>
After completion, create `.planning/phases/19-mcp-server-profiling/19-01-SUMMARY.md`
</output>
