---
phase: 19-mcp-server-profiling
plan: 02
type: execute
wave: 2
depends_on: [19-01]
files_modified:
  - src/commands/mcp.js
  - bin/gsd-tools.cjs
  - bin/gsd-tools.test.cjs
autonomous: true
requirements: [MCP-03, MCP-04]

must_haves:
  truths:
    - "Each server gets a relevance score based on project file indicators"
    - "Servers are recommended as keep/disable/review with reasoning"
    - "Low-cost servers (< 1K tokens) are always marked relevant"
    - "Total potential savings shown in tokens and context percentage"
  artifacts:
    - path: "src/commands/mcp.js"
      provides: "Relevance scoring and recommendation engine"
      exports: ["scoreServerRelevance", "generateRecommendations"]
    - path: "bin/gsd-tools.test.cjs"
      provides: "Relevance scoring and recommendation tests"
      contains: "relevance"
  key_links:
    - from: "src/commands/mcp.js (scoreServerRelevance)"
      to: "project filesystem"
      via: "fs.existsSync checks for indicator files"
      pattern: "existsSync.*indicator"
    - from: "src/commands/mcp.js (generateRecommendations)"
      to: "scoreServerRelevance"
      via: "function call per server"
      pattern: "scoreServerRelevance"
    - from: "src/commands/mcp.js (cmdMcpProfile)"
      to: "generateRecommendations"
      via: "enriches server list with recommendations"
      pattern: "generateRecommendations"
---

<objective>
Add project-aware relevance scoring and actionable recommendations to the MCP profiling command.

Purpose: Knowing which servers exist and their token cost (Plan 01) isn't enough — users need to know which servers are actually useful for their project and which are wasting context. This plan adds intelligence that matches servers against project file indicators and produces keep/disable/review recommendations with reasoning.

Output: Enhanced `mcp-profile` output that includes per-server relevance scores and recommendations with total potential token savings.
</objective>

<execution_context>
@/home/cam/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/cam/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/19-mcp-server-profiling/19-01-SUMMARY.md

Builds on Plan 01's `discoverMcpServers()` and `estimateTokenCost()`. Extends `cmdMcpProfile` output with relevance and recommendation fields.

The env-manifest.json from Phase 18 provides detected languages, tools, and infrastructure — but relevance scoring should work independently (direct file checks) so it functions even without env scan. If env-manifest.json exists, it can be used as a fast path.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build relevance scoring and recommendation engine</name>
  <files>src/commands/mcp.js, bin/gsd-tools.cjs</files>
  <action>
Add to `src/commands/mcp.js`:

**`RELEVANCE_INDICATORS`** — Static mapping from server type to project file indicators that signal relevance:

```javascript
const RELEVANCE_INDICATORS = {
  postgres: {
    files: ['prisma/schema.prisma', 'migrations/', 'db/', 'ecto/', 'schema.sql', 'knexfile.js', 'drizzle.config.ts'],
    patterns: ['*.sql'],
    description: 'Database schema or migrations detected'
  },
  github: {
    files: ['.github/', '.git/'],
    patterns: [],
    description: 'Git repository detected'
  },
  terraform: {
    files: ['*.tf', 'terraform/', '.terraform/'],
    patterns: ['*.tf'],
    description: 'Terraform configuration files detected'
  },
  docker: {
    files: ['Dockerfile', 'docker-compose.yml', 'docker-compose.yaml', '.dockerignore'],
    patterns: [],
    description: 'Docker configuration detected'
  },
  'brave-search': {
    files: [],
    patterns: [],
    description: 'General-purpose web search (always useful)',
    always_relevant: true
  },
  context7: {
    files: [],
    patterns: [],
    description: 'Documentation lookup (always useful)',
    always_relevant: true
  },
  redis: {
    files: ['redis.conf'],
    patterns: [],
    env_hints: ['REDIS_URL', 'REDIS_HOST'],
    description: 'Redis configuration or environment hints detected'
  },
  rabbitmq: {
    files: ['schemas/', 'rabbitmq.conf'],
    env_hints: ['RABBITMQ_URL', 'AMQP_URL'],
    description: 'Message queue schemas or config detected'
  },
  pulsar: {
    files: [],
    env_hints: ['PULSAR_SERVICE_URL'],
    description: 'Pulsar connection configured'
  },
  consul: {
    files: ['consul.hcl', 'consul/'],
    env_hints: ['CONSUL_HTTP_ADDR'],
    description: 'Consul configuration detected'
  },
  vault: {
    files: ['vault.hcl', 'vault/'],
    env_hints: ['VAULT_ADDR'],
    description: 'Vault configuration detected'
  },
  sqlite: {
    files: ['*.sqlite', '*.db', 'better-sqlite3'],
    patterns: ['*.sqlite'],
    description: 'SQLite database files detected'
  },
  puppeteer: {
    files: ['puppeteer.config.js', '.puppeteerrc'],
    patterns: [],
    description: 'Puppeteer/browser automation config detected'
  },
  slack: {
    files: ['slack.json', '.slack/'],
    env_hints: ['SLACK_BOT_TOKEN', 'SLACK_WEBHOOK_URL'],
    description: 'Slack integration detected'
  },
  filesystem: {
    files: [],
    patterns: [],
    description: 'Filesystem access (always useful for coding)',
    always_relevant: true
  },
  podman: {
    files: ['Containerfile', 'Dockerfile', 'podman-compose.yml'],
    patterns: [],
    description: 'Container configuration detected'
  }
};
```

**`scoreServerRelevance(server, cwd)`** — Scores a server's relevance to the current project:

1. Match server name/command against RELEVANCE_INDICATORS keys (fuzzy: "my-postgres" matches "postgres")
2. If indicator has `always_relevant: true` → return `{ score: "relevant", reason: indicator.description }`
3. If server token estimate < 1000 → return `{ score: "relevant", reason: "Low cost (<1K tokens) — not worth disabling" }`
4. Check each indicator file/pattern against project filesystem using `fs.existsSync(path.join(cwd, file))`:
   - If any indicator file exists → `{ score: "relevant", reason: indicator.description }`
   - If no indicators found and server has env_hints → check `.env`, `docker-compose.yml` for env vars → `{ score: "possibly-relevant", reason: "Environment hints found but no project files" }`
   - If no indicators match → `{ score: "not-relevant", reason: "No project files matching this server type" }`
5. If server not in RELEVANCE_INDICATORS → `{ score: "possibly-relevant", reason: "Unknown server — manual review recommended" }`

**`generateRecommendations(servers, cwd)`** — For each server with relevance score:
- `relevant` → recommendation: `"keep"`, reasoning: `indicator.description`
- `possibly-relevant` → recommendation: `"review"`, reasoning: `"Check if this server is needed for your workflow"`
- `not-relevant` → recommendation: `"disable"`, reasoning: `"No matching project files found — saves ${tokens} tokens (${percent}%)"`

Calculate `total_potential_savings` — sum of token estimates for all "disable" recommendations.

**Update `cmdMcpProfile`** to call scoring and recommendation after discovery:
- Enrich each server object with: `relevance` (relevant/possibly-relevant/not-relevant), `recommendation` (keep/disable/review), `recommendation_reason`
- Add to result: `total_potential_savings`, `potential_savings_percent`, `recommendations_summary: { keep: N, disable: N, review: N }`

Build with `npm run build`.
  </action>
  <verify>
Run `npm run build` — bundle under 500KB.
Run `node bin/gsd-tools.cjs mcp-profile --raw` from event-pipeline — servers should have relevance scores and recommendations.
Verify: postgres should be "relevant" (migrations/ exist in event-pipeline), brave-search should be "relevant" (always_relevant).
  </verify>
  <done>
Each server has a relevance score (relevant/possibly-relevant/not-relevant) and recommendation (keep/disable/review) with reasoning. Total potential savings calculated. Low-cost servers marked relevant.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add tests for relevance scoring and recommendations</name>
  <files>bin/gsd-tools.test.cjs</files>
  <action>
Add to the existing `describe('mcp-profile')` test suite:

1. **Scores relevant server with matching files** — Create temp dir with `.mcp.json` containing "postgres" server AND `prisma/schema.prisma` file. Verify relevance is "relevant" and recommendation is "keep".

2. **Scores not-relevant server without matching files** — Create temp dir with `.mcp.json` containing "terraform" server but NO `.tf` files. Verify relevance is "not-relevant" and recommendation is "disable".

3. **Always-relevant servers** — Create temp dir with `opencode.json` containing "brave-search". Verify relevance is "relevant" regardless of project files, with `always_relevant` reasoning.

4. **Low-cost server marked relevant** — Create temp dir with `.mcp.json` containing a server that matches a known server with < 1K token estimate (e.g., context7 at ~1500 — adjust threshold test or use a mock). Verify low-cost servers get "relevant" score.

5. **Unknown server gets possibly-relevant** — Create temp dir with `.mcp.json` containing "my-custom-tool" (not in known DB). Verify relevance is "possibly-relevant" and recommendation is "review".

6. **Recommendations summary correct** — Create temp dir with mixed servers (1 relevant, 1 not-relevant, 1 unknown). Verify `recommendations_summary` counts are correct.

7. **Total potential savings calculation** — Create temp dir with servers where some are "disable". Verify `total_potential_savings` equals sum of disabled servers' token estimates and `potential_savings_percent` is correct.

8. **Env hint detection for possibly-relevant** — Create temp dir with `.mcp.json` containing "redis" server AND a `.env` file containing `REDIS_URL=...`. Verify score is "possibly-relevant" or "relevant" (depending on exact indicator matching).

Run `npm test` — all tests pass.
  </action>
  <verify>
Run `npm test` — all tests pass (existing + new).
Verify no regressions in test count.
  </verify>
  <done>
8+ test cases for relevance scoring covering relevant/not-relevant/always-relevant/unknown servers, recommendation generation, savings calculation, and env hint detection. All tests pass.
  </done>
</task>

</tasks>

<verification>
- `npm run build` passes, bundle under 500KB
- `npm test` passes with all existing + new tests
- `node bin/gsd-tools.cjs mcp-profile --raw` from event-pipeline includes relevance and recommendations for all servers
- Postgres scores "relevant" (has migrations/), terraform scores correctly based on project
- Total potential savings is sum of "disable" servers only
- Recommendations summary counts match server scoring
</verification>

<success_criteria>
- MCP-03: Each server scored as relevant/possibly-relevant/not-relevant based on project file indicators
- MCP-04: Each server recommended as keep/disable/review with reasoning and total potential savings
- All tests pass, bundle under 500KB, no regressions
</success_criteria>

<output>
After completion, create `.planning/phases/19-mcp-server-profiling/19-02-SUMMARY.md`
</output>
