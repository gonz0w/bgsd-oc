---
phase: 19-mcp-server-profiling
plan: 03
type: execute
wave: 3
depends_on: [19-02]
files_modified:
  - src/commands/mcp.js
  - src/router.js
  - src/lib/constants.js
  - bin/gsd-tools.cjs
  - bin/gsd-tools.test.cjs
autonomous: true
requirements: [MCP-05]

must_haves:
  truths:
    - "mcp-profile --apply disables recommended servers in opencode.json"
    - "Backup created before any config modification"
    - "mcp-profile --restore undoes changes from backup"
    - "Only 'disable' recommendations are applied (not 'review')"
  artifacts:
    - path: "src/commands/mcp.js"
      provides: "Config mutation with backup/restore"
      exports: ["applyRecommendations", "restoreBackup"]
    - path: "bin/gsd-tools.test.cjs"
      provides: "Apply/restore tests"
      contains: "apply.*restore"
  key_links:
    - from: "src/commands/mcp.js (applyRecommendations)"
      to: "opencode.json"
      via: "fs.writeFileSync after backup"
      pattern: "writeFileSync.*opencode"
    - from: "src/commands/mcp.js (restoreBackup)"
      to: "opencode.json.bak"
      via: "fs.copyFileSync to restore"
      pattern: "copyFileSync.*\\.bak"
    - from: "src/commands/mcp.js (cmdMcpProfile)"
      to: "applyRecommendations"
      via: "--apply flag check"
      pattern: "args.*apply"
---

<objective>
Add the ability to auto-disable wasteful MCP servers and restore from backup.

Purpose: After seeing which servers are irrelevant and how many tokens they waste (Plans 01-02), users need a one-command way to disable them. This plan adds `--apply` to execute disable recommendations and `--restore` to undo changes, both with safety measures (backup before mutation).

Output: `mcp-profile --apply` that disables recommended servers in `opencode.json` with backup, and `--restore` to undo.
</objective>

<execution_context>
@/home/cam/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/cam/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/19-mcp-server-profiling/19-01-SUMMARY.md
@.planning/phases/19-mcp-server-profiling/19-02-SUMMARY.md

Builds on Plan 01's discovery and Plan 02's recommendations. Only modifies `opencode.json` (OpenCode format supports `enabled: false`). Does NOT modify `.mcp.json` (standard MCP format — no standard disable field).

OpenCode config structure: `{ mcp: { "server-name": { type: "local", command: [...], enabled: false } } }`
Setting `enabled: false` on a server disables it without removing the config.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement apply and restore functionality</name>
  <files>src/commands/mcp.js, src/router.js, src/lib/constants.js, bin/gsd-tools.cjs</files>
  <action>
Add to `src/commands/mcp.js`:

**`applyRecommendations(cwd, servers)`** — Disables recommended servers in `opencode.json`:

1. Read project-level `opencode.json` (path.join(cwd, 'opencode.json'))
2. If doesn't exist → return `{ applied: false, reason: "No opencode.json found — only OpenCode configs support disable" }`
3. Create backup: copy `opencode.json` → `opencode.json.bak` (overwrite existing backup)
4. For each server with recommendation "disable" that came from opencode.json:
   - Set `config.mcp[serverName].enabled = false` in the parsed JSON
5. Write modified JSON back to `opencode.json` with 2-space indent formatting
6. Return `{ applied: true, backup_path: "opencode.json.bak", disabled_count: N, disabled_servers: [...], tokens_saved: N }`

Important: Only modify servers that came from `opencode.json` source (not `.mcp.json` servers). If a server is only in `.mcp.json`, skip it and note in output.

**`restoreBackup(cwd)`** — Restores `opencode.json` from backup:

1. Check `opencode.json.bak` exists at `path.join(cwd, 'opencode.json.bak')`
2. If not → return `{ restored: false, reason: "No backup found (opencode.json.bak)" }`
3. Copy `opencode.json.bak` → `opencode.json` (overwrite)
4. Delete `opencode.json.bak`
5. Return `{ restored: true, message: "Restored opencode.json from backup" }`

**Update `cmdMcpProfile`** to handle flags:
- `--apply` → Run discovery + scoring + `applyRecommendations()`. Output result with applied changes.
- `--restore` → Run `restoreBackup()` only (no discovery needed). Output result.
- `--dry-run` (with `--apply`) → Show what would be disabled without actually modifying files. Default behavior when `--apply` is not passed is already a dry-run report.

Update router: Ensure `--apply` and `--restore` flags are passed through to `cmdMcpProfile`.

Add COMMAND_HELP updates in `src/lib/constants.js` for `mcp-profile --apply` and `mcp-profile --restore`.

Build with `npm run build`.
  </action>
  <verify>
Run `npm run build` — bundle under 500KB.
Test manually: Create temp opencode.json with MCP servers. Run `mcp-profile --apply` — verify backup created and servers disabled. Run `mcp-profile --restore` — verify original restored.
  </verify>
  <done>
`--apply` creates backup and sets `enabled: false` on recommended disable servers in opencode.json. `--restore` copies backup back. Only opencode.json is modified (not .mcp.json). Build passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add tests for apply and restore operations</name>
  <files>bin/gsd-tools.test.cjs</files>
  <action>
Add to the existing `describe('mcp-profile')` test suite:

1. **Apply creates backup** — Create temp dir with `opencode.json` containing 2 servers (1 will be "disable" recommendation — e.g., terraform with no .tf files). Run `mcp-profile --apply`. Verify `opencode.json.bak` exists and matches original content.

2. **Apply disables recommended servers** — After apply from test 1, read `opencode.json`. Verify the disabled server has `enabled: false`. Verify the kept server does NOT have `enabled: false`.

3. **Apply only modifies opencode.json servers** — Create temp dir with both `.mcp.json` (postgres) and `opencode.json` (terraform, no .tf). Run `mcp-profile --apply`. Verify `.mcp.json` is unchanged (not modified).

4. **Apply returns correct summary** — Verify `applied: true`, `disabled_count` matches number of disable recommendations, `disabled_servers` array contains correct names, `tokens_saved` is correct.

5. **Apply with no opencode.json** — Create temp dir with only `.mcp.json`. Run `mcp-profile --apply`. Verify `applied: false` with reason about missing opencode.json.

6. **Restore from backup** — After a previous apply, run `mcp-profile --restore`. Verify `opencode.json` matches original content. Verify `opencode.json.bak` is removed.

7. **Restore without backup** — Create temp dir with `opencode.json` but no `.bak`. Run `mcp-profile --restore`. Verify `restored: false` with appropriate reason.

8. **Apply preserves non-MCP config** — Create temp dir with `opencode.json` containing both `mcp` section and other sections (`$schema`, `permission`, `plugin`). Run `mcp-profile --apply`. Verify all non-MCP sections are preserved exactly.

9. **Idempotent apply** — Run `mcp-profile --apply` twice. Verify second run doesn't corrupt config (backup is from current state, disabled servers remain disabled).

Run `npm test` — all tests pass.
  </action>
  <verify>
Run `npm test` — all tests pass (existing + new).
Verify no regressions in test count.
  </verify>
  <done>
9+ test cases covering backup creation, server disabling, restore, edge cases (no config, no backup, idempotent), and config preservation. All tests pass, no regressions.
  </done>
</task>

</tasks>

<verification>
- `npm run build` passes, bundle under 500KB
- `npm test` passes with all existing + new tests
- `mcp-profile --apply` creates backup and disables servers in opencode.json
- `mcp-profile --restore` restores from backup and cleans up .bak file
- Non-MCP sections in opencode.json preserved after apply
- `.mcp.json` never modified by apply
- Idempotent: running apply twice doesn't corrupt
</verification>

<success_criteria>
- MCP-05: `--apply` disables recommended servers with backup, `--restore` undoes the change
- Only opencode.json is mutated (not .mcp.json)
- Backup always created before modification
- All tests pass, bundle under 500KB, no regressions
</success_criteria>

<output>
After completion, create `.planning/phases/19-mcp-server-profiling/19-03-SUMMARY.md`
</output>
