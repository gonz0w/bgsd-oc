---
phase: 22-workflow-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bin/gsd-tools.cjs
  - bin/gsd-tools.test.cjs
  - workflows/complete-and-clear.md
autonomous: true
requirements:
  - WFLW-01
must_haves:
  truths:
    - "User runs /gsd-complete-and-clear and sees what was completed this session (plans, phases, decisions)"
    - "User sees the suggested next command to run based on project state"
    - "STATE.md session continuity is updated with accurate stopped-at and timestamp"
    - "Running the workflow leaves STATE.md in a clean state ready for the next session"
  artifacts:
    - path: "bin/gsd-tools.cjs"
      provides: "session-summary CLI command"
      contains: "cmdSessionSummary"
    - path: "workflows/complete-and-clear.md"
      provides: "Complete-and-clear workflow prompt"
      contains: "session-summary"
    - path: "bin/gsd-tools.test.cjs"
      provides: "Tests for session-summary command"
      contains: "session-summary"
  key_links:
    - from: "workflows/complete-and-clear.md"
      to: "bin/gsd-tools.cjs"
      via: "node gsd-tools.cjs session-summary --raw"
      pattern: "session-summary"
    - from: "workflows/complete-and-clear.md"
      to: "bin/gsd-tools.cjs"
      via: "node gsd-tools.cjs state record-session"
      pattern: "record-session"
    - from: "bin/gsd-tools.cjs cmdSessionSummary"
      to: ".planning/STATE.md"
      via: "fs.readFileSync + parse position, decisions, session-diff"
      pattern: "cmdStateLoad|session-diff"
---

<objective>
Implement the `/gsd-complete-and-clear` workflow — a session-ending command that summarizes what was accomplished, suggests the next command, and updates STATE.md session continuity for clean handoff.

Purpose: Clean session endings eliminate stale context. The next session picks up immediately without confusion about what happened previously.
Output: `session-summary` CLI command + `complete-and-clear.md` workflow + tests
</objective>

<execution_context>
@/home/cam/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/cam/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add session-summary CLI command to gsd-tools.cjs</name>
  <files>bin/gsd-tools.cjs, bin/gsd-tools.test.cjs</files>
  <action>
Add a `cmdSessionSummary(cwd, raw)` function and wire it into the CLI router as `session-summary`.

The command reads STATE.md and computes a session summary JSON:

```json
{
  "current_position": {
    "phase": "21 of 22",
    "phase_name": "Worktree Parallelism",
    "plan": "03",
    "status": "Executing"
  },
  "session_activity": {
    "plans_completed": ["21-02", "21-03"],
    "decisions_made": ["Lockfile auto-resolution uses checkout --theirs"],
    "blockers_resolved": [],
    "last_activity": "2026-02-25"
  },
  "next_action": {
    "command": "/gsd-execute-phase 22",
    "description": "Execute Phase 22: Workflow Polish"
  },
  "session_continuity": {
    "stopped_at": "Completed 21-03-PLAN.md (worktree workflow integration)",
    "resume_file": "None"
  }
}
```

**Implementation approach:**

1. Reuse `cmdStateLoad` to parse STATE.md for current position (phase, plan, status).
2. Reuse `cmdSessionDiff` logic (or call it internally) to get commits since last session — extract plan completions from commit messages matching `feat(XX-NN):` or summary file creation patterns.
3. Parse decisions from STATE.md "Accumulated Context > Decisions" section — extract the last few decisions (limit to 5 most recent).
4. Determine `next_action` by examining roadmap state:
   - If current phase has incomplete plans → suggest `/gsd-execute-phase {phase}`
   - If current phase complete but next phase unplanned → suggest `/gsd-plan-phase {next}`
   - If current phase complete and next phase planned → suggest `/gsd-execute-phase {next}`
   - If all phases complete → suggest `/gsd-complete-milestone`
   Use `cmdRoadmapAnalyze` or parse ROADMAP.md directly to determine phase completion status.
5. Build `stopped_at` string from current position + latest activity description.

**CLI registration:**
- Add to help text at the top of the file (the help/usage string block around line 80-90): `session-summary           Generate session handoff summary`
- Add to the command router switch statement (around line 12868+): `case "session-summary": cmdSessionSummary(cwd, raw); break;`
- Add to the error message command list string (around line 12868).

**Tests (in gsd-tools.test.cjs):**
Add a `describe('session-summary command')` block with at least 3 tests:
1. Returns valid JSON with all required fields when STATE.md exists
2. Returns error JSON when STATE.md is missing
3. Correctly identifies next action based on phase completion state (mock a completed phase in ROADMAP.md, verify it suggests the next phase)

Follow existing test patterns: create temp dir, write mock STATE.md + ROADMAP.md, call `runGsdTools('session-summary', tmpDir)`, assert JSON output structure.

**Bundle size:** This adds ~80-100 lines to gsd-tools.cjs. Well within the 550KB budget.

**Patterns to follow:**
- Use `safeReadFile()` for reading STATE.md/ROADMAP.md (existing helper)
- Use `output(data, raw)` for JSON output (existing helper)
- Use `stateReplaceField()` pattern from `cmdStateRecordSession` if needed
- Use `debugLog()` for error paths
  </action>
  <verify>
Run `node bin/gsd-tools.cjs session-summary --raw` from the project root — should return JSON with `current_position`, `session_activity`, `next_action`, `session_continuity` fields.

Run `npm test` — all existing tests pass plus new session-summary tests pass.

Check bundle size: `wc -c bin/gsd-tools.cjs` stays under 550KB (currently ~525KB).
  </verify>
  <done>
`session-summary` CLI command returns structured JSON summarizing session state. Tests pass. No regressions in existing test suite. Bundle under 550KB.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create complete-and-clear workflow + update STATE.md session handling</name>
  <files>workflows/complete-and-clear.md</files>
  <action>
Create `workflows/complete-and-clear.md` — the workflow prompt for `/gsd-complete-and-clear`.

The workflow:

1. **Initialize**: Call `session-summary --raw` to get session data.
2. **Display summary**: Format the session summary using UI brand patterns:

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
 GSD ► SESSION COMPLETE ✓
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

## What Was Done

- ✓ Completed {plan-01-name}
- ✓ Completed {plan-02-name}
- ✓ {N} decisions recorded

## Current State

Phase: {X} of {Y} — {phase-name}
Progress: ████████░░ 80%

## Decisions Made

- {decision-1}
- {decision-2}
```

3. **Update session continuity**: Call `state record-session --stopped-at "{description}" --resume-file "None"` to stamp STATE.md.
4. **Suggest next action**: Display the Next Up block:

```
───────────────────────────────────────────────────────────────

## ▶ Next Up

**Phase {N}: {Name}** — {goal}

`{next-command}`

<sub>`/clear` first → fresh context window</sub>

───────────────────────────────────────────────────────────────
```

5. **Prompt context reset**: Remind user to `/clear` for fresh context window.

**Workflow structure** — follow existing patterns from `pause-work.md` and `resume-project.md`:

```markdown
<purpose>
End a session cleanly with a summary of what was accomplished and a prompt for the next action.
</purpose>

<required_reading>
Read all files referenced by the invoking prompt's execution_context.
</required_reading>

<process>
<step name="summarize">
  Call session-summary, parse JSON, format display.
</step>

<step name="update_state">
  Call state record-session with stopped-at from summary.
</step>

<step name="suggest_next">
  Display Next Up block with next_action from summary.
  Remind user to /clear.
</step>
</process>

<success_criteria>
- [ ] Session summary displayed with completed work
- [ ] STATE.md session continuity updated
- [ ] Next command suggested with /clear reminder
</success_criteria>
```

**Key design decisions:**
- Use `session-summary` CLI output as the single data source (not re-parsing STATE.md in the workflow)
- Keep the workflow lightweight (~60 lines) — it's a display + state-update workflow, not an orchestration workflow
- Follow ui-brand.md patterns: stage banner, status symbols (✓), Next Up block
- Handle edge case: if `session-summary` returns empty `plans_completed`, show "No plans completed this session" and still display current state
- Handle edge case: if no next action determinable, suggest `/gsd-resume` as fallback
  </action>
  <verify>
Read `workflows/complete-and-clear.md` — verify it has `<purpose>`, `<process>`, `<success_criteria>` sections.
Verify it calls `session-summary --raw` in step 1.
Verify it calls `state record-session` in step 2.
Verify it uses UI brand patterns (stage banner, Next Up block).
Verify the workflow is listed with `ls workflows/complete-and-clear.md`.
  </verify>
  <done>
`workflows/complete-and-clear.md` exists with structured workflow that calls `session-summary`, displays formatted summary with UI brand patterns, updates STATE.md session continuity, and suggests next command with `/clear` reminder.
  </done>
</task>

</tasks>

<verification>
1. `node bin/gsd-tools.cjs session-summary --raw` returns valid JSON with all 4 top-level fields
2. `npm test` passes with zero regressions + new session-summary tests
3. `workflows/complete-and-clear.md` exists and follows workflow structure patterns
4. `wc -c bin/gsd-tools.cjs` confirms bundle under 550KB
5. Manual trace: workflow calls session-summary → gets data → displays summary → calls record-session → suggests next
</verification>

<success_criteria>
- `/gsd-complete-and-clear` has a workflow file that generates session summary, updates STATE.md, and suggests next command
- `session-summary` CLI command provides structured JSON for the workflow to consume
- STATE.md session continuity section is updated with accurate timestamp and stopped-at description
- Tests cover the CLI command with at least 3 cases
- Bundle size stays under 550KB
</success_criteria>

<output>
After completion, create `.planning/phases/22-workflow-polish/22-01-SUMMARY.md`
</output>
