---
phase: 29-workflow-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - workflows/execute-phase.md
autonomous: true
requirements:
  - WKFL-01
  - WKFL-02
outcome_ids:
  - DO-07
  - DO-09

must_haves:
  truths:
    - "Executor agents receive codebase context (imports, dependents, conventions, risk) for files their plan modifies"
    - "Pre-flight convention check runs before wave execution and logs advisory warnings for naming mismatches"
    - "Projects without codebase-intel.json work identically to before (graceful no-op)"
  artifacts:
    - path: "workflows/execute-phase.md"
      provides: "Codebase context injection in executor spawn prompts + pre-flight convention check step"
      contains: "codebase_context"
  key_links:
    - from: "workflows/execute-phase.md"
      to: "gsd-tools.cjs codebase context --files"
      via: "CLI call before executor spawn"
      pattern: "codebase context --files"
    - from: "workflows/execute-phase.md"
      to: "gsd-tools.cjs frontmatter"
      via: "Extract files_modified from plan frontmatter"
      pattern: "frontmatter.*files_modified"
---

<objective>
Add codebase intelligence injection to the execute-phase workflow so executor agents automatically receive architectural context (imports, dependents, conventions, risk levels) for the files they modify, and a pre-flight convention check warns about naming mismatches before execution begins.

Purpose: Agents currently execute plans with no awareness of project conventions or dependency relationships. This causes mistakes from incomplete project understanding (DO-07) and misses convention violations that could be caught pre-execution (DO-09).
Output: Updated `workflows/execute-phase.md` with context injection and convention pre-flight.
</objective>

<execution_context>
@__OPENCODE_CONFIG__/get-shit-done/workflows/execute-plan.md
@__OPENCODE_CONFIG__/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-workflow-integration/29-RESEARCH.md
@workflows/execute-phase.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add codebase context injection to executor spawn prompts</name>
  <files>workflows/execute-phase.md</files>
  <action>
In `workflows/execute-phase.md`, modify both Mode A and Mode B executor spawn sections to inject codebase context:

1. **Before each executor spawn** (in both Mode A worktree and Mode B standard sections), add instructions for the orchestrator to:
   - Extract `files_modified` from the plan's frontmatter using: `node gsd-tools.cjs frontmatter "${PLAN_PATH}" --field files_modified --raw 2>/dev/null`
   - Run `node gsd-tools.cjs codebase context --files ${PLAN_FILES} --plan ${PLAN_PATH} --raw 2>/dev/null`
   - If the command succeeds (non-empty output), include a `<codebase_context>` block in the executor spawn prompt between `<files_to_read>` and `<success_criteria>`

2. **Format the injected block as:**
   ```
   <codebase_context>
   Architectural context for files this plan modifies.
   Use this to understand import relationships, naming conventions, and risk levels.

   {JSON output from codebase context --files}
   </codebase_context>
   ```

3. **Graceful no-op:** If the codebase context command fails (no intel, command error), skip the `<codebase_context>` block entirely — do not add an empty block, do not warn. The executor prompt works exactly as before.

4. **Both modes:** Apply to Mode A (worktree parallel) and Mode B (standard sequential) spawn sections. The injection logic is identical in both.

Do NOT restructure the existing workflow flow. This is an additive change — insert the context injection step and the prompt block, leave everything else untouched.
  </action>
  <verify>
Read the updated `workflows/execute-phase.md` and confirm:
- Both Mode A and Mode B executor spawn sections include codebase context injection instructions
- The `<codebase_context>` block appears between `<files_to_read>` and `<success_criteria>` in both modes
- Instructions include `2>/dev/null` error suppression and success check before injection
- No other sections of the workflow were modified
  </verify>
  <done>Both executor spawn modes inject a `<codebase_context>` block when codebase intel is available, with graceful no-op when it isn't</done>
</task>

<task type="auto">
  <name>Task 2: Add pre-flight convention check step</name>
  <files>workflows/execute-phase.md</files>
  <action>
In `workflows/execute-phase.md`, add a new `preflight_convention_check` step after `preflight_worktree_check` and before `discover_and_group_plans`:

1. **Step definition:**
   ```markdown
   <step name="preflight_convention_check">
   ```

2. **Logic:**
   - Collect all `files_modified` from all incomplete plans in the phase (from the init JSON `plans` array, extract frontmatter for each)
   - Deduplicate the file list
   - Run `node gsd-tools.cjs codebase context --files ${ALL_FILES} --raw 2>/dev/null`
   - Parse the JSON output — for each file, check `conventions.naming.pattern` and `conventions.naming.confidence`
   - Only flag files where confidence > 80% AND the file path's naming style differs from the detected convention pattern
   - If command fails or no conventions found: skip silently (no warning, no error)

3. **Output format (advisory only):**
   ```
   ⚠ Convention advisory:
     {file_path} — project uses {pattern} ({confidence}% confidence) in this directory
   ```

4. **Never block execution.** This is purely informational — log and continue regardless of findings.

5. **Pass convention warnings to executor agents.** Include any warnings in the executor spawn prompt's `<codebase_context>` block (Task 1 handles the block itself, this task adds convention-specific warnings to the orchestrator's pre-flight output so it's visible and can be forwarded).

Place this step between `preflight_worktree_check` and `discover_and_group_plans` in the process flow.
  </action>
  <verify>
Read the updated `workflows/execute-phase.md` and confirm:
- New `preflight_convention_check` step exists between `preflight_worktree_check` and `discover_and_group_plans`
- Step collects files from all incomplete plans
- Step uses `codebase context --files` with `2>/dev/null` error handling
- Output uses `⚠` prefix and includes pattern + confidence
- Step never blocks execution (advisory only)
  </verify>
  <done>Pre-flight convention check step exists in execute-phase workflow, produces advisory warnings for naming mismatches, and never blocks execution</done>
</task>

</tasks>

<verification>
1. Read `workflows/execute-phase.md` — confirm `preflight_convention_check` step exists in correct position
2. Read `workflows/execute-phase.md` — confirm both Mode A and Mode B spawn sections include `<codebase_context>` injection
3. Grep for `codebase context --files` — appears in both the pre-flight step and executor spawn sections
4. Grep for `2>/dev/null` on all codebase commands — graceful error handling present
5. Verify no other workflow files were modified
</verification>

<success_criteria>
- execute-phase.md contains codebase context injection in both executor spawn modes
- execute-phase.md contains pre-flight convention check step
- All codebase commands use `2>/dev/null` for graceful degradation
- No structural changes to existing workflow steps
</success_criteria>

<output>
After completion, create `.planning/phases/29-workflow-integration/29-01-SUMMARY.md`
</output>
