---
phase: 26-init-integration-context-summary
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/commands/init.js
  - src/lib/codebase-intel.js
autonomous: true
requirements: [CTXI-01, INFRA-04]

must_haves:
  truths:
    - "Init output includes codebase_stats, codebase_conventions, codebase_dependencies as three separate fields"
    - "Convention summary shows detected naming patterns with confidence percentages"
    - "Dependency overview shows top-imported modules and graph stats"
    - "Each field includes a confidence score indicating data quality"
    - "Missing data produces null values for individual fields, never crashes"
    - "Total codebase context injection stays under 500 tokens"
  artifacts:
    - path: "src/commands/init.js"
      provides: "Three-field codebase context formatter with confidence scores"
      contains: "formatCodebaseStats|formatCodebaseConventions|formatCodebaseDependencies"
    - path: "src/lib/codebase-intel.js"
      provides: "Enhanced staleness with hybrid time-based detection"
      contains: "time_stale|hour"
  key_links:
    - from: "src/commands/init.js"
      to: "src/commands/codebase.js"
      via: "autoTriggerCodebaseIntel returns full intel object"
      pattern: "autoTriggerCodebaseIntel"
    - from: "src/commands/init.js"
      to: "codebase-intel.json"
      via: "conventions and dependencies keys in intel object"
      pattern: "intel\\.conventions|intel\\.dependencies"
---

<objective>
Expand init command codebase context from a single compact summary to three structured fields — stats, conventions, and dependencies — with confidence scores and hybrid staleness detection.

Purpose: Agents currently only see file counts and languages. With convention and dependency context, agents can make better decisions about naming patterns, module structure, and change impact — directly serving DO-07 (agents receive architectural context scoped to their current task).

Output: Updated `formatCodebaseSummary` producing three-field structure, enhanced staleness detection with time-based fallback.
</objective>

<execution_context>
@__OPENCODE_CONFIG__/get-shit-done/workflows/execute-plan.md
@__OPENCODE_CONFIG__/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/INTENT.md
@.planning/phases/26-init-integration-context-summary/26-CONTEXT.md
@.planning/phases/23-infrastructure-storage/23-02-SUMMARY.md
@.planning/phases/24-convention-extraction/24-01-SUMMARY.md
@.planning/phases/25-dependency-graph/25-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Expand formatCodebaseSummary to three-field structure with confidence scores</name>
  <files>src/commands/init.js</files>
  <action>
Refactor the existing `formatCodebaseSummary(intel)` function in `src/commands/init.js` into a new function `formatCodebaseContext(intel)` that returns an object with three separate fields:

**`codebase_stats`** (existing data, restructured):
```js
{
  total_files: intel.stats.total_files,
  total_lines: intel.stats.total_lines,
  top_languages: "javascript(29), markdown(122)...", // existing format
  git_commit: intel.git_commit_hash,
  generated_at: intel.generated_at,
  confidence: 1.0 // stats are always precise
}
```

**`codebase_conventions`** (from `intel.conventions`, added by Phase 24):
```js
{
  naming: { dominant: "kebab-case", confidence: 0.85, alternatives: ["camelCase"] },
  structure: { type: "nested", test_placement: "co-located", config_placement: "root" },
  framework: intel.conventions?.framework_patterns?.length > 0 
    ? { name: "...", patterns_detected: N } : null,
  confidence: average of naming + structure confidences
}
```
If `intel.conventions` is null/undefined, return `null` for this field.

**`codebase_dependencies`** (from `intel.dependencies`, added by Phase 25):
```js
{
  total_modules: intel.dependencies?.stats?.total_files || 0,
  total_edges: intel.dependencies?.stats?.total_edges || 0,
  top_imported: top 5 most-imported files from reverse adjacency list,
  has_cycles: intel.dependencies?.stats?.cycles > 0,
  confidence: intel.dependencies ? 0.85 : 0  // regex parsing is ~85% accurate
}
```
If `intel.dependencies` is null/undefined, return `null` for this field.

Update ALL init commands that currently use `formatCodebaseSummary`:
- `cmdInitExecutePhase`: Replace `result.codebase_summary = formatCodebaseSummary(...)` with spreading three fields from `formatCodebaseContext(...)`: `result.codebase_stats`, `result.codebase_conventions`, `result.codebase_dependencies`
- `cmdInitPlanPhase`: Same replacement
- `cmdInitPhaseOp`: Same replacement  
- `cmdInitProgress`: Same replacement (keep `codebase_intel_exists` boolean)

For compact mode outputs: include all three fields when non-null. Trim null fields per existing pattern (delete from result if null).

**Critical constraints:**
- Total token budget for all three fields: <500 tokens combined. Keep summaries terse — agent-facing, not human-facing (per CONTEXT.md decision).
- Top imported modules: show relative path + fan-in count, max 5 entries.
- Convention naming: only show dominant pattern + confidence + any strong alternatives (>20% usage).
- All null handling must follow existing try/catch pattern — never crash.
- Remove the old `formatCodebaseSummary` function after migration.

Add a `freshness` field to the top level (not per-section) that flags very stale data:
```js
result.codebase_freshness = isFresh ? null : { stale: true, reason: "24h+ old" or "N commits behind" }
```
Only flag as stale if generated_at is >24 hours old OR intel.git_commit_hash is more than 10 commits behind HEAD. Otherwise set to null (fresh data = no advisory needed, per CONTEXT.md decision on freshness flagging).
  </action>
  <verify>
Run `node bin/gsd-tools.cjs init progress --raw 2>/dev/null | python3 -c "import json,sys; d=json.load(sys.stdin); print('stats:', d.get('codebase_stats','MISSING')); print('conv:', d.get('codebase_conventions','MISSING')); print('deps:', d.get('codebase_dependencies','MISSING'))"` — should show all three fields with data (not MISSING).
Run `node bin/gsd-tools.cjs init plan-phase 26 --raw 2>/dev/null | python3 -c "import json,sys; d=json.load(sys.stdin); cs=d.get('codebase_stats'); print('has_stats:', cs is not None); print('has_confidence:', 'confidence' in (cs or {}))"` — should print True for both.
  </verify>
  <done>All four init commands output codebase_stats, codebase_conventions, codebase_dependencies with confidence scores. Old codebase_summary field replaced. Null fields silently omitted.</done>
</task>

<task type="auto">
  <name>Task 2: Add hybrid staleness detection with time-based fallback</name>
  <files>src/lib/codebase-intel.js</files>
  <action>
Enhance the `checkStaleness(cwd)` function in `src/lib/codebase-intel.js` to add time-based staleness as a secondary signal alongside the existing commit-based check.

**Current behavior:** Only git-commit-based or mtime-based staleness.
**New behavior:** After the git-commit check passes (returns `stale: false`), add a time-based check:

```js
// After existing git-commit check shows fresh...
// Strategy 1.5: Time-based staleness (hybrid — even if git says fresh)
if (intel.generated_at) {
  const ageMs = Date.now() - new Date(intel.generated_at).getTime();
  const ONE_HOUR = 60 * 60 * 1000;
  if (ageMs > ONE_HOUR) {
    return { stale: true, reason: 'time_stale', changed_files: [] };
  }
}
```

This goes AFTER the git-hash check at line ~325 (`return { stale: false }` for matching HEAD), but BEFORE the mtime fallback section. If git says fresh (HEAD matches) but data is >1 hour old, flag as stale with reason `time_stale` and empty changed_files (triggers full re-analysis since we don't know what changed outside git).

**Also add** a helper function `getStalenessAge(intel)` exported from this module:
```js
function getStalenessAge(intel) {
  if (!intel || !intel.generated_at) return null;
  const ageMs = Date.now() - new Date(intel.generated_at).getTime();
  const commitsBehind = ...; // count commits between intel.git_commit_hash and HEAD
  return { age_ms: ageMs, commits_behind: commitsBehind };
}
```
This will be used by `formatCodebaseContext` in init.js for the freshness flagging field.

Export `getStalenessAge` alongside existing exports at bottom of file.
  </action>
  <verify>
Run `node bin/gsd-tools.cjs codebase status --raw 2>/dev/null | python3 -c "import json,sys; d=json.load(sys.stdin); print('stale:', d.get('stale'), 'reason:', d.get('reason','fresh'))"` — should show staleness status.
Verify the function signature is correct: `grep -n "getStalenessAge" src/lib/codebase-intel.js` should show the function definition and export.
  </verify>
  <done>Staleness detection uses hybrid commit+time strategy. Intel older than 1 hour flagged as stale even if git HEAD matches. getStalenessAge exported for freshness flagging in init output.</done>
</task>

</tasks>

<verification>
- `node bin/gsd-tools.cjs init progress --raw` includes three codebase fields (stats, conventions, dependencies)
- `node bin/gsd-tools.cjs init execute-phase 26 --raw` includes three codebase fields
- `node bin/gsd-tools.cjs codebase status --raw` works without error
- All existing tests pass: `npm test` (or `node --test bin/gsd-tools.test.cjs`)
- No `codebase_summary` field remains in any init output (replaced by three fields)
</verification>

<success_criteria>
Init commands output structured codebase context with stats, convention patterns, and dependency overview — each with confidence scores. Total injection under 500 tokens. Hybrid staleness detects time-based drift.
</success_criteria>

<output>
After completion, create `.planning/phases/26-init-integration-context-summary/26-01-SUMMARY.md`
</output>
