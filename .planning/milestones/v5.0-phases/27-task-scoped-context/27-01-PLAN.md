---
phase: 27-task-scoped-context
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/commands/codebase.js
  - src/router.js
  - bin/gsd-tools.cjs
autonomous: true
requirements: [CTXI-02]
intent:
  outcome_ids: [DO-07, SC-06]

must_haves:
  truths:
    - "User can run `codebase context --files <paths>` and get per-file architectural context"
    - "Each file in output shows direct imports (1-hop, max 8) and direct dependents (1-hop, max 8)"
    - "Each file has a risk_level (high/caution/normal) based on fan-in and cycle membership"
    - "Each file shows applicable conventions (naming pattern + framework patterns)"
    - "Files not in intel return a no-data stub instead of crashing"
    - "Output is structured JSON (--raw) or human-readable table (default)"
  artifacts:
    - path: "src/commands/codebase.js"
      provides: "cmdCodebaseContext function with per-file context assembly"
      exports: ["cmdCodebaseContext"]
    - path: "src/router.js"
      provides: "Route for codebase context subcommand"
      contains: "context"
  key_links:
    - from: "src/commands/codebase.js"
      to: "src/lib/deps.js"
      via: "require for buildDependencyGraph, findCycles"
      pattern: "require.*deps"
    - from: "src/commands/codebase.js"
      to: "src/lib/conventions.js"
      via: "require for extractConventions"
      pattern: "require.*conventions"
    - from: "src/router.js"
      to: "src/commands/codebase.js"
      via: "lazyCodebase().cmdCodebaseContext"
      pattern: "cmdCodebaseContext"
---

<objective>
Implement the `codebase context --files <paths>` CLI command that assembles per-file architectural context from cached intel data — 1-hop imports/dependents, convention info, and risk level.

Purpose: Executor agents need task-scoped architectural context to understand what they're modifying. This command reshapes existing Phase 24/25 intel into a per-file view.
Output: Working `codebase context` command producing structured JSON per file.
</objective>

<execution_context>
@__OPENCODE_CONFIG__/get-shit-done/workflows/execute-plan.md
@__OPENCODE_CONFIG__/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-task-scoped-context/27-CONTEXT.md
@.planning/phases/27-task-scoped-context/27-RESEARCH.md
@src/commands/codebase.js
@src/router.js
@src/lib/deps.js
@src/lib/conventions.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement cmdCodebaseContext with per-file context assembly</name>
  <files>src/commands/codebase.js</files>
  <action>
Add `cmdCodebaseContext(cwd, args, raw)` function to `src/commands/codebase.js`, following the exact pattern of `cmdCodebaseImpact` (line 524).

**Argument parsing:**
- Extract file paths: all args that don't start with `--` after the `--files` flag position (if `--files` present), or all non-flag args
- Optional `--plan <path>` flag for plan-scope signal (used in Plan 02 for scoring; parse and store but don't use yet)
- If no file paths provided, call `error('Usage: codebase context --files <file1> [file2] ...')` and return

**Intel loading (follow cmdCodebaseImpact pattern exactly):**
- `readIntel(cwd)` — if null, `error('No codebase intel. Run: codebase analyze')` and return
- Auto-build dependency graph if `intel.dependencies` is null: `buildDependencyGraph(intel)` → persist via `writeIntel`
- Auto-extract conventions if `intel.conventions` is null: `extractConventions(intel, { cwd })` → persist via `writeIntel`
- Get cycle data: `findCycles(graph)` → build `cycleFiles` Set from all SCCs

**Per-file context assembly — for each requested file path:**

1. Check if file exists in graph: if `!graph.forward[file] && !graph.reverse[file]`, return stub: `{ file, status: "no-data", imports: [], dependents: [], conventions: null, risk_level: "normal" }`

2. **Imports (1-hop):** `(graph.forward[file] || [])` — sort by fan-in (most-imported first using `graph.reverse[dep].length`), take top 8

3. **Dependents (1-hop):** `(graph.reverse[file] || [])` — sort by fan-out (most-importing first using `graph.forward[dep].length`), take top 8

4. **Risk level:** `computeRiskLevel(file, graph, cycleFiles)`:
   - `(graph.reverse[file] || []).length > 10` → "high"
   - `cycleFiles.has(file)` → "caution"
   - else → "normal"

5. **Conventions:** `matchFileConventions(file, intel.conventions)`:
   - Get directory of file via `path.dirname(file)`
   - Check `conventions.naming.by_directory[dir]` first, fall back to `conventions.naming.overall`
   - Check `conventions.frameworks` array for patterns matching file extension/path
   - Return object `{ naming: { pattern, confidence }, frameworks: [...matching] }` or null if no conventions data

**Output shape (JSON object):**
```json
{
  "success": true,
  "files": {
    "src/foo.js": {
      "imports": ["src/bar.js", ...],
      "dependents": ["src/baz.js", ...],
      "conventions": { "naming": {...}, "frameworks": [...] },
      "risk_level": "normal"
    }
  },
  "file_count": N,
  "truncated": false
}
```

For non-raw output, format as a human-readable table showing: file path | risk | import count | dependent count | naming convention.

**Add to module.exports:** `cmdCodebaseContext`

**Helper functions to create (internal to codebase.js):**
- `computeRiskLevel(file, graph, cycleFiles)` — returns "high"/"caution"/"normal"
- `matchFileConventions(file, conventions)` — returns conventions object or null
  </action>
  <verify>
Run `node bin/gsd-tools.cjs codebase context --files src/commands/codebase.js --raw` from the project root (after rebuilding bundle). Should return JSON with imports, dependents, conventions, and risk_level for the file. Run with a nonexistent file path to verify no-data stub is returned. Run without --raw to verify table output.
  </verify>
  <done>
`codebase context --files <paths>` returns per-file JSON with imports (max 8, sorted by fan-in), dependents (max 8, sorted by fan-out), conventions (naming + frameworks), and risk_level. Files not in intel return no-data stubs. Both --raw JSON and human-readable table output work.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire router and rebuild bundle</name>
  <files>src/router.js, bin/gsd-tools.cjs</files>
  <action>
**Router (src/router.js):**

In the `case 'codebase':` block (line ~576), add a new `else if` clause before the final `else` error handler:

```javascript
} else if (sub === 'context') {
  lazyCodebase().cmdCodebaseContext(cwd, args.slice(2), raw);
}
```

Update the error message on the fallback `else` to include `context`:
```
'Usage: codebase <analyze|status|conventions|rules|deps|impact|context>'
```

Also update the help text in the usage string at the top of the router (line ~71) if `codebase` subcommands are listed there.

**Bundle rebuild:**
Run `node build.js` to rebuild `bin/gsd-tools.cjs`.

**Verification:**
Test from the project root:
1. `node bin/gsd-tools.cjs codebase context --files src/commands/codebase.js --raw` — should return structured JSON
2. `node bin/gsd-tools.cjs codebase context --files nonexistent.js --raw` — should return no-data stub
3. `node bin/gsd-tools.cjs codebase context` — should show usage error
4. `node bin/gsd-tools.cjs codebase context --files src/commands/codebase.js` — should show human-readable table
  </action>
  <verify>
`node bin/gsd-tools.cjs codebase context --files src/commands/codebase.js --raw 2>/dev/null` returns valid JSON with file context data. `node bin/gsd-tools.cjs codebase context 2>&1` shows usage error. `node bin/gsd-tools.cjs codebase context --files does-not-exist.js --raw 2>/dev/null` returns no-data stub without crashing.
  </verify>
  <done>
`codebase context` is routed correctly, bundle is rebuilt, all three test cases (normal file, missing file, no args) produce correct output.
  </done>
</task>

</tasks>

<verification>
1. `node bin/gsd-tools.cjs codebase context --files src/commands/codebase.js --raw` returns per-file context JSON
2. `node bin/gsd-tools.cjs codebase context --files src/lib/deps.js src/lib/conventions.js --raw` returns context for multiple files
3. `node bin/gsd-tools.cjs codebase context --files nonexistent.js --raw` returns no-data stub without error
4. `node bin/gsd-tools.cjs codebase context` shows usage error
5. JSON output includes imports[], dependents[], conventions{}, risk_level for each file
6. Imports sorted by fan-in, capped at 8; dependents sorted by fan-out, capped at 8
7. Response time <100ms for cached intel
</verification>

<success_criteria>
- `codebase context --files <paths>` returns structured per-file context from cached intel
- Each file shows 1-hop imports, 1-hop dependents, conventions, and risk level
- Files not in intel return graceful no-data stubs
- Both JSON (--raw) and human-readable output modes work
- CTXI-02 requirement fully satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/27-task-scoped-context/27-01-SUMMARY.md`
</output>
