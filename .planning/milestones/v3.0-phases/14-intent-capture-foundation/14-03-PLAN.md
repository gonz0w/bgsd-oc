---
phase: 14-intent-capture-foundation
plan: 03
type: execute
wave: 2
depends_on:
  - 14-01
files_modified:
  - src/commands/intent.js
  - src/commands/init.js
  - src/router.js
  - bin/gsd-tools.test.cjs
autonomous: true
requirements:
  - ICAP-01
  - ICAP-02
  - ICAP-03
  - ICAP-04

must_haves:
  truths:
    - "intent validate checks all sections present, IDs well-formed, no format errors"
    - "intent validate returns exit code 0 for valid, exit code 1 for issues"
    - "intent validate shows lint-style output by default with checkmarks and crosses"
    - "intent validate --raw returns structured JSON with per-section results"
    - "All intent commands have --help support"
    - "Tests cover create, show, read, update, validate round-trips"
  artifacts:
    - path: "src/commands/intent.js"
      provides: "Validate command and --help entries"
      contains: "cmdIntentValidate"
    - path: "bin/gsd-tools.test.cjs"
      provides: "Intent command test suite"
      contains: "describe.*intent"
  key_links:
    - from: "src/commands/intent.js"
      to: "src/lib/helpers.js"
      via: "parseIntentMd for structural validation"
      pattern: "parseIntentMd"
    - from: "bin/gsd-tools.test.cjs"
      to: "bin/gsd-tools.cjs"
      via: "CLI invocation for integration tests"
      pattern: "runGsdTools.*intent"
---

<objective>
Implement `intent validate` for structural validation, add --help support for all intent commands, and create a comprehensive test suite.

Purpose: Validate closes the quality loop — users can check their INTENT.md is well-formed. Tests lock in the contract for all intent commands. --help ensures discoverability.

Output: `cmdIntentValidate()`, --help entries for all intent subcommands, integration test suite.
</objective>

<execution_context>
@__OPENCODE_CONFIG__/get-shit-done/workflows/execute-plan.md
@__OPENCODE_CONFIG__/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/14-intent-capture-foundation/14-CONTEXT.md
@.planning/phases/14-intent-capture-foundation/14-01-SUMMARY.md
@.planning/codebase/CONVENTIONS.md
@.planning/codebase/TESTING.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: intent validate command</name>
  <files>
    src/commands/intent.js
    src/router.js
  </files>
  <action>
**Add `cmdIntentValidate(cwd, args, raw)` to `src/commands/intent.js`:**

1. Read `.planning/INTENT.md`, error if not found
2. Parse with `parseIntentMd(content)`
3. Run structural validation checks:

**Section presence checks:**
- Each of the 6 sections must exist and have content (not just HTML comments)
- Report: `✓ Objective: defined` or `✗ Objective: missing or empty`

**ID format checks (per section):**
- Outcomes: each item matches `DO-\d+ \[P[123]\]:` format
- Criteria: each item matches `SC-\d+:` format
- Constraints: each item matches `C-\d+:` format
- Health quantitative: each item matches `HM-\d+:` format
- Report: `✓ Outcomes: 4 items, IDs valid` or `✗ Outcomes: DO-03 has invalid format`

**ID uniqueness checks:**
- No duplicate IDs within a section
- Report: `✗ Outcomes: duplicate ID DO-02`

**Sub-section checks:**
- Constraints must have at least one of: `### Technical`, `### Business`, `### Timeline`
- Health must have `### Quantitative` and `### Qualitative` sub-sections
- Report: `✓ Constraints: 3 sub-sections` or `✗ Health: missing ### Qualitative`

**Revision check:**
- `**Revision:** N` must be present and be a positive integer
- Report: `✓ Revision: 3` or `✗ Revision: missing or invalid`

**Content minimums:**
- At least 1 desired outcome
- At least 1 success criterion
- Report: `✗ Outcomes: no items defined (minimum 1)`

4. **Human-readable output (default):**
```
INTENT Validation — .planning/INTENT.md

✓ Objective: defined
✓ Target Users: 2 audiences
✓ Outcomes: 4 items, IDs valid
✗ Success Criteria: missing or empty
✓ Constraints: 3 sub-sections (2 technical, 1 business)
✓ Health Metrics: quantitative (3 items), qualitative defined
✓ Revision: 3

Result: 1 issue found
```

5. **JSON output (`--raw`):**
```json
{
  "valid": false,
  "issues": [
    { "section": "criteria", "type": "missing", "message": "Success Criteria: missing or empty" }
  ],
  "sections": {
    "objective": { "valid": true, "message": "defined" },
    "users": { "valid": true, "count": 2 },
    "outcomes": { "valid": true, "count": 4 },
    "criteria": { "valid": false, "count": 0, "issues": ["missing or empty"] },
    "constraints": { "valid": true, "count": 3, "sub_sections": ["technical", "business"] },
    "health": { "valid": true, "quantitative_count": 3, "qualitative": true }
  },
  "revision": 3
}
```

6. **Exit codes:** Exit 0 if valid (no issues), exit 1 if any issues found. Use a special `outputValidation(result, raw)` helper that calls `process.exit(result.valid ? 0 : 1)` after writing output — don't use `error()` since issues are expected output, not errors.

**Router updates:**
- `intent validate` → `cmdIntentValidate(cwd, args, raw)`

Run `npm run build` after implementation.
  </action>
  <verify>
Run `npm run build` — succeeds.
Test with valid INTENT.md: `node bin/gsd-tools.cjs intent validate` → exit code 0, all checkmarks.
Test with INTENT.md missing criteria section: exit code 1, cross on criteria.
Test `--raw`: JSON output with valid/issues structure.
  </verify>
  <done>
`intent validate` checks all sections, ID formats, uniqueness, sub-sections, revision, and content minimums. Lint-style human output by default, JSON with --raw. Exit code 0/1 for CI/hook usage.
  </done>
</task>

<task type="auto">
  <name>Task 2: Help entries and integration tests</name>
  <files>
    src/commands/intent.js
    src/router.js
    bin/gsd-tools.test.cjs
  </files>
  <action>
**--help support:**

Add help entries for all intent subcommands in the router's help dispatch (follow existing pattern — see how other commands like `state`, `verify`, `roadmap` handle `--help`):

```
intent create    Create a new INTENT.md (errors if exists, use --force to overwrite)
intent show      Display intent summary (compact by default, --full for complete, section filter supported)
intent read      Read intent as JSON (alias for intent show --raw, section filter supported)
intent update    Update an intent section (--add, --remove, --set-priority for granular ops)
intent validate  Validate INTENT.md structure (exit 0=valid, 1=issues)
```

Also add `intent` to the top-level help output listing and update the header comment block at the top of `src/commands/intent.js` or `src/router.js` (wherever help is defined).

**Integration tests — add to `bin/gsd-tools.test.cjs`:**

Add `describe('intent commands')` test suite:

1. **Create tests:**
   - `intent create` in fresh .planning/ → creates INTENT.md with all 6 XML sections
   - `intent create` when INTENT.md exists → exits with error
   - `intent create --force` when INTENT.md exists → succeeds
   - Created INTENT.md has `**Revision:** 1`

2. **Show/read tests:**
   - `intent show --raw` returns valid JSON with all section keys
   - `intent read --raw` returns same JSON as `intent show --raw`
   - `intent read outcomes --raw` returns just outcomes array

3. **Update tests:**
   - `intent update outcomes --add 'Test outcome' --priority P1` → adds DO-01, revision increments
   - `intent update outcomes --add 'Another'` → adds DO-02 (default P2)
   - `intent update outcomes --remove DO-01` → removes, keeps DO-02
   - `intent update outcomes --add 'Third'` → assigns DO-03 (not DO-01 — gap preserved)
   - `intent update outcomes --set-priority DO-02 P1` → changes priority
   - `intent update objective --value 'New objective'` → replaces section

4. **Validate tests:**
   - Valid INTENT.md with all sections → exit code 0
   - INTENT.md with missing section → exit code 1, issues array non-empty
   - `intent validate --raw` → returns JSON with valid/issues fields

5. **Round-trip test:**
   - Create → update (add items to each section) → show --raw → validate → all consistent

All tests use temp directories with `fs.mkdtempSync`. Use the `runGsdTools` helper pattern from existing tests. Each test cleans up after itself.

Run `npm test` — all tests pass (existing + new).
  </action>
  <verify>
Run `npm run build` — succeeds.
Run `npm test` — all tests pass, 0 failures.
Run `node bin/gsd-tools.cjs intent --help` — shows subcommand list.
Run `node bin/gsd-tools.cjs intent create --help` — shows create usage.
  </verify>
  <done>
All 5 intent subcommands have --help. 15+ integration tests covering create, show, read, update, validate, and round-trip scenarios. All tests pass alongside existing suite.
  </done>
</task>

</tasks>

<verification>
- `intent validate` correctly identifies valid and invalid INTENT.md files
- Exit codes work (0 for valid, 1 for issues)
- All intent commands show help with --help
- `npm test` passes all tests (existing + new intent tests)
- Round-trip test proves create → update → read → validate consistency
</verification>

<success_criteria>
- `intent validate` catches missing sections, malformed IDs, missing sub-sections
- Lint-style output with ✓/✗ symbols
- JSON output via --raw
- 15+ integration tests passing
- --help works for all subcommands
- `npm test` green with no regressions
</success_criteria>

<output>
After completion, create `.planning/phases/14-intent-capture-foundation/14-03-SUMMARY.md`
</output>
