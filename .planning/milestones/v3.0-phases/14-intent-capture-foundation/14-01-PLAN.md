---
phase: 14-intent-capture-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - templates/intent.md
  - src/lib/helpers.js
  - src/commands/intent.js
  - src/router.js
autonomous: true
requirements:
  - ICAP-01
  - ICAP-02

must_haves:
  truths:
    - "INTENT.md template reference doc exists with structure definition, good/bad examples, and guidelines"
    - "Running intent create in a project with .planning/ produces a valid INTENT.md"
    - "intent create errors if INTENT.md already exists (without --force)"
    - "intent create --force overwrites existing INTENT.md"
    - "Created INTENT.md has all 6 structured sections with XML tags"
    - "Revision number starts at 1 on creation"
  artifacts:
    - path: "templates/intent.md"
      provides: "Reference doc with format definition, examples, guidelines"
      min_lines: 80
    - path: "src/commands/intent.js"
      provides: "Intent command module with create command"
      contains: "cmdIntentCreate"
    - path: "src/lib/helpers.js"
      provides: "parseIntentMd helper function"
      contains: "parseIntentMd"
  key_links:
    - from: "src/commands/intent.js"
      to: "src/lib/helpers.js"
      via: "parseIntentMd import for structured parsing"
      pattern: "parseIntentMd"
    - from: "src/router.js"
      to: "src/commands/intent.js"
      via: "case 'intent' routing"
      pattern: "case.*intent"
---

<objective>
Create the INTENT.md template reference document, intent parser, and `intent create` command.

Purpose: Establish the foundation — template defines the structure, parser enables reading/writing, create command produces the first INTENT.md. Everything in Plans 02-03 depends on these.

Output: `templates/intent.md` reference doc, `parseIntentMd()` parser in helpers, `cmdIntentCreate()` in new intent command module, router wiring.
</objective>

<execution_context>
@__OPENCODE_CONFIG__/get-shit-done/workflows/execute-plan.md
@__OPENCODE_CONFIG__/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/14-intent-capture-foundation/14-CONTEXT.md
@.planning/codebase/CONVENTIONS.md
@.planning/codebase/STRUCTURE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: INTENT.md template reference document</name>
  <files>
    templates/intent.md
  </files>
  <action>
Create `templates/intent.md` as a reference document (NOT a fill-in template — the code generates INTENT.md from internal template, per user decision). Follow the same pattern as `templates/context.md`:

**Structure:**
1. Header explaining what INTENT.md is and its purpose
2. File location: `.planning/INTENT.md` — top-level alongside ROADMAP.md, STATE.md
3. Section ordering (narrative flow): Objective → Target Users → Desired Outcomes → Success Criteria → Constraints → Health Metrics
4. Each section documented with:
   - XML tag name (`<objective>`, `<users>`, `<outcomes>`, `<criteria>`, `<constraints>`, `<health>`)
   - What goes in it
   - Format rules (ID formats: DO-XX, SC-XX, C-XX, HM-XX)
   - 1-2 good examples and 1 bad example
5. ID format reference table:
   - `DO-XX [PX]:` for desired outcomes (P1 Critical, P2 Important, P3 Nice-to-have)
   - `SC-XX:` for success criteria (launch gates)
   - `C-XX:` for constraints (under `### Technical`, `### Business`, `### Timeline` sub-headers)
   - `HM-XX:` for health metrics (under `### Quantitative` sub-header only; `### Qualitative` is prose, no IDs)
6. Revision tracking: `**Revision:** N` at document top, auto-incremented on updates
7. ID gap preservation rule: when items removed, remaining IDs are NOT renumbered
8. Two complete example INTENT.md files: one for a tool/library, one for an application
9. No preamble rule: file jumps straight to `<objective>` — no "how to use" header in actual INTENT.md

Keep the reference doc concise but complete (80-150 lines). Focus on what agents need to know to create and parse INTENT.md correctly.
  </action>
  <verify>
File exists at `templates/intent.md`. Contains all 6 section definitions with XML tag names. Contains ID format table. Contains 2 example INTENT.md files.
  </verify>
  <done>
Reference doc covers all sections, ID formats, revision tracking, gap preservation, and includes 2 complete examples.
  </done>
</task>

<task type="auto">
  <name>Task 2: Intent parser and create command</name>
  <files>
    src/lib/helpers.js
    src/commands/intent.js
    src/router.js
  </files>
  <action>
**Parser — add to `src/lib/helpers.js`:**

Add `parseIntentMd(content)` function that parses an INTENT.md file into structured JSON:

```javascript
function parseIntentMd(content) {
  // Returns:
  // {
  //   revision: number,
  //   created: string|null,
  //   updated: string|null,
  //   objective: { statement: string, elaboration: string },
  //   users: [{ text: string }],
  //   outcomes: [{ id: string, priority: string, text: string }],
  //   criteria: [{ id: string, text: string }],
  //   constraints: { technical: [{id, text}], business: [{id, text}], timeline: [{id, text}] },
  //   health: { quantitative: [{id, text}], qualitative: string }
  // }
}
```

Parsing rules:
- Extract XML-tagged sections using regex: `<tagname>([\s\S]*?)<\/tagname>`
- Parse `**Revision:** N` from document top
- Parse outcomes: lines matching `- DO-\d+ \[P[123]\]: (.+)` → `{id, priority, text}`
- Parse criteria: lines matching `- SC-\d+: (.+)` → `{id, text}`
- Parse constraints: split by `### Technical`, `### Business`, `### Timeline` sub-headers, parse `- C-\d+: (.+)` within each
- Parse health metrics: split by `### Quantitative` and `### Qualitative`, parse `- HM-\d+: (.+)` for quantitative, capture prose for qualitative
- Parse objective: first line = statement, remaining = elaboration
- Parse users: bullet list items
- Return structured JSON with null defaults for missing sections (graceful degradation)

Also add `generateIntentMd(data)` function that takes the same JSON structure and produces a formatted INTENT.md string. This is the internal template — it generates the actual file content with HTML comments as section instructions:
- `<!-- Single statement: what this project does and why -->` under `<objective>`
- `<!-- Brief audience descriptions, one per line -->` under `<users>`
- `<!-- Bullet list: - DO-XX [PX]: description -->` under `<outcomes>`
- `<!-- Bullet list: - SC-XX: launch gate -->` under `<criteria>`
- `<!-- Sub-headers: ### Technical, ### Business, ### Timeline. Items: - C-XX: constraint -->` under `<constraints>`
- `<!-- Sub-headers: ### Quantitative (- HM-XX: metric) and ### Qualitative (prose) -->` under `<health>`

When generating with empty/default data, produce the HTML-comment-only version (no pre-filled example content, per user decision).

Export both functions.

**Command module — create `src/commands/intent.js`:**

Create new command module following existing patterns (see `src/commands/state.js` for style).

`cmdIntentCreate(cwd, args, raw)`:
1. Guard: check `.planning/` exists, error if not
2. Build path: `path.join(cwd, '.planning', 'INTENT.md')`
3. Check existence: if file exists AND no `--force` flag → `error('INTENT.md already exists. Use --force to overwrite.')`
4. Parse CLI flags for each section (for programmatic/testing use):
   - `--objective 'text'`
   - `--users 'user1' 'user2'`
   - `--outcomes 'DO-01 [P1]: desc'`
   - etc.
5. If no flags provided, generate empty template (HTML comments only)
6. If flags provided, populate corresponding sections
7. Set `**Revision:** 1` and `**Created:** {current-timestamp}` and `**Updated:** {current-timestamp}`
8. Write file using `generateIntentMd(data)`
9. Auto-commit if `commit_docs` enabled: `docs(intent): create INTENT.md`
10. Output result: `{ created: true, path: '.planning/INTENT.md', revision: 1, sections: [...] }`

**Router — update `src/router.js`:**

Add `case 'intent':` routing that dispatches to subcommands:
- `intent create` → `cmdIntentCreate(cwd, args, raw)`
- (Other subcommands added in Plans 02-03)

Import `cmdIntentCreate` from `./commands/intent.js`.

**Build and verify:**
Run `npm run build` to produce updated `bin/gsd-tools.cjs`. Test: `node bin/gsd-tools.cjs intent create --help` shows usage.
  </action>
  <verify>
Run `npm run build` — succeeds.
Create a temp directory with `.planning/`, run `node bin/gsd-tools.cjs intent create` — produces `.planning/INTENT.md`.
Verify INTENT.md contains all 6 XML-tagged sections.
Run again without --force — errors with "already exists".
Run with --force — overwrites successfully.
  </verify>
  <done>
`parseIntentMd()` and `generateIntentMd()` in helpers. `cmdIntentCreate()` in intent.js. Router wired. `intent create` produces valid INTENT.md with all sections, respects --force flag, auto-commits.
  </done>
</task>

</tasks>

<verification>
- `templates/intent.md` exists with format definition and examples
- `npm run build` passes
- `node bin/gsd-tools.cjs intent create` in a test project produces valid INTENT.md
- INTENT.md contains all 6 sections: objective, users, outcomes, criteria, constraints, health
- Parser round-trips: `parseIntentMd(generateIntentMd(data))` preserves structure
</verification>

<success_criteria>
- INTENT.md template reference doc covers all sections and ID formats
- `intent create` produces structured INTENT.md with XML-tagged sections
- `intent create` respects --force and errors on existing file
- Parser extracts all sections, IDs, priorities into clean JSON
- Build succeeds, no regressions
</success_criteria>

<output>
After completion, create `.planning/phases/14-intent-capture-foundation/14-01-SUMMARY.md`
</output>
