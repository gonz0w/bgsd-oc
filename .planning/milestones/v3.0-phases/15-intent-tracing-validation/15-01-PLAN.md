---
phase: 15-intent-tracing-validation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/commands/intent.js
  - src/lib/helpers.js
  - src/router.js
  - src/lib/constants.js
  - bin/gsd-tools.cjs
autonomous: true
requirements:
  - ITRC-01
  - ITRC-02
  - ITRC-03

must_haves:
  truths:
    - "PLAN.md frontmatter can include an intent section with outcome_ids tracing to INTENT.md desired outcomes"
    - "Running intent trace produces a traceability matrix mapping desired outcomes to phases/plans"
    - "Running intent trace --gaps shows desired outcomes with no phase or plan addressing them"
    - "intent trace reads all PLAN.md files in current milestone and INTENT.md to build the matrix"
  artifacts:
    - path: "src/commands/intent.js"
      provides: "cmdIntentTrace with traceability matrix and gap detection"
      contains: "cmdIntentTrace"
    - path: "src/lib/helpers.js"
      provides: "parsePlanIntent helper for extracting intent section from PLAN.md"
      contains: "parsePlanIntent"
    - path: "src/router.js"
      provides: "intent trace routing"
      contains: "intent"
  key_links:
    - from: "src/commands/intent.js"
      to: "src/lib/helpers.js"
      via: "parsePlanIntent import for extracting plan intent sections"
      pattern: "parsePlanIntent"
    - from: "src/commands/intent.js"
      to: "src/lib/helpers.js"
      via: "parseIntentMd import for reading INTENT.md outcomes"
      pattern: "parseIntentMd"
    - from: "src/router.js"
      to: "src/commands/intent.js"
      via: "intent trace routing"
      pattern: "cmdIntentTrace"
---

<objective>
Add intent tracing infrastructure: a helper to parse intent sections from PLAN.md files, and an `intent trace` command that builds a traceability matrix showing which desired outcomes map to which plans, with gap detection for uncovered outcomes.

Purpose: This is the foundation for Phase 15 — without tracing, there's nothing to validate. Plans need a way to declare which outcomes they serve, and the system needs to aggregate that into a matrix.

Output: `parsePlanIntent()` helper, `cmdIntentTrace()` command, router wiring, help entries.
</objective>

<execution_context>
@__OPENCODE_CONFIG__/get-shit-done/workflows/execute-plan.md
@__OPENCODE_CONFIG__/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/14-intent-capture-foundation/14-01-SUMMARY.md
@.planning/phases/14-intent-capture-foundation/14-02-SUMMARY.md
@.planning/codebase/CONVENTIONS.md
@.planning/codebase/STRUCTURE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Plan intent parser and intent trace command</name>
  <files>
    src/lib/helpers.js
    src/commands/intent.js
    src/router.js
    src/lib/constants.js
  </files>
  <action>
**Helper — add to `src/lib/helpers.js`:**

Add `parsePlanIntent(content)` function that extracts intent tracing data from a PLAN.md's frontmatter. The intent section in PLAN.md frontmatter will be structured as:

```yaml
intent:
  outcome_ids: [DO-01, DO-03]
  rationale: "Brief explanation of why this plan serves these outcomes"
```

The parser should:
1. Extract the `intent` field from PLAN.md YAML frontmatter (use existing `extractFrontmatter()` from `src/lib/frontmatter.js`)
2. Return `{ outcome_ids: string[], rationale: string }` or `null` if no intent section
3. Handle both array format `[DO-01, DO-03]` and comma-separated string `"DO-01, DO-03"`
4. Validate IDs match `DO-\d+` pattern, filter out invalid ones
5. Return `null` gracefully if frontmatter has no `intent` field

Export `parsePlanIntent`.

**Command — add to `src/commands/intent.js`:**

Add `cmdIntentTrace(cwd, args, raw)` function:

1. Read `.planning/INTENT.md` — parse with `parseIntentMd()` to get all desired outcomes (DO-XX with priority)
2. Find all PLAN.md files in current milestone's phase directories:
   - Use `getMilestoneInfo(cwd)` to get phase range (existing pattern from init.js)
   - Scan `.planning/phases/*/` directories within that range
   - Read each `*-PLAN.md` file, extract frontmatter with `extractFrontmatter()`
   - Extract `intent.outcome_ids` from frontmatter (via `parsePlanIntent()`)
   - Also extract `phase` and `plan` from frontmatter for identification
3. Build traceability matrix:
   - For each desired outcome (DO-XX): list which plans trace to it
   - For each plan: list which outcomes it traces to
   - Calculate coverage: `covered_outcomes / total_outcomes`
4. Detect gaps (ITRC-03):
   - Outcomes with zero plans tracing to them = gaps
   - Include priority in gap report (P1 gaps are more concerning than P3)
5. Handle `--gaps` flag: when present, only output uncovered outcomes (not full matrix)

**JSON output (`--raw`):**
```json
{
  "total_outcomes": 5,
  "covered_outcomes": 3,
  "coverage_percent": 60,
  "matrix": [
    { "outcome_id": "DO-01", "priority": "P1", "text": "...", "plans": ["14-01", "14-02"] },
    { "outcome_id": "DO-02", "priority": "P2", "text": "...", "plans": [] }
  ],
  "gaps": [
    { "outcome_id": "DO-02", "priority": "P2", "text": "..." }
  ],
  "plans": [
    { "plan_id": "14-01", "phase": "14-intent-capture-foundation", "outcome_ids": ["DO-01"] }
  ]
}
```

**Human-readable output (default):**
```
Intent Traceability — .planning/INTENT.md
Coverage: 3/5 outcomes (60%)

  ✓ DO-01 [P1]: Plan every work item → 14-01, 14-02
  ✓ DO-03 [P2]: Track decisions made → 14-03
  ✓ DO-05 [P3]: Ship incrementally → 15-01
  ✗ DO-02 [P1]: Validate quality gates → (no plans)
  ✗ DO-04 [P2]: Reduce context usage → (no plans)

Gaps: 2 outcomes uncovered (1×P1, 1×P2)
```

Sort output by: gaps first (sorted by priority P1→P3), then covered (sorted by priority).

**Router — update `src/router.js`:**

Add `intent trace` subcommand routing to `cmdIntentTrace`.
Import `cmdIntentTrace` from intent.js.

**Help — update `src/lib/constants.js`:**

Add COMMAND_HELP entries:
- `'intent trace'`: Usage, description (traceability matrix), flags (`--gaps`), examples
- Update `'intent'` overview to include `trace` in subcommand list

**Build:** Run `npm run build` to produce updated bundle.
  </action>
  <verify>
Run `npm run build` — succeeds.
Run `npm test` — all existing tests pass (no regressions).
Test in a project that has `.planning/INTENT.md` and PLAN.md files:
- `node bin/gsd-tools.cjs intent trace` — shows traceability matrix
- `node bin/gsd-tools.cjs intent trace --raw` — returns JSON with matrix/gaps/coverage
- `node bin/gsd-tools.cjs intent trace --gaps` — shows only uncovered outcomes
- `node bin/gsd-tools.cjs intent trace --help` — shows usage
  </verify>
  <done>
`parsePlanIntent()` in helpers extracts intent section from PLAN.md frontmatter. `cmdIntentTrace()` builds traceability matrix from INTENT.md outcomes × PLAN.md intent sections. Gap detection flags uncovered outcomes with priority. Router wired, help entries added.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integration tests for intent tracing</name>
  <files>
    bin/gsd-tools.test.cjs
  </files>
  <action>
Add integration tests for the intent trace command to `bin/gsd-tools.test.cjs`, following the existing test patterns (Phase 14 added 19 intent tests as a model).

**Test suite: "intent trace" (6-8 tests):**

1. **trace with no INTENT.md** — errors with "No INTENT.md found"
2. **trace with INTENT.md but no plans** — returns 0 coverage, all outcomes as gaps
3. **trace with INTENT.md + plans tracing to outcomes** — correct matrix with coverage percent
4. **trace --gaps shows only uncovered outcomes** — filters to gaps only
5. **trace with plan missing intent section** — plan appears with empty outcome_ids (not an error)
6. **trace --raw returns valid JSON** — parseable JSON with matrix/gaps/coverage fields
7. **parsePlanIntent handles missing intent** — returns null for PLAN.md without intent frontmatter
8. **parsePlanIntent handles comma-separated IDs** — `"DO-01, DO-03"` parsed correctly

Setup: Create temp directory structure with `.planning/INTENT.md` (using `generateIntentMd()`), a phase directory with PLAN.md files (with and without intent frontmatter). Clean up after tests.

Follow existing test patterns:
- Use `describe()` / `it()` from `node:test`
- Use temp dirs with `fs.mkdtempSync()`
- Use `execSync` to call `node bin/gsd-tools.cjs intent trace --raw` in temp dir
- Parse JSON output, assert fields

Run `npm test` to verify all tests pass (existing 316 + new ~8 = ~324).
  </action>
  <verify>
`npm test` passes with zero failures. New tests appear in output. Test count increased by 6-8.
  </verify>
  <done>
Integration tests cover: trace with/without INTENT.md, matrix correctness, gap detection, --gaps filter, --raw JSON output, parsePlanIntent edge cases. All tests pass.
  </done>
</task>

</tasks>

<verification>
- `npm run build` passes, bundle within 450KB budget
- `npm test` passes with zero failures
- `intent trace` produces correct traceability matrix from INTENT.md × PLAN.md files
- `intent trace --gaps` shows only uncovered outcomes
- `parsePlanIntent()` correctly extracts outcome_ids from PLAN.md frontmatter
- Help entries work: `intent trace --help`
</verification>

<success_criteria>
- PLAN.md frontmatter supports intent.outcome_ids field linking to desired outcomes
- Traceability matrix maps every desired outcome to the plans addressing it
- Uncovered outcomes (gaps) are detected and flagged with priority
- Coverage percentage is calculated correctly
- Integration tests verify all behaviors
</success_criteria>

<output>
After completion, create `.planning/phases/15-intent-tracing-validation/15-01-SUMMARY.md`
</output>
