---
phase: 15-intent-tracing-validation
plan: 02
type: execute
wave: 2
depends_on: ["15-01"]
files_modified:
  - src/commands/intent.js
  - src/router.js
  - src/lib/constants.js
  - src/commands/init.js
  - bin/gsd-tools.cjs
  - bin/gsd-tools.test.cjs
autonomous: true
requirements:
  - IVAL-01
  - IVAL-02
  - IVAL-03
  - IVAL-04
  - IVAL-05

must_haves:
  truths:
    - "Running intent drift detects plan objectives that don't trace to any desired outcome (objective mismatch)"
    - "Running intent drift detects tasks with no intent backing (feature creep)"
    - "Running intent drift detects low-priority work before high-priority outcomes are addressed (priority inversion)"
    - "Running intent drift produces a numeric drift score 0-100 (0=perfect alignment, 100=total drift)"
    - "Intent validation runs as advisory pre-flight in execute-phase init (warns, never blocks)"
  artifacts:
    - path: "src/commands/intent.js"
      provides: "cmdIntentDrift with 4 drift signals and numeric score"
      contains: "cmdIntentDrift"
    - path: "src/commands/init.js"
      provides: "Advisory intent drift in execute-phase init output"
      contains: "intent_drift"
    - path: "src/router.js"
      provides: "intent drift routing"
      contains: "cmdIntentDrift"
  key_links:
    - from: "src/commands/intent.js"
      to: "src/lib/helpers.js"
      via: "parsePlanIntent for reading plan intent sections"
      pattern: "parsePlanIntent"
    - from: "src/commands/init.js"
      to: "src/commands/intent.js"
      via: "drift scoring logic invoked during execute-phase init"
      pattern: "intent_drift|drift_score"
    - from: "src/router.js"
      to: "src/commands/intent.js"
      via: "intent drift routing"
      pattern: "cmdIntentDrift"
---

<objective>
Add intent validation command (`intent drift`) that detects 4 types of misalignment between work and stated intent, produces a numeric drift score, and integrate as advisory pre-flight into execute-phase init.

Purpose: This is the intelligence layer — tracing (Plan 01) tells you what maps where; validation tells you what's WRONG. The drift score gives a single number to assess alignment. Pre-flight integration means agents always see alignment status before executing.

Output: `cmdIntentDrift()` command with 4 drift signals + score, advisory output in `init execute-phase`, router wiring, help entries, integration tests.
</objective>

<execution_context>
@__OPENCODE_CONFIG__/get-shit-done/workflows/execute-plan.md
@__OPENCODE_CONFIG__/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/15-intent-tracing-validation/15-01-SUMMARY.md
@.planning/codebase/CONVENTIONS.md
@.planning/codebase/STRUCTURE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Intent drift command with 4 validation signals and drift score</name>
  <files>
    src/commands/intent.js
    src/router.js
    src/lib/constants.js
  </files>
  <action>
**Command — add to `src/commands/intent.js`:**

Add `cmdIntentDrift(cwd, args, raw)` function that performs 4 types of intent validation and produces a numeric drift score:

**Signal 1: Objective Mismatch (IVAL-01)**
Detect plans whose intent section doesn't trace to ANY desired outcome.
- Read all PLAN.md files in current milestone phases
- For each plan: extract `intent.outcome_ids` via `parsePlanIntent()`
- Plans with NO intent section or EMPTY outcome_ids = objective mismatch
- Output: list of plans with no outcome tracing

**Signal 2: Feature Creep (IVAL-02)**
Detect tasks/plans that claim outcome IDs not present in INTENT.md.
- Compare each plan's `intent.outcome_ids` against INTENT.md's actual desired outcomes
- Any outcome_id in a plan that doesn't exist in INTENT.md = feature creep (inventing requirements)
- Also: plans with intent sections referencing removed/invalid DO-XX IDs
- Output: list of invalid outcome references per plan

**Signal 3: Priority Inversion (IVAL-03)**
Detect when work is being done on low-priority outcomes while high-priority outcomes remain unaddressed.
- From `intent trace` data: get coverage per outcome
- Check if P2/P3 outcomes have plans but P1 outcomes don't = priority inversion
- More specifically: any uncovered P1 outcome while any P2 or P3 outcome is covered = inversion
- Output: list of inversions (uncovered P1 with covered P2/P3 examples)

**Signal 4: Drift Score (IVAL-04)**
Compute numeric 0-100 score measuring alignment:
```
drift_score = weighted_sum(signals) / max_possible * 100

Weights:
- coverage_gap: (uncovered_outcomes / total_outcomes) * 40
  - P1 gaps weighted 3x, P2 gaps weighted 2x, P3 gaps weighted 1x
- objective_mismatch: (untraced_plans / total_plans) * 25
- feature_creep: (invalid_refs / total_refs) * 15
- priority_inversion: (inversion_count > 0 ? 20 : 0)

score = round(coverage_gap + objective_mismatch + feature_creep + priority_inversion)
score = clamp(score, 0, 100)

0 = perfect alignment, 100 = total drift
```

Expose the scoring function as `calculateDriftScore(data)` (not exported, internal to intent.js) so the same logic can be called from init.js without shelling out.

Actually, better: export a `getIntentDriftData(cwd)` function that returns the raw drift data (signals + score) without output formatting. `cmdIntentDrift` calls it and formats. `cmdInitExecutePhase` calls it for advisory display. This avoids shelling out.

**JSON output (`--raw`):**
```json
{
  "drift_score": 35,
  "alignment": "moderate",
  "signals": {
    "coverage_gap": { "score": 20, "details": [...] },
    "objective_mismatch": { "score": 10, "plans": [...] },
    "feature_creep": { "score": 0, "invalid_refs": [] },
    "priority_inversion": { "score": 5, "inversions": [...] }
  },
  "total_outcomes": 5,
  "covered_outcomes": 3,
  "total_plans": 8,
  "traced_plans": 6
}
```

**Alignment labels:**
- 0-15: "excellent" (green if TTY)
- 16-35: "good" (default color)
- 36-60: "moderate" (yellow if TTY)
- 61-100: "poor" (red if TTY)

**Human-readable output (default):**
```
Intent Drift Analysis
Score: 35/100 (moderate)

Coverage Gaps (20 pts):
  ✗ DO-02 [P1]: Validate quality gates — no plans
  ✗ DO-04 [P2]: Reduce context usage — no plans

Objective Mismatch (10 pts):
  ✗ 15-01: no intent section in frontmatter
  ✗ 13-02: no intent section in frontmatter

Feature Creep (0 pts):
  ✓ No invalid outcome references

Priority Inversion (5 pts):
  ⚠ DO-02 [P1] uncovered, but DO-05 [P3] has 2 plans

Summary: 3/5 outcomes covered, 6/8 plans traced
```

**Router — update `src/router.js`:**

Add `intent drift` subcommand routing to `cmdIntentDrift`.
Import `cmdIntentDrift` from intent.js.
Also export `getIntentDriftData` from intent.js for use by init.js.

**Help — update `src/lib/constants.js`:**

Add COMMAND_HELP entry for `'intent drift'`: Usage, description (drift analysis), score interpretation, examples.
Update `'intent'` overview to include `drift` in subcommand list.

**Build:** Run `npm run build`.
  </action>
  <verify>
Run `npm run build` — succeeds, bundle within 450KB budget.
Run `npm test` — all existing tests pass (no regressions).
Test in a project with INTENT.md and PLAN.md files:
- `node bin/gsd-tools.cjs intent drift` — shows drift analysis with score
- `node bin/gsd-tools.cjs intent drift --raw` — returns JSON with signals and score
- `node bin/gsd-tools.cjs intent drift --help` — shows usage
  </verify>
  <done>
`cmdIntentDrift()` detects 4 misalignment signals (coverage gaps, objective mismatch, feature creep, priority inversion), computes weighted drift score 0-100 with alignment labels. `getIntentDriftData()` exported for use by init commands.
  </done>
</task>

<task type="auto">
  <name>Task 2: Advisory pre-flight in execute-phase init</name>
  <files>
    src/commands/init.js
  </files>
  <action>
**Wire intent drift into `cmdInitExecutePhase` in `src/commands/init.js`:**

Add advisory intent drift scoring to the execute-phase init output. This fulfills IVAL-05: "intent validation runs as advisory pre-flight check before plan execution, warning but not blocking."

1. Import `getIntentDriftData` from `../commands/intent.js`
2. In `cmdInitExecutePhase()`, after existing data gathering:
   - Call `getIntentDriftData(cwd)` wrapped in try/catch (advisory = never crash if INTENT.md missing or parse fails)
   - If drift data available, add to output:
     ```json
     "intent_drift": {
       "score": 35,
       "alignment": "moderate",
       "gaps_count": 2,
       "untraced_plans": 2,
       "advisory": "⚠ 2 P1 outcomes uncovered. Consider addressing before new work."
     }
     ```
   - If INTENT.md doesn't exist: `"intent_drift": null` (silent — no intent system yet)
   - If score is 0-15: no advisory message (alignment is excellent)
   - If score is 16-35: advisory = "Intent alignment is good."
   - If score is 36-60: advisory = "⚠ {gaps_count} outcomes uncovered. Review intent trace."
   - If score is 61-100: advisory = "⚠ Significant drift detected (score: {score}). Run `intent drift` for details."
3. CRITICAL: This is advisory-only. Never return error, never block execution, never set exit code > 0 based on drift.
4. In compact mode (`_gsdCompactMode`), include only `score`, `alignment`, and `advisory` (omit signal details).

**Build:** Run `npm run build`.
  </action>
  <verify>
Run `npm run build` — succeeds.
Run `npm test` — all existing tests pass.
Test: `node bin/gsd-tools.cjs init execute-phase 15 --raw` in a project with INTENT.md — output includes `intent_drift` field with score and alignment.
Test: in a project WITHOUT INTENT.md — output has `intent_drift: null` (no crash, no error).
  </verify>
  <done>
`init execute-phase` includes advisory intent drift scoring. Shows alignment status and advisory message. Never blocks execution. Gracefully handles missing INTENT.md.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integration tests for intent drift and pre-flight</name>
  <files>
    bin/gsd-tools.test.cjs
  </files>
  <action>
Add integration tests for intent drift command and pre-flight integration to `bin/gsd-tools.test.cjs`.

**Test suite: "intent drift" (8-10 tests):**

1. **drift with no INTENT.md** — errors with "No INTENT.md found"
2. **drift with INTENT.md but no plans** — score = 100 (all outcomes uncovered), all gaps
3. **drift with perfect alignment** — score = 0 (all outcomes covered, no mismatches)
4. **drift detects objective mismatch** — plan with no intent section flagged
5. **drift detects feature creep** — plan referencing non-existent DO-99 flagged
6. **drift detects priority inversion** — P1 uncovered while P3 covered flagged
7. **drift score within 0-100 range** — various scenarios produce valid scores
8. **drift --raw returns valid JSON** — parseable JSON with signals/score/alignment
9. **drift alignment labels correct** — 0-15 = excellent, 16-35 = good, 36-60 = moderate, 61-100 = poor
10. **pre-flight in init: intent_drift null when no INTENT.md** — `init execute-phase --raw` on project without INTENT.md includes `"intent_drift": null`

Setup: Create temp directory structures with `.planning/INTENT.md` and phase directories containing PLAN.md files with various intent configurations. Use `generateIntentMd()` to create test INTENT.md files. Write test PLAN.md files with frontmatter containing `intent: { outcome_ids: [...] }`.

Follow existing test patterns from Phase 14's intent tests.

Run `npm test` to verify all tests pass (existing ~324 from Plan 01 + new ~10 = ~334).
  </action>
  <verify>
`npm test` passes with zero failures. New tests appear in output. Test count increased by 8-10.
  </verify>
  <done>
Integration tests cover: drift with/without INTENT.md, all 4 signals (mismatch, creep, inversion, gaps), drift score calculation, alignment labels, --raw JSON output, pre-flight advisory integration. All tests pass.
  </done>
</task>

</tasks>

<verification>
- `npm run build` passes, bundle within 450KB budget
- `npm test` passes with zero failures (all new + existing tests)
- `intent drift` detects all 4 types of misalignment
- Drift score accurately reflects alignment state (0-100)
- `init execute-phase` includes advisory intent drift output
- Pre-flight never blocks execution (advisory only)
- Missing INTENT.md handled gracefully throughout
</verification>

<success_criteria>
- 4 drift signals detected: objective mismatch, feature creep, priority inversion, coverage gaps
- Numeric drift score 0-100 with weighted formula
- Advisory pre-flight in execute-phase init output (warns, never blocks)
- Integration tests verify all validation behaviors
- No regressions in existing tests
</success_criteria>

<output>
After completion, create `.planning/phases/15-intent-tracing-validation/15-02-SUMMARY.md`
</output>
