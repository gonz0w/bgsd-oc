---
phase: 17-intent-enhancement
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/helpers.js
  - src/commands/intent.js
  - bin/gsd-tools.cjs
  - bin/gsd-tools.test.cjs
  - templates/intent.md
autonomous: true
requirements: [ICAP-06]
intent:
  outcome_ids: [DO-06]
  rationale: "Intent evolution tracking enables DO-06 â€” changes tracked with reasoning across milestones"

must_haves:
  truths:
    - "INTENT.md includes a <history> section that logs intent changes with reasoning and milestone context"
    - "Running intent update automatically appends an entry to the history section"
    - "Running intent show displays current intent plus a summary of how it has evolved"
    - "Running intent show --raw includes history data in JSON output"
  artifacts:
    - path: "src/lib/helpers.js"
      provides: "parseIntentMd parses <history> section; generateIntentMd writes <history> section"
      contains: "history"
    - path: "src/commands/intent.js"
      provides: "cmdIntentUpdate appends history entries; cmdIntentShow renders evolution summary"
      contains: "history"
    - path: "templates/intent.md"
      provides: "Updated template reference documenting <history> section format"
      contains: "<history>"
  key_links:
    - from: "src/commands/intent.js"
      to: "src/lib/helpers.js"
      via: "parseIntentMd returns history array; generateIntentMd accepts history array"
      pattern: "data\\.history"
    - from: "src/commands/intent.js (cmdIntentUpdate)"
      to: "src/lib/helpers.js (generateIntentMd)"
      via: "Update pushes new history entry before regenerating file"
      pattern: "history\\.push|data\\.history"
---

<objective>
Add intent evolution tracking to INTENT.md â€” a `<history>` section that logs what changed, why, and in which milestone context.

Purpose: Enables ICAP-06 (intent evolution across milestones). When intent changes over time, the reasoning is preserved so future planning decisions can understand why the project's direction shifted.
Output: Extended parser/generator supporting `<history>`, automatic history logging on `intent update`, evolution summary in `intent show`.
</objective>

<execution_context>
@__OPENCODE_CONFIG__/get-shit-done/workflows/execute-plan.md
@__OPENCODE_CONFIG__/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/INTENT.md
@.planning/REQUIREMENTS.md
@src/lib/helpers.js
@src/commands/intent.js
@templates/intent.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend parser, generator, and update command with history tracking</name>
  <files>src/lib/helpers.js, src/commands/intent.js</files>
  <action>
**1. Extend `parseIntentMd()` in `src/lib/helpers.js` to parse a `<history>` section:**

Add after the health parsing block. The `<history>` section contains entries in this format:
```
<history>
### v3.0 â€” 2026-02-25
- **Added** DO-06 [P3]: Intent evolves across milestones with tracked reasoning
  - Reason: Needed to preserve why intent changed for future milestone planning

### v2.0 â€” 2026-02-20
- **Modified** DO-01: Changed from "captures project goals" to "captures why it exists"
  - Reason: "Goals" was too vague; "why it exists" drives better alignment
- **Removed** DO-03: Removed real-time monitoring outcome
  - Reason: CLI tool, not a daemon â€” monitoring doesn't fit the architecture
</history>
```

Parse into an array of milestone entries:
```javascript
history: [
  {
    milestone: 'v3.0',
    date: '2026-02-25',
    changes: [
      { type: 'Added', target: 'DO-06 [P3]', description: 'Intent evolves...', reason: 'Needed to preserve...' }
    ]
  }
]
```

Parsing rules:
- Each `### vX.Y â€” YYYY-MM-DD` starts a new milestone entry
- Each `- **Type** target: description` is a change (types: Added, Modified, Removed)
- Each `  - Reason: text` is the reason for the preceding change
- Return empty array `[]` if no `<history>` section exists (backward compatible)

Add `history` to the return object from `parseIntentMd()`.

**2. Extend `generateIntentMd()` in `src/lib/helpers.js` to write `<history>` section:**

After the `</health>` block, add:
```javascript
// History (optional â€” only written if entries exist)
if (data.history && data.history.length > 0) {
  lines.push('<history>');
  for (const entry of data.history) {
    lines.push(`### ${entry.milestone} â€” ${entry.date}`);
    for (const change of entry.changes) {
      lines.push(`- **${change.type}** ${change.target}: ${change.description}`);
      if (change.reason) {
        lines.push(`  - Reason: ${change.reason}`);
      }
    }
    lines.push('');
  }
  lines.push('</history>');
  lines.push('');
}
```

No `<history>` section is written when history is empty â€” existing INTENT.md files without history remain unchanged.

**3. Extend `cmdIntentUpdate()` in `src/commands/intent.js` to auto-log history:**

Currently `cmdIntentUpdate` modifies a section and regenerates the file. After the section modification but before calling `generateIntentMd`:

a. Detect what changed by comparing old data vs new data for the updated section. Build a diff summary:
   - For array sections (outcomes, criteria, constraints, users, health.quantitative): compare IDs to find added/removed/modified items
   - For string sections (objective, health.qualitative): detect if content changed
   
b. If changes detected, create a history entry. Get the current milestone from ROADMAP.md (parse for ðŸ”µ marker to find active milestone version, fallback to "unknown"). Today's date from `new Date().toISOString().split('T')[0]`.

c. Find or create the milestone entry in `data.history`:
   - If an entry for this milestone+date already exists, append changes to it
   - Otherwise, create a new entry and prepend it (newest first)

d. Auto-generate reason text: `"Updated via intent update {section}"` â€” this is the default. The user can add `--reason "text"` flag to `intent update` to provide a custom reason.

Add `--reason` flag parsing at the top of `cmdIntentUpdate`:
```javascript
const reasonIndex = args.indexOf('--reason');
let reason = null;
if (reasonIndex !== -1) {
  // Collect all args after --reason until next -- flag
  const reasonParts = [];
  for (let i = reasonIndex + 1; i < args.length; i++) {
    if (args[i].startsWith('--')) break;
    reasonParts.push(args[i]);
  }
  reason = reasonParts.join(' ') || null;
  // Remove --reason and its value from args
  args.splice(reasonIndex, reasonParts.length + 1);
}
```

**4. Extend `cmdIntentShow()` in `src/commands/intent.js`:**

a. In `renderCompactSummary()`: After the existing health metrics line, add an evolution summary if history exists:
```javascript
// Evolution summary (if history exists)
if (data.history && data.history.length > 0) {
  const totalChanges = data.history.reduce((sum, e) => sum + e.changes.length, 0);
  const milestones = data.history.map(e => e.milestone).join(', ');
  lines.push(`Evolution: ${totalChanges} changes across ${milestones}`);
}
```

b. In `renderSection()`: Add a `history` case:
```javascript
case 'history':
  lines.push('## Intent Evolution');
  lines.push('');
  if (data.history && data.history.length > 0) {
    for (const entry of data.history) {
      lines.push(`### ${entry.milestone} â€” ${entry.date}`);
      for (const change of entry.changes) {
        lines.push(`- **${change.type}** ${change.target}: ${change.description}`);
        if (change.reason) {
          lines.push(`  - Reason: ${change.reason}`);
        }
      }
      lines.push('');
    }
  } else {
    lines.push('(no history recorded)');
  }
  break;
```

c. Add `'history'` to the `SECTION_ALIASES` array (should be near the top of the file â€” find `const SECTION_ALIASES = [...]` and add `'history'`).

d. In `--raw` JSON output: `data.history` is already included since `parseIntentMd` returns it as part of the data object.

**5. Update `cmdIntentValidate()` to accept (but not require) `<history>` section:**

History is optional â€” `cmdIntentValidate` should NOT fail if `<history>` is missing. If present, validate basic structure:
- Each entry has `milestone` and `date` (date matches YYYY-MM-DD)
- Each change has `type` (Added|Modified|Removed) and `target`

Add as an advisory check (warning, not error) if history has structural issues.
  </action>
  <verify>
Run `npm test` â€” all 340 existing tests pass with zero regressions.

Manual verification:
1. `node bin/gsd-tools.cjs intent show` â€” compact summary includes "Evolution:" line if history exists, omits it if not
2. `node bin/gsd-tools.cjs intent show history` â€” renders history section or "(no history recorded)"
3. `node bin/gsd-tools.cjs intent show --raw` â€” JSON includes `history` array
4. `node bin/gsd-tools.cjs intent update outcomes --value "- DO-07 [P3]: New outcome"` â€” updates file AND appends history entry
5. `node bin/gsd-tools.cjs intent validate` â€” passes on INTENT.md without history, passes on INTENT.md with valid history
6. `wc -c bin/gsd-tools.cjs` â€” within 450KB budget
  </verify>
  <done>
parseIntentMd returns history array, generateIntentMd writes history section, intent update logs changes automatically with milestone context, intent show displays evolution summary, intent validate accepts optional history. All 340+ tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update template reference and add integration tests</name>
  <files>templates/intent.md, bin/gsd-tools.test.cjs</files>
  <action>
**1. Update `templates/intent.md` to document the `<history>` section:**

Add a new row to the Sections table:
```
| `<history>` | Evolution log: what changed, why, which milestone | None (structured entries) |
```

Add a new section detail block:
```markdown
### `<history>` (Optional)
Milestone-grouped entries tracking intent evolution. Written automatically by `intent update`. Newest milestone first.

Entry format:
- `### vX.Y â€” YYYY-MM-DD` starts a milestone block
- `- **Type** target: description` records a change (Type: Added, Modified, Removed)
- `  - Reason: explanation` explains why the change was made

This section is optional â€” older INTENT.md files without history are valid. History appears only after the first `intent update` call.
```

Update the Rules section:
```markdown
5. **History is optional:** INTENT.md files without `<history>` are valid. History is appended automatically by `intent update`.
6. **History is newest-first:** Most recent milestone entries appear at the top.
```

Add a `<history>` section to both examples to show the format in context.

**2. Add integration tests in `bin/gsd-tools.test.cjs`:**

Add a new test suite `intent history` with these tests:

a. **Parse INTENT.md without history** â€” Create INTENT.md without `<history>`, run `intent show --raw`, verify `history` field is `[]` (empty array).

b. **Parse INTENT.md with history** â€” Create INTENT.md with a `<history>` section containing 2 milestone entries with 3 total changes, run `intent show --raw`, verify all entries and changes parsed correctly.

c. **Update auto-logs history** â€” Create INTENT.md, run `intent update outcomes --value "- DO-07 [P3]: New test outcome"`, read INTENT.md, verify `<history>` section was appended with an Added entry.

d. **Update with --reason flag** â€” Run `intent update outcomes --value "- DO-08 [P3]: Another outcome" --reason "Testing reason tracking"`, verify history entry has custom reason.

e. **Show compact includes evolution** â€” Create INTENT.md with history, run `intent show`, verify output contains "Evolution:" line.

f. **Show history section** â€” Run `intent show history`, verify output contains "## Intent Evolution" and milestone headers.

g. **Validate accepts history** â€” Create INTENT.md with valid history, run `intent validate`, verify exit code 0.

h. **Validate works without history** â€” Create INTENT.md without history, run `intent validate`, verify exit code 0.

Follow existing test patterns in the file: use `writeFileSync` to create test INTENT.md, `execSync` to run commands, parse output, assert.
  </action>
  <verify>
Run `npm test` â€” all tests pass including new history tests (expected: 340 + ~8 new = ~348).
Run `node bin/gsd-tools.cjs intent validate` on current project INTENT.md â€” passes (backward compatible).
Verify `wc -c bin/gsd-tools.cjs` within 450KB budget.
  </verify>
  <done>
Template reference documents `<history>` section format and rules. 8 integration tests cover: parsing with/without history, auto-logging on update, --reason flag, compact summary with evolution, section rendering, and validation compatibility. All tests pass, bundle within budget.
  </done>
</task>

</tasks>

<verification>
1. Backward compatibility: Existing INTENT.md files without `<history>` work exactly as before â€” parser returns empty history, generator doesn't write empty section, validate passes, show doesn't mention evolution
2. Forward compatibility: New INTENT.md files get history tracking automatically on first `intent update`
3. Bundle size: `wc -c bin/gsd-tools.cjs` â‰¤ 450KB (currently 447KB, adding ~100 lines â‰ˆ 3-5KB)
4. All tests pass: `npm test` shows 348+ pass, 0 fail
</verification>

<success_criteria>
- INTENT.md supports a `<history>` section with milestone-grouped change entries
- `intent update` automatically logs what changed with type/target/description/reason
- `intent show` displays evolution summary (compact) or full history (section view)
- `intent show --raw` includes history in JSON output
- `intent validate` accepts INTENT.md with or without history
- `--reason` flag allows custom reasoning on intent updates
- All existing tests pass, 8+ new tests added
- Bundle stays within 450KB budget
</success_criteria>

<output>
After completion, create `.planning/phases/17-intent-enhancement/17-01-SUMMARY.md`
</output>
