---
phase: 06-token-measurement-output-infrastructure
plan: 03
type: execute
wave: 2
depends_on: ["06-01"]
files_modified: [src/commands/features.js, src/lib/constants.js, bin/gsd-tools.test.cjs]
autonomous: true
requirements: [MEAS-03]

must_haves:
  truths:
    - "Running `context-budget compare` with no argument compares current state vs the most recent saved baseline"
    - "Running `context-budget compare <path>` compares current state vs the specified baseline file"
    - "Comparison output shows per-workflow: name | before | after | delta | % change, sorted by biggest reduction"
    - "Comparison includes a summary row with total before/after and overall % change"
  artifacts:
    - path: "src/commands/features.js"
      provides: "context-budget compare subcommand"
      contains: "cmdContextBudgetCompare"
    - path: "src/lib/constants.js"
      provides: "COMMAND_HELP entry for context-budget subcommands"
      contains: "context-budget"
  key_links:
    - from: "src/commands/features.js"
      to: ".planning/baselines/"
      via: "compare reads saved baseline JSON and compares against current measurement"
      pattern: "baselines"
---

<objective>
Add `context-budget compare` subcommand that measures current workflow token counts and compares them against a saved baseline, showing per-workflow delta and percentage change.

Purpose: This is the "proof" command â€” after Phase 8 compresses workflows, running `context-budget compare` will show exactly how many tokens were saved per workflow and whether the 30% target was hit. Without this, the only way to verify reduction is manual calculation.

Output: `context-budget compare` subcommand, comparison table output, updated --help text for all context-budget subcommands.
</objective>

<execution_context>
@__OPENCODE_CONFIG__/get-shit-done/workflows/execute-plan.md
@__OPENCODE_CONFIG__/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-token-measurement-output-infrastructure/06-CONTEXT.md
@.planning/phases/06-token-measurement-output-infrastructure/06-01-PLAN.md
@.planning/phases/06-token-measurement-output-infrastructure/06-02-PLAN.md

@src/commands/features.js
@src/lib/constants.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement context-budget compare subcommand</name>
  <files>src/commands/features.js</files>
  <action>
1. Implement `cmdContextBudgetCompare(cwd, baselinePath, raw)` in `src/commands/features.js`:

   **Baseline resolution:**
   - If `baselinePath` is provided and exists, use it
   - If `baselinePath` is not provided, find the most recent `baseline-*.json` file in `.planning/baselines/`
   - If no baseline exists, error with helpful message: "No baseline found. Run `context-budget baseline` first."

   **Current measurement:**
   - Reuse the same measurement logic from `cmdContextBudgetBaseline` (extract it into a shared helper function `measureAllWorkflows(cwd)` if not already done in Plan 02)
   - This measures current token counts for all workflows

   **Comparison logic:**
   - Match workflows by name between baseline and current
   - For each workflow: calculate delta (current - baseline) and percentage change
   - Handle added workflows (in current but not baseline): show as "NEW"
   - Handle removed workflows (in baseline but not current): show as "REMOVED"

   **Output format (JSON):**
   ```json
   {
     "baseline_file": "baseline-2026-02-22T10:30:00Z.json",
     "baseline_date": "2026-02-22T10:30:00Z",
     "current_date": "2026-02-22T15:00:00Z",
     "summary": {
       "before_total": 245000,
       "after_total": 171500,
       "delta": -73500,
       "percent_change": -30.0,
       "workflows_improved": 28,
       "workflows_unchanged": 2,
       "workflows_worsened": 2
     },
     "workflows": [
       {
         "name": "new-project.md",
         "before": 30650,
         "after": 21455,
         "delta": -9195,
         "percent_change": -30.0
       }
     ]
   }
   ```
   Sort workflows by delta ascending (biggest reductions first).

   **Table output (stderr for humans):**
   ```
   ## Context Budget Comparison
   
   Baseline: baseline-2026-02-22T10:30:00Z.json (2026-02-22)
   
   Workflow                     | Before  | After   | Delta   | Change
   -----------------------------|---------|---------|---------|-------
   new-project.md               |  30,650 |  21,455 |  -9,195 | -30.0%
   complete-milestone.md        |  19,900 |  13,930 |  -5,970 | -30.0%
   ...
   -----------------------------|---------|---------|---------|-------
   TOTAL                        | 245,000 | 171,500 | -73,500 | -30.0%
   
   Improved: 28 | Unchanged: 2 | Worsened: 2
   ```

2. **Refactor shared measurement logic:**
   If Plan 02 implemented baseline measurement inline in `cmdContextBudgetBaseline`, extract the core measurement loop into a reusable `measureAllWorkflows(cwd)` function that both `baseline` and `compare` can call. This avoids duplicating the workflow scanning + @-reference parsing + token estimation logic.

3. Add the compare function to module exports and ensure router.js dispatches correctly (the routing was set up in Plan 02).
  </action>
  <verify>
Run:
```
npm run build
```
Test manually (requires a baseline to exist first):
```
node bin/gsd-tools.cjs context-budget baseline --raw 2>/dev/null > /dev/null
node bin/gsd-tools.cjs context-budget compare --raw 2>/dev/null | python3 -c "import json,sys; d=json.load(sys.stdin); print(f'before: {d[\"summary\"][\"before_total\"]}, after: {d[\"summary\"][\"after_total\"]}, delta: {d[\"summary\"][\"delta\"]}')"
```
Since no changes were made between baseline and compare, delta should be 0 or very close to 0.
  </verify>
  <done>context-budget compare implemented, reads baseline JSON, measures current state, outputs per-workflow delta table, sorted by biggest reduction, handles missing baselines gracefully</done>
</task>

<task type="auto">
  <name>Task 2: Update --help text and add tests for compare</name>
  <files>src/lib/constants.js, bin/gsd-tools.test.cjs</files>
  <action>
1. Update `COMMAND_HELP` in `src/lib/constants.js` to include comprehensive help for all context-budget subcommands:
   ```
   'context-budget': `Usage: gsd-tools context-budget <subcommand|path> [options] [--raw]
   
   Measure and compare token consumption across GSD workflows.
   
   Subcommands:
     <path>                    Estimate tokens for a single file (existing behavior)
     baseline                  Measure all workflows, save baseline to .planning/baselines/
     compare [baseline-path]   Compare current vs saved baseline (default: most recent)
   
   Options:
     --fields <fields>         Return only specified JSON fields (comma-separated)
     --raw                     Output raw JSON
   
   Examples:
     gsd-tools context-budget .planning/ROADMAP.md
     gsd-tools context-budget baseline
     gsd-tools context-budget compare
     gsd-tools context-budget compare .planning/baselines/baseline-2026-02-22.json`
   ```

2. Add tests for compare functionality:
   - Test compare with no baseline returns error message
   - Test compare JSON structure has required fields (summary, workflows)
   - Test compare shows zero delta when run immediately after baseline
   - Test compare sorts by delta ascending (biggest reductions first)
   - Test compare handles workflows added/removed between baseline and current

3. Run full test suite.
  </action>
  <verify>
```
npm run build && npm test
```
All tests pass. Verify help text:
```
node bin/gsd-tools.cjs context-budget --help 2>&1
```
Shows the updated help with all subcommands.
  </verify>
  <done>COMMAND_HELP updated with full context-budget documentation, compare tests pass, full test suite green, --help shows correct usage for all subcommands</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds
- [ ] `npm test` passes (all existing + new tests)
- [ ] `context-budget compare` with no baseline gives helpful error
- [ ] `context-budget baseline` followed by `context-budget compare` shows ~0 delta
- [ ] Comparison output is sorted by biggest reduction first
- [ ] `context-budget --help` shows all three subcommands
- [ ] Backward compat: `context-budget <path>` still works
</verification>

<success_criteria>
- All tasks completed with passing tests
- Before/after comparison works with default (most recent) and explicit baseline paths
- Comparison shows per-workflow name | before | after | delta | % change
- Summary row shows total before/after and overall percentage
- No regressions in existing functionality
</success_criteria>

<output>
After completion, create `.planning/phases/06-token-measurement-output-infrastructure/06-03-SUMMARY.md`
</output>
