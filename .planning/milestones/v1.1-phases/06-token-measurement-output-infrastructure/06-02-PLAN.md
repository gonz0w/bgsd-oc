---
phase: 06-token-measurement-output-infrastructure
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified: [src/commands/features.js, src/lib/helpers.js, src/router.js, bin/gsd-tools.test.cjs]
autonomous: true
requirements: [MEAS-02]

must_haves:
  truths:
    - "Running `context-budget baseline` scans all workflow files and reports token counts for each"
    - "Baseline output includes workflow name, token count, referenced file tokens, and total — sorted biggest first"
    - "Baseline results are saved to .planning/baselines/ as timestamped JSON files"
    - "Workflow discovery is dynamic — scans the workflows directory and parses @-references to build a dependency graph"
  artifacts:
    - path: "src/commands/features.js"
      provides: "Enhanced context-budget with baseline subcommand"
      contains: "baseline"
    - path: "src/lib/helpers.js"
      provides: "Workflow reference parsing utilities"
      contains: "extractAtReferences"
  key_links:
    - from: "src/commands/features.js"
      to: "src/lib/helpers.js"
      via: "baseline command uses extractAtReferences to discover workflow dependencies"
      pattern: "extractAtReferences"
    - from: "src/commands/features.js"
      to: "src/lib/context.js"
      via: "baseline uses estimateTokens for each workflow and its references"
      pattern: "estimateTokens"
---

<objective>
Extend the context-budget command with a `baseline` subcommand that measures token consumption for all 32+ workflow invocations, saving results to .planning/baselines/ for later comparison.

Purpose: Without baselines, Phase 8's workflow compression has no "before" measurement to prove the 30% target. This plan creates the measurement infrastructure that captures the full context cost of each workflow — not just the .md file itself, but all @-referenced files it loads.

Output: `context-budget baseline` subcommand, @-reference parser for workflow files, baseline JSON file saved to .planning/baselines/, sorted table output to stderr.
</objective>

<execution_context>
@__OPENCODE_CONFIG__/get-shit-done/workflows/execute-plan.md
@__OPENCODE_CONFIG__/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-token-measurement-output-infrastructure/06-CONTEXT.md
@.planning/phases/06-token-measurement-output-infrastructure/06-01-PLAN.md

@src/commands/features.js
@src/lib/helpers.js
@src/lib/context.js
@src/router.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add extractAtReferences() to helpers.js and baseline subcommand to features.js</name>
  <files>src/lib/helpers.js, src/commands/features.js, src/router.js</files>
  <action>
1. Add `extractAtReferences(content)` to `src/lib/helpers.js`:
   - Parse `@path/to/file` references from markdown content
   - Handle patterns: `@/absolute/path`, `@relative/path`, `@.planning/path`
   - Also extract from `<required_reading>` and `<context>` blocks
   - Return array of resolved file paths (absolute)
   - Skip patterns that are clearly not file refs (e.g., `@mention` in text, email addresses)

   ```javascript
   function extractAtReferences(content) {
     const refs = new Set();
     // Match @-references in various contexts
     // Pattern: @ followed by a path-like string (contains / and ends with file extension or known directory)
     const atPattern = /@((?:\/[\w./-]+|\.[\w./-]+)(?:\.\w+)?)/g;
     let match;
     while ((match = atPattern.exec(content)) !== null) {
       const ref = match[1];
       // Filter out email-like patterns and too-short refs
       if (ref.includes('/') && !ref.includes('@')) {
         refs.add(ref);
       }
     }
     return Array.from(refs);
   }
   ```

2. Update `src/router.js` to support `context-budget baseline` and `context-budget compare` subcommands:
   ```javascript
   case 'context-budget': {
     const subcommand = args[1];
     if (subcommand === 'baseline') {
       cmdContextBudgetBaseline(cwd, raw);
     } else if (subcommand === 'compare') {
       cmdContextBudgetCompare(cwd, args[2], raw);
     } else {
       // Existing behavior: treat args[1] as plan path
       cmdContextBudget(cwd, args[1], raw);
     }
     break;
   }
   ```
   Import the new functions from features.js.

3. Implement `cmdContextBudgetBaseline(cwd, raw)` in `src/commands/features.js`:

   **Workflow discovery:** Scan the GSD plugin's workflows directory dynamically. The plugin install path can be derived from `__dirname` (which resolves to the bundled script's location — the `bin/` directory, so the workflows are at `../workflows/` relative to the binary). Also support a `GSD_PLUGIN_DIR` env var for testing.

   **For each workflow file:**
   a. Read the workflow .md content
   b. Estimate tokens for the workflow itself using `estimateTokens()`
   c. Parse @-references using `extractAtReferences()`
   d. For each referenced file that exists, estimate its tokens
   e. Record: `{ name, workflow_tokens, ref_count, ref_tokens, total_tokens }`

   **Output format:**
   - JSON to stdout (for --raw consumers): array of workflow measurements + metadata
   - Table to stderr (for humans): sorted by total_tokens descending
   ```
   Workflow                     | Tokens  | Refs | Ref Tokens | Total
   -----------------------------|---------|------|------------|-------
   new-project.md               |  12,450 |   8  |    18,200  | 30,650
   complete-milestone.md        |   7,800 |   5  |    12,100  | 19,900
   ...
   ```

   **Baseline file:** Save to `.planning/baselines/baseline-{timestamp}.json` with:
   ```json
   {
     "timestamp": "2026-02-22T10:30:00Z",
     "workflow_count": 32,
     "total_tokens": 245000,
     "workflows": [ ... per-workflow data ... ]
   }
   ```
   Create `.planning/baselines/` directory if it doesn't exist.

4. Export the new functions and add them to the router.

**Key decisions from CONTEXT.md:**
- Table output to terminal, sorted biggest first
- Dynamic workflow discovery (scan directory, no static manifest)
- Baseline saved as timestamped JSON
- Full agent context = workflow file + all referenced files (not just the .md alone)

**Plugin path detection:** Use `path.resolve(__dirname, '..')` to find the plugin root from the bundled binary location. The bundled binary is at `bin/gsd-tools.cjs`, so `..` gives the plugin root, and `../workflows/` gives the workflows directory. Fall back to `GSD_PLUGIN_DIR` env var if set.
  </action>
  <verify>
Run:
```
npm run build && npm test
```
Then manually test baseline:
```
node bin/gsd-tools.cjs context-budget baseline --raw 2>/dev/null | python3 -c "import json,sys; d=json.load(sys.stdin); print(f'workflows: {d[\"workflow_count\"]}, total_tokens: {d[\"total_tokens\"]}')"
```
Should show 32+ workflows with token counts. Check .planning/baselines/ has a new JSON file.
  </verify>
  <done>extractAtReferences() added to helpers.js, context-budget baseline subcommand works, scans all workflow files dynamically, parses @-references, saves timestamped baseline JSON to .planning/baselines/, outputs sorted table to stderr</done>
</task>

<task type="auto">
  <name>Task 2: Add tests for baseline measurement</name>
  <files>bin/gsd-tools.test.cjs</files>
  <action>
1. Add tests for `extractAtReferences()`:
   - Test extracts @/absolute/path references
   - Test extracts @.planning/relative references
   - Test ignores email addresses and non-path @mentions
   - Test deduplicates references
   - Test handles `<context>` blocks

2. Add tests for baseline JSON structure:
   - Test baseline output has required fields (timestamp, workflow_count, total_tokens, workflows)
   - Test each workflow entry has name, workflow_tokens, ref_count, ref_tokens, total_tokens
   - Test workflows are sorted by total_tokens descending
   - Test baseline file is created in .planning/baselines/

3. Add test for backward compatibility:
   - `context-budget .planning/ROADMAP.md` still works (single file mode)
   - `context-budget baseline` works (new subcommand)
   - Both use tokenx-based estimation (not lines*4)

**Note:** The baseline test can use the project's own workflows directory for real data. Since the test runs from the project root, `workflows/` is accessible.
  </action>
  <verify>
```
npm run build && npm test
```
All tests pass, including new extractAtReferences and baseline tests.
  </verify>
  <done>Tests for extractAtReferences, baseline JSON structure, backward compatibility all pass. Full test suite green.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds
- [ ] `npm test` passes (all existing + new tests)
- [ ] `node bin/gsd-tools.cjs context-budget baseline --raw` outputs valid JSON with 32+ workflows
- [ ] `.planning/baselines/baseline-*.json` file is created
- [ ] `node bin/gsd-tools.cjs context-budget .planning/ROADMAP.md --raw` still works (backward compat)
- [ ] Table output shows workflows sorted by total tokens descending
</verification>

<success_criteria>
- All tasks completed with passing tests
- Baseline measurement captures all 32+ workflow files
- Each workflow measurement includes the workflow itself and all @-referenced files
- Baseline saved as timestamped JSON in .planning/baselines/
- Backward compatible with existing context-budget single-file usage
- No regressions
</success_criteria>

<output>
After completion, create `.planning/phases/06-token-measurement-output-infrastructure/06-02-SUMMARY.md`
</output>
