---
phase: 08-workflow-reference-compression
plan: 03
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - templates/research.md
  - templates/research-project/SUMMARY.md
  - templates/research-project/ARCHITECTURE.md
  - templates/research-project/FEATURES.md
  - templates/research-project/PITFALLS.md
  - templates/research-project/STACK.md
autonomous: true
requirements: [WKFL-04]

must_haves:
  truths:
    - "Research output templates support a compact summary tier that agents load by default"
    - "Full detail is available on demand — agents can load specific sections when they need depth"
    - "Research SUMMARY.md template includes a structured compact block for planners"
  artifacts:
    - path: "templates/research.md"
      provides: "Research template with summary/detail tiers"
      contains: "research_compact"
    - path: "templates/research-project/SUMMARY.md"
      provides: "Research project summary with compact tier"
      contains: "compact_summary"
  key_links:
    - from: "templates/research.md"
      to: "workflows/plan-phase.md"
      via: "planner reads research_compact section by default, full sections on demand"
      pattern: "research_compact|compact_summary"
---

<objective>
Add summary/detail tiers to research output templates so agents load compact summaries by default and full detail on demand.

Purpose: Research files can be 200-500+ lines. Planners typically need the summary, recommendations, and pitfalls — not every code example and alternative analysis. By structuring research output with a compact tier, planners can load ~30% of the research file by default, saving significant context. This fulfills WKFL-04.

Output: Updated research templates with compact/detail tiers, section markers for selective loading.
</objective>

<execution_context>
@__OPENCODE_CONFIG__/get-shit-done/workflows/execute-plan.md
@__OPENCODE_CONFIG__/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/08-workflow-reference-compression/08-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add summary/detail tiers to research templates</name>
  <files>templates/research.md, templates/research-project/SUMMARY.md, templates/research-project/ARCHITECTURE.md, templates/research-project/FEATURES.md, templates/research-project/PITFALLS.md, templates/research-project/STACK.md</files>
  <action>
**Modify the research template (`templates/research.md`) to support two tiers:**

**Tier 1 — Compact (default load):**
Add a `<!-- section: compact -->` block near the top of the template, AFTER the frontmatter, containing:
- `<research_compact>` XML tag wrapping:
  - Summary paragraph (2-3 sentences)
  - Primary recommendation (one-liner)
  - Key stack decisions (table: library | purpose | version — no "why" column)
  - Top 3 pitfalls (one-liner each, no "warning signs" or "root cause")
  - User constraints summary (locked decisions only, one-liner each)
- `</research_compact>`

This compact block is what planners load by default. It should be ~40-60 lines, not the full 200-500+ line research file.

**Add template guidance:** Include instructions in the template telling researchers:
```
<!-- The compact section is the DEFAULT view for planners.
     Keep it under 60 lines. Include only what affects planning decisions.
     Full sections below are loaded on-demand via extract-sections. -->
```

**Tier 2 — Full detail (on-demand):**
Add `<!-- section: name -->` markers around each major section of the research template:
- `<!-- section: standard_stack -->` around the Standard Stack section
- `<!-- section: architecture -->` around Architecture Patterns
- `<!-- section: pitfalls -->` around Common Pitfalls (full version)
- `<!-- section: code_examples -->` around Code Examples
- `<!-- section: dont_hand_roll -->` around Don't Hand-Roll
- `<!-- section: sota -->` around State of the Art

These markers enable `extract-sections` (from Plan 01) to load individual sections when a planner or executor needs depth on a specific topic.

**Update the research-project templates (5 files):**

For each template in `templates/research-project/`:
- Add `<!-- section: compact -->` blocks with a condensed version of that template's key findings
- Add section markers around the full-detail content

For `templates/research-project/SUMMARY.md` specifically:
- Add a `<compact_summary>` block that synthesizes all 4 research areas (stack, architecture, features, pitfalls) into ~30 lines
- This is what the orchestrator loads when presenting research results before planning

**CRITICAL:** Do NOT remove any existing template content. Only ADD the compact blocks and section markers. The full-detail content must remain for researchers who populate it.
  </action>
  <verify>
```bash
# Verify compact sections exist in templates
rg 'section: compact' templates/research.md
rg 'research_compact' templates/research.md
rg 'compact_summary' templates/research-project/SUMMARY.md

# Verify section markers in all research-project templates
for f in templates/research-project/*.md; do
  markers=$(rg -c 'section:' "$f" || echo 0)
  echo "$f: $markers section markers"
done

# Verify no content was removed (file sizes should be larger)
wc -l templates/research.md  # Should be > 552 (original)
wc -l templates/research-project/SUMMARY.md  # Should be > original

# Build succeeds
npm run build
```
  </verify>
  <done>
Research template has compact/detail tiers. Compact section is ~40-60 lines with summary, recommendation, key stack, top pitfalls. Full detail sections have markers for selective loading. All 5 research-project templates updated with compact blocks and section markers. No existing content removed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Run before/after baseline comparison for Phase 8 verification</name>
  <files>bin/gsd-tools.test.cjs</files>
  <action>
**Run the final measurement to verify the 30% reduction target.**

**Step 1: Capture post-compression baseline**
```bash
node bin/gsd-tools.cjs context-budget baseline --raw
```

**Step 2: Compare against the pre-Phase-8 baseline**
Find the most recent baseline from BEFORE Phase 8 work:
```bash
ls -1 .planning/baselines/ | head -1
```

Run comparison:
```bash
node bin/gsd-tools.cjs context-budget compare .planning/baselines/<pre-phase-8-baseline>.json --raw
```

**Step 3: Extract top 6 workflow deltas**
From the comparison output, extract the token deltas for:
1. execute-phase.md
2. verify-phase.md
3. new-project.md
4. execute-plan.md
5. verify-work.md
6. complete-milestone.md

Calculate average reduction percentage across these 6.

**Step 4: Record results**
If average >= 30%: Phase 8 success criterion 5 is met.
If average < 30% but >= 25%: Note in SUMMARY.md — close but may need additional compression in remaining workflows.
If average < 25%: Flag as gap — additional compression needed.

**Step 5: Add a test**
Add one test to `bin/gsd-tools.test.cjs`:
- `extract-sections command is registered` — verify the command exists and responds to `--help`

This is a minimal smoke test ensuring Plan 01's command survived the build process. The detailed extract-sections tests are in Plan 01.
  </action>
  <verify>
```bash
# Run full test suite
npm test

# Verify baseline was captured
ls -la .planning/baselines/ | tail -3

# Show the comparison results
node bin/gsd-tools.cjs context-budget compare .planning/baselines/$(ls -1 .planning/baselines/ | head -1) --raw 2>/dev/null | python3 -c "
import json, sys
d = json.load(sys.stdin)
top6 = ['execute-phase.md', 'verify-phase.md', 'new-project.md', 'execute-plan.md', 'verify-work.md', 'complete-milestone.md']
for w in d.get('workflows', []):
    if w.get('name') in top6:
        print(f\"{w['name']}: {w.get('delta_percent', 0):.1f}%\")
"
```
  </verify>
  <done>
Post-compression baseline captured. Before/after comparison shows token reduction across top 6 workflows. Average reduction percentage calculated and recorded. Smoke test for extract-sections command passes.
  </done>
</task>

</tasks>

<verification>
- [ ] Research template has `<research_compact>` block under 60 lines
- [ ] Research template has `<!-- section: name -->` markers on all major sections
- [ ] All 5 research-project templates have compact blocks and section markers
- [ ] Post-compression baseline captured in `.planning/baselines/`
- [ ] Before/after comparison shows reduction across top 6 workflows
- [ ] `npm test` passes
- [ ] `npm run build` succeeds
</verification>

<success_criteria>
- Research template `<research_compact>` section exists and is under 60 lines
- `extract-sections templates/research.md "compact" --raw` returns the compact block
- Before/after comparison shows measurable reduction averaged across top 6 workflows
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/08-workflow-reference-compression/08-03-SUMMARY.md`
</output>
