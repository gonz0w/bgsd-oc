---
phase: 07-init-command-compaction
plan: 03
type: execute
wave: 1
depends_on: ["07-01", "07-02"]
files_modified:
  - src/router.js
  - src/commands/init.js
  - src/lib/constants.js
  - bin/gsd-tools.test.cjs
autonomous: true
requirements: [CLIP-02, CLIP-03]
gap_closure: true

must_haves:
  truths:
    - "--compact (without --manifest) returns field-reduced JSON achieving ≥38% average reduction across all 12 init commands"
    - "--compact --manifest returns field-reduced JSON plus context manifest with file guidance"
    - "Existing workflows using --compact continue to work (manifest just becomes opt-in)"
  artifacts:
    - path: "src/router.js"
      provides: "--manifest global flag parsing"
      contains: "_gsdManifestMode"
    - path: "src/commands/init.js"
      provides: "Conditional manifest inclusion gated on _gsdManifestMode"
      contains: "_gsdManifestMode"
    - path: "src/lib/constants.js"
      provides: "Updated help text documenting --manifest flag"
      contains: "--manifest"
    - path: "bin/gsd-tools.test.cjs"
      provides: "Tests asserting --compact alone meets 38% target, --manifest adds guidance"
  key_links:
    - from: "src/router.js"
      to: "global._gsdManifestMode"
      via: "Flag parsing"
      pattern: "_gsdManifestMode = true"
    - from: "src/commands/init.js"
      to: "global._gsdManifestMode"
      via: "Conditional manifest inclusion"
      pattern: "_gsdManifestMode"
---

<objective>
Split `--compact` manifest overhead into opt-in `--manifest` flag so that `--compact` alone achieves the ≥38% reduction target.

Purpose: Verification found that `_manifest` adds 100-800 bytes per command, causing 8/12 commands to produce LARGER compact output than full output. The field reduction (Plan 01) genuinely works — manifests (Plan 02) are the overhead source. Separating them makes `--compact` meet its size target while preserving manifest guidance as opt-in.

Output: Updated router, init commands, constants, and tests. `--compact` alone drops fields (meets 38% target). `--compact --manifest` adds file guidance (bigger but provides value).
</objective>

<execution_context>
@__OPENCODE_CONFIG__/get-shit-done/workflows/execute-plan.md
@__OPENCODE_CONFIG__/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/07-init-command-compaction/07-VERIFICATION.md
@.planning/phases/07-init-command-compaction/07-01-SUMMARY.md
@.planning/phases/07-init-command-compaction/07-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add --manifest flag and gate manifest inclusion</name>
  <files>src/router.js, src/commands/init.js, src/lib/constants.js</files>
  <action>
**1. src/router.js** — Add `--manifest` global flag parsing after the existing `--compact` block (lines 73-78):

```javascript
// Parse --manifest global flag for context manifest in compact output
const manifestIdx = args.indexOf('--manifest');
if (manifestIdx !== -1) {
  global._gsdManifestMode = true;
  args.splice(manifestIdx, 1);
}
```

**2. src/commands/init.js** — In all 12 compact code paths, wrap the `_manifest` assignment in a conditional check for `global._gsdManifestMode`. The pattern for each function:

BEFORE (current):
```javascript
const compactResult = {
  // ...essential fields...
  _manifest: { files: manifestFiles },
};
```

AFTER:
```javascript
const compactResult = {
  // ...essential fields...
};
if (global._gsdManifestMode) {
  compactResult._manifest = { files: manifestFiles };
}
```

Apply this to all 12 `cmdInit*` functions. The manifest-building code (manifestFiles arrays, dynamic file scanning) stays — it just only gets included in the output when `--manifest` is also passed.

Specific locations in src/commands/init.js (search for `_manifest`):
- `cmdInitExecutePhase` (~line 87): Change inline `_manifest` in object literal to conditional assignment after object creation
- `cmdInitPlanPhase` (~line 196): Already uses `compactResult._manifest = ...` pattern — wrap in `if (global._gsdManifestMode)`
- `cmdInitNewProject` (~line 275): Inline — extract to conditional
- `cmdInitNewMilestone` (~line 325): Inline — extract to conditional
- `cmdInitQuick` (~line 391): Inline — extract to conditional
- `cmdInitResume` (~line 438): Inline — extract to conditional
- `cmdInitVerifyWork` (~line 496): Inline — extract to conditional
- `cmdInitPhaseOp` (~line 608): Already uses `compactResult._manifest = ...` — wrap in conditional
- `cmdInitTodos` (~line 681): Inline — extract to conditional
- `cmdInitMilestoneOp` (~line 760): Inline — extract to conditional
- `cmdInitMapCodebase` (~line 809): Inline — extract to conditional
- `cmdInitProgress` (~line 937): Inline — extract to conditional

Do NOT change the manifest content itself — only gate its inclusion. The existing manifest data is correct and valuable when requested.

**3. src/lib/constants.js** — Update the init command help text (around line 139):

BEFORE:
```
  --compact  Return essential-only fields with context manifest (38-50% smaller)
```

AFTER:
```
  --compact   Return essential-only fields (38-50% smaller)
  --manifest  Include context manifest with --compact (adds file loading guidance)
```

Also update the example line to show both:
```
  gsd-tools init progress --compact --raw
  gsd-tools init progress --compact --manifest --raw
```
  </action>
  <verify>
Run these commands from the gsd-opencode directory and verify:
1. `node bin/gsd-tools.cjs init verify-work 07 --compact --raw 2>/dev/null` — should NOT have `_manifest` key
2. `node bin/gsd-tools.cjs init verify-work 07 --compact --manifest --raw 2>/dev/null` — should HAVE `_manifest` key with files array
3. `node bin/gsd-tools.cjs init progress --compact --raw 2>/dev/null` — should NOT have `_manifest` key
4. `node bin/gsd-tools.cjs init map-codebase --compact --raw 2>/dev/null` — should NOT have `_manifest` key, output should be much smaller than before
5. Build: `npm run build` passes
  </verify>
  <done>All 12 init commands: `--compact` returns fields-only (no manifest), `--compact --manifest` returns fields + manifest. Help text updated.</done>
</task>

<task type="auto">
  <name>Task 2: Update tests for split flag behavior</name>
  <files>bin/gsd-tools.test.cjs</files>
  <action>
Update the compact/manifest test suite in `bin/gsd-tools.test.cjs` to reflect the new split behavior:

**1. Update the test "compact output includes _manifest with files array" (around line 1311):**
- Change from: `init progress --compact --raw` → `init progress --compact --manifest --raw`
- Test name: `'compact --manifest output includes _manifest with files array'`
- This test now verifies that `--manifest` flag triggers manifest inclusion

**2. Update the test "plan-phase manifest includes requirements and state" (around line 1324):**
- Change command from: `init plan-phase 07 --compact --raw` → `init plan-phase 07 --compact --manifest --raw`
- Test name: `'plan-phase --manifest includes requirements and state'`

**3. Update the test "execute-phase manifest includes plan files" (around line 1349):**
- Change command from: `init execute-phase 06 --compact --raw` → `init execute-phase 06 --compact --manifest --raw`
- Test name: `'execute-phase --manifest includes plan files'`

**4. Update the test "manifest only references files that exist" (around line 1372):**
- Change command from: `init plan-phase 07 --compact --raw` → `init plan-phase 07 --compact --manifest --raw`
- Test name: `'--manifest only references files that exist'`

**5. Update "non-compact output does not include _manifest" test (around line 1391):**
- Keep as-is (non-compact should still not have manifest)

**6. Add new test: "--compact without --manifest excludes _manifest":**
```javascript
test('--compact without --manifest excludes _manifest', () => {
  const result = runGsdTools('init progress --compact --raw', tmpDir);
  assert.ok(result.success, `Command failed: ${result.error}`);
  const output = JSON.parse(result.output);
  assert.strictEqual(output._manifest, undefined, 'compact-only has no _manifest');
});
```

**7. Rewrite the reduction test "--compact reduces init output size by at least 38% for model-heavy commands" (around line 1236):**
Now that `--compact` doesn't include manifests, test ALL 12 commands for ≥38% average reduction (not just model-heavy cherry-picks):

```javascript
test('--compact reduces init output size by at least 38% average across all commands', () => {
  // Set up phase dir for commands that need one
  const phaseDir = path.join(tmpDir, '.planning', 'phases', '03-api');
  fs.mkdirSync(phaseDir, { recursive: true });
  fs.writeFileSync(path.join(phaseDir, '03-01-PLAN.md'), '# Plan');

  const commands = [
    'init progress',
    'init execute-phase 03',
    'init plan-phase 03',
    'init new-project',
    'init new-milestone',
    'init resume',
    'init verify-work 03',
    'init phase-op 03',
    'init milestone-op',
    'init map-codebase',
    'init quick "test task"',
    'init todos',
  ];

  const reductions = [];
  for (const cmd of commands) {
    const full = runGsdTools(`${cmd} --raw`, tmpDir);
    const compact = runGsdTools(`${cmd} --compact --raw`, tmpDir);
    if (!full.success || !compact.success) continue;

    const fullSize = Buffer.byteLength(full.output, 'utf8');
    const compactSize = Buffer.byteLength(compact.output, 'utf8');
    if (fullSize === 0) continue;
    const reduction = (1 - compactSize / fullSize) * 100;
    reductions.push({ cmd, reduction, fullSize, compactSize });
  }

  const avgReduction = reductions.reduce((sum, r) => sum + r.reduction, 0) / reductions.length;
  assert.ok(
    avgReduction >= 38,
    `Average reduction across all ${reductions.length} commands: expected >=38%, got ${avgReduction.toFixed(1)}%`
  );
});
```

**8. Rewrite/replace the "compact + manifest meets 38-50% reduction target across all init commands" test (around line 1399):**
Replace with a test that verifies `--compact --manifest` produces valid manifest data but is expected to be bigger:

```javascript
test('--compact --manifest includes manifest and returns valid output for all commands', () => {
  const phaseDir = path.join(tmpDir, '.planning', 'phases', '03-api');
  fs.mkdirSync(phaseDir, { recursive: true });
  fs.writeFileSync(path.join(phaseDir, '03-01-PLAN.md'), '# Plan');
  fs.writeFileSync(path.join(phaseDir, '03-CONTEXT.md'), '# Context');
  fs.writeFileSync(path.join(phaseDir, '03-RESEARCH.md'), '# Research');

  const allCommands = [
    'init progress',
    'init execute-phase 03',
    'init plan-phase 03',
    'init new-project',
    'init new-milestone',
    'init resume',
    'init verify-work 03',
    'init phase-op 03',
    'init milestone-op',
    'init map-codebase',
    'init quick "test task"',
    'init todos',
  ];

  for (const cmd of allCommands) {
    const result = runGsdTools(`${cmd} --compact --manifest --raw`, tmpDir);
    if (!result.success) continue;
    const output = JSON.parse(result.output);
    // All should have _manifest when --manifest flag is used
    assert.ok('_manifest' in output, `${cmd} missing _manifest with --manifest flag`);
    assert.ok(Array.isArray(output._manifest.files), `${cmd} _manifest.files is not array`);
  }
});
```

**9. Run `npm test`** to verify all tests pass. The pre-existing DEBT-01 failure in `roadmap analyze > parses phases with goals and disk status` is known and expected — ignore that one only.
  </action>
  <verify>
Run `npm test 2>&1` from the project root. Expected: all compact/manifest tests pass. The only allowed failure is the pre-existing DEBT-01 test (`roadmap analyze > parses phases with goals and disk status`).
  </verify>
  <done>Tests accurately reflect split behavior: `--compact` alone meets ≥38% average reduction across all 12 commands; `--compact --manifest` adds file guidance. No cherry-picking of favorable commands.</done>
</task>

</tasks>

<verification>
After both tasks:
1. Run size comparison across all 12 commands:
```bash
for cmd in "init progress" "init execute-phase 07" "init plan-phase 07" "init new-project" "init new-milestone" "init quick test" "init resume" "init verify-work 07" "init phase-op 07" "init todos" "init milestone-op" "init map-codebase"; do
  full=$(node bin/gsd-tools.cjs $cmd --raw 2>/dev/null | wc -c)
  compact=$(node bin/gsd-tools.cjs $cmd --compact --raw 2>/dev/null | wc -c)
  manifest=$(node bin/gsd-tools.cjs $cmd --compact --manifest --raw 2>/dev/null | wc -c)
  pct=$((100 - compact * 100 / full))
  echo "$cmd: full=$full compact=$compact ($pct%) manifest=$manifest"
done
```
2. Verify average reduction ≥38% across all 12
3. Verify `--compact --manifest` still produces valid manifest data
4. `npm test` passes (except known DEBT-01)
</verification>

<success_criteria>
- `--compact` alone achieves ≥38% average byte reduction across all 12 init commands (no manifest overhead)
- `--compact --manifest` adds `_manifest.files` with path/sections/required structure (opt-in guidance)
- `--compact` without `--manifest` returns NO `_manifest` key
- All existing manifest functionality preserved when `--manifest` flag is used
- `npm test` passes (except pre-existing DEBT-01)
- Backward compatible: non-compact output unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/07-init-command-compaction/07-03-SUMMARY.md`
</output>
