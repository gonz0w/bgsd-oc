---
phase: 13-test-infrastructure-polish
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - bin/gsd-tools.test.cjs
  - src/commands/features.js
  - src/lib/constants.js
  - src/router.js
  - bin/gsd-tools.cjs
autonomous: true
requirements:
  - TEST-04
  - TEST-05
  - TEST-06

must_haves:
  truths:
    - "E2E simulation test covers init → state → verify sequence"
    - "Snapshot tests verify init command output structure"
    - "Coverage tracking reports which commands have tests"
  artifacts:
    - path: "bin/gsd-tools.test.cjs"
      provides: "E2E and snapshot tests"
      contains: "describe.*e2e"
    - path: "src/commands/features.js"
      provides: "cmdTestCoverage function"
      contains: "cmdTestCoverage"
  key_links:
    - from: "src/commands/features.js"
      to: "bin/gsd-tools.test.cjs"
      via: "test file parsing for coverage"
      pattern: "gsd-tools\\.test"
---

<objective>
Add E2E workflow simulation, snapshot tests for init output stability, and test coverage tracking.

Purpose: Verify end-to-end workflows, ensure init command outputs are stable, and track which commands have tests.

Output: E2E test suite, snapshot tests, and `test-coverage` CLI command.
</objective>

<execution_context>
@__OPENCODE_CONFIG__/get-shit-done/workflows/execute-plan.md
@__OPENCODE_CONFIG__/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/codebase/TESTING.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: E2E simulation and snapshot tests</name>
  <files>
    bin/gsd-tools.test.cjs
  </files>
  <action>
Add test suites:

**`describe('integration: e2e simulation')`** (TEST-04):

1. **Full project lifecycle** — Create a complete mock project in temp dir:
   - Create .planning/ with STATE.md, ROADMAP.md, REQUIREMENTS.md, PROJECT.md, config.json
   - Create a phase directory with a PLAN.md
   - Run `init progress` → verify project exists, phases detected
   - Run `state validate` → verify clean or specific issues
   - Run `verify plan-structure <plan>` → verify valid structure
   - Run `verify requirements` → verify requirement tracking
   This tests that the full sequence works end-to-end.

2. **Memory lifecycle** — Create project, write decisions and bookmarks, run `init memory`, verify digest includes written data.

**`describe('integration: snapshot tests')`** (TEST-05):

3. **init progress output structure** — Run `init progress` on the real project. Verify output has expected top-level keys: `milestone_version`, `milestone_name`, `phases`, `phase_count`, `completed_count`, `project_exists`, `roadmap_exists`, `state_exists`.

4. **init execute-phase output structure** — Run `init execute-phase 13`. Verify output has expected keys: `phase_found`, `phase_number`, `plan_count`.

5. **init plan-phase output structure** — Run `init plan-phase 13`. Verify output has expected keys: `phase_dir`, `has_research`, `has_context`.

6. **state load output structure** — Run `state load`. Verify output has: `config`, `state_raw`, `state_exists`, `roadmap_exists`.

These are structure tests — they verify the SHAPE of output, not exact values. This makes them stable across project changes.

Run `npm test` — all pass.
  </action>
  <verify>
Run `npm test` — all tests pass.
  </verify>
  <done>
6 tests covering E2E simulation and output structure snapshots.
  </done>
</task>

<task type="auto">
  <name>Task 2: Test coverage tracking command</name>
  <files>
    src/commands/features.js
    src/lib/constants.js
    src/router.js
    bin/gsd-tools.cjs
    bin/gsd-tools.test.cjs
  </files>
  <action>
Add `cmdTestCoverage(cwd, raw)` to `src/commands/features.js`:

**Implementation:**
1. Read `bin/gsd-tools.test.cjs` (or find test file in project)
2. Extract all test descriptions by matching `describe('...'` and `it('...'` patterns
3. Read `src/router.js` to extract all command names from the switch statement
4. Match: a command is "covered" if its name appears in a test description or test command string
5. Report:
   ```json
   {
     "total_commands": 50,
     "commands_with_tests": 35,
     "coverage_percent": 70,
     "covered": ["state", "memory", "verify", ...],
     "uncovered": ["websearch", "scaffold", ...],
     "test_count": 275
   }
   ```

Wire as `test-coverage` command in router. Add COMMAND_HELP entry.

Add 2 tests:
1. test-coverage returns valid JSON with expected fields
2. test-coverage reports non-zero coverage

Run `npm run build && npm test`.
  </action>
  <verify>
Run `npm run build` — succeeds.
Run `node bin/gsd-tools.cjs test-coverage --raw` — returns coverage JSON.
Run `npm test` — all pass.
  </verify>
  <done>
Test coverage command exists, reports which commands have tests and which don't.
  </done>
</task>

</tasks>

<verification>
- `npm run build` succeeds
- `npm test` passes all tests
- E2E simulation verifies full workflow
- Snapshot tests verify output structure stability
- test-coverage reports command coverage
</verification>

<success_criteria>
- E2E simulation covers init → state → verify lifecycle
- Snapshot tests verify 4 init command output structures
- Test coverage command reports covered/uncovered commands
- 8+ new tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/13-test-infrastructure-polish/13-02-SUMMARY.md`
</output>
