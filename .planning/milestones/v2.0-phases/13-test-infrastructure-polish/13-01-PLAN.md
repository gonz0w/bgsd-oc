---
phase: 13-test-infrastructure-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - bin/gsd-tools.test.cjs
  - bin/gsd-tools.cjs
autonomous: true
requirements:
  - TEST-01
  - TEST-02
  - TEST-03

must_haves:
  truths:
    - "Workflow sequence tests verify multi-command state transitions"
    - "State round-trip tests verify create → write → patch → advance → reload"
    - "Config migration tests verify old formats migrate correctly"
  artifacts:
    - path: "bin/gsd-tools.test.cjs"
      provides: "Integration test suites"
      contains: "describe.*workflow sequence"
  key_links:
    - from: "bin/gsd-tools.test.cjs"
      to: "bin/gsd-tools.cjs"
      via: "execSync for multi-command sequences"
      pattern: "runGsdTools"
---

<objective>
Create integration tests for multi-command workflow sequences, state round-trips, and config migration.

Purpose: Lock in the v2.0 contract with tests that verify commands work together in sequence, not just individually.

Output: 3 new test suites verifying end-to-end command interactions.
</objective>

<execution_context>
@__OPENCODE_CONFIG__/get-shit-done/workflows/execute-plan.md
@__OPENCODE_CONFIG__/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/codebase/TESTING.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Workflow sequence tests</name>
  <files>
    bin/gsd-tools.test.cjs
  </files>
  <action>
Add `describe('integration: workflow sequences')` test suite with these tests:

**TEST-01: Multi-command workflow sequences:**

1. **init → state → roadmap sequence** — Create a complete .planning/ project (STATE.md, ROADMAP.md, config.json, PROJECT.md). Run `init progress`. Verify it returns valid phase data. Then run `state get "Current Position"`. Verify position matches. Then run `roadmap analyze`. Verify phase count matches.

2. **state mutation sequence** — Create project. Run `state patch --Phase "1 of 5" --Plan "01"`. Verify patch applied. Run `state advance-plan`. Verify plan incremented. Run `state update-progress`. Verify progress recalculated.

3. **memory write → read → list sequence** — Run `memory write --store decisions --entry '{"text":"test"}'`. Run `memory read --store decisions`. Verify entry present. Run `memory list`. Verify store shows 1 entry.

4. **verify sequence** — Create project with REQUIREMENTS.md and PLAN.md. Run `verify plan-structure` on the plan. Run `verify requirements`. Verify both return structured results.

**TEST-02: State round-trip tests:**

5. **Full state lifecycle** — Create minimal STATE.md. Run `state load`. Run `state patch` to update 3 fields. Run `state get` for each field. Verify values match patches. Run `state add-decision`. Run `state get decisions`. Verify decision present.

6. **Frontmatter round-trip** — Create a PLAN.md with specific frontmatter. Run `frontmatter get`. Verify all fields. Run `frontmatter set --field wave --value 3`. Run `frontmatter get`. Verify wave updated, other fields unchanged.

**TEST-03: Config migration tests:**

7. **Old flat config migrates** — Create old-format config.json with flat keys. Run `config-migrate`. Read config, verify nested structure preserved.

8. **Already-migrated config is idempotent** — Create modern config. Run `config-migrate`. Verify no changes.

All tests use temp directories with `fs.mkdtempSync`. Use the `runGsdTools` helper pattern.

Run `npm test` — all pass.
  </action>
  <verify>
Run `npm test` — all tests pass (0 failures).
Run `node --test --test-name-pattern="integration"` — integration tests pass.
  </verify>
  <done>
8 integration tests covering workflow sequences, state round-trips, and config migration. All pass alongside existing suite.
  </done>
</task>

</tasks>

<verification>
- `npm test` passes all tests
- Integration tests verify multi-command sequences
- State round-trip tests verify lifecycle
</verification>

<success_criteria>
- 8+ integration tests pass
- Workflow sequences verified end-to-end
- State round-trip verified
- Config migration tested
</success_criteria>

<output>
After completion, create `.planning/phases/13-test-infrastructure-polish/13-01-SUMMARY.md`
</output>
