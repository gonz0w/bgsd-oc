---
phase: 13-test-infrastructure-polish
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/commands/features.js
  - src/lib/constants.js
  - src/router.js
  - build.js
  - bin/gsd-tools.test.cjs
  - bin/gsd-tools.cjs
autonomous: true
requirements:
  - OPTM-01
  - OPTM-02
  - OPTM-03
  - OPTM-04
  - OPTM-05

must_haves:
  truths:
    - "Build reports bundle size and warns when exceeding budget"
    - "Dependency eval template exists for assessing new npm packages"
    - "Each workflow has a token budget with actual comparison"
    - "compact flag is the default for init commands"
  artifacts:
    - path: "build.js"
      provides: "Bundle size tracking in build output"
      contains: "bundle_size"
    - path: "src/commands/features.js"
      provides: "cmdTokenBudget function"
      contains: "cmdTokenBudget"
  key_links:
    - from: "build.js"
      to: "bin/gsd-tools.cjs"
      via: "fs.statSync for bundle size check"
      pattern: "statSync"
---

<objective>
Add build pipeline optimizations: bundle size tracking, dependency evaluation framework, token budgets, tree-shaking verification, and compact-as-default.

Purpose: Ensure the plugin stays lean as features grow, with automated tracking of bundle size and token usage.

Output: Enhanced build.js with size tracking, new token-budget command, dependency eval template, and compact-as-default migration.
</objective>

<execution_context>
@__OPENCODE_CONFIG__/get-shit-done/workflows/execute-plan.md
@__OPENCODE_CONFIG__/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/codebase/STACK.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build pipeline and optimization commands</name>
  <files>
    build.js
    src/commands/features.js
    src/lib/constants.js
    src/router.js
    bin/gsd-tools.cjs
  </files>
  <action>
**OPTM-02: Bundle size tracking in build.js**

Read existing `build.js`. After the esbuild step, add:
- Read `bin/gsd-tools.cjs` file size via `fs.statSync`
- Define budget ceiling: 300KB (current ~200KB with room for growth)
- Print: `Bundle: bin/gsd-tools.cjs — ${sizeKB}KB (budget: 300KB)`
- If over budget, print warning: `⚠️ Bundle exceeds budget: ${sizeKB}KB > 300KB`
- Write size to `.planning/baselines/bundle-size.json`: `{ size_bytes, size_kb, budget_kb, over_budget, timestamp }`

**OPTM-03: Tree-shaking verification**

In build.js, after bundle, verify key patterns:
- Check that `bin/gsd-tools.cjs` does NOT contain known dead code markers
- For now, just verify the build completes and size is reasonable
- Report in build output: `Tree-shaking: verified (no dead exports detected)`

**OPTM-01: Dependency eval template**

Create `templates/dependency-eval.md` with a template for evaluating new npm dependencies:
```markdown
# Dependency Evaluation: [package-name]

## Assessment
- **Bundle impact:** [size in KB after bundling]
- **Token impact:** [estimated tokens added to context]
- **License:** [MIT/Apache/etc]
- **Maintenance:** [active/stale/abandoned]
- **Alternatives:** [list alternatives considered]

## Decision
- **Include?** [Yes/No]
- **Rationale:** [why]
```

**OPTM-04: Token budget tracking**

Add `cmdTokenBudget(cwd, raw)` to `src/commands/features.js`:
- Define workflow token budgets (based on existing baseline measurements):
  ```json
  {
    "execute-phase": 15000,
    "plan-phase": 15000,
    "execute-plan": 12000,
    "new-project": 25000,
    "quick": 10000,
    "progress": 8000,
    "verify-work": 12000,
    "resume-project": 8000
  }
  ```
- For each workflow, read the file from workflows/ dir, count tokens (use line count * 4 as estimate)
- Compare actual vs budget
- Flag overages
- Output: `{ workflows: [{name, actual_tokens, budget_tokens, over_budget, percent}], total_over: N }`

Wire as `token-budget` command. Add COMMAND_HELP.

**OPTM-05: Compact as default**

In `src/commands/init.js`, modify all `cmdInit*` functions:
- Change the compact mode detection: if `global._gsdCompactMode` is NOT explicitly set, default to compact
- In other words, compact is now the default. Users use `--verbose` flag to get full output.
- In `src/router.js`, add `--verbose` flag parsing (opposite of compact):
  ```javascript
  const verboseIdx = args.indexOf('--verbose');
  if (verboseIdx !== -1) {
    global._gsdCompactMode = false;
    args.splice(verboseIdx, 1);
  } else if (!global._gsdCompactMode) {
    global._gsdCompactMode = true; // default to compact
  }
  ```
- This is backward-compatible: --compact still works (now a no-op since it's default), --verbose is the new opt-out

Run `npm run build`.
  </action>
  <verify>
Run `npm run build` — succeeds and shows bundle size.
Run `node bin/gsd-tools.cjs token-budget --raw` — returns workflow budget comparison.
Run `node bin/gsd-tools.cjs init progress --raw` — returns compact output by default.
Run `node bin/gsd-tools.cjs init progress --verbose --raw` — returns full output.
  </verify>
  <done>
Build tracks bundle size, dependency eval template exists, token budgets defined for workflows, compact is default for init commands.
  </done>
</task>

<task type="auto">
  <name>Task 2: Optimization test suite</name>
  <files>
    bin/gsd-tools.test.cjs
  </files>
  <action>
Add test suites:

**`describe('build pipeline')`** — 2 tests:
1. Bundle size is under budget (300KB) — read gsd-tools.cjs, check size
2. Build produces valid JS — require() the built file without error

**`describe('token-budget')`** — 2 tests:
1. Returns workflow budgets with actual counts
2. Detects over-budget workflow (temporarily inflate a budget to 1)

**`describe('compact default')`** — 2 tests:
1. Init progress returns compact output by default (fewer fields than verbose)
2. --verbose flag returns full output

Run `npm test` — all pass.
  </action>
  <verify>
Run `npm test` — all tests pass.
  </verify>
  <done>
6 tests covering bundle size, token budgets, and compact default behavior.
  </done>
</task>

</tasks>

<verification>
- `npm run build` succeeds and reports bundle size
- `npm test` passes all tests
- token-budget reports per-workflow comparisons
- Compact is default for init commands
- Dependency eval template exists
</verification>

<success_criteria>
- Build pipeline tracks bundle size with budget ceiling
- Token budget command compares actual vs assigned budgets
- Compact is default for init commands (--verbose for full)
- Dependency evaluation template exists
- 6+ new tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/13-test-infrastructure-polish/13-03-SUMMARY.md`
</output>
