---
phase: 13-test-infrastructure-polish
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/commands/features.js
  - src/lib/constants.js
  - src/router.js
  - bin/gsd-tools.test.cjs
  - bin/gsd-tools.cjs
autonomous: true
requirements:
  - MCPA-01

must_haves:
  truths:
    - "mcp-discover command lists available MCP server configurations"
    - "Output includes server names, transport types, and tool counts"
  artifacts:
    - path: "src/commands/features.js"
      provides: "cmdMcpDiscover function"
      contains: "cmdMcpDiscover"
    - path: "bin/gsd-tools.test.cjs"
      provides: "MCP discovery tests"
      contains: "describe.*mcp-discover"
  key_links:
    - from: "src/commands/features.js"
      to: ".mcp.json"
      via: "fs.readFileSync for MCP config"
      pattern: "\\.mcp\\.json"
---

<objective>
Add MCP server discovery command that reads available MCP configurations and surfaces them to workflows.

Purpose: Enable the plugin to be aware of available MCP tools, which can inform planning and execution.

Output: New `mcp-discover` CLI command that reads MCP config and reports available servers and their capabilities.
</objective>

<execution_context>
@__OPENCODE_CONFIG__/get-shit-done/workflows/execute-plan.md
@__OPENCODE_CONFIG__/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: MCP discovery command</name>
  <files>
    src/commands/features.js
    src/lib/constants.js
    src/router.js
    bin/gsd-tools.cjs
  </files>
  <action>
Add `cmdMcpDiscover(cwd, raw)` to `src/commands/features.js`:

**Implementation:**
1. Look for MCP config files in standard locations:
   - `{cwd}/.mcp.json` (project-level)
   - `~/.config/opencode/.mcp.json` (user-level, for OpenCode)
2. For each found config, parse JSON
3. MCP config format is typically:
   ```json
   {
     "mcpServers": {
       "server-name": {
         "command": "npx",
         "args": ["-y", "server-package"],
         "type": "stdio"
       }
     }
   }
   ```
   OR OpenCode format with `servers` key.
4. Extract server names, transport types, and command details
5. Output:
   ```json
   {
     "configs_found": [".mcp.json", "~/.config/opencode/.mcp.json"],
     "servers": [
       {
         "name": "postgres",
         "source": ".mcp.json",
         "transport": "stdio",
         "command": "npx -y @modelcontextprotocol/server-postgres",
         "description": null
       }
     ],
     "server_count": 3,
     "capabilities": ["Database access via postgres", "File operations via filesystem"]
   }
   ```
6. If no MCP configs found, return `{ configs_found: [], servers: [], server_count: 0 }`

Note: This is a lightweight discovery — it reads config files, it doesn't connect to servers. Full capability introspection (listing actual tools per server) would require MCP protocol communication, which is deferred to a future milestone.

Wire as `mcp-discover` command. Add COMMAND_HELP.

Run `npm run build`.
  </action>
  <verify>
Run `npm run build` — succeeds.
Run `node bin/gsd-tools.cjs mcp-discover --raw` — returns MCP server list.
  </verify>
  <done>
MCP discovery command reads available MCP configurations from standard locations and reports servers.
  </done>
</task>

<task type="auto">
  <name>Task 2: MCP discovery tests</name>
  <files>
    bin/gsd-tools.test.cjs
  </files>
  <action>
Add `describe('mcp-discover')` with 3 tests:

1. **Returns empty when no MCP config** — Run in temp dir with no .mcp.json. Verify `servers: []`.
2. **Discovers project-level MCP config** — Create `.mcp.json` in temp dir with 2 servers. Run mcp-discover. Verify 2 servers found.
3. **Handles malformed config gracefully** — Create `.mcp.json` with invalid JSON. Verify no crash, returns empty or error field.

Run `npm test` — all pass.
  </action>
  <verify>
Run `npm test` — all tests pass.
  </verify>
  <done>
3 tests covering MCP discovery with empty config, populated config, and malformed config.
  </done>
</task>

</tasks>

<verification>
- `npm run build` succeeds
- `npm test` passes all tests
- mcp-discover reports available MCP servers
- Graceful handling of missing/malformed configs
</verification>

<success_criteria>
- MCP discovery command reads standard config locations
- Reports server names, transport types, commands
- Graceful when no MCP configs found
- 3+ new tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/13-test-infrastructure-polish/13-04-SUMMARY.md`
</output>
