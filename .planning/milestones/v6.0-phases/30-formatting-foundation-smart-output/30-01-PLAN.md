---
phase: 30-formatting-foundation-smart-output
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/format.js
autonomous: true
requirements:
  - FMT-01
  - FMT-02
  - FMT-03
  - FMT-04
  - FMT-05

must_haves:
  truths:
    - "formatTable(headers, rows, options) renders aligned columns with header separator, truncation at column width, and optional borders"
    - "Color utility auto-disables when NO_COLOR is set or output is non-TTY"
    - "progressBar(percent, width) renders percentage with filled/empty blocks and color gradient (red→yellow→green)"
    - "sectionHeader(label) renders inline label embedded in horizontal rule (e.g., '━━ Progress ━━━━━━━━')"
    - "banner(title) renders a branded milestone/phase completion banner"
    - "SYMBOLS object exports ✓, ✗, ▶, ○ constants used by all output paths"
    - "Terminal width is detected and formatting adapts to available columns"
  artifacts:
    - path: "src/lib/format.js"
      provides: "All formatting primitives — color, table, progress bar, banner, section header, box, symbols"
      exports: ["color", "SYMBOLS", "formatTable", "progressBar", "sectionHeader", "banner", "box", "getTerminalWidth", "truncate", "relativeTime", "colorByPercent"]
  key_links:
    - from: "src/lib/format.js"
      to: "process.stdout.columns"
      via: "getTerminalWidth() fallback chain"
      pattern: "process\\.stdout\\.columns"
    - from: "src/lib/format.js"
      to: "process.env.NO_COLOR"
      via: "color utility initialization"
      pattern: "NO_COLOR"
---

<objective>
Create the shared formatting primitives module that all command renderers depend on.

Purpose: Every GSD command needs tables, colors, progress bars, banners, and status symbols. This plan builds them as a single importable module with zero external dependencies, following the Linear/Vercel CLI aesthetic decided in CONTEXT.md.

Output: `src/lib/format.js` — a complete formatting toolkit with TTY-aware color support and responsive terminal width handling.
</objective>

<execution_context>
@__OPENCODE_CONFIG__/get-shit-done/workflows/execute-plan.md
@__OPENCODE_CONFIG__/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/INTENT.md
@.planning/phases/30-formatting-foundation-smart-output/30-CONTEXT.md
@.planning/REQUIREMENTS.md
@__OPENCODE_CONFIG__/get-shit-done/references/ui-brand.md
@src/lib/output.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Color utility, terminal detection, and symbol constants</name>
  <files>src/lib/format.js</files>
  <action>
Create `src/lib/format.js` with the foundational formatting infrastructure:

**Color utility (~2KB picocolors pattern per FMT-02):**
- Implement a tiny color library with: `bold`, `dim`, `red`, `green`, `yellow`, `cyan`, `blue`, `magenta`, `gray`, `white`, `underline`
- Each function wraps text in ANSI escape codes
- Auto-disable all colors when: `process.env.NO_COLOR` is set (no-color.org standard), or stdout is not a TTY
- Support graceful color depth degradation: detect true color (24-bit) capability via `COLORTERM=truecolor` env var, fall back to 256-color, then 16-color, then no color
- Export a `color` object with all color functions: `color.red('text')`, `color.bold('text')`, etc.
- Add `color.enabled` boolean for checking state
- Add `colorByPercent(percent)` helper that returns a color function: red (0-33%), yellow (34-66%), green (67-100%)

**Terminal detection:**
- `getTerminalWidth()` — returns `process.stdout.columns || 80` (fallback 80)
- `isTTY()` — returns `!!process.stdout.isTTY`

**Symbol constants (FMT-05):**
- Export `SYMBOLS` object with: `check: '✓'`, `cross: '✗'`, `progress: '▶'`, `pending: '○'`, `warning: '⚠'`, `arrow: '→'`, `bullet: '•'`, `dash: '─'`, `heavyDash: '━'`
- These are Unicode characters, not ANSI-colored — coloring happens at render time

**Helper utilities:**
- `truncate(text, maxWidth)` — truncates with '…' at maxWidth
- `relativeTime(dateStr)` — converts ISO date or 'YYYY-MM-DD' to relative time ('2h ago', 'yesterday', '3 days ago')
- `pad(text, width, align)` — left/right/center padding for table columns
- `stripAnsi(text)` — removes ANSI codes for width calculation (regex: `/\x1b\[[0-9;]*m/g`)

Per user decision: minimal/clean aesthetic. No over-engineering — just the primitives.
  </action>
  <verify>
Run: `node -e "const f = require('./src/lib/format'); console.log(f.color.green('ok'), f.SYMBOLS.check, f.getTerminalWidth(), f.truncate('hello world', 8), f.relativeTime('2026-02-25'))"`
Expected: colored 'ok', ✓ symbol, terminal width number, 'hello w…', relative time string.
Also: `NO_COLOR=1 node -e "const f = require('./src/lib/format'); console.log(f.color.enabled)"` should print `false`.
  </verify>
  <done>Color utility works with auto-disable, SYMBOLS exported, terminal width detected, truncate and relativeTime produce correct output.</done>
</task>

<task type="auto">
  <name>Task 2: Table, progress bar, section header, banner, and box renderers</name>
  <files>src/lib/format.js</files>
  <action>
Add the higher-level formatting functions to `src/lib/format.js`, building on Task 1's primitives:

**formatTable(headers, rows, options) — FMT-01:**
- `headers`: array of strings (column names)
- `rows`: array of arrays (row data)
- `options`: `{ maxWidth, truncate, borders, indent, colorFn }`
- PSql-style rendering per user decision:
  ```
   Name         Status   Plans   Progress
  ─────────────────────────────────────────
   Foundation   ✓        3/3     100%
   Quality      ▶        1/4     25%
  ```
- Column widths auto-calculated from content, respecting `maxWidth` (default: terminal width)
- Long text in cells truncated with '…' at column width
- Header separator uses '─' characters
- Rows with >10 items truncated: show first 10 + `... and N more (use --all to see full list)` per user decision
- Optional `indent` (default: 1 space before each row)
- Optional `colorFn` for per-cell coloring based on value

**progressBar(percent, width) — FMT-03:**
- Format: `47% [███████░░░]` per user decision
- `percent`: 0-100 number
- `width`: bar width in chars (default: 20)
- Color gradient per user decision: red (0-33%), yellow (34-66%), green (67-100%) using `colorByPercent()`
- Shows both milestone-level and plan-level progress when called with appropriate context

**sectionHeader(label) — part of FMT-04:**
- Format: `━━ Progress ━━━━━━━━` (inline label embedded in horizontal rule) per user decision
- Width adapts to terminal width via `getTerminalWidth()`
- Label is colored (e.g., bold or cyan)

**banner(title) — FMT-04:**
- Subtle prefix per user decision: small 'bGSD' prefix on section headers, NOT big banners
- Exception: milestone/phase completion gets a celebratory banner
- Standard: `bGSD ▶ {TITLE}` with a horizontal rule below
- Completion: a special styled treatment with `━━━` borders and `✓` or achievement text

**box(content, type) — FMT-04:**
- Per user decision: horizontal rules only, NO full box-drawing borders
- Types: 'info', 'warning', 'error', 'success'
- Renders as: colored prefix line + content + bottom rule
- Error type: red-prefixed. Warning type: yellow-prefixed. Per user decision.

**summaryLine(text) — from user decisions:**
- Every command ends with a one-line takeaway
- Renders as: dim horizontal rule + bold summary text

**actionHint(text) — from user decisions:**
- Always show next action at bottom of output
- Renders as: dim `→ {text}`

**listWithTruncation(items, maxItems) — from user decisions:**
- Show first `maxItems` (default 10) items
- If more exist: `... and N more (use --all to see full list)`
- Numbered items per user decision (show index numbers)
  </action>
  <verify>
Run: `node -e "
const f = require('./src/lib/format');
console.log(f.formatTable(['Name','Status'], [['Test','✓'],['Other','○']]));
console.log(f.progressBar(47));
console.log(f.sectionHeader('Progress'));
console.log(f.banner('PLANNING PHASE 30'));
console.log(f.box('Something happened', 'warning'));
console.log(f.summaryLine('3 plans created'));
console.log(f.actionHint('Run /gsd-execute-phase 30'));
"`
Expected: PSql-style table, colored progress bar, inline section header, branded banner, warning box, summary line, and action hint all rendering correctly.
  </verify>
  <done>All formatting primitives render correctly: formatTable with aligned columns and truncation, progressBar with color gradient, sectionHeader with inline label, banner with bGSD branding, box with horizontal rules only, summaryLine, actionHint, and listWithTruncation.</done>
</task>

</tasks>

<verification>
- `node -e "const f = require('./src/lib/format'); console.log(Object.keys(f).sort().join(', '))"` — all exports present
- `NO_COLOR=1 node -e "const f = require('./src/lib/format'); console.log(f.progressBar(50))"` — no ANSI codes in output
- `node -e "const f = require('./src/lib/format'); console.log(f.formatTable(['A','B'], Array.from({length: 15}, (_, i) => [i+1, 'item'])))"` — shows 10 rows + truncation message
- Module has zero external dependencies (Node.js stdlib only)
</verification>

<success_criteria>
- src/lib/format.js exists with all FMT-01 through FMT-05 primitives exported
- formatTable renders PSql-style aligned columns with header separator and truncation
- Color utility respects NO_COLOR and non-TTY auto-disable
- progressBar shows percentage with color gradient
- sectionHeader renders inline label in horizontal rule
- banner uses 'bGSD' branding (subtle prefix, not big banners per user decision)
- SYMBOLS exports all status markers as constants
- Zero external dependencies
</success_criteria>

<output>
After completion, create `.planning/phases/30-formatting-foundation-smart-output/30-01-SUMMARY.md`
</output>
