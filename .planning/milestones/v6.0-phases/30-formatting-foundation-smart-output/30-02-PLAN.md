---
phase: 30-formatting-foundation-smart-output
plan: 02
type: execute
wave: 2
depends_on:
  - 30-01
files_modified:
  - src/lib/output.js
  - src/router.js
  - src/lib/constants.js
  - workflows/execute-phase.md
  - workflows/progress.md
  - workflows/add-todo.md
  - workflows/complete-and-clear.md
  - workflows/plan-phase.md
  - workflows/new-project.md
  - workflows/verify-phase.md
  - workflows/pause-work.md
  - workflows/execute-plan.md
  - workflows/transition.md
  - workflows/audit-milestone.md
  - workflows/cmd-validate-config.md
  - workflows/cmd-trace-requirement.md
  - workflows/cmd-velocity.md
  - workflows/cmd-rollback-info.md
  - workflows/cmd-codebase-impact.md
  - workflows/cmd-search-lessons.md
  - workflows/cmd-validate-deps.md
  - workflows/cmd-search-decisions.md
  - workflows/cmd-test-run.md
  - workflows/cmd-context-budget.md
  - workflows/cmd-session-diff.md
  - README.md
  - AGENTS.md
  - workflows/help.md
autonomous: true
requirements:
  - OUT-01
  - OUT-02
  - OUT-03
  - OUT-04

must_haves:
  truths:
    - "Running any GSD command in a terminal shows human-readable output; piping the same command produces JSON"
    - "--pretty flag forces human-readable output when piped (e.g., for less -R)"
    - "--raw flag is removed from router.js — auto TTY detection replaces it"
    - "All workflow .md files no longer reference --raw flag"
    - "Brand references updated from 'Get Shit Done' to 'bGSD' / 'Get Stuff Done'"
    - "Diagnostic/debug output goes to stderr, actual data goes to stdout"
  artifacts:
    - path: "src/lib/output.js"
      provides: "TTY-aware output routing — formatted for TTY, JSON for piped"
      exports: ["output", "error", "debugLog", "isTTY", "outputMode"]
    - path: "src/router.js"
      provides: "Parses --pretty flag, removes --raw, sets output mode globally"
  key_links:
    - from: "src/router.js"
      to: "src/lib/output.js"
      via: "Sets global._gsdOutputMode based on TTY detection and --pretty flag"
      pattern: "global\\._gsdOutputMode"
    - from: "src/lib/output.js"
      to: "src/lib/format.js"
      via: "Imports formatting functions when in TTY mode"
      pattern: "require.*format"
    - from: "src/lib/output.js"
      to: "process.stdout.isTTY"
      via: "Auto-detection for output mode"
      pattern: "isTTY"
---

<objective>
Wire TTY-aware output mode switching into the CLI, remove the --raw flag, add --pretty, update all workflow callers, and rename the brand to "bGSD".

Purpose: The formatting primitives from Plan 01 need an output routing layer that auto-detects whether the user is in a terminal (show formatted output) or piping (produce JSON). This eliminates the manual --raw flag that every workflow invocation currently uses, and establishes the "bGSD" brand identity.

Output: Modified output.js with dual-mode rendering, updated router.js with --pretty and no --raw, all workflow files updated, brand renamed.
</objective>

<execution_context>
@__OPENCODE_CONFIG__/get-shit-done/workflows/execute-plan.md
@__OPENCODE_CONFIG__/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/INTENT.md
@.planning/phases/30-formatting-foundation-smart-output/30-CONTEXT.md
@.planning/phases/30-formatting-foundation-smart-output/30-01-SUMMARY.md
@.planning/REQUIREMENTS.md
@src/lib/output.js
@src/router.js
@src/lib/constants.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: TTY auto-detection, output mode switching, and --pretty flag</name>
  <files>src/lib/output.js, src/router.js</files>
  <action>
**Modify `src/router.js`:**
- Remove `--raw` flag parsing entirely (lines that find and splice `--raw` from args)
- Add `--pretty` flag parsing: if present, set `global._gsdOutputMode = 'pretty'`
- Add TTY auto-detection at startup (before command routing):
  ```
  if (global._gsdOutputMode === undefined) {
    global._gsdOutputMode = process.stdout.isTTY ? 'formatted' : 'json';
  }
  ```
- The `--pretty` flag overrides pipe detection: forces formatted output even when piped (useful for `| less -R`)
- Keep `--compact` and `--verbose` flags as-is (they control density within formatted mode only)
- Update the usage string to remove `--raw` and add `--pretty`
- Pass `global._gsdOutputMode` (not `raw` boolean) to command handlers

**Modify `src/lib/output.js`:**
- Rename the `output(result, raw, rawValue)` function signature to `output(result, options)` where options is `{ rawValue, formatter }`
- For backward compatibility: if second arg is boolean, treat as legacy `raw` mode (JSON output). This prevents breakage during migration.
- Core logic:
  ```
  function output(result, options = {}) {
    const mode = global._gsdOutputMode || 'json';  // default to JSON (safe)

    if (mode === 'json') {
      // Existing JSON output logic (field filtering, tmpfile for large payloads)
      outputJSON(result);
    } else {
      // Formatted output — if a formatter function was provided, use it
      // Otherwise fall back to JSON (commands not yet migrated)
      if (options.formatter) {
        const formatted = options.formatter(result);
        process.stdout.write(formatted + '\n');
      } else {
        outputJSON(result);  // graceful fallback for un-migrated commands
      }
    }
    process.exit(0);
  }
  ```
- Extract JSON output logic into `outputJSON(result)` helper (field filtering, tmpfile, etc.)
- Add `outputMode()` export that returns current mode ('formatted', 'json', or 'pretty')
- Per user decision: stderr for diagnostics. The existing `debugLog()` and `error()` already use stderr — verify and keep.
- Per user decision: stderr in piped mode is always human-readable. Add a `status(message)` function that writes to stderr (for progress indicators the user sees even when stdout is piped):
  ```
  function status(message) {
    process.stderr.write(message + '\n');
  }
  ```

**Important: backward compatibility.** Existing command handlers call `output(result, raw)` with boolean `raw`. The new function must detect this and handle it:
```
if (typeof options === 'boolean') {
  // Legacy call: output(result, raw) — treat as JSON mode
  return outputJSON(result);
}
```
This ensures ALL existing commands keep working immediately. Individual commands get migrated to `output(result, { formatter })` in Phases 32-34.
  </action>
  <verify>
Run: `node bin/gsd-tools.cjs quick-summary 2>/dev/null` in a terminal — should still produce JSON (no formatter registered yet, graceful fallback).
Run: `echo "test" | node bin/gsd-tools.cjs quick-summary 2>/dev/null` — should produce JSON (piped mode).
Run: `node bin/gsd-tools.cjs quick-summary --pretty 2>/dev/null` — should produce JSON (no formatter yet, graceful fallback).
Run: `node -e "const o = require('./src/lib/output'); console.log(typeof o.output, typeof o.outputMode, typeof o.status)"` — all should be 'function'.
Verify: `node bin/gsd-tools.cjs init progress 2>/dev/null | head -1` — still produces valid JSON (backward compat).
  </verify>
  <done>TTY auto-detection routes output mode. --raw is removed. --pretty flag forces formatted mode. Backward compatibility maintained — all existing commands still produce JSON via graceful fallback. status() writes to stderr for piped-mode progress.</done>
</task>

<task type="auto">
  <name>Task 2: Remove --raw from all workflow files and rename brand to bGSD</name>
  <files>workflows/execute-phase.md, workflows/progress.md, workflows/add-todo.md, workflows/complete-and-clear.md, workflows/plan-phase.md, workflows/new-project.md, workflows/verify-phase.md, workflows/pause-work.md, workflows/execute-plan.md, workflows/transition.md, workflows/audit-milestone.md, workflows/cmd-validate-config.md, workflows/cmd-trace-requirement.md, workflows/cmd-velocity.md, workflows/cmd-rollback-info.md, workflows/cmd-codebase-impact.md, workflows/cmd-search-lessons.md, workflows/cmd-validate-deps.md, workflows/cmd-search-decisions.md, workflows/cmd-test-run.md, workflows/cmd-context-budget.md, workflows/cmd-session-diff.md, src/lib/constants.js, README.md, AGENTS.md, workflows/help.md</files>
  <action>
**Remove `--raw` from all workflow .md files (per user decision: "Remove immediately in this milestone"):**

For each workflow file listed, find all instances of ` --raw` in command invocations and remove them. The commands are typically:
```bash
# Before:
RESULT=$(node __OPENCODE_CONFIG__/get-shit-done/bin/gsd-tools.cjs some-command --raw 2>/dev/null)
# After:
RESULT=$(node __OPENCODE_CONFIG__/get-shit-done/bin/gsd-tools.cjs some-command 2>/dev/null)
```

These invocations are inside `$()` command substitution, which creates a non-TTY context. The auto-detection from Task 1 will produce JSON automatically — no `--raw` flag needed.

Affected workflow files (from grep analysis):
- `workflows/execute-phase.md` (9 instances)
- `workflows/progress.md` (1 instance)
- `workflows/add-todo.md` (1 instance)
- `workflows/complete-and-clear.md` (1 instance)
- `workflows/plan-phase.md` (2 instances)
- `workflows/new-project.md` (1 instance)
- `workflows/verify-phase.md` (1 instance)
- `workflows/pause-work.md` (1 instance)
- `workflows/execute-plan.md` (1 instance)
- `workflows/transition.md` (1 instance)
- `workflows/audit-milestone.md` (2 instances)
- All `workflows/cmd-*.md` files (1 instance each, ~11 files)

**Remove `--raw` from usage strings in `src/lib/constants.js`:**
- Find all COMMAND_HELP entries that reference `--raw` in usage strings
- Remove `[--raw]` from usage patterns and `--raw` from option descriptions
- Replace with `[--pretty]` where appropriate, add `--pretty` flag description: "Force human-readable output when piped"
- This is a large file (~1088 lines) with many help strings — be thorough but only modify the `--raw` references

**Brand rename (per user decision: "bGSD" / "Get Stuff Done"):**
- `README.md`: Change `GSD (Get Shit Done)` → `bGSD (Get Stuff Done)` in the title/heading
- `AGENTS.md`: Change `Get Shit Done (GSD)` → `Get Stuff Done (bGSD)` in the description
- `workflows/help.md`: Change `GSD (Get Shit Done)` → `bGSD (Get Stuff Done)` in the intro text

Do NOT modify planning docs (.planning/), CONTEXT.md, or any files in .planning/ — those are historical records.
  </action>
  <verify>
Run: `grep -r '\-\-raw' workflows/ --include='*.md' | grep -v '\.planning/' | wc -l` — should be 0.
Run: `grep -r 'Get Shit Done' README.md AGENTS.md workflows/help.md | wc -l` — should be 0.
Run: `grep -c '\-\-raw' src/lib/constants.js` — should be 0 (or very close to 0 — only historical references if any).
Run: `node bin/gsd-tools.cjs init progress 2>/dev/null | head -1` — still valid JSON (backward compat check after all changes).
  </verify>
  <done>All workflow files updated — no --raw flags remain in any command invocation. Constants.js usage strings updated. Brand renamed to "bGSD" / "Get Stuff Done" in README.md, AGENTS.md, and workflows/help.md. All existing commands still function correctly.</done>
</task>

</tasks>

<verification>
- `node bin/gsd-tools.cjs init progress 2>/dev/null | python3 -c "import json,sys; json.load(sys.stdin); print('valid JSON')"` — piped output is valid JSON
- `grep -r '\-\-raw' workflows/ --include='*.md' | wc -l` — zero results
- `grep -r 'Get Shit Done' README.md AGENTS.md workflows/help.md` — zero results
- `node bin/gsd-tools.cjs --help 2>&1 | grep -c 'raw'` — zero or only in historical context
- `node -e "const o = require('./src/lib/output'); console.log(typeof o.status)"` — 'function'
</verification>

<success_criteria>
- TTY detection auto-routes output: formatted for terminal, JSON for piped
- --raw flag is removed from router.js and all workflow .md files
- --pretty flag forces formatted output when piped
- All existing commands still work (JSON fallback for un-migrated commands)
- Brand renamed: "bGSD" / "Get Stuff Done" in README, AGENTS.md, help.md
- status() function writes progress to stderr
- No external dependencies added
</success_criteria>

<output>
After completion, create `.planning/phases/30-formatting-foundation-smart-output/30-02-SUMMARY.md`
</output>
