---
phase: 32-init-state-command-renderers
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/commands/init.js, src/commands/state.js]
autonomous: true
requirements: [CMD-01, CMD-02]

must_haves:
  truths:
    - "init progress in TTY shows branded banner, progress bar, phase checklist, and milestone summary"
    - "state show in TTY renders formatted state card with position, velocity, and blockers"
    - "state update-progress confirms update with formatted success message"
    - "All three commands still produce valid JSON when piped"
  artifacts:
    - path: "src/commands/init.js"
      provides: "formatInitProgress formatter function"
      contains: "formatter"
    - path: "src/commands/state.js"
      provides: "formatStateShow and formatStateUpdateProgress formatter functions"
      contains: "formatter"
  key_links:
    - from: "src/commands/init.js"
      to: "src/lib/format.js"
      via: "import formatting primitives"
      pattern: "require.*format"
    - from: "src/commands/state.js"
      to: "src/lib/format.js"
      via: "import formatting primitives"
      pattern: "require.*format"
---

<objective>
Add TTY-aware formatted output to the 3 user-facing init/state commands: `init progress`, `state show`, and `state update-progress`.

Purpose: These are the most-used commands — developers see `init progress` at the start of every session. Making them visually branded and scannable improves the daily experience.
Output: Formatter functions wired into output() calls for all 3 commands.
</objective>

<execution_context>
@__OPENCODE_CONFIG__/get-shit-done/workflows/execute-plan.md
@__OPENCODE_CONFIG__/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/30-formatting-foundation-smart-output/30-02-SUMMARY.md
@src/lib/format.js
@src/lib/output.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add formatter to init progress</name>
  <files>src/commands/init.js</files>
  <action>
Add `require('../lib/format')` at the top of init.js — import `banner`, `sectionHeader`, `progressBar`, `formatTable`, `summaryLine`, `actionHint`, `color`, `SYMBOLS`, `colorByPercent`.

Create a `formatInitProgress(result)` function that renders:
1. `banner('Progress')` — branded header
2. Milestone line: `{milestone_version} — {milestone_name}`
3. `progressBar(completedPercent)` with `{completed_count}/{phase_count} phases`
4. `sectionHeader('Phases')` then `formatTable` with columns: [Phase, Status, Plans] where Status uses `SYMBOLS.check` for complete, `SYMBOLS.progress` for in_progress, `SYMBOLS.pending` for pending
5. If `current_phase`: show `sectionHeader('Current')` with phase name
6. If `next_phase`: `actionHint('Next: /gsd-discuss-phase {next_phase.number}')`
7. If `session_diff` with commits: `sectionHeader('Session')` with `{commit_count} commits since last session`
8. `summaryLine('{completed}/{total} phases complete — {milestone_name}')` at bottom

Change the `output(result, raw)` call at line 1408 to:
```js
output(result, { formatter: formatInitProgress });
```

Also change the compact mode output at line 1395 to:
```js
output(compactResult, { formatter: formatInitProgress });
```

IMPORTANT: Do NOT touch any other init commands — they are agent-consumed and must stay as-is.
  </action>
  <verify>Run `node bin/gsd-tools.cjs init progress` in terminal — should show branded output. Run `node bin/gsd-tools.cjs init progress | cat` — should show JSON.</verify>
  <done>init progress shows banner, progress bar, phase table, and action hints in TTY; produces JSON when piped</done>
</task>

<task type="auto">
  <name>Task 2: Add formatters to state show and state update-progress</name>
  <files>src/commands/state.js</files>
  <action>
Add `require('../lib/format')` at the top of state.js — import `banner`, `sectionHeader`, `formatTable`, `summaryLine`, `actionHint`, `color`, `SYMBOLS`, `progressBar`, `box`.

**state show (cmdStateLoad):**

Create `formatStateShow(result)` that renders:
1. `banner('State')` — branded header  
2. `sectionHeader('Configuration')` with key config values in a compact format: `model_profile`, `commit_docs`, `branching_strategy`, `parallelization`
3. `sectionHeader('Files')` with existence indicators: `SYMBOLS.check`/`SYMBOLS.cross` for state_exists, roadmap_exists, config_exists
4. `summaryLine('State loaded')` at bottom

Change `output(result, raw, rawLines)` at line 70 to:
```js
output(result, { formatter: formatStateShow, rawValue: rawLines });
```

**state update-progress (cmdStateUpdateProgress):**

Create `formatStateUpdateProgress(result)` that renders:
1. If `result.updated`: `box('Progress updated: {percent}%', 'success')` followed by `progressBar(result.percent)` and `{completed}/{total} plans`
2. If `!result.updated`: `box(result.reason, 'warning')`

Change `output({...}, raw, progressStr)` at line 262 to:
```js
output({...}, { formatter: formatStateUpdateProgress, rawValue: progressStr });
```

Also change line 264 to use the new pattern:
```js
output({ updated: false, reason: 'Progress field not found in STATE.md' }, { formatter: formatStateUpdateProgress, rawValue: 'false' });
```

IMPORTANT: Do NOT touch any other state commands — they are agent-consumed.
  </action>
  <verify>Run `node bin/gsd-tools.cjs state load` in terminal — should show formatted state card. Run `node bin/gsd-tools.cjs state update-progress` — should show formatted confirmation. Both should produce JSON when piped.</verify>
  <done>state show renders formatted config/files card, state update-progress shows success/warning box, both produce JSON when piped</done>
</task>

</tasks>

<verification>
1. `node bin/gsd-tools.cjs init progress` — branded banner, progress bar, phase table visible
2. `node bin/gsd-tools.cjs init progress | cat` — valid JSON output
3. `node bin/gsd-tools.cjs state load` — formatted state card
4. `node bin/gsd-tools.cjs state load | cat` — valid JSON output
5. `node bin/gsd-tools.cjs state update-progress` — formatted success/warning
6. `npm test` — all existing tests pass (no regressions)
</verification>

<success_criteria>
All 3 user-facing commands produce branded formatted output in TTY and JSON when piped. No regressions in existing tests.
</success_criteria>

<output>
After completion, create `.planning/phases/32-init-state-command-renderers/32-01-SUMMARY.md`
</output>
