---
phase: 31-quality-gates-format-testing
plan: 02
type: execute
wave: 2
depends_on:
  - 31-01
files_modified:
  - bin/format.test.cjs
autonomous: true
requirements:
  - QUAL-02

must_haves:
  truths:
    - "formatTable renders aligned columns with header separator and handles empty input"
    - "Color utility auto-disables when NO_COLOR is set"
    - "progressBar renders percentage with correct bar width"
    - "banner and box produce expected output structure"
    - "SYMBOLS exports all expected constants"
    - "truncate, relativeTime, and listWithTruncation produce correct output"
  artifacts:
    - path: "bin/format.test.cjs"
      provides: "Test coverage for all src/lib/format.js utilities"
      min_lines: 100
  key_links:
    - from: "bin/format.test.cjs"
      to: "src/lib/format.js"
      via: "direct require"
      pattern: "require.*format"
---

<objective>
Add test coverage for the new formatting utilities created in Phase 30.

Purpose: The format.js module (431 lines, 18 exports) has zero test coverage. Before downstream phases build command renderers on this foundation, we need confidence that the primitives work correctly. Tests cover documented use cases — not exhaustive edge cases.

Output: `bin/format.test.cjs` — test file covering formatTable, color, progressBar, banner, box, sectionHeader, SYMBOLS, truncate, relativeTime, and listWithTruncation.
</objective>

<execution_context>
@__OPENCODE_CONFIG__/get-shit-done/workflows/execute-plan.md
@__OPENCODE_CONFIG__/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/INTENT.md
@.planning/phases/31-quality-gates-format-testing/31-CONTEXT.md
@.planning/phases/31-quality-gates-format-testing/31-01-SUMMARY.md
@.planning/REQUIREMENTS.md
@src/lib/format.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create format utility test suite</name>
  <files>bin/format.test.cjs</files>
  <action>
Create `bin/format.test.cjs` using Node.js built-in test runner (same as existing `bin/gsd-tools.test.cjs`). This file is NOT included in the package — it's for pre-release development testing only.

**Test the documented use cases from Phase 30 spec:**

**SYMBOLS constants:**
- `SYMBOLS.check` is '✓', `SYMBOLS.cross` is '✗', `SYMBOLS.progress` is '▶', `SYMBOLS.pending` is '○'
- All expected keys exist (check, cross, progress, pending, warning, arrow, bullet, dash, heavyDash)

**Color utility:**
- `color.red('text')` wraps text in ANSI red codes when colors enabled
- `color.enabled` is false when `NO_COLOR` env var is set (test by setting env in subprocess)
- `colorByPercent(20)` returns red-range function, `colorByPercent(50)` returns yellow, `colorByPercent(80)` returns green
- `stripAnsi()` removes ANSI codes correctly

**formatTable:**
- Basic table: `formatTable(['Name', 'Status'], [['Test', '✓']])` produces aligned output with header separator (contains '─')
- Empty rows: `formatTable(['A', 'B'], [])` produces header-only output (no crash)
- Truncation: Table with >10 rows shows truncation message containing '... and'
- Column alignment: values are space-padded to align

**progressBar:**
- `progressBar(0)` contains '0%' and '░' characters
- `progressBar(100)` contains '100%' and '█' characters
- `progressBar(50)` contains '50%' and both '█' and '░'
- Width parameter controls bar length

**sectionHeader:**
- `sectionHeader('Progress')` contains 'Progress' and '━' characters
- Output width adapts (not hardcoded)

**banner:**
- `banner('TEST')` contains 'bGSD' and 'TEST'
- Banner includes '━' horizontal rule

**box:**
- `box('message', 'warning')` contains 'message'
- `box('message', 'error')` contains 'ERROR' prefix
- Box uses horizontal rules (not full box-drawing borders per user decision)

**truncate:**
- `truncate('hello world', 8)` returns 'hello w…'
- `truncate('short', 10)` returns 'short' unchanged
- `truncate('', 5)` returns '' (no crash)

**relativeTime:**
- Today's date returns 'today' or contains 'ago'
- Yesterday returns 'yesterday' or '1 day ago'
- Does not crash on invalid input

**listWithTruncation:**
- List of 5 items shows all 5 (under default threshold of 10)
- List of 15 items shows 10 + truncation message

**pad:**
- `pad('hi', 5)` returns 'hi   ' (right-padded to 5)
- `pad('hi', 5, 'right')` returns '   hi' (left-padding for right-align)

**getTerminalWidth / isTTY:**
- `getTerminalWidth()` returns a number
- `isTTY()` returns a boolean

Use `require('../src/lib/format')` to import directly (not through the CLI).
For NO_COLOR test, use `execSync` to run a subprocess with `NO_COLOR=1` env set.
  </action>
  <verify>
Run: `node bin/format.test.cjs 2>&1 | grep -c "✖"` — should be 0.
Run: `node bin/format.test.cjs 2>&1 | grep -c "✔"` — should be ≥15 (one per utility, some with multiple cases).
Run: `node bin/gsd-tools.test.cjs 2>&1 | grep -c "✖"` — still 0 (no regression from adding new test file).
  </verify>
  <done>Format utility test suite exists with ≥15 passing tests covering all exported utilities. Tests verify documented behaviors: table alignment, color auto-disable, progress bar rendering, banner branding, box types, truncation, and list truncation. No test regressions in existing suite.</done>
</task>

</tasks>

<verification>
- `node bin/format.test.cjs` — all tests pass
- `node bin/gsd-tools.test.cjs` — all existing tests still pass (no regression)
- `grep -c 'formatTable\|progressBar\|color\|banner\|SYMBOLS\|truncate' bin/format.test.cjs` — all utilities covered
</verification>

<success_criteria>
- bin/format.test.cjs exists with ≥15 tests covering format.js utilities (QUAL-02 satisfied)
- formatTable, color, progressBar, banner, box, sectionHeader, SYMBOLS, truncate, relativeTime, listWithTruncation all have at least one test
- Color auto-disable verified in non-TTY test environment
- No regressions in existing test suite
- Test file not included in package (pre-release only)
</success_criteria>

<output>
After completion, create `.planning/phases/31-quality-gates-format-testing/31-02-SUMMARY.md`
</output>
