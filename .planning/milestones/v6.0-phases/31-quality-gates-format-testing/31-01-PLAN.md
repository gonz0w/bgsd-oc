---
phase: 31-quality-gates-format-testing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/output.js
  - bin/gsd-tools.test.cjs
autonomous: true
requirements:
  - QUAL-01

must_haves:
  truths:
    - "All existing tests pass with zero failures when run via `node bin/gsd-tools.test.cjs`"
    - "Piped commands produce JSON (not rawValue text) — verified by JSON.parse succeeding on piped output of `phases list`, `current-timestamp`, `progress bar`"
    - "Commands in TTY mode still produce output (backward compat not broken)"
  artifacts:
    - path: "src/lib/output.js"
      provides: "Fixed outputJSON — ignores rawValue in json mode, always outputs structured JSON"
    - path: "bin/gsd-tools.test.cjs"
      provides: "All --raw references removed from test invocations"
  key_links:
    - from: "src/lib/output.js"
      to: "src/router.js"
      via: "outputJSON called with rawValue — now ignored in json mode"
      pattern: "outputJSON.*rawValue"
---

<objective>
Fix the root cause of 243 test failures: the outputJSON function outputs rawValue text even in json (piped) mode. Also remove stale --raw flags from test invocations.

Purpose: Phase 30 introduced TTY auto-detection but left a bug — `outputJSON(result, rawValue)` writes rawValue as plain text regardless of output mode. In piped contexts (tests, scripts), this produces text instead of JSON, breaking all tests that JSON.parse the output. This is the single root cause of 243 failures.

Output: Green test suite — all existing tests pass. Fixed output.js that correctly produces JSON when piped.
</objective>

<execution_context>
@__OPENCODE_CONFIG__/get-shit-done/workflows/execute-plan.md
@__OPENCODE_CONFIG__/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/INTENT.md
@.planning/phases/31-quality-gates-format-testing/31-CONTEXT.md
@.planning/phases/30-formatting-foundation-smart-output/30-02-SUMMARY.md
@.planning/REQUIREMENTS.md
@src/lib/output.js
@src/router.js
@bin/gsd-tools.test.cjs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix outputJSON rawValue bug and clean test --raw references</name>
  <files>src/lib/output.js, bin/gsd-tools.test.cjs</files>
  <action>
**Fix the bug in `src/lib/output.js`:**

The `outputJSON(result, rawValue)` function (lines 92-96) currently outputs `rawValue` as plain text when defined, regardless of output mode. This is wrong — in json mode (piped), it should always output JSON.

Change `outputJSON` to ignore `rawValue` in json mode:

```js
function outputJSON(result, rawValue) {
  // In json mode, ALWAYS output structured JSON — ignore rawValue.
  // rawValue was a legacy --raw feature for plain text output.
  // With TTY auto-detection, piped contexts get JSON, TTY gets formatted.
  // rawValue is only honored when explicitly in formatted/pretty mode
  // (for commands that produce simple text output like current-timestamp).
  const mode = global._gsdOutputMode || 'json';
  if (rawValue !== undefined && mode !== 'json') {
    process.stdout.write(String(rawValue));
    return;
  }
  // ... rest of existing JSON output logic (field filtering, tmpfile) unchanged
}
```

Key behavior change:
- **Before:** `outputJSON(result, rawValue)` ALWAYS outputs rawValue if defined (breaking piped JSON)
- **After:** `outputJSON(result, rawValue)` only outputs rawValue in formatted/pretty mode; in json mode, outputs the `result` object as JSON

This single fix should resolve the vast majority of the 243 failures because tests run in piped mode (execSync with stdio: pipe) → json mode → now produces JSON instead of rawValue text.

**Also update the backward-compat path in `output()`:**

The `output(result, options)` function (line 137-141) handles legacy boolean calls:
```js
if (typeof options === 'boolean') {
  outputJSON(result, arguments[2]);
  process.exit(0);
  return;
}
```

This is fine — `outputJSON` now handles mode-awareness internally. No change needed here.

**Clean --raw from test file:**

In `bin/gsd-tools.test.cjs`, remove `--raw` from all 336 test invocations. The `--raw` flag is still accepted as a silent no-op in router.js, so this is cosmetic cleanup — but it prevents confusion and ensures tests rely on auto-detection, not a deprecated flag.

Use find-and-replace: remove ` --raw` from all `runGsdTools(...)` call arguments. Be careful not to remove `--raw` from test names/descriptions or comments that discuss the behavior.

**After both fixes, run the test suite:**

```bash
node bin/gsd-tools.test.cjs 2>&1 | tail -20
```

If any tests still fail after the outputJSON fix + --raw removal, investigate individually — those are the actual broken tests from v5.0 or Phase 30 side effects. Fix them on a case-by-case basis.

**Important edge case:** Some commands use rawValue for legitimate plain-text output (e.g., `current-timestamp` outputs just a timestamp string, `generate-slug` outputs just the slug). After the fix, these will output JSON in piped mode (e.g., `{"timestamp": "2026-02-26T..."}`). Tests that expected plain text from these commands need to be updated to parse JSON instead. Check: `current-timestamp`, `generate-slug`, `progress bar`, `verify-path-exists`.
  </action>
  <verify>
Run: `node bin/gsd-tools.test.cjs 2>&1 | grep -c "✖"` — should be 0 (or very close to 0).
Run: `node bin/gsd-tools.test.cjs 2>&1 | grep -c "✔"` — should be close to the total test count.
Run: `echo "test" | node bin/gsd-tools.cjs phases list 2>/dev/null | python3 -c "import json,sys; json.load(sys.stdin); print('valid JSON')"` — should print "valid JSON".
Run: `echo "test" | node bin/gsd-tools.cjs current-timestamp 2>/dev/null | python3 -c "import json,sys; json.load(sys.stdin); print('valid JSON')"` — should print "valid JSON".
  </verify>
  <done>All existing tests pass (0 failures). Piped commands consistently produce JSON. outputJSON bug fixed — rawValue only honored in formatted/pretty mode, not json mode.</done>
</task>

</tasks>

<verification>
- `node bin/gsd-tools.test.cjs 2>&1 | grep "✖"` — zero failing tests
- `echo "" | node bin/gsd-tools.cjs phases list 2>/dev/null | head -c 1` — should be `{` (JSON object)
- `echo "" | node bin/gsd-tools.cjs init progress 2>/dev/null | head -c 1` — should be `{` (JSON object)
</verification>

<success_criteria>
- All tests pass with zero failures (QUAL-01 satisfied)
- outputJSON correctly produces JSON in piped/json mode
- rawValue only used in formatted/pretty mode
- --raw references removed from test file
</success_criteria>

<output>
After completion, create `.planning/phases/31-quality-gates-format-testing/31-01-SUMMARY.md`
</output>
