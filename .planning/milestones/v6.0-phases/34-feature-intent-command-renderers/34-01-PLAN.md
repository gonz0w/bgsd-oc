---
phase: 34-feature-intent-command-renderers
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/commands/features.js, src/commands/intent.js]
autonomous: true
requirements: [CMD-05, CMD-06]

must_haves:
  truths:
    - "velocity shows plans/day rate, forecast, and per-milestone table in formatted output"
    - "quick-summary shows milestone progress in formatted output"
    - "intent show, intent validate, and intent drift use shared formatting utilities"
    - "All commands still produce valid JSON when piped"
  artifacts:
    - path: "src/commands/features.js"
      provides: "formatVelocity and formatQuickSummary formatter functions"
      contains: "formatter"
    - path: "src/commands/intent.js"
      provides: "Updated intent formatters using shared format.js utilities"
      contains: "require.*format"
  key_links:
    - from: "src/commands/features.js"
      to: "src/lib/format.js"
      via: "import formatting primitives"
      pattern: "require.*format"
    - from: "src/commands/intent.js"
      to: "src/lib/format.js"
      via: "import formatting primitives"
      pattern: "require.*format"
---

<objective>
Add TTY-aware formatted output to 5 user-facing feature/intent commands: `velocity`, `quick-summary`, `intent show`, `intent validate`, `intent drift`.

Purpose: Complete the command renderer migration — after this plan, every user-facing command uses shared formatting.
Output: Formatter functions wired into output() calls for all 5 commands.
</objective>

<execution_context>
@__OPENCODE_CONFIG__/get-shit-done/workflows/execute-plan.md
@__OPENCODE_CONFIG__/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/30-formatting-foundation-smart-output/30-02-SUMMARY.md
@src/lib/format.js
@src/lib/output.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add formatters to velocity and quick-summary</name>
  <files>src/commands/features.js</files>
  <action>
Add `require('../lib/format')` at the top of features.js — import `banner`, `sectionHeader`, `formatTable`, `summaryLine`, `actionHint`, `color`, `SYMBOLS`, `progressBar`, `colorByPercent`.

**velocity (cmdVelocity):**

Create `formatVelocity(result)` that renders:
1. `banner('Velocity')` — branded header
2. `Milestone: {result.milestone}`
3. `sectionHeader('Metrics')` with:
   - `Plans completed: {plans_completed}`
   - `Active days: {active_days}`
   - `Average: {avg_plans_per_day} plans/day`
4. If `plan_metrics` has items: `sectionHeader('Recent Plans')` then `formatTable` with columns [Plan, Duration, Tasks, Files] (show last 10)
5. If `forecast.remaining_phases > 0`: `sectionHeader('Forecast')` with `{remaining_phases} phases, ~{estimated_remaining_plans} plans, ~{estimated_days_remaining} days`
6. `summaryLine('{avg_plans_per_day} plans/day — {remaining_phases} phases remaining')`

Change `output({...}, raw)` at line 845 to:
```js
output({...}, { formatter: formatVelocity });
```

**quick-summary (cmdQuickTaskSummary):**

Create `formatQuickSummary(result)` that renders:
1. `banner('Quick Summary')` — branded header
2. `Milestone: {result.milestone}`
3. `Total quick tasks: {result.total_quick_tasks}`
4. If tasks exist: `formatTable` with columns [#, Description, Date, Status]
5. `summaryLine('{total_quick_tasks} quick tasks completed')`

Change `output({...}, raw)` at line 1094 to:
```js
output({...}, { formatter: formatQuickSummary });
```

IMPORTANT: Do NOT touch any other feature commands — they are agent-consumed.
  </action>
  <verify>Run `node bin/gsd-tools.cjs velocity` in terminal — should show branded velocity report. Run `node bin/gsd-tools.cjs quick-summary` — should show task list. Both should produce JSON when piped.</verify>
  <done>velocity shows plans/day with forecast table, quick-summary shows task list, both produce JSON when piped</done>
</task>

<task type="auto">
  <name>Task 2: Migrate intent show, validate, and drift to shared formatting</name>
  <files>src/commands/intent.js</files>
  <action>
The intent commands already have inline TTY formatting (direct ANSI codes, `process.stdout.isTTY` checks). Migrate them to use shared `format.js` utilities for consistency.

Add `require('../lib/format')` at the top of intent.js — import `banner`, `sectionHeader`, `formatTable`, `summaryLine`, `color`, `SYMBOLS`, `box`, `colorByPercent`, `actionHint`.

**intent show (cmdIntentShow):**

Update `renderCompactSummary(data)` to use shared formatting:
- Replace `process.stdout.isTTY` check with `color` (auto-handles NO_COLOR/TTY)
- Replace header `'INTENT — Revision...'` with `banner('Intent')`
- Replace inline `\x1b[31m` etc. in `colorPriority()` with `color.red`, `color.yellow`, `color.dim`
- Use `sectionHeader('Outcomes')` instead of plain text header
- Add `summaryLine(...)` at bottom

Update `renderSection(data, section)` similarly — replace `process.stdout.isTTY` with shared color utility.

Change the output pattern in cmdIntentShow. Currently uses `output(null, true, content)` for raw text. Migrate to the formatter pattern:
- For JSON mode: `output(data, { formatter: formatIntentShow })`
- The formatter handles section filtering internally based on the parsed data

**intent validate (cmdIntentValidate):**

Create `formatIntentValidate(result)` that renders:
1. `banner('Intent Validate')` — branded header
2. Status: `result.valid ? box('Intent is valid', 'success') : box('{issues.length} issues found', 'error')`
3. `sectionHeader('Sections')` then compact section checklist using `SYMBOLS.check`/`SYMBOLS.cross` for each section
4. If issues: `sectionHeader('Issues')` with each issue on a line
5. `summaryLine(valid ? '✓ Intent valid' : '{issues.length} issues')`

Change `output(result, raw)` at line 706 to:
```js
output(result, { formatter: formatIntentValidate });
```

**intent drift (cmdIntentDrift):**

Update the existing formatted output to use shared utilities:
- Replace `process.stdout.isTTY` with `color` 
- Replace `'Intent Drift Analysis'` with `banner('Intent Drift')`
- Replace inline ANSI codes (`\x1b[32m`, `\x1b[33m`, `\x1b[31m`) with `color.green`, `color.yellow`, `color.red`
- Replace `✗` and `✓` literals with `SYMBOLS.cross` and `SYMBOLS.check`
- Replace `⚠` with `SYMBOLS.warning`
- Add `summaryLine(...)` at bottom
- Wrap in a formatter function and use `output(data, { formatter: formatIntentDrift })` pattern

Change the raw/formatted split (lines 1480-1552) to use the standard output pattern:
```js
output(data, { formatter: formatIntentDrift });
```

IMPORTANT: Preserve the `if (raw)` → JSON path for intent show's section filtering. The formatter should handle section display based on the full data object.
  </action>
  <verify>Run `node bin/gsd-tools.cjs intent show` — should use shared formatting with banner and colored priorities. Run `node bin/gsd-tools.cjs intent drift` — should use shared symbols and colors. Both should produce JSON when piped.</verify>
  <done>All 3 intent commands use shared format.js utilities (banner, color, SYMBOLS) instead of inline ANSI codes. JSON output preserved when piped.</done>
</task>

</tasks>

<verification>
1. `node bin/gsd-tools.cjs velocity` — branded velocity report with tables
2. `node bin/gsd-tools.cjs quick-summary` — formatted task list
3. `node bin/gsd-tools.cjs intent show` — banner, colored priorities
4. `node bin/gsd-tools.cjs intent validate` — section checklist with pass/fail
5. `node bin/gsd-tools.cjs intent drift` — shared SYMBOLS, color functions
6. All five piped to `| cat` produce valid JSON
7. `npm test` — all existing tests pass
</verification>

<success_criteria>
All 5 user-facing commands produce branded formatted output using shared format.js utilities. No inline ANSI codes remain in intent commands. JSON output preserved when piped. No regressions.
</success_criteria>

<output>
After completion, create `.planning/phases/34-feature-intent-command-renderers/34-01-SUMMARY.md`
</output>
