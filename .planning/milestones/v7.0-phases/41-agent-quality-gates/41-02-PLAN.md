---
phase: 41-agent-quality-gates
plan: 02
type: execute
wave: 2
depends_on: [41-01]
files_modified:
  - references/reviewer-agent.md
  - workflows/execute-plan.md
  - workflows/verify-phase.md
  - templates/summary.md
autonomous: true
requirements: [QUAL-01, QUAL-03]

must_haves:
  truths:
    - "A gsd-reviewer reference document defines how the reviewer agent checks code against conventions"
    - "The execute-plan workflow includes a post-execution review step that spawns a reviewer with fresh context"
    - "The verify-phase workflow checks for review results as part of phase verification"
    - "Review findings appear in SUMMARY.md with actionable feedback"
  artifacts:
    - path: "references/reviewer-agent.md"
      provides: "Reviewer agent behavioral instructions and review protocol"
      min_lines: 40
    - path: "workflows/execute-plan.md"
      provides: "Post-execution review step"
      contains: "review"
    - path: "workflows/verify-phase.md"
      provides: "Review result verification"
      contains: "review"
    - path: "templates/summary.md"
      provides: "Review findings section template"
      contains: "Review Findings"
  key_links:
    - from: "workflows/execute-plan.md"
      to: "references/reviewer-agent.md"
      via: "reference loading for reviewer context"
      pattern: "reviewer-agent"
    - from: "workflows/execute-plan.md"
      to: "gsd-tools review"
      via: "CLI call to assemble review context"
      pattern: "gsd-tools.*review"
    - from: "workflows/verify-phase.md"
      to: "templates/summary.md"
      via: "review findings format verification"
      pattern: "review.*findings|Review Findings"
---

<objective>
Create the gsd-reviewer agent reference and integrate post-execution code review into the execute-plan and verify-phase workflows with review findings in SUMMARY.md.

Purpose: Completes the quality gate loop — every plan execution gets a post-review by a separate agent with fresh context checking code against conventions. This is the core value of Phase 41 (QUAL-01, QUAL-03).
Output: Reviewer reference doc, updated execute-plan and verify-phase workflows, updated summary template.
</objective>

<execution_context>
@/home/cam/.config/Claude/get-shit-done/workflows/execute-plan.md
@/home/cam/.config/Claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/41-agent-quality-gates/41-01-SUMMARY.md
@workflows/execute-plan.md
@workflows/verify-phase.md
@templates/summary.md
@references/git-integration.md
@src/lib/context.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Reviewer agent reference document</name>
  <files>references/reviewer-agent.md</files>
  <action>
  Create `references/reviewer-agent.md` — the behavioral reference for the gsd-reviewer agent pattern. This is NOT a Claude Code agent definition file; it's a reference document loaded by the execute-plan workflow when performing post-execution review.

  Structure:

  ```markdown
  # Code Reviewer Reference

  <purpose>
  Review code changes from a completed plan against project conventions
  with fresh context (not the executor's spent context).
  </purpose>

  <review_protocol>

  ## 1. Load Review Context

  ```bash
  REVIEW=$(node {config_path}/bin/gsd-tools.cjs review {phase} {plan} --raw)
  ```

  This provides: recent commits, diff summary, conventions data, changed files list.

  Also load if available:
  - `.planning/codebase/CONVENTIONS.md` — project conventions
  - Plan's `must_haves` from PLAN.md frontmatter — what the plan was supposed to achieve

  ## 2. Review Dimensions

  Check each changed file against these dimensions:

  **Convention compliance:**
  - Naming patterns (files, functions, variables) match project conventions
  - Import ordering follows established patterns
  - Error handling follows project patterns
  - Code style (formatting, spacing) is consistent

  **Architectural fit:**
  - New code follows established module patterns (lazy loading, detector registry, etc.)
  - Dependencies flow in correct direction (no circular imports)
  - New exports are intentional and documented in COMMAND_HELP if CLI-facing

  **Completeness:**
  - Must-haves from plan are addressed (check against frontmatter truths)
  - No TODO/FIXME/HACK left without justification
  - Tests exist for new functionality
  - Error paths handled (not just happy path)

  **Bundle awareness:**
  - New code additions are size-conscious (bundle budget: 1000KB)
  - Lazy loading used for optional features
  - No unnecessary dependencies introduced

  ## 3. Output Format

  Produce a structured review:

  ```json
  {
    "status": "approved|changes_requested|info_only",
    "findings": [
      {
        "severity": "blocker|warning|info",
        "file": "path/to/file.js",
        "line": 42,
        "dimension": "convention|architecture|completeness|bundle",
        "finding": "Description of the issue",
        "suggestion": "How to fix it"
      }
    ],
    "summary": "One-line review summary"
  }
  ```

  - **blocker:** Must fix before phase completion (convention violation, missing error handling, architectural issue)
  - **warning:** Should fix but not blocking (naming nit, missing edge case test)
  - **info:** FYI for future consideration (optimization opportunity, pattern suggestion)

  ## 4. Review Scope

  ONLY review files changed in this plan's commits. Do NOT review:
  - Files from prior plans
  - Test files (unless test quality is a finding)
  - Planning/documentation files (.planning/, *.md in project root)
  - Generated files (bin/gsd-tools.cjs — it's a build artifact)

  </review_protocol>

  <anti_patterns>
  - Do NOT rewrite the code — only identify issues with specific suggestions
  - Do NOT review style preferences not backed by CONVENTIONS.md
  - Do NOT block on info-level findings
  - Do NOT review the same file twice in one review
  - Do NOT suggest adding dependencies to save a few lines
  </anti_patterns>
  ```

  The document should be self-contained (~60-80 lines) so a fresh agent can follow it without additional context. Use the `{config_path}` placeholder for the gsd-tools path (replaced at runtime by the workflow).
  </action>
  <verify>
  ```bash
  test -f references/reviewer-agent.md && echo "EXISTS"
  wc -l references/reviewer-agent.md  # Should be 60-80 lines
  grep -c "review_protocol\|Convention compliance\|Architectural fit\|Completeness\|Bundle awareness" references/reviewer-agent.md  # Should find all 5 sections
  ```
  </verify>
  <done>references/reviewer-agent.md exists with review protocol, 4 review dimensions, structured output format, anti-patterns, and scope rules.</done>
</task>

<task type="auto">
  <name>Task 2: Pipeline integration — execute-plan review step + verify-phase check + summary template</name>
  <files>workflows/execute-plan.md, workflows/verify-phase.md, templates/summary.md</files>
  <action>
  **1. Update execute-plan.md — add post-execution review step:**

  After the existing `parse_segments` / execution steps and BEFORE the `create_summary` step, add a new step:

  ```markdown
  <step name="post_execution_review">
  After plan execution completes (all tasks committed, before SUMMARY creation):

  1. Check if plan has `autonomous: true` and is not a gap_closure plan. Skip review for gap closures and checkpoint plans.

  2. Assemble review context:
  ```bash
  REVIEW_CTX=$(node {config_path}/bin/gsd-tools.cjs review ${PHASE_NUM} ${PLAN_NUM} --raw 2>/dev/null)
  ```

  3. If review context available (non-empty, valid JSON), perform review:
     - Load `references/reviewer-agent.md` for review protocol
     - Review the changed files against conventions using the protocol
     - Produce review findings JSON

  4. Store review findings for SUMMARY inclusion:
     - If `status: approved` — note in summary, no action needed
     - If `status: changes_requested` with blockers — list blockers, but do NOT auto-fix (reviewer suggests, executor decides in next iteration)
     - If `status: info_only` — note findings in summary for awareness

  5. Review is NON-BLOCKING for plan completion. Findings are informational for this iteration.
     Future iterations may make blockers blocking once the review pipeline is proven reliable.

  Skip conditions (do NOT review):
  - Plan has `gap_closure: true` in frontmatter
  - Plan has checkpoints (Pattern B/C) — review happens per-segment if at all
  - Review context assembly fails (no commits found, etc.)
  - Bundle is over budget (focus on fixing that first)
  </step>
  ```

  Place this step between the execution completion and SUMMARY creation in the workflow.

  **2. Update execute-plan.md — include review findings in SUMMARY creation step:**

  In the existing `create_summary` step, after the "Deviations from Plan" section guidance, add:

  ```markdown
  **Review Findings section:**
  If post_execution_review produced findings, include in SUMMARY:

  ## Review Findings

  **Status:** {approved|changes_requested|info_only}

  | Severity | File | Dimension | Finding | Suggestion |
  |----------|------|-----------|---------|------------|
  | {severity} | {file} | {dimension} | {finding} | {suggestion} |

  If no review was performed (gap closure, skipped, etc.): omit this section entirely.
  ```

  **3. Update verify-phase.md — check for review results:**

  In the `verify_requirements` step or `scan_antipatterns` step, add a check:

  ```markdown
  **Review coverage check:**
  For each SUMMARY.md in the phase:
  - Check if "Review Findings" section exists
  - If missing and plan was autonomous (not gap_closure): flag as ⚠️ "No post-execution review"
  - If present with status "changes_requested" and blockers: flag as ⚠️ "Unresolved review blockers"
  - If present with status "approved" or "info_only": ✓ Review completed

  Include review coverage in verification report:
  ```
  | Plan | Review Status | Blockers |
  |------|---------------|----------|
  | 41-01 | approved | 0 |
  | 41-02 | changes_requested | 2 |
  ```
  ```

  **4. Update templates/summary.md — add Review Findings section:**

  In the summary template, after the "Deviations from Plan" section and before "Issues Encountered", add:

  ```markdown
  ## Review Findings

  [If post-execution review was performed:]

  **Status:** {approved|changes_requested|info_only}

  | Severity | File | Dimension | Finding | Suggestion |
  |----------|------|-----------|---------|------------|
  | warning | src/lib/foo.js | convention | Missing error handling in parseX | Add try/catch with descriptive error |
  | info | src/router.js | architecture | Consider lazy-loading new module | Use lazyFoo() pattern |

  **Review summary:** [One-line summary from reviewer]

  [If no review performed:]
  Review skipped — {reason: gap closure plan / checkpoint plan / review context unavailable}
  ```

  **IMPORTANT:** These are all markdown file edits. No JS bundle changes. No impact on the 1000KB bundle budget.
  </action>
  <verify>
  ```bash
  # Verify all files updated
  grep -l "post_execution_review\|review" workflows/execute-plan.md  # Should match
  grep -l "review.*coverage\|Review Status" workflows/verify-phase.md  # Should match
  grep -l "Review Findings" templates/summary.md  # Should match
  grep -l "review_protocol" references/reviewer-agent.md  # Should match (from Task 1)
  ```
  </verify>
  <done>execute-plan.md has post-execution review step. verify-phase.md checks review coverage. summary template includes Review Findings section. All changes are markdown-only (no bundle impact).</done>
</task>

</tasks>

<verification>
- references/reviewer-agent.md exists with complete review protocol
- workflows/execute-plan.md includes post_execution_review step between execution and summary creation
- workflows/verify-phase.md includes review coverage check in verification
- templates/summary.md includes Review Findings section template
- No JS bundle changes in this plan (all markdown)
- Review protocol covers 4 dimensions: convention, architecture, completeness, bundle
- Review output is structured JSON with severity levels (blocker/warning/info)
- Review is non-blocking for this iteration (findings are informational)
</verification>

<success_criteria>
- Complete reviewer reference document enables a fresh agent to perform code review without additional context
- Execute-plan workflow automatically performs post-execution review for autonomous plans
- Verify-phase workflow checks review coverage and flags missing/blocker reviews
- Summary template captures review findings in actionable format
- Zero impact on JS bundle size
</success_criteria>

<output>
After completion, create `.planning/phases/41-agent-quality-gates/41-02-SUMMARY.md`
</output>
