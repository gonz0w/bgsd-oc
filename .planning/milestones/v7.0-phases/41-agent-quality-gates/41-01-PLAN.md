---
phase: 41-agent-quality-gates
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/commands/misc.js
  - src/lib/context.js
  - src/lib/constants.js
  - src/router.js
  - bin/gsd-tools.test.cjs
autonomous: true
requirements: [QUAL-02, QUAL-01]

must_haves:
  truths:
    - "Commits made via gsd-tools commit --agent <type> include Agent-Type trailer in commit metadata"
    - "gsd-tools review <phase> <plan> outputs diff + conventions + recent commits as JSON for reviewer consumption"
    - "AGENT_MANIFESTS includes gsd-reviewer with review-scoped fields"
  artifacts:
    - path: "src/commands/misc.js"
      provides: "cmdCommit with --agent trailer support, cmdReview for review context assembly"
      contains: "Agent-Type"
    - path: "src/lib/context.js"
      provides: "gsd-reviewer agent manifest"
      contains: "gsd-reviewer"
    - path: "src/lib/constants.js"
      provides: "COMMAND_HELP entries for review command"
      contains: "review"
  key_links:
    - from: "src/commands/misc.js"
      to: "src/lib/git.js"
      via: "execGit for trailers, structuredLog/diffSummary for review context"
      pattern: "execGit.*--trailer|structuredLog|diffSummary"
    - from: "src/router.js"
      to: "src/commands/misc.js"
      via: "case 'review' routing"
      pattern: "case.*review"
---

<objective>
Add commit attribution via git trailers and a review context CLI command that assembles diff/conventions/commits data for the reviewer agent.

Purpose: Provides the provenance tracking (QUAL-02) and data infrastructure (for QUAL-01) that the reviewer agent and pipeline integration (Plan 02) depend on.
Output: Enhanced cmdCommit with --agent flag, new `review` CLI command, gsd-reviewer manifest in AGENT_MANIFESTS.
</objective>

<execution_context>
@/home/cam/.config/Claude/get-shit-done/workflows/execute-plan.md
@/home/cam/.config/Claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/37-foundation-safety-net/37-01-SUMMARY.md
@.planning/phases/40-context-efficiency/40-01-SUMMARY.md
@src/commands/misc.js
@src/lib/context.js
@src/lib/git.js
@src/lib/constants.js
@src/router.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Commit attribution via git trailers + gsd-reviewer manifest</name>
  <files>src/commands/misc.js, src/lib/context.js, src/lib/constants.js, bin/gsd-tools.test.cjs</files>
  <action>
  **1. Add --agent flag to cmdCommit (src/commands/misc.js):**

  In the `cmdCommit` function (line ~589), parse a new `--agent` flag from args (same pattern as `--amend` and `--force`):
  ```
  const agentIdx = args.indexOf('--agent');
  const agentType = agentIdx !== -1 ? args[agentIdx + 1] : null;
  ```
  Filter `--agent` and its value from the `files` array if they appear after `--files`.

  When building commit args, if `agentType` is truthy, append git trailer:
  ```
  if (agentType) {
    commitArgs.push('--trailer', `Agent-Type: ${agentType}`);
  }
  ```
  This uses git's native `--trailer` flag (available since git 2.32) to add structured metadata to commits.

  Add `agent_type` to the output result object so callers see what was attributed:
  ```
  const result = { committed: true, hash, reason: 'committed', agent_type: agentType || null };
  ```

  **2. Add gsd-reviewer to AGENT_MANIFESTS (src/lib/context.js):**

  In the `AGENT_MANIFESTS` object (after the existing 5 agent types), add:
  ```
  'gsd-reviewer': {
    fields: ['phase_dir', 'phase_number', 'phase_name', 'codebase_conventions', 'codebase_dependencies'],
    optional: ['codebase_stats'],
    exclude: ['intent_summary', 'plan_count', 'summaries', 'incomplete_plans']
  },
  ```
  This scopes the reviewer to conventions + codebase structure data, excluding execution state.

  **3. Update COMMAND_HELP (src/lib/constants.js):**

  Add to the `commit` entry or create a note: `--agent <type>` flag for commit attribution.

  **4. Tests (bin/gsd-tools.test.cjs):**

  Add 4 tests:
  - `commit --agent gsd-executor` produces commit with Agent-Type trailer (verify via `git log --format=%b -1` or `git log --format=%(trailers) -1`)
  - `commit` without --agent produces commit WITHOUT Agent-Type trailer
  - AGENT_MANIFESTS['gsd-reviewer'] exists with expected fields
  - scopeContextForAgent with 'gsd-reviewer' returns scoped result with _agent metadata

  **BUNDLE CONSTRAINT:** The bundle is at 997KB / 1000KB. Keep additions minimal — the --agent flag is ~15 lines in cmdCommit, the manifest is ~5 lines. Total: ~20 lines of new code.
  </action>
  <verify>
  ```bash
  npm test  # All tests pass including new ones
  npm run build  # Bundle stays within 1000KB budget
  # Manual verification:
  node bin/gsd-tools.cjs commit "test: attribution check" --agent gsd-executor --files .planning/baselines/
  git log --format='%(trailers)' -1  # Should show "Agent-Type: gsd-executor"
  git reset HEAD~1  # Clean up test commit
  ```
  </verify>
  <done>cmdCommit accepts --agent flag and includes Agent-Type git trailer in commits. gsd-reviewer manifest exists in AGENT_MANIFESTS. 4 new tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Review context CLI command</name>
  <files>src/commands/misc.js, src/router.js, src/lib/constants.js, bin/gsd-tools.test.cjs</files>
  <action>
  **1. Add cmdReview function (src/commands/misc.js):**

  Create a lean `cmdReview(cwd, args, raw)` function that assembles review-ready context for a plan. Args: `<phase> <plan-number>` (e.g., `review 38 01`).

  The function should:
  1. Find the phase directory using `findPhaseInternal(cwd, phaseArg)`
  2. Find the SUMMARY.md for the plan to get commit hashes from "Task Commits" section
  3. Call `structuredLog(cwd, { count: 10 })` to get recent commits, filter to commits matching plan scope (by conventional commit scope matching `{phase}-{plan}`)
  4. Call `diffSummary(cwd, { from: firstCommitHash + '~1', to: lastCommitHash })` for the plan's total diff
  5. Load conventions from codebase-intel.json if available (via `readIntel(cwd)`, extract conventions field)
  6. Load CONVENTIONS.md content from codebase map if available: `fs.readFileSync(path.join(cwd, '.planning/codebase/CONVENTIONS.md'), 'utf-8')` with try/catch fallback to null

  Output JSON:
  ```json
  {
    "phase": "38-ast-intelligence-repo-map",
    "plan": "01",
    "commits": [...],
    "diff": { ... },
    "conventions": { ... },
    "conventions_doc": "..." ,
    "files_changed": [...]
  }
  ```

  Keep this function lean (target ~40-50 lines). Use lazy requires for git functions (they're already available via the module).

  **2. Wire into router (src/router.js):**

  Add `case "review":` that calls `lazyMisc().cmdReview(cwd, args, raw)`. Follow the existing lazy-load pattern.

  **3. Update COMMAND_HELP (src/lib/constants.js):**

  Add entry: `"review": "review <phase> <plan> — Assemble review context (diff, conventions, commits) for reviewer agent"`

  **4. Tests (bin/gsd-tools.test.cjs):**

  Add 3 tests:
  - `review` without args returns error
  - `review 37 01` (completed phase) returns JSON with commits, diff, and conventions fields
  - Output includes `files_changed` array

  **BUNDLE CONSTRAINT:** Target ~40-50 lines for cmdReview. Use existing functions (structuredLog, diffSummary from git.js, readIntel from codebase-intel.js). Do NOT add new dependencies.
  </action>
  <verify>
  ```bash
  npm test  # All tests pass
  npm run build  # Bundle within 1000KB
  node bin/gsd-tools.cjs review 37 01 --raw  # Returns JSON with commits, diff, conventions
  ```
  </verify>
  <done>`gsd-tools review <phase> <plan>` outputs review-ready JSON context. Router wired. COMMAND_HELP updated. 3 new tests pass. Bundle within budget.</done>
</task>

</tasks>

<verification>
- `npm test` passes with all existing + 7 new tests
- `npm run build` produces bundle within 1000KB budget
- `gsd-tools commit "test" --agent gsd-executor --files <file>` creates commit with Agent-Type trailer
- `gsd-tools review 37 01 --raw` returns structured JSON with commits, diff, and conventions
- `gsd-tools init execute-phase 41 --agent=gsd-reviewer --raw` returns scoped context for reviewer
</verification>

<success_criteria>
- Commits made with --agent flag contain Agent-Type git trailer verifiable via `git log --format='%(trailers)'`
- Review CLI command produces JSON context suitable for reviewer agent consumption
- gsd-reviewer agent manifest exists and scopes context appropriately
- Bundle stays within 1000KB budget
</success_criteria>

<output>
After completion, create `.planning/phases/41-agent-quality-gates/41-01-SUMMARY.md`
</output>
