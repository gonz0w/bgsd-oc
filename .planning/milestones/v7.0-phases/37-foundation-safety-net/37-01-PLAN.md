---
phase: 37-foundation-safety-net
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/git.js
  - src/commands/misc.js
  - src/router.js
  - bin/gsd-tools.test.cjs
autonomous: true
requirements: [GIT-01, GIT-02]

must_haves:
  truths:
    - "gsd-tools git log returns structured JSON with hash, author, date, message, and file stats per commit"
    - "gsd-tools git diff-summary returns files changed with insertions/deletions counts"
    - "gsd-tools git blame <file> returns line-to-commit/author mapping"
    - "gsd-tools git branch-info returns current branch, detached state, upstream tracking"
    - "gsd-tools commit blocks on dirty tree, active rebase, detached HEAD, or shallow clone unless --force"
    - "Multiple pre-commit failures are reported together in a single pass"
    - "Pre-commit block messages are terse with fix commands"
    - "All existing 574+ tests pass with zero regressions"
  artifacts:
    - path: "src/lib/git.js"
      provides: "Structured git log, diff-summary, blame, branch-info functions"
      exports: ["execGit", "structuredLog", "diffSummary", "blame", "branchInfo"]
    - path: "src/commands/misc.js"
      provides: "Pre-commit repo-state validation in cmdCommit"
      contains: "preCommitChecks"
    - path: "src/router.js"
      provides: "CLI routing for git subcommands"
      contains: "case 'git'"
  key_links:
    - from: "src/router.js"
      to: "src/lib/git.js"
      via: "lazy-loaded git module dispatch"
      pattern: "case 'git'"
    - from: "src/commands/misc.js"
      to: "src/lib/git.js"
      via: "pre-commit checks use branchInfo/execGit"
      pattern: "branchInfo\\|execGit"
---

<objective>
Add structured git intelligence and pre-commit safety checks to gsd-tools.

Purpose: GIT-01 exposes structured git log, diff-summary, blame, and branch-info through the CLI so agents and workflows can consume git data as JSON. GIT-02 adds pre-commit repo-state validation to `cmdCommit` that catches dangerous states (dirty tree, active rebase, detached HEAD, shallow clone) before writing, with `--force` bypass and terse error messages.

Output: Enhanced `git.js` module, `git` CLI subcommands, pre-commit checks in `cmdCommit`, tests for all new functionality.
</objective>

<execution_context>
@__OPENCODE_CONFIG__/get-shit-done/workflows/execute-plan.md
@__OPENCODE_CONFIG__/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/37-foundation-safety-net/37-CONTEXT.md
@src/lib/git.js
@src/commands/misc.js
@src/router.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhanced git.js with structured log, diff-summary, blame, branch-info</name>
  <files>src/lib/git.js</files>
  <action>
Expand `src/lib/git.js` with four new exported functions alongside the existing `execGit`. Follow existing module conventions: `'use strict';` at top, section dividers (`// ─── Section Name ───...`), camelCase function names, JSDoc for params/returns.

**`structuredLog(cwd, opts)`** — Returns array of commit objects.
- opts: `{ count, since, until, path, author }` (all optional, defaults: count=20)
- Calls `execGit(cwd, ['log', '--format=%H|%an|%ae|%ai|%s', ...filters])` then for each commit calls `execGit(cwd, ['diff-tree', '--no-commit-id', '--numstat', '-r', hash])` to get file stats
- Returns: `[{ hash, author, email, date, message, files: [{ path, insertions, deletions }], file_count, total_insertions, total_deletions }]`
- Parse `--numstat` output: lines are `insertions\tdeletions\tfilepath` (binary files show `-\t-\tpath`)
- Support conventional commit parsing: extract `type(scope): description` from message into `{ type, scope, description }` field (null if not conventional)

**`diffSummary(cwd, opts)`** — Returns diff stats between refs.
- opts: `{ from, to, path }` (defaults: from='HEAD~1', to='HEAD')
- Calls `execGit(cwd, ['diff', '--numstat', from, to, '--', path])` (path optional)
- Returns: `{ from, to, files: [{ path, insertions, deletions }], file_count, total_insertions, total_deletions }`

**`blame(cwd, filePath)`** — Returns line-to-commit mapping.
- Calls `execGit(cwd, ['blame', '--porcelain', filePath])`
- Parses porcelain output: extract hash, author, author-time, line content for each line
- Returns: `{ file: filePath, lines: [{ line_number, hash, author, date, content }], unique_authors: [...], unique_commits: [...] }`

**`branchInfo(cwd)`** — Returns current branch state.
- Calls multiple `execGit` for: `rev-parse --abbrev-ref HEAD`, `rev-parse HEAD`, `status --porcelain`, `rev-parse --is-shallow-repository`
- Check for active rebase: `fs.existsSync(path.join(cwd, '.git', 'rebase-merge'))` or `.git/rebase-apply`
- Returns: `{ branch, head_sha, is_detached, is_shallow, has_dirty_files, dirty_file_count, is_rebasing, upstream: { remote, branch, ahead, behind } }`
- For upstream: `execGit(cwd, ['rev-list', '--left-right', '--count', 'HEAD...@{upstream}'])` (gracefully handle no upstream case)

All functions return structured data. Errors return `{ error: string }` instead of throwing.

Module exports: `{ execGit, structuredLog, diffSummary, blame, branchInfo }`
  </action>
  <verify>
Run `npm run build` to verify the module compiles into the bundle without errors. Run `npm test` to verify zero regressions in existing tests.
  </verify>
  <done>
git.js exports 5 functions (execGit + 4 new). Each returns structured JSON. Build succeeds. All existing tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Git CLI commands + pre-commit repo-state checks + tests</name>
  <files>src/router.js, src/commands/misc.js, bin/gsd-tools.test.cjs</files>
  <action>
**Router additions (src/router.js):**

Add a `case 'git':` block in the main switch (after the existing command cases). Add a lazy loader `lazyGit()` that returns `require('./lib/git')`. Route git subcommands:

```
case 'git': {
  const gitSub = args[1];
  const gitMod = lazyGit();
  switch (gitSub) {
    case 'log': // parse --count, --since, --path, --author from remaining args
    case 'diff-summary': // parse --from, --to, --path
    case 'blame': // args[2] is file path
    case 'branch-info': // no additional args
    default: error('Unknown git subcommand: ' + gitSub);
  }
}
```

Each subcommand calls the corresponding git.js function and pipes result through `output()`. Follow the existing arg-parsing patterns in router.js (index-based `args[N]` with flag extraction).

Add COMMAND_HELP entry in `src/lib/constants.js`:
```
'git': 'git <log|diff-summary|blame|branch-info> [options] — Structured git intelligence'
```

**Pre-commit checks (src/commands/misc.js):**

Add a `preCommitChecks(cwd, force)` function before `cmdCommit`. This runs ALL checks before reporting, per user decision (report all failures together).

Checks (in order):
1. **Shallow clone**: `execGit(cwd, ['rev-parse', '--is-shallow-repository'])` — if 'true', block with "Shallow clone detected. Run `git fetch --unshallow` first."
2. **Detached HEAD**: `execGit(cwd, ['symbolic-ref', '-q', 'HEAD'])` — if exitCode !== 0, block with "Detached HEAD. Checkout a branch: `git checkout <branch>`"
3. **Active rebase**: Check `fs.existsSync(path.join(cwd, '.git', 'rebase-merge'))` or `rebase-apply` — if true, block with "Rebase in progress. Complete or abort: `git rebase --continue` or `git rebase --abort`"
4. **Dirty working tree** (files outside .planning/): `execGit(cwd, ['status', '--porcelain'])` — filter lines NOT starting with `.planning/`, if any remain, block with "Dirty working tree ({N} files). Stash: `git stash` or commit changes first."

Returns: `{ passed: boolean, failures: [{ check, message, fix }] }`

Integrate into `cmdCommit`:
- After config checks, before staging files, call `preCommitChecks(cwd, forceFlag)`
- Extract `--force` flag from args in router `case 'commit':` and pass to cmdCommit
- If `!passed && !force`: output `{ committed: false, hash: null, reason: 'pre_commit_blocked', failures }` and return
- Use distinct exit code: `process.exitCode = 2` for pre-commit blocks (vs default 1 for general errors)

**Tests (bin/gsd-tools.test.cjs):**

Add a new section at the end of the test file:

```
// ─── git commands ────────────────────────────────────────────────────────────
```

Tests for git subcommands (each in its own describe block):
- `git log` — create a temp repo with 3 commits, verify structured output has hash/author/date/message/files fields, verify file stats
- `git log --count 1` — verify only 1 commit returned
- `git diff-summary` — make a change, verify files/insertions/deletions
- `git blame` — verify line-to-commit mapping for a known file
- `git branch-info` — verify branch name, not detached, not shallow
- `git branch-info` on detached HEAD — checkout a commit hash, verify is_detached=true

Pre-commit check tests:
```
// ─── pre-commit checks ──────────────────────────────────────────────────────
```
- `commit` with dirty non-.planning files — verify blocked with reason 'pre_commit_blocked'
- `commit --force` with dirty files — verify bypass works (committed or nothing_to_commit)
- `commit` in detached HEAD — checkout hash, verify blocked
- `commit` clean state — verify normal commit proceeds

Use the existing test patterns: `createTempProject()`, `runGsdTools()`, `beforeEach`/`afterEach` temp dir lifecycle. Initialize git repos in temp dirs: `execSync('git init && git add . && git commit -m "init"', { cwd: tmpDir })`.
  </action>
  <verify>
Run `npm run build && npm test`. All existing tests pass. New git command tests pass. New pre-commit tests pass. Verify `node bin/gsd-tools.cjs git branch-info` returns valid JSON in the project root.
  </verify>
  <done>
`gsd-tools git log|diff-summary|blame|branch-info` all return structured JSON. `commit` blocks on dirty tree/detached HEAD/rebase/shallow unless `--force`. All tests pass including new ones. Distinct exit code 2 for pre-commit blocks.
  </done>
</task>

</tasks>

<verification>
1. `npm test` — all existing 574+ tests pass, new git + pre-commit tests pass
2. `node bin/gsd-tools.cjs git log --count 3` — returns JSON array of 3 commits with file stats
3. `node bin/gsd-tools.cjs git branch-info` — returns JSON with branch name, not detached
4. `node bin/gsd-tools.cjs git blame src/lib/git.js` — returns line-to-commit mapping
5. Manual test: create dirty file outside .planning/, run `node bin/gsd-tools.cjs commit "test"`, verify blocked with exit code 2
</verification>

<success_criteria>
- Enhanced git.js exports 5 functions (execGit + structuredLog + diffSummary + blame + branchInfo)
- All 4 git subcommands accessible via CLI and return structured JSON
- Pre-commit checks catch dirty tree, detached HEAD, active rebase, shallow clone
- Pre-commit failures reported together with terse messages and fix commands
- --force bypasses pre-commit checks
- Exit code 2 for pre-commit blocks
- Zero regressions in existing test suite
</success_criteria>

<output>
After completion, create `.planning/phases/37-foundation-safety-net/37-01-SUMMARY.md`
</output>
