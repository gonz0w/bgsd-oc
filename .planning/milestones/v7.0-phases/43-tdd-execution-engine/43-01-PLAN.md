---
phase: 43-tdd-execution-engine
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/commands/misc.js
  - src/router.js
  - src/lib/constants.js
  - bin/gsd-tools.test.cjs
  - bin/gsd-tools.cjs
autonomous: true
requirements: [TDD-01, TDD-02, TDD-03, TDD-04, TDD-05, EXEC-01]

must_haves:
  truths:
    - "tdd validate-red exits 0 when test command returns non-zero (test actually fails)"
    - "tdd validate-green exits 0 when test command returns zero (test passes)"
    - "tdd validate-refactor exits 0 when test command returns zero after refactor"
    - "tdd validate-red exits 1 with diagnostic when test passes (wrong — expected failure)"
    - "commit --tdd-phase red adds GSD-Phase: red trailer to commit"
    - "tdd auto-test runs test command and reports pass/fail with exit code"
    - "tdd detect-antipattern checks for common TDD violations and returns structured warnings"
  artifacts:
    - path: "src/commands/misc.js"
      provides: "cmdTdd function with validate-red, validate-green, validate-refactor, auto-test, detect-antipattern subcommands"
    - path: "src/router.js"
      provides: "tdd command routing"
    - path: "src/lib/constants.js"
      provides: "COMMAND_HELP entries for tdd subcommands"
    - path: "bin/gsd-tools.test.cjs"
      provides: "Tests for all tdd subcommands"
  key_links:
    - from: "src/router.js"
      to: "src/commands/misc.js"
      via: "lazyMisc().cmdTdd() dispatch"
      pattern: "case 'tdd':"
    - from: "src/commands/misc.js"
      to: "child_process.execSync"
      via: "test command execution in tdd validate-*"
      pattern: "execSync.*test_command"
---

<objective>
TDD validation CLI commands and commit trailer extension for orchestrator-enforced RED→GREEN→REFACTOR gates.

Purpose: Provide the machine-readable gate commands that the TDD workflow calls between phases. Without these, the orchestrator cannot verify that tests actually fail (RED), pass (GREEN), or remain passing (REFACTOR). Also adds auto-test-after-edit and anti-pattern detection as CLI commands.

Output: `tdd validate-red|validate-green|validate-refactor|auto-test|detect-antipattern` CLI commands, `--tdd-phase` commit trailer, tests.
</objective>

<execution_context>
@/home/cam/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/cam/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/commands/misc.js
@src/router.js
@src/lib/constants.js
@src/lib/git.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: TDD validation commands and commit trailer extension</name>
  <files>src/commands/misc.js, src/router.js, src/lib/constants.js</files>
  <action>
Add a `cmdTdd` function to src/commands/misc.js with these subcommands:

**`validate-red`** — Takes `--test-cmd` (the test command, e.g. `npm test`) and `--test-file` (optional, the specific test file). Runs the test command via `execSync` with a 120s timeout. Exits 0 (success) if test command returns non-zero (meaning test fails — correct for RED). Exits 1 with diagnostic JSON if test passes (meaning test should have failed but didn't). Returns JSON: `{ phase: "red", valid: true/false, test_exit_code: N, output_snippet: "..." }`. Capture first 500 chars of combined stdout+stderr as `output_snippet`.

**`validate-green`** — Same interface. Exits 0 if test command returns zero (test passes — correct for GREEN). Exits 1 with diagnostic if test fails (meaning implementation isn't working). Returns JSON: `{ phase: "green", valid: true/false, test_exit_code: N, output_snippet: "..." }`.

**`validate-refactor`** — Same as validate-green (tests must pass after refactor). Returns JSON with `phase: "refactor"`.

**`auto-test`** — Takes `--test-cmd`. Runs the test command. Returns JSON: `{ passed: true/false, exit_code: N, output_snippet: "..." }`. Does NOT set process.exitCode — the workflow decides whether to stop.

**`detect-antipattern`** — Takes `--phase` (red|green|refactor) and `--files` (comma-separated list of modified files). Checks for common TDD violations:
- In RED phase: warns if any non-test source files were modified (pre-test code)
- In GREEN phase: warns if test files were modified (test should be stable in GREEN)
- Any phase: warns if mock count exceeds 5 in any single test file (over-mocking heuristic — count `jest.mock(`, `vi.mock(`, `sinon.stub(`, `.mock(` patterns)
Returns JSON: `{ phase: "...", warnings: [{ type: "pre_test_code|test_modified_in_green|over_mocking", file: "...", message: "..." }] }`.

**Commit trailer extension:** In the existing `cmdCommit` function, add `--tdd-phase` flag parsing (similar to `--agent`). When present, adds `GSD-Phase: <value>` trailer to the commit. Value must be one of: red, green, refactor. This is additive to the existing `--agent` flag — both can be used on the same commit.

**Router wiring:** In src/router.js, add `case 'tdd':` that parses subcommand (validate-red, validate-green, validate-refactor, auto-test, detect-antipattern) and routes to `lazyMisc().cmdTdd(cwd, subcommand, parsedArgs, raw)`. Parse `--test-cmd`, `--test-file`, `--phase`, `--files` flags from args.

**Help entries:** In src/lib/constants.js, add COMMAND_HELP entries for `tdd` and its subcommands. Also update `commit` help to mention `--tdd-phase`.

**Bundle budget:** The bundle is at exactly 1000KB. To make room:
1. Keep cmdTdd implementation compact (~80-100 lines total for all subcommands)
2. Compact COMMAND_HELP text for `tdd` (single help block, not per-subcommand)
3. If still over budget, shorten existing verbose help entries (e.g. `state` which is 20+ lines)

Update the usage string in router.js to include `tdd`.
  </action>
  <verify>
1. `node bin/gsd-tools.cjs tdd --help` prints help
2. `node bin/gsd-tools.cjs tdd validate-red --test-cmd "exit 1"` returns `{ phase: "red", valid: true, ... }`
3. `node bin/gsd-tools.cjs tdd validate-red --test-cmd "exit 0"` returns `{ phase: "red", valid: false, ... }` with exit code 1
4. `node bin/gsd-tools.cjs tdd validate-green --test-cmd "exit 0"` returns `{ phase: "green", valid: true, ... }`
5. `node bin/gsd-tools.cjs tdd auto-test --test-cmd "exit 0"` returns `{ passed: true, ... }`
6. `node bin/gsd-tools.cjs tdd detect-antipattern --phase red --files "src/foo.js"` returns warnings about pre-test code
7. `npm run build` succeeds with bundle <= 1000KB
  </verify>
  <done>All 5 tdd subcommands work: validate-red/green/refactor enforce gates, auto-test reports results, detect-antipattern catches violations. cmdCommit supports --tdd-phase trailer.</done>
</task>

<task type="auto">
  <name>Task 2: Tests for TDD commands and commit trailer</name>
  <files>bin/gsd-tools.test.cjs</files>
  <action>
Add test cases to bin/gsd-tools.test.cjs in a new `describe('tdd', ...)` block:

1. **validate-red succeeds on test failure:** Run `tdd validate-red --test-cmd "exit 1"`, verify JSON has `valid: true, phase: "red"`
2. **validate-red fails on test pass:** Run `tdd validate-red --test-cmd "exit 0"`, verify JSON has `valid: false, phase: "red"` and process exit code is 1
3. **validate-green succeeds on test pass:** Run `tdd validate-green --test-cmd "exit 0"`, verify JSON has `valid: true, phase: "green"`
4. **validate-green fails on test failure:** Run `tdd validate-green --test-cmd "exit 1"`, verify JSON has `valid: false, phase: "green"`
5. **validate-refactor same as green:** Run `tdd validate-refactor --test-cmd "exit 0"`, verify JSON has `valid: true, phase: "refactor"`
6. **auto-test reports pass:** Run `tdd auto-test --test-cmd "exit 0"`, verify JSON has `passed: true`
7. **auto-test reports fail:** Run `tdd auto-test --test-cmd "exit 1"`, verify JSON has `passed: false`
8. **detect-antipattern red phase warns on source files:** Run with `--phase red --files "src/foo.js"`, verify warnings include `pre_test_code`
9. **detect-antipattern red phase clean on test files:** Run with `--phase red --files "src/foo.test.js"`, verify empty warnings
10. **GSD-Phase trailer on commit:** Create temp dir with git init, make a change, run `commit "test" --tdd-phase red --files .`, verify `git log --format=%b` contains `GSD-Phase: red`

Keep test implementations compact (use `execSync` pattern matching existing tests).
  </action>
  <verify>
`npm test` passes with all new tdd tests passing and zero regressions. Check test count increased by ~10.
  </verify>
  <done>10 tests covering all tdd subcommands and GSD-Phase trailer. Full test suite passes with zero regressions.</done>
</task>

</tasks>

<verification>
1. `npm test` passes with all tests (existing + new)
2. `npm run build` produces bundle <= 1000KB
3. All 5 tdd subcommands produce valid JSON output
4. `--tdd-phase` trailer appears in git log output
5. Anti-pattern detection catches pre-test code in RED phase
</verification>

<success_criteria>
- tdd validate-red/green/refactor CLI commands enforce TDD gates with structured JSON output
- tdd auto-test runs tests and reports results without setting exit code
- tdd detect-antipattern warns on pre-test code, test modification in GREEN, and over-mocking
- cmdCommit --tdd-phase adds GSD-Phase trailer to commits
- Bundle stays within 1000KB budget
- All tests pass with zero regressions
</success_criteria>

<output>
After completion, create `.planning/phases/43-tdd-execution-engine/43-01-SUMMARY.md`
</output>
