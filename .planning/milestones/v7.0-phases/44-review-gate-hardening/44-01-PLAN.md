---
phase: 44-review-gate-hardening
plan: 01
type: execute
wave: 1
depends_on:
  - phase: 41
    provides: "gsd-reviewer agent with convention-based review"
  - phase: 43
    provides: "TDD execution workflow with state tracking"
files_modified: []
autonomous: false
requirements:
  - QUAL-04
  - QUAL-05
  - QUAL-06
user_setup: []

must_haves:
  truths:
    - "Two-stage review: spec compliance (must_haves) → code quality (conventions/patterns)"
    - "Severity classification: BLOCKER prevents completion, WARNING/INFO are advisory"
    - "Stuck/loop detection triggers recovery after >2 retries on same error"
  artifacts:
    - path: "src/lib/review/stage-*.js"
      provides: "Two-stage review module"
    - path: "src/lib/review/severity.js"
      provides: "Severity classification logic"
    - path: "src/lib/recovery/stuck-detector.js"
      provides: "Stuck/loop detection and recovery"
  key_links:
    - gsd-reviewer reference (Phase 41)
    - TDD workflow (Phase 43)
---

<objective>
Implement review gate hardening: two-stage review, severity classification, and stuck/loop detection.
</objective>

<execution_context>
@/home/cam/.config/opencode/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@.planning/phases/44-review-gate-hardening/44-CONTEXT.md
@.planning/ROADMAP.md (Phase 44 requirements: QUAL-04, QUAL-05, QUAL-06)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Two-Stage Review Module</name>
  <files>src/lib/review/</files>
  <action>
    Create the two-stage review module that performs:
    1. Spec compliance check: validate code against plan must_haves
    2. Code quality check: validate conventions, patterns
    
    Implement in src/lib/review/stage-review.js with clear separation between stages.
  </action>
  <verify>
    Node.js can require the module without errors
  </verify>
  <done>Two-stage review module exists with spec-compliance and quality-check stages</done>
</task>

<task type="auto">
  <name>Task 2: Severity Classification System</name>
  <files>src/lib/review/severity.js</files>
  <action>
    Create severity classification system with:
    - BLOCKER: prevents task completion
    - WARNING: should fix but task can proceed  
    - INFO: FYI, no action required
    
    Integrate with existing review findings format.
  </action>
  <verify>
    Severity enum and classification function work correctly
  </verify>
  <done>Severity classification system implemented with BLOCKER/WARNING/INFO levels</done>
</task>

<task type="auto">
  <name>Task 3: Stuck/Loop Detection</name>
  <files>src/lib/recovery/stuck-detector.js</files>
  <action>
    Create stuck/loop detection module that:
    - Tracks failure patterns per task
    - Triggers recovery after >2 retries on same error
    - Provides rollback + alternative strategy suggestions
    
    Uses executor state from TDD workflow (Phase 43).
  </action>
  <verify>
    Detection logic correctly identifies stuck state after threshold
  </verify>
  <done>Stuck/loop detection triggers recovery workflow when threshold exceeded</done>
</task>

<task type="auto">
  <name>Task 4: Integration Tests</name>
  <files>tests/</files>
  <action>
    Add integration tests for:
    - Two-stage review flow
    - Severity classification
    - Stuck detection threshold
    
    Run tests to verify implementation.
  </action>
  <verify>
    npm test passes for new tests
  </verify>
  <done>All new functionality tested and passing</done>
</task>

</tasks>

<verification>
All tasks complete with passing tests
Two-stage review works: spec → quality
Severity blocks task completion when set to BLOCKER
Stuck detection triggers after >2 retries
</verification>

<success_criteria>
Two-stage review implemented and functional
Severity classification prevents completion on BLOCKER
Stuck/loop detection triggers recovery workflow
</success_criteria>

<output>
After completion, create `.planning/phases/44-review-gate-hardening/{phase}-01-SUMMARY.md`
</output>
