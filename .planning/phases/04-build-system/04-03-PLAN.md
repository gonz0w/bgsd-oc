---
phase: 04-build-system
plan: 03
type: execute
wave: 3
depends_on: [04-02]
files_modified: [deploy.sh]
autonomous: true
requirements: [BUILD-03]

must_haves:
  truths:
    - "deploy.sh calls npm run build before copying files"
    - "deploy.sh runs a smoke test after deploying"
    - "Smoke test verifies deployed artifact can execute current-timestamp --raw"
  artifacts:
    - path: "deploy.sh"
      provides: "Updated deployment script with build step and smoke test"
      contains: "npm run build"
  key_links:
    - from: "deploy.sh"
      to: "build.js"
      via: "npm run build invocation"
      pattern: "npm run build"
    - from: "deploy.sh"
      to: "deployed bin/gsd-tools.cjs"
      via: "smoke test after copy"
      pattern: "current-timestamp"
---

<objective>
Update deploy.sh to build before deploying and verify the deployed artifact works.

Purpose: With source now in src/ and bin/gsd-tools.cjs being a build artifact, deploy.sh must run the build step first. A smoke test after deployment catches broken builds before they affect real workflows.

Output: Updated deploy.sh with build step and post-deploy smoke test.
</objective>

<execution_context>
@/home/cam/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/cam/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-build-system/04-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update deploy.sh with build step and smoke test</name>
  <files>deploy.sh</files>
  <action>
Update `deploy.sh` to:

1. Run `npm run build` BEFORE copying files:
   ```bash
   echo "Building from source..."
   npm run build
   echo "  Build complete."
   ```

2. After copying files, run a smoke test:
   ```bash
   echo "Running smoke test..."
   SMOKE=$(node "$DEST/bin/gsd-tools.cjs" current-timestamp --raw 2>/dev/null)
   if [ -z "$SMOKE" ]; then
     echo "  ❌ Smoke test FAILED — deployed artifact does not execute correctly."
     echo "  Rolling back to backup..."
     rm -rf "$DEST"
     mv "$BACKUP" "$DEST"
     echo "  Rolled back successfully."
     exit 1
   fi
   echo "  ✅ Smoke test passed: $SMOKE"
   ```

3. Keep the existing backup mechanism (it creates a timestamped backup before overwriting).

4. Also copy `src/` to the destination (for debugging access to source modules, though the bundled bin/gsd-tools.cjs is the execution artifact).

5. The final deploy.sh flow should be:
   a. Build from source (`npm run build`)
   b. Back up current installation
   c. Copy bin/, workflows/, templates/, references/, src/, VERSION
   d. Smoke test deployed artifact
   e. If smoke test fails, rollback from backup
   f. Report success

6. Ensure the script still uses `set -euo pipefail` for safety.
  </action>
  <verify>
Read deploy.sh and verify it has: build step, backup, copy, smoke test, rollback on failure.
Run: `bash -n deploy.sh` — syntax check passes.
  </verify>
  <done>deploy.sh builds from source before deploying, runs smoke test after deploy, rolls back on failure.</done>
</task>

</tasks>

<verification>
1. `grep 'npm run build' deploy.sh` — build step present
2. `grep 'current-timestamp' deploy.sh` — smoke test present
3. `grep 'Rolling back' deploy.sh` — rollback on failure present
4. `bash -n deploy.sh` — no syntax errors
</verification>

<success_criteria>
- deploy.sh builds before deploying
- Smoke test verifies deployed artifact
- Automatic rollback on smoke test failure
- Existing backup mechanism preserved
</success_criteria>

<output>
After completion, create `.planning/phases/04-build-system/04-03-SUMMARY.md`
</output>
