---
phase: 24-convention-extraction
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/conventions.js
  - src/commands/codebase.js
  - src/router.js
  - bin/gsd-tools.cjs
autonomous: true
requirements: [CONV-01, CONV-02, CONV-04]

must_haves:
  truths:
    - "User can run `codebase conventions` and see naming patterns (camelCase, snake_case, etc.) with confidence percentages"
    - "User can see file organization rules (directory structure patterns, file placement)"
    - "Each detected convention has a confidence score (percentage of files following the pattern)"
    - "Only patterns above a configurable confidence threshold are shown"
  artifacts:
    - path: "src/lib/conventions.js"
      provides: "Convention extraction engine: naming detection, file-org detection, confidence scoring"
      min_lines: 150
    - path: "src/commands/codebase.js"
      provides: "cmdCodebaseConventions command handler"
      exports: ["cmdCodebaseConventions"]
  key_links:
    - from: "src/commands/codebase.js"
      to: "src/lib/conventions.js"
      via: "require() import"
      pattern: "require.*conventions"
    - from: "src/lib/conventions.js"
      to: "src/lib/codebase-intel.js"
      via: "readIntel() for file data"
      pattern: "readIntel|require.*codebase-intel"
    - from: "src/router.js"
      to: "src/commands/codebase.js"
      via: "lazyCodebase() conventions route"
      pattern: "conventions"
---

<objective>
Create the convention extraction engine and `codebase conventions` CLI command that auto-detects naming patterns (camelCase, snake_case, PascalCase, kebab-case) and file organization rules from the codebase-intel.json file data, each with confidence scoring.

Purpose: Enable agents to understand project coding conventions before generating code, reducing style mismatches and review friction.
Output: `src/lib/conventions.js` module + working `codebase conventions` command
</objective>

<execution_context>
@/home/cam/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/cam/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-infrastructure-storage/23-01-SUMMARY.md
@src/lib/codebase-intel.js
@src/commands/codebase.js
@src/router.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create conventions.js extraction engine</name>
  <files>src/lib/conventions.js</files>
  <action>
Create `src/lib/conventions.js` as a new module following the established pattern (require fs, path, and codebase-intel helpers).

**Naming pattern detection (`detectNamingConventions`):**
- Analyze file names (without extension) from codebase-intel.json `files` object keys
- Classify each filename into: camelCase, PascalCase, snake_case, kebab-case, UPPER_SNAKE_CASE, or mixed/unknown
- Regex classifiers:
  - camelCase: `/^[a-z][a-zA-Z0-9]*$/` (starts lowercase, has uppercase)
  - PascalCase: `/^[A-Z][a-zA-Z0-9]*$/` (starts uppercase)
  - snake_case: `/^[a-z][a-z0-9]*(_[a-z0-9]+)+$/`
  - kebab-case: `/^[a-z][a-z0-9]*(-[a-z0-9]+)+$/`
  - UPPER_SNAKE_CASE: `/^[A-Z][A-Z0-9]*(_[A-Z0-9]+)*$/`
- Group results by directory (e.g., `src/commands/` uses kebab-case, `src/lib/` uses kebab-case)
- Calculate confidence per directory: `(files matching dominant pattern / total files in dir) * 100`
- Also calculate overall project naming confidence
- Skip non-source files (use LANGUAGE_MAP from codebase-intel.js to filter)

**File organization detection (`detectFileOrganization`):**
- Analyze directory structure from file paths in codebase-intel.json
- Detect patterns:
  - "flat" vs "nested" organization (max depth, average depth)
  - Source file grouping (by type: commands/, lib/, tests/ OR by feature)
  - Test file placement (co-located `*.test.*` vs separate `test/` dir)
  - Config file placement (root vs config/ dir)
  - Index files presence (index.js/index.ts barrel exports)
- Each pattern gets a confidence score based on consistency

**Confidence scoring:**
- Each convention: `{ pattern: string, confidence: number (0-100), file_count: number, examples: string[] (max 3) }`
- Default threshold: 60% (configurable via parameter)
- Only return conventions above threshold unless `--all` flag

**Storage:** Return a `conventions` object suitable for merging into codebase-intel.json:
```js
{
  naming: { overall: {...}, by_directory: {...} },
  file_organization: { structure_type: ..., test_placement: ..., patterns: [...] },
  extracted_at: ISO timestamp
}
```

Export: `detectNamingConventions(intel)`, `detectFileOrganization(intel)`, `extractConventions(intel, options)` (combines both).
  </action>
  <verify>
Run: `node -e "const c = require('./src/lib/conventions'); console.log(Object.keys(c))"` — should export detectNamingConventions, detectFileOrganization, extractConventions.
Then: `node -e "const intel = require('./src/lib/codebase-intel'); const c = require('./src/lib/conventions'); const data = intel.readIntel(process.cwd()); if(data) { const r = c.extractConventions(data); console.log(JSON.stringify(r, null, 2)); } else { console.log('run codebase analyze first'); }"` — should output naming patterns and file org for this project.
  </verify>
  <done>conventions.js exports 3 functions; extractConventions returns naming patterns with confidence scores and file organization rules when given intel data</done>
</task>

<task type="auto">
  <name>Task 2: Add `codebase conventions` CLI command + router wiring</name>
  <files>src/commands/codebase.js, src/router.js, bin/gsd-tools.cjs</files>
  <action>
**In `src/commands/codebase.js`:**

Add `cmdCodebaseConventions(cwd, args, raw)` following existing command patterns:
1. Read intel via `readIntel(cwd)` — if null, error "No codebase intel. Run: codebase analyze"
2. Import `extractConventions` from `../lib/conventions`
3. Parse flags: `--all` (show below-threshold), `--threshold N` (override 60% default), `--json` (raw JSON output)
4. Call `extractConventions(intel, { threshold, showAll })`
5. Store conventions back into intel: `intel.conventions = conventions; writeIntel(cwd, intel)`
6. Output structured JSON result with:
   - `naming_patterns`: array of `{ scope, pattern, confidence, file_count, examples }`
   - `file_organization`: object with detected structure patterns
   - `total_conventions`: count of patterns found
   - `threshold_used`: the confidence threshold applied

Export `cmdCodebaseConventions` from module.

**In `src/router.js`:**

Extend the `case 'codebase':` switch block to add `conventions` subcommand:
```js
} else if (sub === 'conventions') {
  lazyCodebase().cmdCodebaseConventions(cwd, args.slice(2), raw);
}
```
Update the error message to include `conventions` in available subcommands.

**Bundle:** Rebuild `bin/gsd-tools.cjs` via the project's build process.
  </action>
  <verify>
Run: `node bin/gsd-tools.cjs codebase conventions --raw 2>/dev/null` — should output JSON with naming_patterns and file_organization.
Run: `node bin/gsd-tools.cjs codebase conventions --threshold 80 --raw 2>/dev/null` — should show fewer conventions (only high-confidence).
Run: `node bin/gsd-tools.cjs codebase conventions --all --raw 2>/dev/null` — should show all patterns including low-confidence.
  </verify>
  <done>`codebase conventions` command works, outputs naming patterns with confidence scores and file organization rules; conventions stored in codebase-intel.json</done>
</task>

</tasks>

<verification>
1. `node bin/gsd-tools.cjs codebase conventions --raw` returns valid JSON with naming patterns and confidence scores
2. Naming patterns correctly detect this project's conventions (kebab-case files, camelCase functions)
3. File organization detects this project's structure (src/ with lib/, commands/ subdirs, separate test file)
4. Confidence scores are 0-100 percentages
5. Conventions are persisted in codebase-intel.json under `conventions` key
6. All existing tests still pass
</verification>

<success_criteria>
- `codebase conventions` command produces structured JSON output with naming patterns and file organization rules
- Each convention has a confidence score (percentage)
- Only patterns above 60% threshold shown by default
- Conventions stored in codebase-intel.json for reuse
- CONV-01, CONV-02, CONV-04 requirements addressed
</success_criteria>

<output>
After completion, create `.planning/phases/24-convention-extraction/24-01-SUMMARY.md`
</output>
