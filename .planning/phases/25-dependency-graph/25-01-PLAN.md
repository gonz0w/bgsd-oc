---
phase: 25-dependency-graph
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/deps.js
  - src/commands/codebase.js
  - src/router.js
  - bin/gsd-tools.cjs
autonomous: true
requirements: [DEPS-01, DEPS-02, DEPS-03]
outcome_ids: [DO-07, DO-08]

must_haves:
  truths:
    - "User can run `codebase deps` to build a dependency graph from source files"
    - "Import parsing works for JavaScript, TypeScript, Python, Go, Elixir, and Rust"
    - "Graph uses adjacency-list representation with forward (imports) and reverse (imported-by) edges"
    - "Dependency graph is persisted in codebase-intel.json for cached reads"
  artifacts:
    - path: "src/lib/deps.js"
      provides: "Import parsers for 6 languages + dependency graph builder"
      exports: ["parseImports", "buildDependencyGraph", "IMPORT_PARSERS"]
    - path: "src/commands/codebase.js"
      provides: "cmdCodebaseDeps CLI command"
      exports: ["cmdCodebaseDeps"]
  key_links:
    - from: "src/lib/deps.js"
      to: "src/lib/codebase-intel.js"
      via: "readIntel/writeIntel for graph storage"
      pattern: "readIntel|writeIntel"
    - from: "src/commands/codebase.js"
      to: "src/lib/deps.js"
      via: "import buildDependencyGraph"
      pattern: "require.*deps"
    - from: "src/router.js"
      to: "src/commands/codebase.js"
      via: "codebase deps route"
      pattern: "deps.*lazyCodebase"
---

<objective>
Create the dependency graph engine with import parsers for 6 languages and the `codebase deps` CLI command.

Purpose: Enable module-level dependency understanding from import/require/use statements, providing the foundation for impact analysis (Plan 02) and future workflow integration (Phase 29).
Output: `src/lib/deps.js` with parsers + graph builder, `cmdCodebaseDeps` in codebase.js, router wiring.
</objective>

<execution_context>
@/home/cam/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/cam/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/STATE.md
@.planning/INTENT.md
@.planning/phases/23-infrastructure-storage/23-01-SUMMARY.md
@src/lib/codebase-intel.js
@src/commands/codebase.js
@src/router.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create dependency graph engine (src/lib/deps.js)</name>
  <files>src/lib/deps.js</files>
  <action>
Create `src/lib/deps.js` with the following components:

**Import parsers** — one regex-based parser per language, each returning an array of import specifiers (module paths or names):

1. **JavaScript/TypeScript**: Parse `require('...')`, `import ... from '...'`, `import('...')`, `export ... from '...'`. Handle both single and double quotes. Ignore comments (// and /* */). Return relative paths and package names.

2. **Python**: Parse `import X`, `from X import Y`, `from . import Y` (relative). Return module paths.

3. **Go**: Parse `import "path"` and `import (` blocks with `"path"` entries. Return import paths.

4. **Elixir**: Parse `alias Module`, `import Module`, `use Module`, `require Module`. Handle multi-alias (`alias Module.{A, B}`). Return module names.

5. **Rust**: Parse `use crate::path`, `use super::path`, `mod name`, `extern crate name`. Return crate/module paths.

**Parser registry** — `IMPORT_PARSERS` object mapping language names (matching `LANGUAGE_MAP` values from codebase-intel.js) to parser functions. Languages without a parser silently return empty arrays.

**`parseImports(filePath, content, language)`** — Look up parser by language, call it, return array of `{ raw: string, resolved: string|null }` where `resolved` attempts to map relative imports to actual file paths (using the project's file list from intel). For non-resolvable imports (packages, ambiguous), `resolved` stays null.

**`buildDependencyGraph(intel)`** — Takes full intel object, iterates over `intel.files`, calls `parseImports` for each source file (reading file content from disk using `fs.readFileSync`). Builds two adjacency lists:
- `forward`: `{ [filePath]: [importedFilePaths] }` — what each file imports
- `reverse`: `{ [filePath]: [importerFilePaths] }` — what imports each file

Only include edges where `resolved` is non-null (actual project files). Store statistics: `{ total_files_parsed, total_edges, languages_parsed, parse_errors }`.

Return `{ forward, reverse, stats, built_at }`.

**Resolution strategy** for relative imports:
- JS/TS: Try `./path`, `./path.js`, `./path.ts`, `./path/index.js`, `./path/index.ts` against intel file list
- Python: Convert dot notation to path (`from foo.bar import baz` → `foo/bar.py` or `foo/bar/__init__.py`)
- Elixir: Convert module names to file paths (`MyApp.Accounts.User` → search for files containing `defmodule MyApp.Accounts.User`)
- Go: Match by package directory name
- Rust: Convert `crate::` paths relative to `src/`

Use `LANGUAGE_MAP` from codebase-intel.js for language detection. Use `readIntel` for cached intel access.

Export: `IMPORT_PARSERS`, `parseImports`, `buildDependencyGraph`.
  </action>
  <verify>
```bash
node -e "const d = require('./src/lib/deps.js'); console.log('Exports:', Object.keys(d)); console.log('Parsers:', Object.keys(d.IMPORT_PARSERS))"
```
Should show exports and parsers for javascript, typescript, python, go, elixir, rust.
  </verify>
  <done>
`src/lib/deps.js` exists with 6 language parsers, parseImports function, and buildDependencyGraph function. Module loads without error and exports all expected functions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add codebase deps CLI command and wire router</name>
  <files>src/commands/codebase.js, src/router.js, bin/gsd-tools.cjs</files>
  <action>
**In `src/commands/codebase.js`:**

Add `cmdCodebaseDeps(cwd, args, raw)`:
1. Read intel via `readIntel(cwd)` — error if no intel exists ("No codebase intel. Run: codebase analyze")
2. Import `buildDependencyGraph` from `../lib/deps`
3. Call `buildDependencyGraph(intel)` to build the graph
4. Store result in `intel.dependencies` and write back via `writeIntel(cwd, intel)`
5. Output structured JSON:
   ```json
   {
     "success": true,
     "stats": { "total_files_parsed": N, "total_edges": N, "languages_parsed": [...], "parse_errors": N },
     "top_dependencies": [...],  // Top 10 files by reverse-edge count (fan-in), sorted descending
     "built_at": "ISO timestamp"
   }
   ```
6. `top_dependencies` entries: `{ file: string, imported_by_count: number }`

Add `--cycles` flag handling stub (just a note in the code that Plan 02 adds cycle detection).

Export `cmdCodebaseDeps` in module.exports.

**In `src/router.js`:**

Add `deps` case to the codebase switch block (alongside analyze/status/conventions/rules):
```javascript
} else if (sub === 'deps') {
  lazyCodebase().cmdCodebaseDeps(cwd, args.slice(2), raw);
}
```

Also add `impact` case for Plan 02 readiness:
```javascript
} else if (sub === 'impact') {
  lazyCodebase().cmdCodebaseImpact(cwd, args.slice(2), raw);
}
```

Update the error message to include deps and impact in the usage string.

**Rebuild bundle:**
```bash
node build.js
```

Verify bundle stays within 700KB budget.
  </action>
  <verify>
```bash
# Build and verify bundle size
node build.js 2>&1 | tail -5

# Test deps command on the project itself
node bin/gsd-tools.cjs codebase deps --raw 2>/dev/null | node -e "const d=JSON.parse(require('fs').readFileSync('/dev/stdin','utf8')); console.log('Success:', d.success, 'Edges:', d.stats.total_edges, 'Files:', d.stats.total_files_parsed)"

# Verify router help includes deps
node bin/gsd-tools.cjs codebase --raw 2>&1 | grep -i deps
```
  </verify>
  <done>
`codebase deps` command builds dependency graph from project source files, stores in codebase-intel.json, and reports statistics. Router properly routes `codebase deps` and `codebase impact`. Bundle builds within 700KB budget.
  </done>
</task>

</tasks>

<verification>
1. `node bin/gsd-tools.cjs codebase deps --raw` succeeds and returns JSON with `success: true`
2. `.planning/codebase/codebase-intel.json` contains `dependencies` field with `forward` and `reverse` adjacency lists
3. `stats.total_edges` > 0 (project has imports)
4. `stats.languages_parsed` includes at least `javascript` (the project itself is JS)
5. Bundle size remains within 700KB
</verification>

<success_criteria>
- `codebase deps` builds forward + reverse adjacency-list graph stored in intel JSON (DEPS-01, DEPS-03)
- Import parsing covers JavaScript, TypeScript, Python, Go, Elixir, Rust via regex (DEPS-02)
- Graph persists in codebase-intel.json for cached access by subsequent commands
- Running on gsd-opencode's own codebase produces a meaningful graph (>0 edges)
</success_criteria>

<output>
After completion, create `.planning/phases/25-dependency-graph/25-01-SUMMARY.md`
</output>
