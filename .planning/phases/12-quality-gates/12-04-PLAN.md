---
phase: 12-quality-gates
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/commands/verify.js
  - src/lib/constants.js
  - src/router.js
  - bin/gsd-tools.test.cjs
  - bin/gsd-tools.cjs
autonomous: true
requirements:
  - PLAN-04
  - PLAN-05
  - PLAN-06

must_haves:
  truths:
    - "verify plan-wave detects shared file modifications within a wave"
    - "verify plan-deps detects dependency cycles and unreachable tasks"
    - "verify plan-structure validates plans against template expected structure"
  artifacts:
    - path: "src/commands/verify.js"
      provides: "cmdVerifyPlanWave, cmdVerifyPlanDeps"
      contains: "cmdVerifyPlanWave"
    - path: "bin/gsd-tools.test.cjs"
      provides: "plan validation tests"
      contains: "describe.*verify plan-wave"
  key_links:
    - from: "src/commands/verify.js"
      to: "PLAN.md files"
      via: "extractFrontmatter for files_modified, depends_on"
      pattern: "files_modified"
---

<objective>
Create plan validation commands for wave-aware decomposition checks, dependency analysis, and template enforcement.

Purpose: Catch plan structural issues before execution — file conflicts in parallel waves, dependency cycles, and missing required sections.

Output: New `verify plan-wave`, `verify plan-deps` subcommands, and enhanced `verify plan-structure` template checking.
</objective>

<execution_context>
@/home/cam/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/cam/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/codebase/CONVENTIONS.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Plan wave and dependency validation commands</name>
  <files>
    src/commands/verify.js
    src/lib/constants.js
    src/router.js
    bin/gsd-tools.cjs
  </files>
  <action>
Add plan validation commands to `src/commands/verify.js`:

**`cmdVerifyPlanWave(cwd, phasePath, raw)`** — Validate wave file conflicts (PLAN-04).
- Read all PLAN.md files in the phase directory
- Extract `wave` and `files_modified` from each plan's frontmatter
- Group plans by wave number
- Within each wave, check for file overlaps between plans
- Output:
  ```json
  {
    "phase": "12",
    "waves": { "1": ["12-01", "12-03", "12-04"], "2": ["12-02"] },
    "conflicts": [
      { "wave": 1, "file": "src/commands/verify.js", "plans": ["12-01", "12-03"] }
    ],
    "verdict": "conflicts_found"|"clean"
  }
  ```

**`cmdVerifyPlanDeps(cwd, phasePath, raw)`** — Validate dependency graph (PLAN-05).
- Read all PLAN.md files, extract `depends_on` and `plan` from frontmatter
- Build directed dependency graph
- Detect:
  1. **Cycles**: A depends on B, B depends on A (use DFS with visited/in-stack sets)
  2. **Unreachable**: Plans that depend on non-existent plan IDs
  3. **Unnecessary serialization**: Plans in sequential waves that have no actual dependency (could be parallel)
- Output:
  ```json
  {
    "phase": "12",
    "plan_count": 4,
    "dependency_graph": { "12-01": [], "12-02": ["12-01"], "12-03": [], "12-04": [] },
    "issues": [
      { "type": "cycle", "plans": ["12-01", "12-02"] },
      { "type": "unreachable", "plan": "12-05", "depends_on": "12-99" }
    ],
    "verdict": "clean"|"issues_found"
  }
  ```

**Enhance existing `cmdVerifyPlanStructure`** — Add template enforcement (PLAN-06).
- After existing structure validation, also check:
  1. Frontmatter has all required fields per plan type (execute: wave, depends_on, files_modified, autonomous, requirements, must_haves)
  2. For `type: tdd` plans: verify `<feature>` block exists instead of `<tasks>`
  3. Verify `requirements` field is non-empty array
  4. Verify task `<name>`, `<action>`, `<verify>`, `<done>` elements exist in each task
- Add `template_compliance` to existing output:
  ```json
  { "template_compliance": { "valid": true, "missing_fields": [], "type_issues": [] } }
  ```

Wire all commands:
- `verify plan-wave <phase-dir>` → cmdVerifyPlanWave
- `verify plan-deps <phase-dir>` → cmdVerifyPlanDeps
- Enhanced plan-structure already wired
- Add COMMAND_HELP entries

Run `npm run build`.
  </action>
  <verify>
Run `npm run build` — succeeds.
Run `node bin/gsd-tools.cjs verify plan-wave .planning/phases/12-quality-gates --raw` — returns wave analysis.
Run `node bin/gsd-tools.cjs verify plan-deps .planning/phases/12-quality-gates --raw` — returns dependency analysis.
Run `node bin/gsd-tools.cjs verify plan-structure .planning/phases/12-quality-gates/12-01-PLAN.md --raw` — returns structure check with template_compliance.
  </verify>
  <done>
Wave conflict detection, dependency cycle detection, and template enforcement exist as verify subcommands.
  </done>
</task>

<task type="auto">
  <name>Task 2: Plan validation test suite</name>
  <files>
    bin/gsd-tools.test.cjs
  </files>
  <action>
Add test suites:

**`describe('verify plan-wave')`** — 3 tests:
1. Detects file conflicts within a wave (two plans in wave 1 modify same file)
2. Returns clean when no conflicts exist
3. Handles phase with single plan

**`describe('verify plan-deps')`** — 4 tests:
1. Detects dependency cycle (A→B→A)
2. Detects unreachable dependency (depends on non-existent plan)
3. Returns clean for valid graph
4. Detects unnecessary serialization (sequential but independent)

**`describe('verify plan-structure template')`** — 3 tests:
1. Detects missing required frontmatter fields
2. Validates TDD plan structure
3. Returns valid for well-formed plan

Run `npm test` — all pass.
  </action>
  <verify>
Run `npm test` — all tests pass (0 failures).
  </verify>
  <done>
10 test cases covering wave conflicts, dependency cycles, unreachable deps, unnecessary serialization, and template enforcement. All pass.
  </done>
</task>

</tasks>

<verification>
- `npm run build` succeeds
- `npm test` passes all tests
- Wave validation detects file conflicts within parallel waves
- Dependency validation catches cycles and unreachable references
- Template enforcement checks plan structure completeness
</verification>

<success_criteria>
- Wave conflict detection for parallel plan execution
- Dependency cycle detection using DFS
- Unreachable dependency detection
- Template enforcement for plan structure compliance
- 10+ new tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/12-quality-gates/12-04-SUMMARY.md`
</output>
