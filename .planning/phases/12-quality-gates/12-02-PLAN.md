---
phase: 12-quality-gates
plan: 02
type: execute
wave: 2
depends_on:
  - "12-01"
files_modified:
  - src/commands/verify.js
  - src/lib/constants.js
  - src/router.js
  - bin/gsd-tools.test.cjs
  - bin/gsd-tools.cjs
autonomous: true
requirements:
  - VRFY-04
  - VRFY-05
  - VRFY-06

must_haves:
  truths:
    - "verify deliverables checks must_haves from plan frontmatter against actual files on disk"
    - "Quality score combines multiple dimensions into a 0-100 score"
    - "Quality scores are stored in memory for trend tracking"
  artifacts:
    - path: "src/commands/verify.js"
      provides: "cmdVerifyQuality, quality scoring logic"
      contains: "cmdVerifyQuality"
    - path: "bin/gsd-tools.test.cjs"
      provides: "quality scoring tests"
      contains: "describe.*verify quality"
  key_links:
    - from: "src/commands/verify.js"
      to: ".planning/memory/quality-scores.json"
      via: "memory write for trend storage"
      pattern: "quality-scores"
---

<objective>
Add goal-backward must_haves verification, multi-dimensional quality scoring, and score trend tracking.

Purpose: Verify that plans actually produced what they promised (must_haves) and provide a composite quality score across tests, requirements, regressions, and must_haves.

Output: Enhanced `verify deliverables` with must_haves checking, new `verify quality` score command, and score trend persistence.
</objective>

<execution_context>
@/home/cam/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/cam/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/codebase/CONVENTIONS.md
@.planning/phases/12-quality-gates/12-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Quality scoring and trend tracking</name>
  <files>
    src/commands/verify.js
    src/lib/constants.js
    src/router.js
    bin/gsd-tools.cjs
  </files>
  <action>
Add quality scoring to `src/commands/verify.js`:

**`cmdVerifyQuality(cwd, options, raw)`** — Produce multi-dimensional quality score (VRFY-04, VRFY-05, VRFY-06).
- Accept `--plan <path>` to specify which plan to verify
- Accept `--phase <number>` to verify entire phase
- Run multiple verification dimensions:
  1. **Tests** (weight 30%): Run `verify deliverables`, get pass/fail. Score: 100 if pass, 0 if fail.
  2. **Must-haves** (weight 30%): Read plan's YAML frontmatter `must_haves`. Check:
     - `artifacts`: For each, verify file exists at `path`. If `contains` specified, verify file content matches pattern. If `exports` specified, verify exported names exist.
     - `key_links`: For each, verify `from` file contains `pattern` regex.
     - Score: (verified_items / total_items) * 100
  3. **Requirements** (weight 20%): Run `verify requirements` for the phase. Score: (addressed / total) * 100.
  4. **Regression** (weight 20%): Check if any regressions exist. Score: 100 if none, 0 if any.
- Compute composite score: weighted average of dimensions.
- Store score in `.planning/memory/quality-scores.json` via memory write pattern (manual JSON write, not CLI call):
  ```json
  { "phase": "12", "plan": "01", "score": 85, "dimensions": {...}, "timestamp": "..." }
  ```
- If previous scores exist for this phase, include trend: `trend: "improving"|"declining"|"stable"` (compare last 3 scores).
- Output:
  ```json
  {
    "score": 85,
    "grade": "B",
    "dimensions": {
      "tests": { "score": 100, "weight": 30, "detail": "all pass" },
      "must_haves": { "score": 80, "weight": 30, "detail": "4/5 verified" },
      "requirements": { "score": 100, "weight": 20, "detail": "all addressed" },
      "regression": { "score": 100, "weight": 20, "detail": "no regressions" }
    },
    "trend": "stable",
    "plan": "12-01",
    "phase": "12"
  }
  ```
- Grade mapping: 90+ = A, 80+ = B, 70+ = C, 60+ = D, below = F.

Wire into router:
- Add `quality` subcommand to verify routing
- Add COMMAND_HELP for `verify quality`

Run `npm run build`.
  </action>
  <verify>
Run `npm run build` — succeeds.
Run `node bin/gsd-tools.cjs verify quality --phase 10 --raw` — returns quality score JSON.
Run `node bin/gsd-tools.cjs verify quality --help` — shows help text.
  </verify>
  <done>
Quality scoring command exists with 4 weighted dimensions, grade mapping, trend tracking, and score persistence. Produces structured JSON output.
  </done>
</task>

<task type="auto">
  <name>Task 2: Quality scoring test suite</name>
  <files>
    bin/gsd-tools.test.cjs
  </files>
  <action>
Add `describe('verify quality')` test suite:

1. **Returns composite score with all dimensions** — Create a tmp project with plan, requirements, test results. Verify score is 0-100 and all dimensions present.
2. **Grade mapping works** — Verify score 95 → "A", 85 → "B", etc.
3. **Must-haves verification checks file existence** — Create plan with must_haves artifacts, verify some files exist and some don't. Score reflects reality.
4. **Stores score in quality-scores.json** — Run quality check, verify .planning/memory/quality-scores.json updated.
5. **Trend tracking compares to previous scores** — Write 2 previous scores, run quality check, verify trend field is present.
6. **Handles missing plan gracefully** — Run without --plan or --phase, get reasonable default or error.

Run `npm test` — all pass.
  </action>
  <verify>
Run `npm test` — all tests pass (0 failures).
  </verify>
  <done>
6 test cases covering quality scoring dimensions, grade mapping, must-haves verification, score persistence, and trend tracking. All pass.
  </done>
</task>

</tasks>

<verification>
- `npm run build` succeeds
- `npm test` passes all tests
- `verify quality` produces composite score with all 4 dimensions
- Score stored in memory for trend tracking
- Grade mapping (A-F) works correctly
</verification>

<success_criteria>
- Quality scoring with 4 weighted dimensions (tests, must_haves, requirements, regression)
- Grade mapping (A-F) based on composite score
- Score trend tracking (improving/declining/stable)
- Must-haves verification: checks file existence and content patterns
- 6+ new tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/12-quality-gates/12-02-SUMMARY.md`
</output>
