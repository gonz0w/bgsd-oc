---
phase: 12-quality-gates
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/commands/verify.js
  - src/lib/constants.js
  - src/router.js
  - bin/gsd-tools.test.cjs
  - bin/gsd-tools.cjs
autonomous: true
requirements:
  - PLAN-01
  - PLAN-02
  - PLAN-03

must_haves:
  truths:
    - "analyze-plan detects multi-concern plans by grouping tasks by file clusters"
    - "analyze-plan scores plans 1-5 on single-responsibility adherence"
    - "analyze-plan suggests how to split poorly-scoring plans"
  artifacts:
    - path: "src/commands/verify.js"
      provides: "cmdAnalyzePlan function"
      contains: "cmdAnalyzePlan"
    - path: "bin/gsd-tools.test.cjs"
      provides: "plan analysis tests"
      contains: "describe.*analyze-plan"
  key_links:
    - from: "src/commands/verify.js"
      to: "PLAN.md files"
      via: "extractFrontmatter + task parsing"
      pattern: "extractFrontmatter"
---

<objective>
Create plan analysis commands for complexity detection, single-responsibility scoring, and split suggestions.

Purpose: Enable automated detection of plans that try to do too much, with concrete suggestions for how to split them.

Output: New `verify analyze-plan` subcommand with SR scoring, concern grouping, and split recommendations.
</objective>

<execution_context>
@/home/cam/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/cam/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/codebase/CONVENTIONS.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Plan analysis command</name>
  <files>
    src/commands/verify.js
    src/lib/constants.js
    src/router.js
    bin/gsd-tools.cjs
  </files>
  <action>
Add plan analysis command to `src/commands/verify.js`:

**`cmdAnalyzePlan(cwd, planPath, raw)`** — Analyze a plan for single-responsibility (PLAN-01, PLAN-02, PLAN-03).

- Read the PLAN.md file, extract frontmatter and parse tasks
- Use `extractFrontmatter()` for YAML, regex for `<task>...</task>` blocks

**Concern Analysis (PLAN-01):**
- Group tasks by their `<files>` elements
- Compute file clusters: tasks that share files are in the same concern
- Tasks with no file overlap are separate concerns
- A plan with 3+ separate concerns is flagged as "multi-concern"

**SR Scoring (PLAN-02):**
Score 1-5 based on:
- **5 (Excellent):** 1 concern group, all tasks share files or logical area, ≤3 tasks
- **4 (Good):** 1-2 concern groups, moderate file overlap, 2-3 tasks
- **3 (Acceptable):** 2 concern groups with some overlap, 3 tasks
- **2 (Poor):** 3+ concern groups, 4+ tasks, diverse file paths
- **1 (Bad):** 4+ concerns, tasks in unrelated subsystems, 5+ tasks

Factors to consider:
- Number of distinct file directories touched
- Whether files are in same module (e.g., all in `src/commands/`) vs scattered
- Task count
- Whether tasks have cross-dependencies (one task's output used by another)

**Split Suggestions (PLAN-03):**
For plans scoring ≤ 3:
- Group tasks by concern clusters
- Suggest N new plans, each containing tasks from one concern
- Output suggested file modifications per new plan

**Output format:**
```json
{
  "plan": "12-01",
  "sr_score": 4,
  "sr_label": "Good",
  "concern_count": 2,
  "concerns": [
    { "group": 1, "tasks": ["Task 1"], "files": ["src/commands/verify.js"], "area": "commands" },
    { "group": 2, "tasks": ["Task 2"], "files": ["bin/gsd-tools.test.cjs"], "area": "tests" }
  ],
  "task_count": 2,
  "files_total": 5,
  "directories_touched": 3,
  "split_suggestion": null,
  "flags": []
}
```

For a poorly-scoring plan, `split_suggestion` would be:
```json
{
  "recommended_splits": 2,
  "proposed_plans": [
    { "concern": "verification commands", "tasks": ["Task 1"], "files": ["src/commands/verify.js", "src/router.js"] },
    { "concern": "test suite", "tasks": ["Task 2", "Task 3"], "files": ["bin/gsd-tools.test.cjs"] }
  ]
}
```

Wire as `verify analyze-plan <path>` in router. Add COMMAND_HELP entry.

Run `npm run build`.
  </action>
  <verify>
Run `npm run build` — succeeds.
Run `node bin/gsd-tools.cjs verify analyze-plan .planning/phases/12-quality-gates/12-01-PLAN.md --raw` — returns analysis JSON.
  </verify>
  <done>
Plan analysis command exists with concern grouping, SR scoring (1-5), and split suggestions for poorly-scoring plans.
  </done>
</task>

<task type="auto">
  <name>Task 2: Plan analysis test suite</name>
  <files>
    bin/gsd-tools.test.cjs
  </files>
  <action>
Add `describe('verify analyze-plan')` test suite:

1. **Scores well-structured plan as 4-5** — Create a minimal 2-task plan with shared files. Expect SR score ≥ 4.
2. **Scores multi-concern plan as 1-2** — Create a plan with 4 tasks in unrelated directories. Expect SR score ≤ 2.
3. **Detects concern groups** — Create a plan with 2 distinct file clusters. Verify `concern_count` === 2.
4. **Suggests splits for poor plans** — Create a poorly-scoring plan. Verify `split_suggestion` is non-null with recommended_splits.
5. **Handles single-task plans** — Create a 1-task plan. Verify SR score === 5.
6. **Handles missing plan file gracefully** — Verify error or graceful failure for non-existent path.

Run `npm test` — all pass.
  </action>
  <verify>
Run `npm test` — all tests pass (0 failures).
  </verify>
  <done>
6 test cases covering SR scoring ranges, concern detection, split suggestions, and edge cases. All pass.
  </done>
</task>

</tasks>

<verification>
- `npm run build` succeeds
- `npm test` passes all tests
- `verify analyze-plan` scores plans 1-5 on single-responsibility
- Multi-concern plans are flagged with split suggestions
</verification>

<success_criteria>
- Plan analysis with concern grouping and SR scoring (1-5)
- Split suggestions for plans scoring ≤ 3
- Concern detection based on file clustering
- 6+ new tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/12-quality-gates/12-03-SUMMARY.md`
</output>
