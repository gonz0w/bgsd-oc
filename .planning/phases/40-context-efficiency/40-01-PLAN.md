---
phase: 40-context-efficiency
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/context.js
  - src/commands/init.js
  - src/lib/constants.js
  - bin/gsd-tools.test.cjs
autonomous: true
requirements: [CTX-02, CTX-03]

must_haves:
  truths:
    - "Each agent type declares required context fields via manifest"
    - "Compact serialization reduces plan state tokens by 70-80%"
    - "Dependency graphs serialize 50-60% smaller with compact format"
    - "init commands respect agent manifests when --agent flag is provided"
  artifacts:
    - path: "src/lib/context.js"
      provides: "Agent manifests, compact serializers, context scoping"
      exports: ["AGENT_MANIFESTS", "compactPlanState", "compactDepGraph", "scopeContextForAgent"]
  key_links:
    - from: "src/commands/init.js"
      to: "src/lib/context.js"
      via: "scopeContextForAgent for --agent flag"
      pattern: "scopeContextForAgent|AGENT_MANIFESTS"
---

<objective>
Add agent context manifests (declaring what each agent type needs) and compact serialization formats that reduce plan state tokens by 70-80% and dependency graphs by 50-60%. Wire agent-scoped output into init commands via --agent flag.

Purpose: Agents currently receive full init output regardless of their role. Executors don't need intent drift scores, researchers don't need worktree config. Manifests let the system provide only declared context at spawn, reducing token waste.
Output: Extended src/lib/context.js with manifests and serializers, enhanced init commands, tests
</objective>

<execution_context>
@/home/cam/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/cam/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/lib/context.js
@src/commands/init.js (lines 140-424 — cmdInitExecutePhase)
@src/lib/constants.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Agent manifests + compact serializers</name>
  <files>src/lib/context.js</files>
  <action>
Extend the existing `src/lib/context.js` (currently 97 lines) with:

**AGENT_MANIFESTS** — Data object declaring what each agent type needs:

```js
const AGENT_MANIFESTS = {
  'gsd-executor': {
    fields: ['phase_dir', 'phase_number', 'phase_name', 'plans', 'incomplete_plans',
             'plan_count', 'incomplete_count', 'branch_name', 'commit_docs',
             'verifier_enabled', 'task_routing', 'env_summary'],
    optional: ['codebase_conventions', 'codebase_dependencies'],
    exclude: ['intent_drift', 'intent_summary', 'worktree_config', 'worktree_active',
              'file_overlaps', 'codebase_freshness', 'codebase_stats'],
  },
  'gsd-verifier': {
    fields: ['phase_dir', 'phase_number', 'phase_name', 'plans', 'summaries',
             'verifier_enabled'],
    optional: ['codebase_stats'],
    exclude: ['intent_drift', 'intent_summary', 'task_routing', 'worktree_config',
              'worktree_active', 'file_overlaps', 'env_summary', 'branch_name',
              'codebase_conventions', 'codebase_dependencies'],
  },
  'gsd-planner': {
    fields: ['phase_dir', 'phase_number', 'phase_name', 'plan_count',
             'research_enabled', 'plan_checker_enabled', 'intent_summary'],
    optional: ['codebase_stats', 'codebase_conventions', 'codebase_dependencies',
               'codebase_freshness', 'env_summary'],
    exclude: ['task_routing', 'worktree_config', 'worktree_active', 'file_overlaps',
              'branch_name'],
  },
  'gsd-phase-researcher': {
    fields: ['phase_dir', 'phase_number', 'phase_name', 'intent_summary'],
    optional: ['codebase_stats', 'env_summary'],
    exclude: ['task_routing', 'worktree_config', 'worktree_active', 'file_overlaps',
              'branch_name', 'verifier_enabled', 'plans', 'incomplete_plans'],
  },
  'gsd-plan-checker': {
    fields: ['phase_dir', 'phase_number', 'phase_name', 'plans', 'plan_count'],
    optional: ['codebase_stats', 'codebase_dependencies'],
    exclude: ['intent_drift', 'intent_summary', 'task_routing', 'worktree_config',
              'worktree_active', 'file_overlaps', 'env_summary', 'branch_name'],
  },
};
```

**`scopeContextForAgent(result, agentType)`** — Filters init output to agent-declared fields:
- Look up manifest for agentType (fall back to returning full result if unknown agent)
- Keep only fields in `fields` + `optional` arrays
- Strip null/undefined optional fields
- Return scoped object with `_agent: agentType` metadata field
- Return `_savings: { original_keys, scoped_keys, reduction_pct }` for transparency

**`compactPlanState(stateRaw)`** — Compresses STATE.md content to essential fields:
- Parse the state markdown text
- Extract: current_phase, plan_progress (e.g. "2/3"), status, last_activity date
- Strip: full performance metrics table, velocity history, session continuity details
- Return compact object (target: 70-80% fewer tokens than raw markdown)
```js
{
  phase: "39",
  progress: "1/1 complete",
  status: "Phase complete",
  last_activity: "2026-02-27",
  decisions: ["Use acorn with module→script fallback", ...],  // last 3-5 only
  blockers: []
}
```

**`compactDepGraph(depData)`** — Compresses dependency graph to essentials:
- Input: full codebase_dependencies object from init output
- Keep: total_modules, total_edges, top_imported (top 5 only), has_cycles
- Strip: full module list, edge details, cycle paths
- Return compact object (target: 50-60% smaller)

Export all new functions and AGENT_MANIFESTS from the module.

**IMPORTANT: Bundle size awareness.** The current bundle is ~1009KB against a 1000KB budget. Keep implementations lean:
- Reuse existing regex patterns from helpers.js where possible
- Avoid importing new modules — context.js already has what's needed
- Use string operations for STATE.md parsing, not heavy frameworks
- AGENT_MANIFESTS is just a data object — minimal code weight
  </action>
  <verify>
`npm run build` succeeds and bundle stays under 1020KB. `node -e "const c = require('./src/lib/context'); console.log(Object.keys(c))"` shows new exports.
  </verify>
  <done>
AGENT_MANIFESTS declares context needs for 5 agent types. scopeContextForAgent filters init output by agent type. compactPlanState reduces STATE.md to essential fields (70-80% reduction). compactDepGraph reduces dependency data by 50-60%.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire into init commands + tests</name>
  <files>src/commands/init.js, src/lib/constants.js, bin/gsd-tools.test.cjs</files>
  <action>
**In src/commands/init.js — cmdInitExecutePhase:**

After building the full result object and before the compact mode check (~line 370), add agent scoping:

```js
// Agent-scoped context — filter output to agent-declared fields
const agentArg = args.find(a => a.startsWith('--agent='));
const agentType = agentArg ? agentArg.split('=')[1] : (process.argv.find(a => a.startsWith('--agent=')) || '').split('=')[1];
if (agentType) {
  const { scopeContextForAgent } = require('../lib/context');
  const scoped = scopeContextForAgent(result, agentType);
  return output(scoped, raw);
}
```

Also add the same pattern to `cmdInitPlanPhase` for planner/researcher scoping.

**In src/lib/constants.js:**

Update the `init` COMMAND_HELP to document the new `--agent` flag:
```
  --agent=<type>  Scope output to agent's declared context (e.g. --agent=gsd-executor)
```

**Tests (10-12 new):**

1. AGENT_MANIFESTS — has entries for gsd-executor, gsd-verifier, gsd-planner, gsd-phase-researcher, gsd-plan-checker
2. scopeContextForAgent — gsd-executor gets task_routing but not intent_drift
3. scopeContextForAgent — gsd-verifier gets phase_dir but not task_routing
4. scopeContextForAgent — unknown agent returns full result
5. scopeContextForAgent — _savings shows reduction percentage
6. compactPlanState — reduces STATE.md to compact object with phase, progress, status
7. compactPlanState — decisions limited to last 5
8. compactPlanState — empty/missing state returns sensible defaults
9. compactDepGraph — reduces dep data, keeps top_imported capped at 5
10. compactDepGraph — null/undefined input returns empty object
11. init execute-phase --agent=gsd-executor — returns scoped output (integration test)
12. init execute-phase --agent=gsd-verifier — returns fewer fields than executor

For integration tests, use the existing project's phase 38 data.

Run `npm run build && npm test`.
  </action>
  <verify>
`npm run build && npm test` — all tests pass. `node bin/gsd-tools.cjs init execute-phase 38 --agent=gsd-executor --raw` returns scoped JSON with fewer fields. `node bin/gsd-tools.cjs init execute-phase 38 --agent=gsd-verifier --raw` returns even fewer fields. Bundle under 1020KB.
  </verify>
  <done>
`init execute-phase --agent=<type>` returns agent-scoped output. `init plan-phase --agent=<type>` also supports scoping. Tests verify each agent type gets correct fields and savings are reported. All 630+ tests pass.
  </done>
</task>

</tasks>

<verification>
- `node bin/gsd-tools.cjs init execute-phase 38 --agent=gsd-executor --raw` → scoped output with _savings
- `node bin/gsd-tools.cjs init execute-phase 38 --agent=gsd-verifier --raw` → fewer fields than executor
- `node bin/gsd-tools.cjs init execute-phase 38 --raw` → full output (no regression)
- Token comparison: scoped vs full output shows 40-60% reduction
- `npm test` passes all tests
</verification>

<success_criteria>
- Agent manifests declare context needs for 5+ agent types
- --agent flag filters init output to declared fields only
- Compact serializers reduce plan state by 70-80% and dep graphs by 50-60%
- No regressions in existing init output
</success_criteria>

<output>
After completion, create `.planning/phases/40-context-efficiency/40-01-SUMMARY.md`
</output>
