---
phase: 45-foundation-decision-journal-state-coherence
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/git.js
  - src/router.js
  - src/lib/constants.js
  - bin/gsd-tools.test.cjs
autonomous: true
requirements:
  - FOUND-02

must_haves:
  truths:
    - "git rewind selectively checks out source files from a target ref while .planning/ files remain untouched"
    - "Rewind auto-stashes uncommitted changes before checkout, restores stash after"
    - "Rewind shows diff summary of what will change and requires --confirm flag (no interactive prompts)"
    - "Protected paths (.planning/, package.json, tsconfig.json, etc.) are excluded from checkout"
    - "git trajectory-branch creates branches in gsd/trajectory/{phase}-{slug} namespace"
    - "Branch creation rejects names that collide with worktree-* namespace"
    - "Branches are local-only by default"
  artifacts:
    - path: "src/lib/git.js"
      provides: "selectiveRewind and trajectoryBranch functions"
      exports: ["selectiveRewind", "trajectoryBranch"]
    - path: "src/router.js"
      provides: "git rewind and git trajectory-branch subcommand routing"
      contains: "rewind"
  key_links:
    - from: "src/lib/git.js selectiveRewind"
      to: "git checkout <ref> -- <paths>"
      via: "execGit with excluded protected paths"
      pattern: "execGit.*checkout"
    - from: "src/lib/git.js selectiveRewind"
      to: "git stash"
      via: "execGit for auto-stash/pop"
      pattern: "execGit.*stash"
    - from: "src/router.js"
      to: "src/lib/git.js"
      via: "gitMod.selectiveRewind and gitMod.trajectoryBranch"
      pattern: "selectiveRewind|trajectoryBranch"
---

<objective>
Add selective git rewind that protects planning state, and trajectory branch namespace management.

Purpose: Code rewinds during trajectory exploration must never corrupt planning files. Developers need to safely rewind source code to any prior commit while `.planning/`, `package.json`, and other root configs remain untouched. Branch namespacing ensures trajectory branches don't collide with worktree branches.

Output: Two new git subcommands (`rewind`, `trajectory-branch`) with protected-path exclusion, auto-stash, diff preview, and namespace collision detection. All existing git tests pass, new rewind/branch tests added.
</objective>

<execution_context>
@/home/cam/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/cam/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/45-foundation-decision-journal-state-coherence/45-CONTEXT.md
@src/lib/git.js
@src/router.js
@src/lib/constants.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement selective rewind with protected paths and auto-stash</name>
  <files>src/lib/git.js, src/router.js, src/lib/constants.js</files>
  <action>
In `src/lib/git.js`, add two new exported functions:

**1. `selectiveRewind(cwd, opts)`**
Parameters via opts: `ref` (required — commit SHA or branch), `confirm` (boolean), `dryRun` (boolean).

Logic:
- Define `PROTECTED_PATHS`: `['.planning', 'package.json', 'package-lock.json', 'tsconfig.json', 'tsconfig.*.json', '.gitignore', '.env', '.env.*']`. Use a denylist approach — everything EXCEPT these paths gets rewound.
- **Step 1 — Validate ref**: Run `execGit(cwd, ['rev-parse', '--verify', ref])`. If fails, return `{ error: 'Invalid ref: ' + ref }`.
- **Step 2 — Compute diff summary**: Run `execGit(cwd, ['diff', '--stat', 'HEAD', ref, '--'])` to get list of files that would change. Filter out any files matching PROTECTED_PATHS patterns (use `path.startsWith()` for directories, exact match for files, and simple glob matching for `tsconfig.*.json` and `.env.*` patterns). Return this as `changes` array with `{ file, status }` entries.
- **Step 3 — If `dryRun`**: Return `{ dry_run: true, ref, changes, protected_paths: PROTECTED_PATHS, files_affected: changes.length }` without modifying anything.
- **Step 4 — If not `confirm`**: Return `{ needs_confirm: true, ref, changes, protected_paths: PROTECTED_PATHS, files_affected: changes.length, message: 'Pass --confirm to execute rewind' }`.
- **Step 5 — Check dirty tree**: Run `execGit(cwd, ['status', '--porcelain'])`. If output non-empty, auto-stash: `execGit(cwd, ['stash', 'push', '-m', 'gsd-rewind-auto-stash'])`. Track `stashed = true`.
- **Step 6 — Perform selective checkout**: Build list of non-protected changed files. Run `execGit(cwd, ['checkout', ref, '--', ...nonProtectedFiles])`. If file list is very long (>50 files), use pathspec approach: checkout all then restore protected files from HEAD via `execGit(cwd, ['checkout', 'HEAD', '--', '.planning'])` and each protected root file.
- **Step 7 — Restore stash**: If `stashed`, run `execGit(cwd, ['stash', 'pop'])`.
- **Step 8 — Return result**: `{ rewound: true, ref, files_changed: nonProtectedFiles.length, files_protected: protectedCount, stash_used: stashed }`.

Error handling: If checkout fails, attempt stash pop if stashed, return error with details.

**2. `trajectoryBranch(cwd, opts)`**
Parameters via opts: `phase` (required), `slug` (required), `push` (boolean, default false).

Logic:
- Construct branch name: `gsd/trajectory/${phase}-${slug}`.
- **Collision check**: Run `execGit(cwd, ['branch', '--list', 'worktree-*'])`. If any worktree branch name would conflict with the trajectory namespace, return error (unlikely but specified).
- **Check existing**: Run `execGit(cwd, ['rev-parse', '--verify', branchName])`. If exists, return `{ exists: true, branch: branchName }`.
- **Create branch**: `execGit(cwd, ['checkout', '-b', branchName])`.
- **Push if flagged**: If `push`, run `execGit(cwd, ['push', '-u', 'origin', branchName])`.
- Return `{ created: true, branch: branchName, pushed: !!push }`.

Export both functions from the module.

In `src/router.js`, add new git subcommand cases:
- `case 'rewind'`: Parse `--ref`, `--confirm`, `--dry-run` from args. Call `gitMod.selectiveRewind(cwd, opts)`. Output result.
- `case 'trajectory-branch'`: Parse `--phase`, `--slug`, `--push` from args. Call `gitMod.trajectoryBranch(cwd, opts)`. Output result.
- Update the default error message to include new subcommands.

In `src/lib/constants.js`, update git command help text to document `rewind` and `trajectory-branch` subcommands with their flags.
  </action>
  <verify>
Run `npm run build`. Then:
- `node bin/gsd-tools.cjs git rewind --ref HEAD~1 --dry-run` → shows files that would change, protected paths excluded.
- `node bin/gsd-tools.cjs git rewind --ref HEAD~1` → returns `needs_confirm: true` with diff summary.
- `node bin/gsd-tools.cjs git trajectory-branch --phase 45 --slug test-branch` → creates branch `gsd/trajectory/45-test-branch`.
  </verify>
  <done>
`git rewind` selectively checks out source files while protecting `.planning/` and root configs. Auto-stash handles dirty trees. `--dry-run` previews changes, `--confirm` executes. `git trajectory-branch` creates properly namespaced branches with collision detection.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add rewind and trajectory branch tests</name>
  <files>bin/gsd-tools.test.cjs</files>
  <action>
Add two new describe blocks in `bin/gsd-tools.test.cjs`:

**`describe('git rewind', () => { ... })`**

Setup: Each test uses a tmpDir with a git repo (`git init`, create some files in `src/` and `.planning/`, make commits).

1. **Rewind dry-run shows changes** — Create repo with 2 commits (commit 1: `src/a.js`, commit 2: modify `src/a.js`). Run `git rewind --ref HEAD~1 --dry-run`. Verify `dry_run: true`, `changes` array includes `src/a.js`, no `.planning/` files.

2. **Rewind without confirm returns needs_confirm** — Same setup. Run `git rewind --ref HEAD~1`. Verify `needs_confirm: true` and `changes` listed.

3. **Rewind with confirm performs checkout** — Create repo, modify `src/a.js` in second commit. Run `git rewind --ref HEAD~1 --confirm`. Verify `rewound: true`. Read `src/a.js` content — should match first commit version.

4. **Protected paths survive rewind** — Create repo with `.planning/STATE.md` and `src/code.js`. Modify both in second commit. Rewind with `--confirm` to first commit. Verify `src/code.js` reverted but `.planning/STATE.md` retains second-commit content.

5. **Protected root configs survive** — Same pattern with `package.json`. Verify it's not rewound.

6. **Auto-stash on dirty tree** — Create repo, make uncommitted change, rewind with `--confirm`. Verify `stash_used: true`, rewind succeeds, uncommitted change restored after.

7. **Invalid ref returns error** — Run `git rewind --ref nonexistent-ref`. Verify error response.

8. **No changes returns empty diff** — Rewind to HEAD (same commit). Verify `changes` is empty or `files_affected: 0`.

**`describe('git trajectory-branch', () => { ... })`**

9. **Creates branch with correct name** — Run `git trajectory-branch --phase 45 --slug test`. Verify `created: true`, branch name `gsd/trajectory/45-test`.

10. **Existing branch returns exists** — Create branch, try again. Verify `exists: true`.

11. **Branch is local-only** — Verify branch exists in local refs but not in remote (no remote configured = fine, just verify no push attempted).

Use existing test helpers (`runGsdTools`, tmpDir patterns). For git tests, initialize repos with `execSync('git init && git add . && git commit -m "init"', { cwd: tmpDir })` pattern.
  </action>
  <verify>
Run `npm test` — all existing tests pass, all new rewind and trajectory-branch tests pass. Zero regressions.
  </verify>
  <done>
11 tests covering: rewind dry-run, confirm gate, selective checkout, protected path preservation (.planning/ and root configs), auto-stash, invalid ref handling, empty diff. Trajectory branch: creation, idempotency, local-only default.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds
2. `npm test` passes all existing + new tests
3. `git rewind --ref HEAD~3 --dry-run` shows affected files without `.planning/` entries
4. `git rewind --ref HEAD~1 --confirm` rewinds source, `.planning/` intact
5. `git trajectory-branch --phase 45 --slug journal` creates `gsd/trajectory/45-journal`
6. Round-trip test: modify `.planning/STATE.md` + `src/foo.js`, commit, rewind, verify STATE.md unchanged
</verification>

<success_criteria>
- Selective rewind protects `.planning/` and root config files during any `git checkout`
- Auto-stash handles dirty working tree transparently
- Dry-run and confirm gates prevent accidental data loss
- Trajectory branches created in `gsd/trajectory/{phase}-{slug}` namespace
- No collision between trajectory and worktree namespaces
- All tests pass (existing + 11 new)
</success_criteria>

<output>
After completion, create `.planning/phases/45-foundation-decision-journal-state-coherence/45-02-SUMMARY.md`
</output>
