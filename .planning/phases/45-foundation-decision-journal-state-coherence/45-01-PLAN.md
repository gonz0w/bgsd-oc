---
phase: 45-foundation-decision-journal-state-coherence
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/commands/memory.js
  - src/lib/constants.js
  - bin/gsd-tools.test.cjs
autonomous: true
requirements:
  - FOUND-01

must_haves:
  truths:
    - "memory write --store trajectories creates structured journal entries in .planning/memory/trajectory.json"
    - "Each entry gets an auto-generated short ID (tj-XXXXXX format)"
    - "Entries have required fields: timestamp, category (decision|observation|correction|hypothesis), text"
    - "Entries support optional metadata: phase, confidence (high|medium|low), tags[], references[]"
    - "memory read --store trajectories returns entries filtered by category, phase, date range, and tags"
    - "Default sort is newest-first; --asc reverses to chronological order"
    - "Journal entries survive session boundaries — data written persists across reads"
  artifacts:
    - path: "src/commands/memory.js"
      provides: "Trajectories store with structured journal entries"
      contains: "trajectories"
    - path: ".planning/memory/trajectory.json"
      provides: "Persistent trajectory journal storage"
  key_links:
    - from: "src/commands/memory.js"
      to: ".planning/memory/trajectory.json"
      via: "fs.readFileSync/writeFileSync"
      pattern: "trajectory\\.json"
    - from: "src/router.js"
      to: "src/commands/memory.js"
      via: "lazyMemory() calls"
      pattern: "cmdMemory(Write|Read)"
---

<objective>
Add `trajectories` as a new memory store with structured journal entries that persist across sessions.

Purpose: Trajectory data needs a persistent, session-portable home. Journal entries (decisions, observations, corrections, hypotheses) must survive session boundaries and support structured filtering — this is the data layer that all higher-level trajectory analysis will build on.

Output: Extended memory.js with `trajectories` store, auto-ID generation, structured entry validation, category/phase/date/tag filtering, sort order control. All existing memory tests pass, new trajectory-specific tests added.
</objective>

<execution_context>
@/home/cam/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/cam/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/45-foundation-decision-journal-state-coherence/45-CONTEXT.md
@src/commands/memory.js
@src/lib/constants.js
@src/router.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend memory store with trajectories support and structured entries</name>
  <files>src/commands/memory.js, src/lib/constants.js</files>
  <action>
In `src/commands/memory.js`:

1. Add `'trajectories'` to `VALID_STORES` array.
2. Add `'trajectories'` to `SACRED_STORES` array (trajectory data should never be auto-compacted — it's a decision journal).
3. In `cmdMemoryWrite`, add trajectory-specific write behavior:
   - When `store === 'trajectories'`:
     - Validate required fields: `category` must be one of `['decision', 'observation', 'correction', 'hypothesis']`, `text` must be a non-empty string.
     - Error with descriptive message if validation fails.
     - Auto-generate a short ID: `entry.id = 'tj-' + crypto.randomBytes(3).toString('hex')` (6 hex chars). Add `const crypto = require('crypto');` at top of file.
     - Ensure no ID collision with existing entries (regenerate if collision found — unlikely but safe).
     - Validate optional metadata fields if present: `phase` (string/number), `confidence` (must be one of `['high', 'medium', 'low']`), `tags` (must be array of strings), `references` (must be array of strings — commit SHAs, file paths, or other entry IDs).
     - Append entry (same as decisions/lessons pattern — simple push, newest at end).
   - Auto-add `timestamp` if not present (existing behavior covers this).

4. In `cmdMemoryRead`, add trajectory-specific filtering:
   - When `store === 'trajectories'`:
     - Support `--category` filter: exact match on entry.category field.
     - Support `--tags` filter: comma-separated, entry must have ALL specified tags.
     - Support `--from` and `--to` date filters: ISO date strings, filter by entry.timestamp. Compare as string (ISO dates sort lexicographically).
     - Default sort: newest first (reverse array before returning). Support `--asc` flag to return in chronological (original append) order.
   - Existing `--phase` and `--query` filters still apply (they are generic).
   - Existing `--limit` still applies after all filtering.

5. In `src/lib/constants.js`, update the memory command help text to include `trajectories` in the store list and document the trajectory-specific flags (`--category`, `--tags`, `--from`, `--to`, `--asc`).

The file is stored as `.planning/memory/trajectory.json` (the store name is `trajectories` but the file follows existing pattern: `${store}.json` → `trajectories.json`). Note: The CONTEXT.md says `trajectory.json` — use `trajectory.json` as the filename per user decision. Override the `${store}.json` pattern for this store: add a mapping `const STORE_FILES = { trajectories: 'trajectory.json' }` and use `STORE_FILES[store] || ${store}.json` for file path resolution in write, read, list, and compact functions. This keeps the CLI interface as `--store trajectories` while the file is `trajectory.json` per user specification.
  </action>
  <verify>
Run `npm run build` to rebuild gsd-tools.cjs from source. Then:
- `node bin/gsd-tools.cjs memory write --store trajectories --entry '{"category":"decision","text":"Test entry","phase":"45"}'` → returns `{written: true, store: "trajectories"}` with entry having auto-generated `id` field matching `tj-` prefix.
- `node bin/gsd-tools.cjs memory read --store trajectories` → returns the entry.
- `node bin/gsd-tools.cjs memory write --store trajectories --entry '{"text":"missing category"}'` → returns error about missing/invalid category.
- `node bin/gsd-tools.cjs memory list` → shows `trajectory.json` store with 1 entry.
  </verify>
  <done>
`memory write --store trajectories` creates structured journal entries with auto-generated `tj-XXXXXX` IDs in `.planning/memory/trajectory.json`. Validation rejects entries without valid category or text. All four categories accepted: decision, observation, correction, hypothesis. Optional metadata (phase, confidence, tags, references) validated when present.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add trajectory-specific tests</name>
  <files>bin/gsd-tools.test.cjs</files>
  <action>
Add a new `describe('memory trajectories', () => { ... })` test block in `bin/gsd-tools.test.cjs`, placed after the existing `memory commands` describe block. Tests to include:

1. **Write basic trajectory entry** — write with category "decision" and text, verify written=true, verify file exists at `.planning/memory/trajectory.json`, verify entry has `id` matching `/^tj-[a-f0-9]{6}$/`, has `timestamp`, has `category`, has `text`.

2. **Write rejects missing category** — write entry without category, verify error response.

3. **Write rejects invalid category** — write with `category: "invalid"`, verify error.

4. **Write rejects missing text** — write with category but no text, verify error.

5. **Write with full metadata** — write with `phase`, `confidence: "medium"`, `tags: ["perf", "memory"]`, `references: ["abc123", "src/foo.js"]`. Verify all fields preserved.

6. **Write rejects invalid confidence** — write with `confidence: "very-high"`, verify error.

7. **Read with category filter** — write 3 entries (decision, observation, decision), read with `--category decision`, verify count=2.

8. **Read with tag filter** — write entries with different tags, read with `--tags perf`, verify only matching entries returned. Test multi-tag: `--tags perf,memory` requires BOTH tags.

9. **Read with date range** — write entries, read with `--from 2026-01-01 --to 2026-12-31`, verify filtering works.

10. **Read default sort is newest-first** — write 3 entries sequentially, read, verify first entry has latest timestamp.

11. **Read with --asc flag** — write entries, read with `--asc`, verify chronological order.

12. **Session persistence** — write entry, create new read call (simulating new session), verify data persists.

13. **Auto-generated IDs are unique** — write 10 entries, verify all IDs are distinct.

14. **Sacred store — compact skips trajectories** — run `memory compact --store trajectories`, verify `reason: "sacred_data"`.

15. **Filename is trajectory.json not trajectories.json** — write entry, verify file path ends with `trajectory.json`.

Use the same test patterns as existing memory tests (tmpDir setup, `runGsdTools` helper, JSON.parse output).
  </action>
  <verify>
Run `npm test` — all existing tests pass (669+), all new trajectory tests pass. Zero regressions.
  </verify>
  <done>
15 trajectory-specific tests all pass. Tests cover: write validation (required fields, optional metadata), read filtering (category, tags, date range), sort order (default newest-first, --asc), session persistence, ID uniqueness, sacred store protection, and correct filename.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds
2. `npm test` passes all existing + new tests
3. `memory write --store trajectories --entry '{"category":"decision","text":"Use vertical slices","phase":"45","confidence":"high","tags":["architecture"]}'` → success with `tj-` prefixed ID
4. `memory read --store trajectories --category decision` → returns only decision entries
5. `memory read --store trajectories --asc` → chronological order
6. `memory list` → shows trajectory.json store
7. `memory compact --store trajectories` → sacred_data (refuses)
</verification>

<success_criteria>
- `memory write/read --store trajectories` fully functional with structured journal entries
- All four categories (decision, observation, correction, hypothesis) accepted
- Auto-generated short IDs (tj-XXXXXX) on every entry
- Category, phase, date range, and tag filtering working
- Newest-first default sort with --asc override
- Data persists in `.planning/memory/trajectory.json` across sessions
- All tests pass (existing + 15 new)
</success_criteria>

<output>
After completion, create `.planning/phases/45-foundation-decision-journal-state-coherence/45-01-SUMMARY.md`
</output>
