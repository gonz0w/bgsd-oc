---
phase: 11-session-continuity
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/commands/memory.js
  - src/lib/constants.js
  - src/router.js
  - bin/gsd-tools.test.cjs
  - bin/gsd-tools.cjs
autonomous: true
requirements:
  - MEMO-01
  - MEMO-02
  - MEMO-05

must_haves:
  truths:
    - "Decisions saved via CLI persist in .planning/memory/decisions.json across sessions"
    - "Bookmarks saved via CLI persist in .planning/memory/bookmarks.json across sessions"
    - "Lessons saved via CLI persist in .planning/memory/lessons.json across sessions"
    - "All memory stores are queryable via CLI and return structured JSON"
    - "Memory directory is auto-created on first write if it doesn't exist"
  artifacts:
    - path: "src/commands/memory.js"
      provides: "Memory store CRUD commands"
      exports: ["cmdMemoryWrite", "cmdMemoryRead", "cmdMemoryList", "cmdMemoryEnsureDir"]
    - path: "bin/gsd-tools.test.cjs"
      provides: "Memory store tests"
      contains: "describe.*memory"
  key_links:
    - from: "src/commands/memory.js"
      to: ".planning/memory/decisions.json"
      via: "fs.readFileSync/writeFileSync"
      pattern: "memory/decisions\\.json"
    - from: "src/commands/memory.js"
      to: ".planning/memory/bookmarks.json"
      via: "fs.readFileSync/writeFileSync"
      pattern: "memory/bookmarks\\.json"
    - from: "src/router.js"
      to: "src/commands/memory.js"
      via: "require and route dispatch"
      pattern: "memory"
---

<objective>
Create the memory directory infrastructure and CRUD commands for the three core memory stores: decisions.json, bookmarks.json, and lessons.json.

Purpose: Foundation for all cross-session persistence. Every other Phase 11 plan depends on these stores existing and being readable/writable via CLI commands.

Output: New `src/commands/memory.js` module with 4 commands (`memory write`, `memory read`, `memory list`, `memory ensure-dir`), wired into the CLI router, with tests.
</objective>

<execution_context>
@/home/cam/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/cam/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/CONVENTIONS.md
@.planning/codebase/ARCHITECTURE.md
@.planning/phases/11-session-continuity/11-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Memory store module with CRUD commands</name>
  <files>
    src/commands/memory.js
    src/lib/constants.js
    src/router.js
    bin/gsd-tools.cjs
  </files>
  <action>
Create `src/commands/memory.js` following the existing command module pattern (see `src/commands/state.js` for reference). All functions follow the `cmdXxx(cwd, options, raw)` signature convention.

**`cmdMemoryEnsureDir(cwd)`** — Internal helper (no CLI exposure needed). Creates `.planning/memory/` directory if it doesn't exist. Returns the directory path. Uses `fs.mkdirSync(dir, { recursive: true })`.

**`cmdMemoryWrite(cwd, options, raw)`** — Write an entry to a memory store.
- Required options: `store` (one of: `decisions`, `bookmarks`, `lessons`, `todos`), `entry` (JSON string of the entry object)
- Behavior:
  1. Call `cmdMemoryEnsureDir(cwd)` to ensure directory exists
  2. Read existing store file (`.planning/memory/{store}.json`), parse as JSON array. If file doesn't exist, start with `[]`.
  3. Parse `entry` from JSON string. Add `timestamp` field with ISO date if not already present.
  4. For `decisions` store: entries are NEVER deleted (per CONTEXT.md "sacred data" rule). Append to array.
  5. For `bookmarks` store: keep only the latest N entries (default 20). New entry goes at index 0 (most recent first). Trim array to N.
  6. For `lessons` store: entries are NEVER deleted (sacred data). Append to array.
  7. For `todos` store: entries can be replaced. Append to array.
  8. Write JSON array back to file with `JSON.stringify(entries, null, 2)`.
  9. Output: `{ written: true, store, entry_count: entries.length }`.

**`cmdMemoryRead(cwd, options, raw)`** — Read entries from a memory store.
- Required options: `store`
- Optional options: `limit` (number, default all), `query` (string for text search), `phase` (filter by phase field)
- Behavior:
  1. Read store file. If not found, return `{ entries: [], count: 0, store }`.
  2. If `phase` provided: filter entries where `entry.phase` matches.
  3. If `query` provided: filter entries where any string value contains query (case-insensitive).
  4. If `limit` provided: slice to first N entries.
  5. Output: `{ entries, count: entries.length, store, total: allEntries.length }`.

**`cmdMemoryList(cwd, options, raw)`** — List available stores with stats.
- Behavior:
  1. Read `.planning/memory/` directory. For each `.json` file, count entries.
  2. Output: `{ stores: [{ name, entry_count, size_bytes, last_modified }], memory_dir: ".planning/memory/" }`.

Wire into CLI router:
- Add `memory` case in `src/router.js` main switch. Subcommands: `write`, `read`, `list`, `ensure-dir`.
- Add `COMMAND_HELP` entries in `src/lib/constants.js` for `memory`, `memory write`, `memory read`, `memory list`.
- Export all functions from `src/commands/memory.js`.

Run `npm run build` to produce updated `bin/gsd-tools.cjs`.
  </action>
  <verify>
Run `npm run build` — succeeds.
Run `node bin/gsd-tools.cjs memory list --raw` — returns JSON with stores array.
Run `node bin/gsd-tools.cjs memory write --store decisions --entry '{"text":"test decision","phase":"11"}' --raw` — returns `written: true`.
Run `node bin/gsd-tools.cjs memory read --store decisions --raw` — returns entries array with the test entry.
Run `node bin/gsd-tools.cjs memory --help` — shows help text.
  </verify>
  <done>
Four memory commands (`write`, `read`, `list`, `ensure-dir`) exist in CLI, produce structured JSON output, auto-create `.planning/memory/` directory on first write, and handle all four store types (decisions, bookmarks, lessons, todos) with appropriate retention rules (decisions/lessons never pruned, bookmarks trimmed to 20).
  </done>
</task>

<task type="auto">
  <name>Task 2: Memory store test suite</name>
  <files>
    bin/gsd-tools.test.cjs
  </files>
  <action>
Add a `describe('memory commands')` test suite to `bin/gsd-tools.test.cjs` following the existing test patterns (see `describe('state record-session command')` for reference). Use the same `runGsdTools(command, tmpDir)` helper and temp directory setup pattern.

**Test cases (minimum 8):**

1. **memory list returns empty when no memory dir** — Create `.planning/` without `memory/`. Run `memory list`. Expect `stores: []`.

2. **memory write creates directory and file** — Run `memory write --store decisions --entry '{"text":"chose X","phase":"11"}'`. Verify `.planning/memory/decisions.json` exists and contains 1 entry with timestamp.

3. **memory write appends to existing store** — Write 2 decisions. Read back. Expect 2 entries in order.

4. **memory read returns empty for missing store** — Run `memory read --store lessons`. Expect `{ entries: [], count: 0 }`.

5. **memory read with query filter** — Write 3 decisions with different text. Read with `--query "chose"`. Expect filtered results.

6. **memory read with phase filter** — Write 2 decisions for phase 11, 1 for phase 12. Read with `--phase 11`. Expect 2 entries.

7. **memory read with limit** — Write 5 lessons. Read with `--limit 3`. Expect 3 entries.

8. **bookmarks store trims to max entries** — Write 25 bookmarks. Read back. Expect 20 entries (most recent first).

9. **decisions store never prunes** — Write 100 decisions. Read back. Expect all 100 entries.

10. **memory list shows stats** — Write to 2 stores. Run `memory list`. Expect 2 stores with correct entry_count and size_bytes > 0.

Run `npm test` to verify all tests pass. Report total test count.
  </action>
  <verify>
Run `npm test` — all tests pass (0 failures).
Run `node --test --test-name-pattern="memory"` — all memory tests pass.
  </verify>
  <done>
10 test cases covering memory CRUD operations, filtering, retention rules, and stats. All pass alongside existing 218+ test suite.
  </done>
</task>

</tasks>

<verification>
- `npm run build` succeeds
- `npm test` passes all tests (existing + new memory tests)
- `node bin/gsd-tools.cjs memory write --store decisions --entry '{"text":"test","phase":"11"}' --raw` returns `written: true`
- `node bin/gsd-tools.cjs memory read --store decisions --raw` returns entries
- `node bin/gsd-tools.cjs memory list --raw` returns store stats
- `.planning/memory/` directory auto-created on first write
</verification>

<success_criteria>
- Memory module exists with 4 commands (write, read, list, ensure-dir)
- All 4 store types supported (decisions, bookmarks, lessons, todos)
- Sacred data rule enforced: decisions and lessons never pruned
- Bookmarks trimmed to configurable max (default 20)
- All memory commands produce structured JSON via output() pattern
- 10+ new tests pass
- Build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/11-session-continuity/11-01-SUMMARY.md`
</output>
