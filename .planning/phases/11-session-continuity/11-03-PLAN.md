---
phase: 11-session-continuity
plan: 03
type: execute
wave: 2
depends_on:
  - "11-01"
files_modified:
  - src/commands/memory.js
  - src/lib/constants.js
  - workflows/execute-plan.md
  - workflows/pause-work.md
  - bin/gsd-tools.test.cjs
  - bin/gsd-tools.cjs
autonomous: true
requirements:
  - MEMO-02
  - MEMO-06

must_haves:
  truths:
    - "Bookmark auto-saves after each task completion in execute-plan workflow"
    - "Pause-work workflow saves bookmark with notes/blockers to bookmarks.json"
    - "Compaction runs when a memory store exceeds its entry threshold"
    - "Decisions and lessons are NEVER compacted — only summarized in place"
    - "Bookmarks and todos can be summarized/trimmed by compaction"
    - "Compaction produces one summary line per old entry"
  artifacts:
    - path: "src/commands/memory.js"
      provides: "cmdMemoryCompact function"
      contains: "cmdMemoryCompact"
    - path: "workflows/execute-plan.md"
      provides: "Bookmark auto-save step after task completion"
      contains: "memory write --store bookmarks"
    - path: "workflows/pause-work.md"
      provides: "Bookmark save on pause with context"
      contains: "memory write --store bookmarks"
    - path: "bin/gsd-tools.test.cjs"
      provides: "Compaction + auto-save tests"
      contains: "describe.*memory compact"
  key_links:
    - from: "workflows/execute-plan.md"
      to: "bin/gsd-tools.cjs"
      via: "node gsd-tools.cjs memory write --store bookmarks"
      pattern: "memory write.*bookmarks"
    - from: "workflows/pause-work.md"
      to: "bin/gsd-tools.cjs"
      via: "node gsd-tools.cjs memory write --store bookmarks"
      pattern: "memory write.*bookmarks"
    - from: "src/commands/memory.js"
      to: ".planning/memory/"
      via: "compact reads all stores, rewrites with compressed entries"
      pattern: "memory/.*\\.json"
---

<objective>
Wire bookmark auto-save into execution workflows and implement deterministic memory compaction to prevent unbounded growth.

Purpose: Bookmarks need to be saved automatically during execution (not just manually via pause) so sessions can resume seamlessly. Compaction ensures memory stores don't grow without bound, while preserving sacred data (decisions and lessons).

Output: Updated execute-plan and pause-work workflows with bookmark writes, new `memory compact` command, compaction tests.
</objective>

<execution_context>
@/home/cam/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/cam/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/CONVENTIONS.md
@.planning/phases/11-session-continuity/11-CONTEXT.md
@.planning/phases/11-session-continuity/11-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Bookmark auto-save in workflows + memory compact command</name>
  <files>
    src/commands/memory.js
    src/lib/constants.js
    src/router.js
    workflows/execute-plan.md
    workflows/pause-work.md
    bin/gsd-tools.cjs
  </files>
  <action>
**Part A: Wire bookmark auto-save into execute-plan.md**

In `workflows/execute-plan.md`, after each task completion (in the step where task SUMMARY is written and committed), add a lightweight bookmark save:

```bash
node /home/cam/.config/opencode/get-shit-done/bin/gsd-tools.cjs memory write \
  --store bookmarks \
  --entry "{\"phase\":\"${PHASE}\",\"plan\":\"${PLAN}\",\"task\":${TASK_NUM},\"total_tasks\":${TOTAL_TASKS},\"last_file\":\"${LAST_MODIFIED_FILE}\",\"git_head\":\"$(git rev-parse --short HEAD)\"}"
```

Place this AFTER the task commit step but BEFORE advancing to the next task. Per CONTEXT.md: "Bookmark auto-save should be lightweight — append to bookmarks.json, not rewrite the whole file each time." The `memory write` command already handles append semantics, so this is a single CLI call.

**Part B: Wire bookmark save into pause-work.md**

In `workflows/pause-work.md`, in the `<step name="commit">` step, add a bookmark write BEFORE the git commit. Include additional context from the pause:

```bash
node /home/cam/.config/opencode/get-shit-done/bin/gsd-tools.cjs memory write \
  --store bookmarks \
  --entry "{\"phase\":\"${PHASE}\",\"plan\":\"${PLAN}\",\"task\":${TASK_NUM},\"total_tasks\":${TOTAL_TASKS},\"paused\":true,\"notes\":\"${PAUSE_NOTES}\",\"blockers\":\"${BLOCKERS}\",\"git_head\":\"$(git rev-parse --short HEAD)\"}"
```

**Part C: Implement `cmdMemoryCompact(cwd, options, raw)`**

Add to `src/commands/memory.js`:

**Arguments:**
- `--store <name>` (optional): Compact a specific store. If omitted, compact all stores.
- `--threshold <N>` (optional): Entry count threshold to trigger compaction. Default: 50 for bookmarks/todos, never for decisions/lessons.
- `--dry-run` (optional): Show what would be compacted without writing.

**Compaction rules (per CONTEXT.md):**

1. **Sacred data (decisions, lessons):** NEVER compacted. If `--store decisions` or `--store lessons` is passed, return `{ compacted: false, reason: "sacred_data" }`. These stores grow unbounded but are expected to be small (dozens of entries per milestone, not thousands).

2. **Bookmarks:** Keep the 10 most recent entries. For entries beyond 10, create one summary line per old entry: `{ summary: "2026-02-22: Phase 11, Plan 02, Task 3 (paused)", original_timestamp: "..." }`. Replace old entries with summary entries.

3. **Todos:** Keep active (non-completed) todos. For completed todos older than the current milestone, create one summary line per entry: `{ summary: "2026-02-22: [completed] Fix worker pool config", original_timestamp: "..." }`. Remove summarized originals.

4. **Auto-trigger check:** `cmdMemoryWrite` should check if the store's entry count exceeds the threshold after writing. If so, emit a warning in the output: `{ written: true, compact_needed: true, entry_count: N, threshold: M }`. The calling workflow can then decide to run `memory compact`. Do NOT auto-compact on write (keep writes fast and predictable).

**Output format:**
```json
{
  "compacted": true,
  "stores_processed": ["bookmarks", "todos"],
  "entries_before": { "bookmarks": 35, "todos": 22 },
  "entries_after": { "bookmarks": 10, "todos": 8 },
  "summaries_created": { "bookmarks": 25, "todos": 14 },
  "sacred_skipped": ["decisions", "lessons"]
}
```

Wire `compact` subcommand into `memory` routing in `src/router.js`. Add `COMMAND_HELP` entry for `memory compact` in `src/lib/constants.js`.

Run `npm run build`.
  </action>
  <verify>
Run `npm run build` — succeeds.
Run `node bin/gsd-tools.cjs memory compact --dry-run --raw` — returns compaction preview.
Run `node bin/gsd-tools.cjs memory compact --store decisions --raw` — returns `compacted: false, reason: sacred_data`.
Run `node bin/gsd-tools.cjs memory compact --store bookmarks --raw` — compacts if over threshold.
Verify `workflows/execute-plan.md` contains `memory write --store bookmarks`.
Verify `workflows/pause-work.md` contains `memory write --store bookmarks`.
  </verify>
  <done>
Bookmark auto-save wired into execute-plan (after each task) and pause-work (on pause with notes/blockers). Memory compact command exists with sacred data protection, configurable thresholds, and dry-run support.
  </done>
</task>

<task type="auto">
  <name>Task 2: Compaction and auto-save test suite</name>
  <files>
    bin/gsd-tools.test.cjs
  </files>
  <action>
Add a `describe('memory compact')` test suite to `bin/gsd-tools.test.cjs`.

**Test cases (minimum 8):**

1. **compact refuses to compact decisions** — Run `memory compact --store decisions`. Expect `{ compacted: false, reason: "sacred_data" }`.

2. **compact refuses to compact lessons** — Run `memory compact --store lessons`. Expect `{ compacted: false, reason: "sacred_data" }`.

3. **compact trims bookmarks to 10** — Write 30 bookmarks. Run `memory compact --store bookmarks`. Read back. Expect 10 entries + summary entries for the older 20. Total should be 30 (10 live + 20 summaries) — wait, per the design, old entries are REPLACED with summaries. So total should be 10 live entries. But the summaries should be stored as summary entries within the same file to preserve history.

   Clarification: After compaction, bookmarks.json should contain 10 recent live entries. The 20 older entries should be replaced by 20 summary-line entries (with `summary` field instead of full data). Total: 30 entries, but 20 are lightweight summaries.

4. **compact with dry-run does not modify files** — Write 30 bookmarks. Run `memory compact --store bookmarks --dry-run`. Verify file unchanged (still 30 full entries).

5. **compact all stores skips sacred data** — Write to all 4 stores (decisions: 10, bookmarks: 30, lessons: 5, todos: 10). Run `memory compact`. Expect `sacred_skipped: ["decisions", "lessons"]`, bookmarks compacted, todos unchanged (under threshold).

6. **compact todos removes old completed items** — Write 15 todos, 10 marked `completed: true` with old timestamps. Run `memory compact --store todos`. Expect completed old entries replaced with summaries.

7. **write command warns when threshold exceeded** — Write 51 bookmarks. Check last write's output includes `compact_needed: true`.

8. **compact with custom threshold** — Write 20 bookmarks. Run `memory compact --store bookmarks --threshold 15`. Expect compaction occurs (20 > 15).

Run `npm test` to verify all tests pass.
  </action>
  <verify>
Run `npm test` — all tests pass (0 failures).
Run `node --test --test-name-pattern="memory compact"` — all compaction tests pass.
  </verify>
  <done>
8 test cases covering sacred data protection, bookmark trimming, dry-run, all-store compaction, todo cleanup, threshold warnings, and custom thresholds. All pass alongside existing test suite.
  </done>
</task>

</tasks>

<verification>
- `npm run build` succeeds
- `npm test` passes all tests
- `execute-plan.md` contains bookmark auto-save step
- `pause-work.md` contains bookmark save with context
- `memory compact` respects sacred data (decisions, lessons never compacted)
- `memory compact --dry-run` previews without modifying
- `memory write` warns when threshold exceeded
</verification>

<success_criteria>
- Bookmark auto-save fires after every task completion in execute-plan workflow
- Pause-work saves enriched bookmark with notes and blockers
- Memory compact exists with sacred data protection for decisions and lessons
- Compaction produces one summary line per old entry (not deletion)
- Threshold-based warning on writes enables workflow-level compaction decisions
- 8+ new tests pass
- Build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/11-session-continuity/11-03-SUMMARY.md`
</output>
