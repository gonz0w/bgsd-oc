---
phase: 11-session-continuity
plan: 02
type: execute
wave: 2
depends_on:
  - "11-01"
files_modified:
  - src/commands/init.js
  - src/lib/constants.js
  - src/router.js
  - bin/gsd-tools.test.cjs
  - bin/gsd-tools.cjs
autonomous: true
requirements:
  - MEMO-03
  - MEMO-04

must_haves:
  truths:
    - "Running `init memory` at session start returns a digest with last position, decisions, blockers, todos"
    - "The digest adapts when --workflow flag specifies which workflow is about to run"
    - "Codebase knowledge from .planning/codebase/ files is surfaced in the digest for execution workflows"
    - "When no memory exists, init memory returns a minimal stub (not an error)"
    - "Priority hierarchy when token-tight: conventions (cut first) → lessons → decisions → todos → position (always present)"
  artifacts:
    - path: "src/commands/init.js"
      provides: "cmdInitMemory function"
      contains: "cmdInitMemory"
    - path: "bin/gsd-tools.test.cjs"
      provides: "init memory tests"
      contains: "describe.*init memory"
  key_links:
    - from: "src/commands/init.js"
      to: ".planning/memory/decisions.json"
      via: "safeReadFile + JSON.parse"
      pattern: "memory/decisions\\.json"
    - from: "src/commands/init.js"
      to: ".planning/memory/bookmarks.json"
      via: "safeReadFile + JSON.parse"
      pattern: "memory/bookmarks\\.json"
    - from: "src/commands/init.js"
      to: ".planning/codebase/"
      via: "fs.readdirSync + safeReadFile for section extraction"
      pattern: "codebase/"
    - from: "src/commands/init.js"
      to: ".planning/STATE.md"
      via: "safeReadFile for position, blockers, todos"
      pattern: "STATE\\.md"
---

<objective>
Create the `init memory` compound command that produces a workflow-aware memory digest at session start, including codebase knowledge surfacing.

Purpose: This is the command that workflows call at session start to restore context. It reads from memory stores (Plan 01), STATE.md, and .planning/codebase/ files to produce a tailored digest.

Output: New `init memory` CLI command with workflow-aware adaptation, codebase section extraction, and priority-based content trimming.
</objective>

<execution_context>
@/home/cam/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/cam/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/CONVENTIONS.md
@.planning/codebase/ARCHITECTURE.md
@.planning/phases/11-session-continuity/11-CONTEXT.md
@.planning/phases/11-session-continuity/11-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Init memory command with workflow-aware digest</name>
  <files>
    src/commands/init.js
    src/lib/constants.js
    src/router.js
    bin/gsd-tools.cjs
  </files>
  <action>
Add `cmdInitMemory(cwd, args, raw)` to `src/commands/init.js` following the existing `cmdInit*` compound command pattern (see `cmdInitExecutePhase` for reference).

**Arguments:**
- `--workflow <name>` (optional): Which workflow is about to run. Values: `execute-phase`, `plan-phase`, `execute-plan`, `quick`, `resume`, `verify-work`, `progress`. If omitted, return full digest.
- `--phase <N>` (optional): Current phase number, used to filter phase-specific memories.
- `--compact` (optional): Reduced output for token-tight contexts.

**Output structure:**
```json
{
  "position": {
    "phase": "11",
    "phase_name": "Session Continuity",
    "plan": "02",
    "task": null,
    "last_file": null,
    "last_activity": "2026-02-22",
    "stopped_at": "Completed 11-01-PLAN.md"
  },
  "bookmark": {
    "phase": "11",
    "plan": "01",
    "task": 3,
    "total_tasks": 5,
    "last_file": "src/commands/memory.js",
    "saved_at": "2026-02-22T15:30:00Z",
    "drift_warning": null
  },
  "decisions": [
    { "text": "Dual-store pattern...", "phase": "11", "timestamp": "..." }
  ],
  "blockers": [],
  "todos": [],
  "lessons": [
    { "text": "Auto-fix only corrects unambiguous drift", "phase": "10" }
  ],
  "codebase": {
    "sections_loaded": ["CONVENTIONS.md", "ARCHITECTURE.md"],
    "content": { "conventions": "...", "architecture": "..." }
  },
  "digest_lines": 12,
  "workflow": "execute-phase",
  "trimmed": []
}
```

**Implementation logic:**

1. **Position** — Read from STATE.md using existing field extraction patterns. Parse `Phase:`, `Plan:`, `Last activity:`, `Stopped at:`.

2. **Bookmark** — Read `.planning/memory/bookmarks.json`, get most recent entry (index 0). If bookmark exists AND `--phase` matches AND git HEAD at bookmark time differs from current, set `drift_warning` to describe the change (use `execGit(cwd, ['log', '--oneline', '-5', '--', ...bookmark.last_files])` to check if relevant files changed). Leverage Phase 10's `state validate` infrastructure concept but keep lightweight — just a HEAD comparison, not full validation.

3. **Decisions** — Read `.planning/memory/decisions.json`. If `--phase` provided, filter to entries matching that phase. Include last 10 decisions (most recent first). In `--compact` mode, include last 5.

4. **Blockers/Todos** — Read from STATE.md `### Blockers/Concerns` and `### Pending Todos` sections. Parse bullet items.

5. **Lessons** — Read `.planning/memory/lessons.json`. If `--phase` provided, filter. Include last 5 lessons.

6. **Codebase knowledge (MEMO-04)** — Based on `--workflow` flag, select relevant `.planning/codebase/` documents:
   - `execute-phase` / `execute-plan`: Load CONVENTIONS.md, ARCHITECTURE.md
   - `plan-phase`: Load ARCHITECTURE.md, STACK.md, CONCERNS.md
   - `verify-work`: Load TESTING.md, CONVENTIONS.md
   - `quick`: Load CONVENTIONS.md
   - Default / no flag: Load ARCHITECTURE.md only
   
   For each selected document, read first 50 lines (enough for key patterns). Store in `codebase.content` keyed by document name (lowercase, no extension).

7. **Priority trimming** — If total output exceeds a token budget estimate (e.g., 4000 characters for `--compact`, 8000 for default), trim in this order (per CONTEXT.md priority hierarchy):
   - First cut: `codebase.content` (conventions are expendable — can be re-read from files)
   - Second cut: `lessons` (reduce to 2)
   - Third cut: `decisions` (reduce to 3)
   - Fourth cut: `todos` (reduce to 2)
   - Never cut: `position` (always present)
   Record what was trimmed in `trimmed` array.

8. **Wire routing** — Add `memory` case to `init` subcommand routing in `src/router.js`. Add `COMMAND_HELP` entry for `init memory` in `src/lib/constants.js`.

Run `npm run build`.
  </action>
  <verify>
Run `npm run build` — succeeds.
Run `node bin/gsd-tools.cjs init memory --raw` — returns JSON with position, decisions, bookmark, codebase sections.
Run `node bin/gsd-tools.cjs init memory --workflow execute-phase --raw` — returns JSON with CONVENTIONS + ARCHITECTURE in codebase.
Run `node bin/gsd-tools.cjs init memory --workflow plan-phase --raw` — returns JSON with ARCHITECTURE + STACK + CONCERNS in codebase.
Run `node bin/gsd-tools.cjs init memory --compact --raw` — returns trimmed output.
Run `node bin/gsd-tools.cjs init memory --help` — shows help text.
  </verify>
  <done>
`init memory` command returns workflow-aware digest with position, bookmark, decisions, blockers, todos, lessons, and codebase knowledge. Output adapts based on --workflow flag. Priority trimming ensures position is always present.
  </done>
</task>

<task type="auto">
  <name>Task 2: Init memory test suite</name>
  <files>
    bin/gsd-tools.test.cjs
  </files>
  <action>
Add a `describe('init memory')` test suite to `bin/gsd-tools.test.cjs` following existing init test patterns (see `describe('state validate pre-flight')` for reference).

**Test cases (minimum 8):**

1. **returns minimal stub when no memory exists** — Create `.planning/` with only STATE.md (minimal). Run `init memory`. Expect `position` present, `decisions: []`, `bookmark: null`.

2. **includes position from STATE.md** — Create STATE.md with Phase 11, Plan 02. Run `init memory`. Expect `position.phase` === "11", `position.plan` === "02".

3. **includes decisions from memory store** — Write 3 decisions to `.planning/memory/decisions.json`. Run `init memory`. Expect `decisions` array with 3 entries.

4. **filters decisions by phase** — Write decisions for phases 10 and 11. Run `init memory --phase 11`. Expect only phase 11 decisions.

5. **includes latest bookmark** — Write 2 bookmarks to `.planning/memory/bookmarks.json`. Run `init memory`. Expect `bookmark` to be the most recent (index 0).

6. **workflow flag selects codebase sections** — Create `.planning/codebase/CONVENTIONS.md` and `.planning/codebase/TESTING.md`. Run `init memory --workflow verify-work`. Expect `codebase.sections_loaded` to include TESTING.md and CONVENTIONS.md.

7. **compact mode reduces output** — Write 15 decisions. Run `init memory --compact`. Expect `decisions` length <= 5.

8. **includes blockers and todos from STATE.md** — Create STATE.md with blockers section containing 2 items. Run `init memory`. Expect `blockers` array with 2 entries.

Run `npm test` to verify all tests pass.
  </action>
  <verify>
Run `npm test` — all tests pass (0 failures).
Run `node --test --test-name-pattern="init memory"` — all init memory tests pass.
  </verify>
  <done>
8 test cases covering init memory digest generation, workflow awareness, phase filtering, codebase selection, compact mode, and graceful handling of missing data. All pass alongside existing test suite.
  </done>
</task>

</tasks>

<verification>
- `npm run build` succeeds
- `npm test` passes all tests
- `init memory` returns complete digest with all sections
- `--workflow` flag correctly selects codebase documents
- `--compact` mode produces trimmed output
- Missing memory gracefully returns empty arrays (not errors)
- Position is always present even in trimmed output
</verification>

<success_criteria>
- `init memory` compound command exists with workflow-aware digest
- Codebase knowledge surfaced from .planning/codebase/ based on workflow type
- Priority hierarchy applied when trimming (position always present, conventions cut first)
- Bookmark drift detection warns when relevant files changed since last session
- 8+ new tests pass
- Build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/11-session-continuity/11-02-SUMMARY.md`
</output>
