---
phase: 46-checkpoint-snapshot-metrics-collection
plan: 02
type: execute
wave: 2
depends_on: [46-01]
files_modified:
  - src/commands/trajectory.js
  - src/router.js
  - src/lib/constants.js
  - bin/gsd-tools.test.cjs
autonomous: true
requirements: [CHKPT-02]

must_haves:
  truths:
    - "User can run `trajectory list` and see all checkpoints with name, scope, timestamp, git ref, and metrics summary"
    - "List output shows checkpoint data in a readable format with key metadata per entry"
  artifacts:
    - path: "src/commands/trajectory.js"
      provides: "Trajectory list command implementation"
      exports: ["cmdTrajectoryCheckpoint", "cmdTrajectoryList"]
    - path: "src/router.js"
      provides: "trajectory list routing"
      contains: "case 'list'"
  key_links:
    - from: "src/commands/trajectory.js (list)"
      to: ".planning/memory/trajectory.json"
      via: "fs.readFileSync to load checkpoint journal entries"
      pattern: "trajectory\\.json.*category.*checkpoint"
    - from: "src/router.js"
      to: "src/commands/trajectory.js"
      via: "lazy-loaded dispatch for list subcommand"
      pattern: "cmdTrajectoryList"
---

<objective>
Create the `trajectory list` command that displays all checkpoints with metadata (name, scope, timestamp, git ref, metrics summary) in both JSON and formatted TTY output.

Purpose: Users need to see what checkpoints exist before they can pivot, compare, or choose — this is the read/discovery side of trajectory engineering.

Output: Working `trajectory list` command with tabular TTY output and JSON output.
</objective>

<execution_context>
@/home/cam/.config/oc/get-shit-done/workflows/execute-plan.md
@/home/cam/.config/oc/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/46-checkpoint-snapshot-metrics-collection/46-01-SUMMARY.md
@src/commands/trajectory.js
@src/router.js
@src/lib/constants.js
@src/lib/format.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement trajectory list command with formatted output</name>
  <files>src/commands/trajectory.js, src/router.js, src/lib/constants.js</files>
  <action>
Add `cmdTrajectoryList(cwd, args, raw)` to `src/commands/trajectory.js`.

**Command signature:** `trajectory list [--scope <scope>] [--name <name>] [--limit <N>]`

**List flow:**
1. Read `.planning/memory/trajectory.json` via fs. Filter entries where `category === "checkpoint"`.
2. Apply filters: `--scope` filters by scope field, `--name` filters by checkpoint_name field, `--limit` limits result count.
3. Sort: newest first (by timestamp, descending).
4. **JSON output** (piped/--json): Output array of checkpoint entries with all fields.
5. **TTY formatted output** (terminal): Render as a table using format.js patterns:
   ```
   bGSD ▶ TRAJECTORY CHECKPOINTS
   ────────────────────────────────────────────────────────────
    Name            Scope  Attempt  Ref      Tests    LOC Δ    Age
    ──────────────────────────────────────────────────────────────
    my-feature      phase  2        a1b2c3d  24/24 ✓  +50/-12  2h ago
    my-feature      phase  1        e4f5g6h  20/24 ✗  +30/-8   5h ago
    auth-approach   task   1        h7i8j9k  24/24 ✓  +15/-3   1d ago
   ────────────────────────────────────────────────────────────
   3 checkpoints (2 scopes)
   → trajectory compare my-feature
   ```

   Use `formatTable` from format.js for the table. Use `color.green` for passing tests, `color.red` for failures. Show relative timestamps (e.g., "2h ago", "1d ago") computed from checkpoint timestamp.

   For the metrics summary columns:
   - **Tests:** `pass/total ✓` (green) or `pass/total ✗` (red if any failures)
   - **LOC Δ:** `+insertions/-deletions`
   - **Ref:** First 7 chars of git_ref
   - **Age:** Relative time since checkpoint

6. If no checkpoints found, output: `{ checkpoints: [], count: 0 }` (JSON) or "No checkpoints found." (TTY).

**Router update (src/router.js):**
- Add `case 'list'` to the trajectory subcommand switch:
  ```
  case 'list': lazyTrajectory().cmdTrajectoryList(cwd, args.slice(1), raw); break;
  ```
- Update the default error message to include `list` in available subcommands.

**Constants update (src/lib/constants.js):**
- Update trajectory help text to include list subcommand:
  ```
  'trajectory': 'Trajectory engineering commands\n  checkpoint <name>  Create named checkpoint with auto-metrics\n    --scope <scope>   Scope level (default: phase)\n    --description <text>  Optional context description\n  list               List all checkpoints with metrics\n    --scope <scope>   Filter by scope\n    --name <name>     Filter by checkpoint name\n    --limit <N>       Limit results'
  ```

**Important constraints:**
- Import `output` from `../lib/output` (already done in trajectory.js from Plan 01)
- For TTY detection, check `global._gsdOutputMode` (same pattern as other commands with formatters)
- Use `output(result, { formatter })` pattern for dual-mode output
- Keep relative time computation simple: compute diff in seconds, format as "Xs ago", "Xm ago", "Xh ago", "Xd ago"
- Handle case where trajectory.json doesn't exist (no checkpoints yet) gracefully
  </action>
  <verify>
  ```bash
  npm run build && npm test
  # Create a test checkpoint first
  node bin/gsd-tools.cjs trajectory checkpoint list-test --scope phase
  # Then list
  node bin/gsd-tools.cjs trajectory list
  # Should show the checkpoint with metrics
  node bin/gsd-tools.cjs trajectory list --pretty
  # Should show formatted table
  # Cleanup
  git branch -D trajectory/phase/list-test/attempt-1 2>/dev/null
  ```
  </verify>
  <done>
  - `trajectory list` shows all checkpoints in JSON format
  - `trajectory list --pretty` shows formatted table with name, scope, attempt, ref, tests, LOC delta, age
  - Filters work: --scope, --name, --limit
  - Empty state handled gracefully
  - Build passes, all tests pass
  </done>
</task>

<task type="auto">
  <name>Task 2: Add trajectory list tests</name>
  <files>bin/gsd-tools.test.cjs</files>
  <action>
Add tests for the trajectory list command in `bin/gsd-tools.test.cjs`.

**Test cases (target: 6-8 tests):**

1. **Empty list:** `trajectory list` with no checkpoints → `{ checkpoints: [], count: 0 }`
2. **List after checkpoint:** Create a checkpoint, then `trajectory list` → returns 1 entry with all fields
3. **Scope filter:** Create checkpoints with different scopes, `trajectory list --scope phase` → only phase-scoped entries
4. **Name filter:** Create checkpoints with different names, `trajectory list --name my-test` → only matching entries
5. **Limit:** Create 3 checkpoints, `trajectory list --limit 2` → returns 2 entries
6. **Sort order:** Create 2 checkpoints (different times), list shows newest first
7. **Entry structure:** Listed entry has name, scope, attempt, branch, git_ref, timestamp, metrics fields
8. **Unknown subcommand:** `trajectory foo` → error with available subcommands

**Test approach:**
- Reuse the test patterns from Plan 01's checkpoint tests
- Pre-populate trajectory.json for some tests rather than running full checkpoint flow (faster, no git branch creation needed)
- For sort order test, manipulate timestamps directly in the JSON file
  </action>
  <verify>
  ```bash
  npm test 2>&1 | grep -E "list|trajectory"
  # All new tests should pass
  npm test 2>&1 | tail -5
  # Total test count increased, 0 failures
  ```
  </verify>
  <done>
  - 6+ trajectory list tests pass
  - Tests cover: empty state, filtering, limiting, sort order, entry structure, error handling
  - Total test suite passes with 0 failures
  - No existing tests broken
  </done>
</task>

</tasks>

<verification>
```bash
# Full verification:
npm run build
npm test
node bin/gsd-tools.cjs trajectory list
node bin/gsd-tools.cjs trajectory list --pretty
node bin/gsd-tools.cjs trajectory list --scope phase
node bin/gsd-tools.cjs trajectory list --name nonexistent
# Should return empty list gracefully
```
</verification>

<success_criteria>
- `trajectory list` returns all checkpoints with full metadata
- Formatted output shows table with name, scope, attempt, ref, tests, LOC delta, age
- Filters (--scope, --name, --limit) work correctly
- Empty state returns clean response (no crash)
- 6+ tests covering list command functionality
- Build passes, all tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/46-checkpoint-snapshot-metrics-collection/46-02-SUMMARY.md`
</output>
