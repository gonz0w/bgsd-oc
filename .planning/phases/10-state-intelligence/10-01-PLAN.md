---
phase: 10-state-intelligence
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/commands/state.js
  - bin/gsd-tools.cjs
  - bin/gsd-tools.test.cjs
autonomous: true
requirements:
  - SVAL-01
  - SVAL-02
  - SVAL-03
  - SVAL-04
  - SVAL-05

must_haves:
  truths:
    - "Running `state validate` reports mismatches between ROADMAP.md plan-completion claims and actual SUMMARY.md files on disk"
    - "Running `state validate` warns when STATE.md Current Position points to a non-existent or already-completed plan"
    - "Running `state validate` detects when Last activity timestamp is stale relative to recent .planning/ git commits"
    - "Running `state validate --fix` auto-corrects count mismatches in ROADMAP.md to match disk reality"
    - "Running `state validate` flags blockers and todos open for 2+ completed plans without resolution"
    - "Clean state outputs short confirmation: State validation passed — no issues found"
  artifacts:
    - path: "src/commands/state.js"
      provides: "cmdStateValidate function"
      contains: "function cmdStateValidate"
    - path: "bin/gsd-tools.cjs"
      provides: "state validate routing in CLI dispatch"
      contains: "state validate"
    - path: "bin/gsd-tools.test.cjs"
      provides: "Tests for state validate"
      contains: "state validate"
  key_links:
    - from: "src/commands/state.js"
      to: ".planning/ROADMAP.md"
      via: "fs.readFileSync + regex parsing"
      pattern: "ROADMAP\\.md"
    - from: "src/commands/state.js"
      to: ".planning/STATE.md"
      via: "fs.readFileSync + regex parsing"
      pattern: "STATE\\.md"
    - from: "src/commands/state.js"
      to: ".planning/phases/"
      via: "fs.readdirSync for disk reality comparison"
      pattern: "phases"
    - from: "bin/gsd-tools.cjs main()"
      to: "cmdStateValidate"
      via: "state subcommand routing"
      pattern: "validate"
---

<objective>
Implement the `state validate` command that detects drift between declared state (ROADMAP.md, STATE.md) and filesystem/git reality.

Purpose: This is the foundation of v2.0 State Intelligence — the plugin becomes self-aware of its own consistency. Every subsequent phase (session continuity, quality gates) depends on having accurate, validated state.

Output: New `state validate` and `state validate --fix` commands in gsd-tools.cjs with tests.
</objective>

<execution_context>
@/home/cam/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/cam/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/10-state-intelligence/10-CONTEXT.md
@.planning/codebase/ARCHITECTURE.md
@.planning/codebase/CONVENTIONS.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement cmdStateValidate with all 5 validation checks</name>
  <files>src/commands/state.js, bin/gsd-tools.cjs</files>
  <action>
Create `cmdStateValidate(cwd, options, raw)` in `src/commands/state.js` (the state commands module).

The function accepts `options = { fix: boolean }` and performs 5 validation checks, collecting issues into a structured array. Each issue has: `{ type, location, expected, actual, severity }` where severity is "error" or "warn".

**Check 1 — Plan count drift (SVAL-01):**
- Parse ROADMAP.md for each phase that has a "Plans:" or plan count field (e.g., `**Plans:** 3 plans` or `3/3 plans`)
- Count actual `-PLAN.md` files on disk in corresponding phase directory
- Count actual `-SUMMARY.md` files on disk
- If ROADMAP plan count doesn't match disk plan count: severity "error", type "plan_count_drift"
- If ROADMAP completion checkbox (`[x]`) is checked but disk has incomplete summaries: severity "error", type "completion_drift"
- Reuse the same phase-finding and file-counting patterns from `cmdRoadmapAnalyze()` (lines 1593-1696 of gsd-tools.cjs)

**Check 2 — Position validation (SVAL-02):**
- Read STATE.md, extract "Phase:" line (e.g., `Phase: 10 of 13 (State Intelligence)`) and "Plan:" line
- If the referenced phase directory doesn't exist on disk: severity "error", type "position_missing"
- If the referenced phase is already complete (all plans have summaries): severity "warn", type "position_completed"

**Check 3 — Activity staleness (SVAL-03):**
- Read STATE.md "Last activity:" line to get the declared timestamp
- Use `execGit(cwd, ['log', '-1', '--format=%ci', '--', '.planning/'])` to get the most recent .planning/ git commit date
- Also use `execGit(cwd, ['log', '-1', '--format=%ci', '--', '.planning/STATE.md'])` for STATE.md's own last commit
- If declared timestamp is >24 hours older than the most recent .planning/ git commit: severity "warn", type "activity_stale"
- Compare dates only (not times) to avoid false positives within same day

**Check 4 — Auto-fix (SVAL-04):**
- If `options.fix` is true AND there are "plan_count_drift" issues:
  - For each plan_count_drift issue: update the ROADMAP.md line to match disk reality
  - Use regex replacement on the `**Plans:**` or progress lines (e.g., `3/5 plans` → `4/5 plans`)
  - Auto-commit each fix: `execGit(cwd, ['add', roadmapPath])` then `execGit(cwd, ['commit', '-m', 'fix(state): correct phase N plan count X → Y'])`
  - Record fixes in result JSON
- Only fix count mismatches — do NOT fix timestamps, position, or other drift (per CONTEXT.md decision)

**Check 5 — Blocker/todo staleness (SVAL-05):**
- Read STATE.md "Blockers/Concerns" and "Pending Todos" sections
- Count completed plans since each blocker/todo was added (use git log to find when the text was added, or simpler: count total completed plans in current milestone)
- If a blocker or todo has existed through 2+ completed plan executions: severity "warn", type "stale_blocker" or "stale_todo"
- Default threshold: 2 plans (configurable via `.planning/config.json` key `staleness_threshold`)
- Read threshold from config using the existing `loadConfig()` pattern

**Output format:**
```json
{
  "status": "clean" | "warnings" | "errors",
  "issues": [ { "type": "...", "location": "...", "expected": "...", "actual": "...", "severity": "error|warn" } ],
  "fixes_applied": [ { "phase": "...", "field": "...", "old": "...", "new": "..." } ],
  "summary": "State validation passed — no issues found" | "Found N errors and M warnings"
}
```

When `--raw` is passed, output the JSON. Without `--raw`, output the same JSON (consistent with other commands).

**CLI routing:**
Add to the `state` subcommand dispatch in `main()` (after the existing `record-session` else-if block, before the default `cmdStateLoad` fallback):
```javascript
} else if (subcommand === 'validate') {
  const fix = args.includes('--fix');
  cmdStateValidate(cwd, { fix }, raw);
}
```

Also add to the COMMAND_HELP map:
```javascript
"state validate": `Usage: gsd-tools state validate [--fix] [--raw]

Validate state consistency between declared state and disk reality.

Checks:
  Plan count drift     ROADMAP.md claims vs actual files
  Position validity    STATE.md position vs existing phases
  Activity staleness   Last activity timestamp vs git history
  Blocker/todo age     Items open through 2+ completed plans

Options:
  --fix    Auto-correct plan count mismatches in ROADMAP.md
  --raw    JSON output`
```

**Patterns to follow:**
- Use the `output(result, raw)` and `error(message)` patterns from CONVENTIONS.md
- Use `safeReadFile()` for all file reads that might not exist
- Use `execGit(cwd, args)` for all git operations
- Use `debugLog('state.validate', ...)` for debug logging in catch blocks
- Follow the guard-and-exit pattern for required params
- Follow the `cmdXxx(cwd, options, raw)` function signature convention
  </action>
  <verify>
Run: `node bin/gsd-tools.cjs state validate --raw` from the project root — should return valid JSON with status field.
Run: `node bin/gsd-tools.cjs state validate --help` — should show usage text.
Run: `npm run build` — should complete without errors.
  </verify>
  <done>
`state validate` returns structured JSON with status (clean/warnings/errors), issues array, and summary message. All 5 check types are implemented: plan_count_drift, position_missing/position_completed, activity_stale, stale_blocker/stale_todo. `--fix` flag corrects plan count mismatches and auto-commits.
  </done>
</task>

<task type="auto">
  <name>Task 2: Write tests for state validate command</name>
  <files>bin/gsd-tools.test.cjs</files>
  <action>
Add a `describe('state validate', ...)` test block to `bin/gsd-tools.test.cjs`.

Use the existing test patterns: `beforeEach` creates a temp `.planning/` directory structure, `afterEach` cleans up. Reference the STATE_FIXTURE and existing state mutation test patterns from Phase 1.

**Test cases (minimum 8):**

1. **Clean state returns "clean" status** — Create a `.planning/` directory with ROADMAP.md declaring 1 plan for phase 1, STATE.md pointing to phase 1, and 1 actual PLAN.md + 1 SUMMARY.md on disk. Verify `status === "clean"` and empty issues array.

2. **Detects plan count drift** — ROADMAP.md says "2/2 plans" but disk only has 1 PLAN.md. Verify issue with type "plan_count_drift" and severity "error".

3. **Detects completion drift** — ROADMAP.md checkbox marked `[x]` but disk has 2 PLANs and only 1 SUMMARY. Verify issue with type "completion_drift" and severity "error".

4. **Detects missing position** — STATE.md says "Phase: 99 of 13" but phase 99 directory doesn't exist. Verify issue with type "position_missing" and severity "error".

5. **Detects completed position** — STATE.md points to phase 1, but phase 1 has equal PLANs and SUMMARYs (complete). Verify issue with type "position_completed" and severity "warn".

6. **Detects stale activity** — STATE.md says "Last activity: 2025-01-01" but there are recent git commits. This test may need to mock/skip git if no git repo exists in temp dir. If git is available in the test temp dir, make a commit dated recently and set STATE.md date to 2025-01-01. Otherwise mark this test as conditional on git availability.

7. **--fix corrects plan count** — Set up a plan count drift, run with `--fix`, verify ROADMAP.md was updated on disk and `fixes_applied` array is non-empty in the result.

8. **No blocker staleness when blockers section is empty** — STATE.md has "None." under Blockers. Verify no stale_blocker issues.

**Test execution pattern:**
Each test should invoke the CLI via `execSync`:
```javascript
const result = JSON.parse(execSync(`node bin/gsd-tools.cjs state validate --raw`, { cwd: tmpDir, encoding: 'utf-8' }));
```

Follow the existing test conventions:
- Use `node:test` describe/test/beforeEach/afterEach
- Use `node:assert` for assertions (deepStrictEqual, strictEqual, ok)
- Clean up temp directories in afterEach
  </action>
  <verify>
Run: `npm test` — all existing tests pass AND new state validate tests pass.
Run: `node --test --test-name-pattern="state validate" bin/gsd-tools.test.cjs` — runs only the new tests.
  </verify>
  <done>
At least 8 test cases pass for `state validate` covering: clean state, plan count drift, completion drift, position missing, position completed, activity staleness, --fix auto-correction, and empty blockers. All prior tests still pass.
  </done>
</task>

</tasks>

<verification>
1. `node bin/gsd-tools.cjs state validate --raw` returns valid JSON with `status`, `issues`, `fixes_applied`, `summary` fields
2. `node bin/gsd-tools.cjs state validate --fix --raw` on a project with drift returns `fixes_applied` with at least one entry
3. `npm test` passes all tests including new state validate tests
4. `npm run build` succeeds (bundled output includes new command)
5. `node bin/gsd-tools.cjs state validate --help` displays usage information
</verification>

<success_criteria>
- `state validate` correctly detects plan count drift between ROADMAP.md and disk
- `state validate` correctly detects invalid STATE.md position references
- `state validate` correctly detects stale activity timestamps via git history
- `state validate --fix` auto-corrects count mismatches and commits
- `state validate` flags blockers/todos open for 2+ completed plans
- Clean state produces short "no issues found" confirmation
- Output format matches decision: `{ type, location, expected, actual, severity }` per issue
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/10-state-intelligence/10-01-SUMMARY.md`
</output>
