---
phase: 10-state-intelligence
plan: 02
type: execute
wave: 2
depends_on:
  - "10-01"
files_modified:
  - workflows/execute-phase.md
  - src/commands/state.js
  - bin/gsd-tools.cjs
  - bin/gsd-tools.test.cjs
autonomous: true
requirements:
  - SVAL-06

must_haves:
  truths:
    - "Execute-phase automatically runs state validation before any plan execution begins"
    - "Errors block execution, warnings print but don't block"
    - "Pre-flight auto-runs --fix first, then blocks only on remaining errors"
    - "Clean state shows minimal banner: Pre-flight: OK"
    - "Users can bypass pre-flight with --skip-validate flag"
  artifacts:
    - path: "workflows/execute-phase.md"
      provides: "Pre-flight state validation step in execute-phase workflow"
      contains: "state validate"
    - path: "src/commands/state.js"
      provides: "cmdStateValidatePreFlight helper for structured pre-flight output"
      contains: "preflight"
    - path: "bin/gsd-tools.test.cjs"
      provides: "Tests for pre-flight integration"
      contains: "pre-flight"
  key_links:
    - from: "workflows/execute-phase.md"
      to: "bin/gsd-tools.cjs state validate"
      via: "CLI invocation in workflow step"
      pattern: "state validate"
    - from: "workflows/execute-phase.md"
      to: "bin/gsd-tools.cjs state validate --fix"
      via: "Auto-fix before blocking check"
      pattern: "state validate --fix"
---

<objective>
Integrate state validation as a pre-flight check in the execute-phase workflow, so drift is automatically detected and self-healed before plan execution begins.

Purpose: The pre-flight check is the user-facing payoff of state intelligence — most sessions self-heal without user intervention via auto-fix, and only genuinely broken state blocks execution.

Output: Updated execute-phase.md workflow with pre-flight step, config support for `--skip-validate`, and integration tests.
</objective>

<execution_context>
@/home/cam/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/cam/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/10-state-intelligence/10-CONTEXT.md
@.planning/phases/10-state-intelligence/10-01-SUMMARY.md
@.planning/codebase/ARCHITECTURE.md
@.planning/codebase/CONVENTIONS.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add pre-flight state validation step to execute-phase workflow</name>
  <files>workflows/execute-phase.md, src/commands/state.js, bin/gsd-tools.cjs</files>
  <action>
**1. Update execute-phase.md workflow:**

Add a new step `preflight_state_validation` between the existing `preflight_dependency_check` step and the `discover_and_group_plans` step (i.e., after line ~46, before the plan discovery step).

The new step should:

```markdown
<step name="preflight_state_validation">
If `--skip-validate` flag: skip silently.

Otherwise, run auto-fix first, then validate:

```bash
# Auto-fix what we can
FIX_RESULT=$(node {gsd-tools-path} state validate --fix --raw 2>/dev/null)
# Then check for remaining issues
VALIDATE_RESULT=$(node {gsd-tools-path} state validate --raw 2>/dev/null)
```

Parse `VALIDATE_RESULT` for `status` field:
- `"clean"`: Display "Pre-flight: OK" and continue
- `"warnings"`: Display warning table, continue execution
- `"errors"`: Display error table. In yolo/auto mode: display errors but continue with warning banner. In interactive mode: ask user to fix or proceed with `--skip-validate`.

If `FIX_RESULT` has `fixes_applied` entries: display "Pre-flight auto-fixed: {count} issue(s)" before the status.

Error classification per CONTEXT.md decisions:
- position errors + count mismatches = "error" (blocking)
- staleness = "warn" (non-blocking)

Display format: Use structured table when issues exist:
```
| Type | Location | Expected | Actual | Severity |
```
</step>
```

Use the `{gsd-tools-path}` pattern consistent with other CLI invocations in the workflow (full path: `node /home/cam/.config/opencode/get-shit-done/bin/gsd-tools.cjs`).

**2. Add `--skip-validate` flag handling to execute-phase.md:**

In the argument parsing section at the top of execute-phase.md, add `--skip-validate` to the recognized flags. This is a workflow-level flag (not a CLI flag) — it controls whether the pre-flight step runs.

**3. Add init support for skip-validate:**

Update `cmdInitExecutePhase` in `src/commands/state.js` (or wherever init execute-phase lives) to include a `skip_validate` field in its output JSON, reading from either:
- CLI args `--skip-validate` flag
- Config: `.planning/config.json` key `gates.skip_validate` (default: false)

Actually — looking at the architecture, the `--skip-validate` flag is a workflow-level argument, not a config flag. The workflow parses it from the user's slash command input. BUT also support a config.json key `gates.pre_flight_validation` (default: true) that can permanently disable it.

Add to `cmdInitExecutePhase`:
```javascript
const config = loadConfig(cwd);
const preFlightEnabled = config.gates?.pre_flight_validation !== false;
// Add to result JSON:
result.pre_flight_validation = preFlightEnabled;
```

**4. Update COMMAND_HELP for state validate:**

Ensure the help text mentions the pre-flight integration:
```
Pre-flight: Execute-phase automatically runs state validate --fix before
execution. Errors block, warnings display. Use --skip-validate to bypass.
```
  </action>
  <verify>
Run: `npm run build` — completes without errors.
Verify: `workflows/execute-phase.md` contains the new `preflight_state_validation` step.
Verify: The step references `state validate --fix` and `state validate` CLI commands.
Run: `node bin/gsd-tools.cjs init execute-phase 10 --raw` — result JSON includes `pre_flight_validation` field.
  </verify>
  <done>
Execute-phase workflow includes pre-flight state validation step between dependency check and plan discovery. Step auto-fixes first, then blocks on remaining errors. Clean state shows "Pre-flight: OK". `--skip-validate` flag and `gates.pre_flight_validation` config key both supported. Init execute-phase output includes `pre_flight_validation` field.
  </done>
</task>

<task type="auto">
  <name>Task 2: Write integration tests for pre-flight and end-to-end validate flow</name>
  <files>bin/gsd-tools.test.cjs</files>
  <action>
Add tests to `bin/gsd-tools.test.cjs` in a new `describe('state validate pre-flight', ...)` block.

**Test cases (minimum 4):**

1. **init execute-phase includes pre_flight_validation field** — Run `node bin/gsd-tools.cjs init execute-phase 10 --raw` against a test project directory with valid `.planning/` structure. Verify result JSON has `pre_flight_validation` key (boolean).

2. **pre_flight_validation respects config** — Create a `.planning/config.json` with `{ "gates": { "pre_flight_validation": false } }`. Run init execute-phase. Verify `pre_flight_validation === false`.

3. **state validate --fix then validate returns clean** — Set up a temp project with plan count drift (ROADMAP says 2 plans, disk has 3). Run `state validate --fix --raw`. Verify fixes_applied non-empty. Then run `state validate --raw`. Verify status is "clean" (or at least the plan_count_drift is gone).

4. **state validate with multiple issue types** — Set up a temp project with both plan count drift AND a stale activity timestamp AND a completed position. Run `state validate --raw`. Verify issues array contains items with different severity levels (both "error" and "warn").

**Test execution pattern:**
Same as Plan 01 tests — `execSync` to invoke CLI, JSON.parse the result, assert on fields.

Follow existing test conventions from the codebase.
  </action>
  <verify>
Run: `npm test` — all tests pass including both Plan 01 and Plan 02 test suites.
Run: `node --test --test-name-pattern="pre-flight" bin/gsd-tools.test.cjs` — runs only the new tests.
  </verify>
  <done>
At least 4 integration tests pass covering: init field presence, config respect, fix-then-validate flow, and multi-issue detection. All prior tests still pass. Full `npm test` green.
  </done>
</task>

</tasks>

<verification>
1. `workflows/execute-phase.md` contains `preflight_state_validation` step between dependency check and plan discovery
2. The pre-flight step invokes `state validate --fix` first, then `state validate` for remaining checks
3. `node bin/gsd-tools.cjs init execute-phase 10 --raw` includes `pre_flight_validation` field
4. Setting `gates.pre_flight_validation: false` in config.json disables pre-flight
5. `npm test` passes all tests (existing + Plan 01 + Plan 02)
6. `npm run build` succeeds
</verification>

<success_criteria>
- Execute-phase workflow runs state validation automatically before plan execution
- Auto-fix runs first, then remaining errors block (interactive) or warn (yolo/auto)
- Clean state shows "Pre-flight: OK" — lightweight, not ceremony
- `--skip-validate` flag bypasses pre-flight entirely
- `gates.pre_flight_validation` config key controls default behavior
- All tests pass including integration tests for pre-flight flow
</success_criteria>

<output>
After completion, create `.planning/phases/10-state-intelligence/10-02-SUMMARY.md`
</output>
