---
phase: 49-choose-merge-winner-cleanup
plan: 02
type: execute
wave: 2
depends_on: [49-01]
files_modified:
  - bin/gsd-tools.test.cjs
autonomous: true
requirements: [CHOOSE-01, CHOOSE-02, CHOOSE-03]

must_haves:
  truths:
    - "Tests verify winning attempt code is merged into current branch"
    - "Tests verify non-chosen attempts are archived as git tags"
    - "Tests verify trajectory working branches are deleted after choose"
    - "Tests verify journal records choose entry with rationale and lifecycle-complete tag"
    - "All existing tests still pass (no regressions)"
  artifacts:
    - path: "bin/gsd-tools.test.cjs"
      provides: "trajectory choose test suite"
      contains: "trajectory choose"
  key_links:
    - from: "bin/gsd-tools.test.cjs"
      to: "bin/gsd-tools.cjs"
      via: "execFileSync trajectory choose"
      pattern: "trajectory.*choose"
---

<objective>
Add comprehensive test suite for trajectory choose command covering all three CHOOSE requirements, edge cases, and journal integrity.

Purpose: Validate that choose merges, archives, cleans up, and journals correctly — the final trajectory lifecycle step must be rock solid.
Output: Passing test suite covering CHOOSE-01, CHOOSE-02, CHOOSE-03 with build verification.
</objective>

<execution_context>
@/home/cam/.config/oc/get-shit-done/workflows/execute-plan.md
@/home/cam/.config/oc/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/49-choose-merge-winner-cleanup/49-01-SUMMARY.md
@bin/gsd-tools.test.cjs
@src/commands/trajectory.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add trajectory choose test suite</name>
  <files>bin/gsd-tools.test.cjs</files>
  <action>
Add a `describe('trajectory choose', ...)` block in the trajectory test section of gsd-tools.test.cjs, following the exact same patterns as the trajectory compare and trajectory pivot test blocks.

**Test setup helper:** Create `initGitForChoose(dir)` that:
1. Initializes git repo with initial commit
2. Uses `writeTrajectoryEntries(dir, entries)` pattern (same as compare tests) to seed journal data
3. Creates actual git branches matching the journal entries (needed since choose will merge/delete them)

**Critical:** Unlike compare tests, choose tests MUST create real git branches because choose does `git merge` and `git branch -D`. Use `execSync('git branch <name>')` in test setup.

**Test cases (10-12 tests):**

1. **CHOOSE-01: Basic choose merges winning attempt** — Create 2 checkpoint entries with branches, each with a unique file committed on that branch. Run `trajectory choose <name> --attempt 2`. Verify: JSON output has `chosen: true`, `chosen_attempt: 2`. Verify the winning branch's file exists in working tree after merge.

2. **CHOOSE-01: Choose requires --attempt flag** — Run without --attempt. Verify: exits with error containing "Must specify winning attempt".

3. **CHOOSE-01: Choose validates attempt exists** — Run with --attempt 99. Verify: exits with error about attempt not found.

4. **CHOOSE-01: Choose rejects abandoned attempt as winner** — Create checkpoint + abandoned entry. Run choose with the abandoned attempt number. Verify: error (can't choose abandoned attempt).

5. **CHOOSE-02: Non-chosen attempts archived as tags** — Create 3 checkpoints (attempts 1, 2, 3). Choose attempt 2. Verify: git tags exist for attempt-1 and attempt-3 branches. Verify: `git tag -l` output contains the archived tag names.

6. **CHOOSE-03: Working branches deleted after choose** — After choose, verify: `git branch --list 'trajectory/*'` returns empty. Verify: `git branch --list 'archived/*'` returns empty (branches gone, only tags remain).

7. **Journal records choose entry** — After choose, read trajectory.json. Verify: last entry has `category: 'choose'`, `chosen_attempt` matches, `tags` includes 'choose' and 'lifecycle-complete', `archived_tags` and `deleted_branches` arrays are populated.

8. **Choose with --reason records rationale** — Run with `--reason "Best test coverage"`. Verify: journal entry has `reason.text` matching.

9. **Choose without --reason still works** — Run without reason flag. Verify: succeeds, journal entry has `reason: null`.

10. **Choose with missing checkpoint name errors** — Run with no name. Verify: error about missing checkpoint name.

11. **Choose with non-existent branch errors gracefully** — Create journal entry but DON'T create the actual git branch. Run choose. Verify: error about branch not found.

12. **TTY output format** — Run choose (without --json implied). Verify output contains "TRAJECTORY CHOOSE" banner text.

**Pattern notes:**
- Use `writeTrajectoryEntries(dir, entries)` for journal setup (from compare tests)
- Use `execSync` for git branch creation in test dirs
- Parse JSON output with `JSON.parse()` for structured assertions
- Each test gets its own temp directory via `mkdtempSync`
  </action>
  <verify>npm test -- --grep "trajectory choose" passes all new tests</verify>
  <done>10+ trajectory choose tests pass covering CHOOSE-01 (merge), CHOOSE-02 (tag archival), CHOOSE-03 (branch cleanup), journal integrity, error cases</done>
</task>

<task type="auto">
  <name>Task 2: Run full test suite and verify build</name>
  <files>bin/gsd-tools.cjs</files>
  <action>
1. Run `npm run build` — verify bundle compiles and stays within 1050KB budget.
2. Run `npm test` — verify ALL tests pass (expect ~750+ with new choose tests). Zero failures, zero regressions.
3. If any failures: fix them. If build exceeds budget: optimize.
  </action>
  <verify>npm test shows 0 failures, npm run build shows bundle ≤ 1050KB</verify>
  <done>Full test suite passes (750+ tests, 0 failures), build within 1050KB budget, no regressions from Phase 48 baseline of 739 tests</done>
</task>

</tasks>

<verification>
1. `npm test -- --grep "trajectory choose"` — all choose tests pass
2. `npm test` — full suite passes, 0 failures
3. `npm run build` — bundle ≤ 1050KB
4. Test count increased from 739 baseline by 10+ new tests
</verification>

<success_criteria>
- 10+ trajectory choose tests covering all CHOOSE requirements
- All tests pass including existing test suite (zero regressions)
- Build within size budget
- Coverage: merge (CHOOSE-01), tag archival (CHOOSE-02), branch cleanup (CHOOSE-03), journal integrity, error handling
</success_criteria>

<output>
After completion, create `.planning/phases/49-choose-merge-winner-cleanup/49-02-SUMMARY.md`
</output>
