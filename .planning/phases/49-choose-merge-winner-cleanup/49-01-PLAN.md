---
phase: 49-choose-merge-winner-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/commands/trajectory.js
  - src/router.js
  - src/lib/constants.js
autonomous: true
requirements: [CHOOSE-01, CHOOSE-02, CHOOSE-03]

must_haves:
  truths:
    - "User can run trajectory choose <name> --attempt <N> and the winning attempt's code is merged into the current branch"
    - "Non-chosen attempts are archived as git tags (not branches) at archived/trajectory/<scope>/<name>/attempt-N"
    - "All trajectory working branches (trajectory/<scope>/<name>/attempt-*) are deleted after archival"
    - "Journal records a 'choose' entry with chosen attempt, rationale, and list of archived/deleted branches"
  artifacts:
    - path: "src/commands/trajectory.js"
      provides: "cmdTrajectoryChoose command and formatChooseResult formatter"
      exports: ["cmdTrajectoryChoose"]
    - path: "src/router.js"
      provides: "trajectory choose routing"
      contains: "case 'choose'"
    - path: "src/lib/constants.js"
      provides: "trajectory choose help text"
      contains: "trajectory choose"
  key_links:
    - from: "src/router.js"
      to: "src/commands/trajectory.js"
      via: "lazyTrajectory().cmdTrajectoryChoose"
      pattern: "case 'choose'"
    - from: "src/commands/trajectory.js"
      to: ".planning/memory/trajectory.json"
      via: "journal read/write"
      pattern: "trajectory\\.json"
    - from: "src/commands/trajectory.js"
      to: "git tag/branch operations"
      via: "execGit"
      pattern: "execGit.*tag|execGit.*branch"
---

<objective>
Implement the `trajectory choose` command that selects a winning attempt, merges its code, archives non-chosen attempts as tags, and cleans up all trajectory working branches.

Purpose: Complete the trajectory lifecycle — after checkpoint, pivot, and compare, the user needs to finalize their choice and get back to a clean working state.
Output: Working `trajectory choose` command with TTY formatter, router wiring, and help text.
</objective>

<execution_context>
@/home/cam/.config/oc/get-shit-done/workflows/execute-plan.md
@/home/cam/.config/oc/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/INTENT.md
@.planning/phases/48-compare-multi-attempt-metrics-aggregation/48-01-SUMMARY.md
@src/commands/trajectory.js
@src/router.js
@src/lib/constants.js
@src/lib/git.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement cmdTrajectoryChoose and formatChooseResult</name>
  <files>src/commands/trajectory.js</files>
  <action>
Add `cmdTrajectoryChoose(cwd, args, raw)` function to trajectory.js, following the exact same patterns as cmdTrajectoryPivot and cmdTrajectoryCompare.

**Command signature:** `trajectory choose <name> --attempt <N> [--scope <scope>] [--reason "why this approach won"]`

**Implementation steps:**

1. **Parse args** — Same pattern as pivot/compare: extract positional `name`, `--attempt N` (REQUIRED), `--scope` (default 'phase'), `--reason` (optional but encouraged).

2. **Validate inputs** — name required + NAME_RE check, attempt number required (error if missing: "Must specify winning attempt: trajectory choose <name> --attempt <N>").

3. **Read trajectory journal** — Same pattern: read `.planning/memory/trajectory.json`, parse entries array.

4. **Find all checkpoint entries** for this scope+name (including abandoned ones for branch cleanup). The winning attempt must exist and NOT be abandoned.

5. **Merge winning attempt's code** — Use `execGit(cwd, ['merge', '--no-ff', winningEntry.branch, '-m', 'trajectory: choose attempt-N for <name>'])`. If merge fails (conflict), error with helpful message: "Merge conflict. Resolve manually, then commit." Do NOT use selectiveRewind — this is a forward merge, not a rewind.

   **IMPORTANT:** Before merge, verify the winning branch exists: `execGit(cwd, ['rev-parse', '--verify', winningEntry.branch])`. If not, error: "Branch not found: {branch}. Was it already cleaned up?"

6. **Archive non-chosen attempts as tags** — For each non-winning checkpoint entry (both active and abandoned) that has a branch:
   - Create lightweight tag: `execGit(cwd, ['tag', entry.branch, entry.git_ref])` — tag name matches branch name (archived/trajectory/... for abandoned, trajectory/... for active non-chosen).
   - Track created tags in result.

7. **Delete trajectory working branches** — For ALL entries (including winner after merge, and abandoned):
   - Delete branch: `execGit(cwd, ['branch', '-D', entry.branch])`
   - Track deleted branches in result.
   - Use -D (force) since branches may not be fully merged to HEAD.

8. **Write journal entry** — Generate unique ID (same crypto.randomBytes pattern). Create entry:
   ```js
   {
     id, timestamp: new Date().toISOString(),
     category: 'choose',
     text: `Chosen: ${name} attempt ${attemptNum}`,
     scope, checkpoint_name: name,
     chosen_attempt: attemptNum,
     chosen_branch: winningEntry.branch,
     chosen_ref: winningEntry.git_ref,
     reason: reasonText ? { text: reasonText } : null,
     archived_tags: [...tagNames],
     deleted_branches: [...branchNames],
     tags: ['choose', 'lifecycle-complete'],
   }
   ```

9. **Output** — `output(result, { formatter: formatChooseResult })` with JSON structure:
   ```js
   {
     chosen: true, checkpoint: name, scope,
     chosen_attempt: attemptNum, chosen_branch: winningEntry.branch,
     merge_ref: mergeResult (HEAD after merge),
     archived_tags: [...], deleted_branches: [...],
     reason: reasonText || null,
   }
   ```

**Add formatChooseResult TTY formatter** following the exact same pattern as formatPivotResult/formatCompareResult:
- `banner('TRAJECTORY CHOOSE')`
- Summary line: "Chose attempt {N} for {name}. Merged and cleaned up."
- List archived tags with SYMBOLS.check
- List deleted branches with SYMBOLS.check
- If reason provided, show it dimmed
- `actionHint('trajectory list')` at bottom

**Update module.exports** to include cmdTrajectoryChoose.
  </action>
  <verify>npm run build succeeds (bundle compiles without errors)</verify>
  <done>cmdTrajectoryChoose function exists, handles merge + archive tags + branch cleanup + journal write, formatChooseResult renders TTY output, exported from module</done>
</task>

<task type="auto">
  <name>Task 2: Wire router and add help text</name>
  <files>src/router.js, src/lib/constants.js</files>
  <action>
**Router (src/router.js):**
Add `case 'choose':` to the trajectory switch block (after 'compare'), following exact same pattern:
```js
case 'choose': lazyTrajectory().cmdTrajectoryChoose(cwd, args.slice(1), raw); break;
```

**Constants (src/lib/constants.js):**

1. Update main `trajectory` help text — add `choose` to the subcommand list and examples:
   - Add line: `  choose <name> --attempt <N>   Select winner, archive rest, clean up`
   - Add example: `  gsd-tools trajectory choose my-feat --attempt 2 --reason "Better test coverage"`

2. Add compound help key `'trajectory choose'` with full usage docs following the exact same format as 'trajectory compare' and 'trajectory pivot':
   ```
   Usage: gsd-tools trajectory choose <name> --attempt <N> [--scope <scope>] [--reason "rationale"]
   
   Select the winning attempt, merge its code, archive non-chosen attempts as tags,
   and delete all trajectory working branches.
   
   Arguments:
     name              Checkpoint name to finalize
   
   Options:
     --attempt <N>     Required. The winning attempt number
     --scope <scope>   Scope level (default: phase)
     --reason "text"   Why this attempt was chosen (recorded in journal)
   
   What happens:
     1. Winning attempt branch is merged into current branch (--no-ff)
     2. Non-chosen attempt branches are archived as lightweight git tags
     3. All trajectory working branches are deleted (tags preserved)
     4. Journal records the choice with rationale
   
   Examples:
     gsd-tools trajectory choose my-feat --attempt 2
     gsd-tools trajectory choose try-redis --scope task --attempt 1 --reason "Lower complexity"
   ```
  </action>
  <verify>npm run build succeeds and `node bin/gsd-tools.cjs trajectory choose` shows help text (no crash)</verify>
  <done>Router dispatches 'choose' to cmdTrajectoryChoose, help text shows for both 'trajectory' and 'trajectory choose'</done>
</task>

</tasks>

<verification>
1. `npm run build` — bundle compiles, size within 1050KB budget
2. `node bin/gsd-tools.cjs help trajectory` — shows choose subcommand
3. `node bin/gsd-tools.cjs help trajectory choose` — shows full choose usage
4. No existing tests regress: `npm test` passes
</verification>

<success_criteria>
- trajectory choose command implemented with merge, tag archival, branch cleanup, and journal write
- Router wires choose subcommand correctly
- Help text covers usage, options, and examples
- Build succeeds within size budget
- All existing tests still pass
</success_criteria>

<output>
After completion, create `.planning/phases/49-choose-merge-winner-cleanup/49-01-SUMMARY.md`
</output>
