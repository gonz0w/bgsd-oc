---
phase: 21-worktree-parallelism
plan: 02
type: execute
wave: 2
depends_on: [21-01]
files_modified:
  - src/commands/worktree.js
  - bin/gsd-tools.test.cjs
  - bin/gsd-tools.cjs
autonomous: true
requirements: [WKTR-03, WKTR-06]

must_haves:
  truths:
    - "worktree merge <plan-id> runs git merge-tree dry-run before actual merge"
    - "Clean merges auto-proceed — worktree branch merged into base branch"
    - "Conflicts block merge with file-level conflict report"
    - "files_modified overlap from PLAN.md frontmatter produces pre-merge warning"
    - "Both static analysis and git merge-tree feed into merge decision"
  artifacts:
    - path: "src/commands/worktree.js"
      provides: "Worktree merge command with dry-run and conflict detection"
      contains: "merge-tree"
  key_links:
    - from: "src/commands/worktree.js"
      to: "git merge-tree"
      via: "execGit for merge-tree --write-tree dry-run"
      pattern: "merge-tree.*--write-tree"
    - from: "src/commands/worktree.js"
      to: "src/lib/frontmatter.js"
      via: "extractFrontmatter for files_modified overlap detection"
      pattern: "files_modified|extractFrontmatter"
---

<objective>
Add merge command with conflict pre-check (git merge-tree dry-run) and static file overlap detection from PLAN.md frontmatter.

Purpose: Safe, automated merge-back from worktrees with conflict detection at two levels — static (plan-time) and dynamic (merge-time).
Output: `worktree merge` command, `worktree check-overlap` command, tests.
</objective>

<execution_context>
@/home/cam/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/cam/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/21-worktree-parallelism/21-CONTEXT.md
@.planning/phases/21-worktree-parallelism/21-01-SUMMARY.md
@src/commands/worktree.js (from Plan 01 — worktree create/list/remove/cleanup)
@src/lib/frontmatter.js (extractFrontmatter helper)
@src/lib/git.js (execGit helper)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Worktree merge command + file overlap detection</name>
  <files>
    src/commands/worktree.js
    src/router.js
  </files>
  <action>
Add to `src/commands/worktree.js`:

**cmdWorktreeMerge(cwd, planId, raw):**
- Find worktree for plan_id (from `git worktree list --porcelain`, match branch pattern `worktree-{phase}-{plan}-*`)
- Get branch name for the worktree
- Get current branch (the base): `git rev-parse --abbrev-ref HEAD`

Step 1 — Static file overlap analysis:
- Read PLAN.md frontmatter for the given plan_id to get `files_modified`
- Read all other PLAN.md files in the same phase directory to get their `files_modified`
- Find intersection of files_modified between this plan and others
- If overlap found: include warning in output (advisory, not blocking — per CONTEXT.md: "both signals feed into merge decision")

Step 2 — Git merge-tree dry-run:
- Run `git merge-tree --write-tree {base_branch} {worktree_branch}` via execGit
- Parse exit code:
  - Exit 0: clean merge, tree SHA in stdout → proceed
  - Exit 1: conflicts detected → parse stderr/stdout for conflicting file paths
  - Exit >1: git error
- For conflicts: parse the "CONFLICT" lines from merge-tree output to extract file paths and conflict types (content, rename/delete, etc.)

Step 3 — Merge execution (only if clean):
- If dry-run clean AND no blocking conflicts:
  - `git merge {worktree_branch} --no-ff -m "merge: plan {plan_id} worktree"` via execGit
  - Output: `{ merged: true, plan_id, branch, tree_sha, file_overlap_warnings: [...] }`
- If conflicts:
  - Output: `{ merged: false, plan_id, conflicts: [{ file, type }], file_overlap_warnings: [...] }`
  - Do NOT attempt merge

Auto-resolve rules (per CONTEXT.md):
- Lockfiles (package-lock.json, pnpm-lock.yaml, yarn.lock, go.sum): if ONLY lockfile conflicts, auto-resolve by accepting worktree version, then re-run merge-tree
- Generated files (.planning/baselines/*): accept worktree version
- For all other conflicts: block and report

**cmdWorktreeCheckOverlap(cwd, phaseNumber, raw):**
- Read all PLAN.md files in the phase directory
- Extract `files_modified` from each plan's frontmatter
- Build overlap matrix: for each pair of plans in the same wave, find shared files
- Output: `{ overlaps: [{ plans: [id1, id2], files: [...], wave: N }], has_conflicts: bool }`
- This is the pre-execution static analysis command that execute-phase can call before creating worktrees

Add router entries for `worktree merge` and `worktree check-overlap` subcommands.
  </action>
  <verify>
- Create test scenario: two worktrees modifying different files → both merge cleanly
- Create test scenario: two worktrees modifying same file → conflict detected and blocked
- `node bin/gsd-tools.cjs worktree check-overlap 21 --raw` returns overlap analysis JSON
- `node bin/gsd-tools.cjs worktree merge 21-01 --raw` merges clean worktree or reports conflicts
  </verify>
  <done>Merge command uses git merge-tree dry-run to pre-check. Clean merges auto-proceed. Conflicts blocked with file-level report. Lockfiles auto-resolved. Static overlap detection available for pre-execution analysis.</done>
</task>

<task type="auto">
  <name>Task 2: Merge and overlap detection tests</name>
  <files>
    bin/gsd-tools.test.cjs
  </files>
  <action>
Add test suite for merge and overlap detection in `bin/gsd-tools.test.cjs`.

**Test setup helper:** `createWorktreeTestRepo()`:
- Create temp dir, init git repo with an initial commit
- Create `.planning/config.json` with worktree config (base_path pointing to temp dir)
- Return { repoDir, configDir, cleanup }

**Tests for `worktree merge`:**

1. **Clean merge succeeds:**
   - Create worktree, modify a unique file in it, commit in worktree
   - Run merge → expect `{ merged: true }`
   - Verify merged content is in base branch

2. **Conflict detected and blocked:**
   - Create worktree, modify file X in worktree AND modify file X in base
   - Run merge → expect `{ merged: false, conflicts: [...] }`
   - Verify file X has no conflict markers in base (merge was blocked)

3. **Lockfile auto-resolution:**
   - Create worktree, modify package-lock.json in both worktree and base
   - Run merge → expect clean merge (lockfile auto-resolved)

4. **File overlap warning included:**
   - Create two PLAN.md files in phase dir, both listing same file in files_modified
   - Run merge for plan 1 → output includes `file_overlap_warnings`

5. **Merge of non-existent plan_id returns error:**
   - Run merge with plan_id that has no worktree → error response

6. **Merge with no commits in worktree:**
   - Create worktree but make no changes → merge succeeds as no-op (or nothing to merge)

**Tests for `worktree check-overlap`:**

1. **No overlap between plans in different waves:**
   - Two plans with different files_modified → `has_conflicts: false`

2. **Overlap detected within same wave:**
   - Two plans in wave 1 sharing `src/router.js` → overlap reported

3. **No overlap when plans have disjoint files:**
   - Three plans, all different files → empty overlaps

4. **Handles missing files_modified gracefully:**
   - Plan without files_modified frontmatter → skipped, no crash

All tests isolated in temp directories with afterEach cleanup.
Run: `node --test bin/gsd-tools.test.cjs` — all tests pass.
  </action>
  <verify>
- `node --test bin/gsd-tools.test.cjs 2>&1 | tail -5` shows 0 failures
- At least 10 new test cases for merge and overlap
  </verify>
  <done>Full test coverage for merge (clean, conflict, lockfile auto-resolve, overlap warnings) and check-overlap (same wave, different wave, missing data). All tests pass, zero regressions.</done>
</task>

</tasks>

<verification>
- `node build.js` succeeds within budget
- `node --test bin/gsd-tools.test.cjs` — all tests pass
- Manual test: create worktree, make change, merge back — verify change appears in base
- `worktree check-overlap` correctly identifies file collisions between same-wave plans
</verification>

<success_criteria>
- worktree merge performs git merge-tree dry-run before every merge
- Clean merges auto-proceed, conflicts block with file-level report
- Lockfiles and generated files auto-resolved per CONTEXT.md decisions
- Static file overlap analysis available as pre-execution check
- Both static and dynamic conflict signals present in merge output
- All tests pass with zero regressions
</success_criteria>

<output>
After completion, create `.planning/phases/21-worktree-parallelism/21-02-SUMMARY.md`
</output>
