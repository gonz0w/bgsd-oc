---
phase: 21-worktree-parallelism
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/commands/worktree.js
  - src/router.js
  - build.js
  - templates/config.json
  - bin/gsd-tools.test.cjs
  - bin/gsd-tools.cjs
autonomous: true
requirements: [WKTR-01, WKTR-02, WKTR-04]

must_haves:
  truths:
    - "worktree create <plan-id> creates isolated worktree with named branch at configured base_path"
    - "worktree list shows active worktrees with plan ID, branch, path, and disk usage"
    - "worktree remove <plan-id> cleans up a specific worktree"
    - "worktree cleanup removes all worktrees for current project"
    - "Config worktree section controls base_path, sync_files, setup_hooks, and max_concurrent"
    - "max_concurrent is validated against available system memory"
  artifacts:
    - path: "src/commands/worktree.js"
      provides: "Worktree create, list, remove, cleanup commands"
      min_lines: 200
    - path: "templates/config.json"
      provides: "Default worktree configuration section"
      contains: "worktree"
  key_links:
    - from: "src/commands/worktree.js"
      to: "src/lib/git.js"
      via: "execGit for git worktree and git branch commands"
      pattern: "execGit.*worktree"
    - from: "src/commands/worktree.js"
      to: "src/lib/config.js"
      via: "loadConfig for worktree settings"
      pattern: "loadConfig|config\\.worktree"
    - from: "src/router.js"
      to: "src/commands/worktree.js"
      via: "command routing for worktree subcommands"
      pattern: "worktree"
---

<objective>
Create the core worktree lifecycle commands (create, list, remove, cleanup) and worktree configuration schema.

Purpose: Enables isolated git worktrees for parallel plan execution — the foundation all merge and workflow integration builds on.
Output: `worktree create/list/remove/cleanup` CLI commands, config.json worktree section, tests.
</objective>

<execution_context>
@/home/cam/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/cam/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/21-worktree-parallelism/21-CONTEXT.md
@src/commands/env.js (reference for command module pattern — exports, function signatures, tests)
@src/router.js (routing registration pattern)
@src/lib/git.js (execGit helper)
@src/lib/config.js (loadConfig helper)
@src/lib/helpers.js (shared helpers)
@src/lib/output.js (output/error helpers)
@build.js (bundle budget check — currently 525KB, at 518KB)
@templates/config.json (default config template to extend)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Worktree command module + config schema</name>
  <files>
    src/commands/worktree.js
    src/router.js
    templates/config.json
    build.js
  </files>
  <action>
Create `src/commands/worktree.js` following the pattern established by `src/commands/env.js`:

**cmdWorktreeCreate(cwd, planId, raw):**
- Parse plan ID (e.g., "21-02") to extract phase and plan numbers
- Load config, read `config.worktree` section (with defaults: base_path="/tmp/gsd-worktrees", sync_files=[".env", ".env.local", ".planning/config.json"], setup_hooks=["npm install"], max_concurrent=3)
- Determine project name from `path.basename(cwd)`
- Worktree path: `{base_path}/{project_name}/{plan_id}/`
- Branch name: `worktree-{phase}-{plan}-{wave}` (get wave from PLAN.md frontmatter if available, else "0")
- Pre-checks:
  - Check worktree doesn't already exist (`git worktree list --porcelain` and check path)
  - Check max_concurrent not exceeded (count existing worktrees for this project)
  - Resource validation: check available RAM via `os.freemem()`, warn if `max_concurrent * 4GB > available_RAM` (per CONTEXT.md decision)
  - Disk space: estimate needed as `project_size * 1.5` (du on cwd), warn if insufficient in base_path partition
- Create worktree: `git worktree add -b {branch_name} {worktree_path}` via execGit
- Sync configured files: copy each file from `sync_files` list using `fs.copyFileSync` (skip if source doesn't exist, log which were synced)
- Run setup hooks: for each hook in `setup_hooks`, run `execSync(hook, { cwd: worktree_path, timeout: 120000 })` — if hook fails, mark worktree as "setup_failed" but don't delete it (per CONTEXT.md: skip that plan, let rest proceed)
- Output JSON: `{ created: true, plan_id, branch, path, synced_files: [...], setup_status: "ok"|"failed", setup_error?: string }`

**cmdWorktreeList(cwd, raw):**
- Load config for base_path
- Run `git worktree list --porcelain` via execGit
- Parse porcelain output (blocks separated by blank lines, each has `worktree <path>`, `HEAD <sha>`, `branch refs/heads/<name>`)
- Filter to only worktrees under base_path for current project
- For each worktree: get disk usage via `execSync('du -sh ' + path)`, extract plan_id from branch name
- Output JSON: `{ worktrees: [{ plan_id, branch, path, head, disk_usage }] }`
- rawValue: table-formatted string

**cmdWorktreeRemove(cwd, planId, raw):**
- Find worktree by plan_id (match branch name pattern)
- Run `git worktree remove {path} --force` via execGit (--force because it may have changes)
- Delete the branch: `git branch -D {branch_name}` via execGit
- Output: `{ removed: true, plan_id, path }`

**cmdWorktreeCleanup(cwd, raw):**
- List all worktrees for current project
- Remove each via the same logic as cmdWorktreeRemove
- Run `git worktree prune` to clean stale references
- Output: `{ cleaned: count, worktrees: [...removed] }`

Register all commands in `src/router.js`:
- Add `case 'worktree':` in the router switch, with nested if/else for subcommands: `create`, `list`, `remove`, `cleanup`
- Import from `src/commands/worktree.js`

Update `templates/config.json` — add `worktree` section with defaults:
```json
"worktree": {
  "enabled": false,
  "base_path": "/tmp/gsd-worktrees",
  "sync_files": [".env", ".env.local", ".planning/config.json"],
  "setup_hooks": [],
  "max_concurrent": 3
}
```

Check bundle budget in `build.js` — if current is near 525KB, raise to 550KB (worktree module is expected ~15-20KB contribution to bundle).
  </action>
  <verify>
- `node bin/gsd-tools.cjs worktree list --raw` returns JSON with empty worktrees array
- `node bin/gsd-tools.cjs worktree create 21-01 --raw` creates worktree (test in /tmp, then cleanup)
- `node bin/gsd-tools.cjs worktree list --raw` shows the created worktree with disk_usage
- `node bin/gsd-tools.cjs worktree remove 21-01 --raw` removes it
- `node bin/gsd-tools.cjs worktree cleanup --raw` succeeds with cleaned: 0
- Bundle builds: `node build.js` passes with size within budget
  </verify>
  <done>All four worktree commands (create, list, remove, cleanup) work end-to-end with config-driven defaults. Config template includes worktree section. Bundle within budget.</done>
</task>

<task type="auto">
  <name>Task 2: Worktree command tests</name>
  <files>
    bin/gsd-tools.test.cjs
  </files>
  <action>
Add test suite for worktree commands in `bin/gsd-tools.test.cjs`, following the pattern of existing env.js tests.

**Test setup:**
- Create a temp directory with `fs.mkdtempSync`
- Initialize a git repo: `git init`, `git add .`, `git commit -m "init"`
- Create a `.planning/config.json` with worktree config pointing base_path to another temp dir
- Create a minimal PLAN.md for test plan IDs

**Tests for `worktree create`:**
1. Creates worktree at expected path with correct branch name
2. Syncs .env file if it exists in source project
3. Skips sync gracefully when .env doesn't exist
4. Returns setup_failed when setup hook fails (e.g., `false` command)
5. Returns error when plan_id is missing
6. Returns error when worktree already exists for same plan_id
7. Respects max_concurrent limit (create max+1 should warn/error)

**Tests for `worktree list`:**
1. Returns empty array when no worktrees exist
2. Returns worktree details after create (plan_id, branch, path, disk_usage)
3. Only shows worktrees for current project (not other projects)

**Tests for `worktree remove`:**
1. Removes worktree and deletes branch
2. Returns error for non-existent plan_id

**Tests for `worktree cleanup`:**
1. Removes all project worktrees
2. Returns cleaned: 0 when none exist

**Tests for config validation:**
1. Default config used when no worktree section in config.json
2. max_concurrent validated against available resources (mock os.freemem)
3. Custom base_path is respected

All tests must run in isolated temp directories — no side effects on the real project. Use `afterEach` to clean up worktrees and temp dirs.

Run: `node --test bin/gsd-tools.test.cjs` — all existing + new tests must pass.
  </action>
  <verify>
- `node --test bin/gsd-tools.test.cjs 2>&1 | tail -5` shows all tests passing with 0 failures
- New test count: verify at least 12 new test cases for worktree commands
  </verify>
  <done>Full test coverage for worktree create/list/remove/cleanup commands. All tests pass including existing tests (zero regressions).</done>
</task>

</tasks>

<verification>
- `node build.js` succeeds with bundle within budget
- `node --test bin/gsd-tools.test.cjs` — all tests pass
- `node bin/gsd-tools.cjs worktree list --raw` returns valid JSON
- Config template has worktree section with documented defaults
</verification>

<success_criteria>
- worktree create/list/remove/cleanup commands are functional
- Config-driven with sensible defaults (base_path, sync_files, max_concurrent)
- Resource validation warns when system can't support requested concurrency
- All tests pass with zero regressions
- Bundle stays within budget
</success_criteria>

<output>
After completion, create `.planning/phases/21-worktree-parallelism/21-01-SUMMARY.md`
</output>
