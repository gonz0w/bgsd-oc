---
phase: 07-init-command-compaction
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/router.js
  - src/commands/init.js
  - src/lib/output.js
  - src/lib/constants.js
  - bin/gsd-tools.test.cjs
autonomous: true
requirements: [CLIP-02]

must_haves:
  truths:
    - "All 12 init commands accept --compact flag and return smaller payloads"
    - "Without --compact, all init commands return identical output to current behavior"
    - "Compact output contains only fields agents need for routing and dispatch"
  artifacts:
    - path: "src/router.js"
      provides: "Global --compact flag parsing"
      contains: "--compact"
    - path: "src/commands/init.js"
      provides: "Compact profiles for all 12 init commands"
      contains: "compactResult"
    - path: "bin/gsd-tools.test.cjs"
      provides: "Tests for --compact backward compat and size reduction"
  key_links:
    - from: "src/router.js"
      to: "global._gsdCompactMode"
      via: "global flag parsing"
      pattern: "_gsdCompactMode"
    - from: "src/commands/init.js"
      to: "src/lib/output.js"
      via: "output() respects compact mode"
      pattern: "compactResult|_gsdCompactMode"
---

<objective>
Add `--compact` flag infrastructure and compact output profiles for all 12 init commands.

Purpose: Init commands currently return full payloads (20-30 keys each) even when agents only need 5-8 essential fields for routing. `--compact` cuts payload size by 38-50%, reducing token consumption in every workflow invocation.

Output: All 12 init commands support `--compact`, returning essential-only data while maintaining full backward compatibility.
</objective>

<execution_context>
@/home/cam/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/cam/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-token-measurement-output-infrastructure/06-01-SUMMARY.md
@src/commands/init.js
@src/router.js
@src/lib/output.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add --compact global flag parsing and compact profile infrastructure</name>
  <files>src/router.js, src/lib/output.js, src/commands/init.js</files>
  <action>
1. **Router (src/router.js):** Add `--compact` flag parsing in `main()`, directly after the existing `--fields` block (lines 62-71). Follow the exact same pattern:
   - Find `--compact` in args
   - Set `global._gsdCompactMode = true`
   - Splice it out of args
   This mirrors how `--fields` uses `global._gsdRequestedFields`.

2. **Init commands (src/commands/init.js):** For each of the 12 `cmdInit*` functions, add a compact code path. The pattern for each function:

   ```js
   // After building the full `result` object, before calling output():
   if (global._gsdCompactMode) {
     const compactResult = {
       // Only essential fields for this command
     };
     return output(compactResult, raw);
   }
   output(result, raw);
   ```

   **Compact profiles (essential-only fields per command):**

   - **cmdInitExecutePhase**: `phase_found`, `phase_dir`, `phase_number`, `phase_name`, `plans` (filenames only, not full objects), `incomplete_plans`, `plan_count`, `incomplete_count`, `branch_name`, `verifier_enabled`
   - **cmdInitPlanPhase**: `phase_found`, `phase_dir`, `phase_number`, `phase_name`, `phase_slug`, `padded_phase`, `has_research`, `has_context`, `has_plans`, `plan_count`, `research_enabled`, `plan_checker_enabled`, `context_path`, `research_path`, `verification_path`, `uat_path` (drop: model names, `planning_exists`, `roadmap_exists`, static file paths like `state_path`/`roadmap_path`/`requirements_path`)
   - **cmdInitNewProject**: `is_brownfield`, `needs_codebase_map`, `has_existing_code`, `has_package_file`, `project_exists`, `has_codebase_map`, `planning_exists`, `has_git`, `brave_search_available` (drop: model names, static `project_path`)
   - **cmdInitNewMilestone**: `current_milestone`, `current_milestone_name`, `project_exists`, `roadmap_exists`, `state_exists`, `research_enabled` (drop: model names, static file paths)
   - **cmdInitQuick**: `next_num`, `slug`, `description`, `task_dir`, `date`, `planning_exists` (drop: model names, static paths, `timestamp`, `roadmap_exists`)
   - **cmdInitResume**: `state_exists`, `planning_exists`, `has_interrupted_agent`, `interrupted_agent_id` (drop: `commit_docs`, static file paths, `project_exists`, `roadmap_exists`)
   - **cmdInitVerifyWork**: `phase_found`, `phase_dir`, `phase_number`, `phase_name`, `has_verification` (drop: model names, `commit_docs`)
   - **cmdInitPhaseOp**: `phase_found`, `phase_dir`, `phase_number`, `phase_name`, `phase_slug`, `padded_phase`, `has_research`, `has_context`, `has_plans`, `has_verification`, `plan_count`, `context_path`, `research_path`, `verification_path`, `uat_path` (drop: `commit_docs`, `brave_search`, static file paths, `planning_exists`, `roadmap_exists`)
   - **cmdInitTodos**: `todo_count`, `todos`, `area_filter`, `date`, `pending_dir_exists` (drop: `commit_docs`, `timestamp`, static paths, `planning_exists`, `todos_dir_exists`)
   - **cmdInitMilestoneOp**: `milestone_version`, `milestone_name`, `phase_count`, `completed_phases`, `all_phases_complete`, `archived_milestones`, `archive_count` (drop: `commit_docs`, `milestone_slug`, file existence booleans, static paths)
   - **cmdInitMapCodebase**: `existing_maps`, `has_maps`, `planning_exists`, `codebase_dir_exists`, `parallelization` (drop: model names, `commit_docs`, `search_gitignored`, static `codebase_dir`)
   - **cmdInitProgress**: `milestone_version`, `milestone_name`, `phases`, `phase_count`, `completed_count`, `in_progress_count`, `current_phase`, `next_phase`, `has_work_in_progress`, `session_diff` (drop: model names, `commit_docs`, `paused_at`, file existence booleans, static file paths)

   **Key principle:** Drop model names (agents know their own model), drop `commit_docs` (agents read config directly if needed), drop static file paths (agents know `.planning/STATE.md` etc.), drop redundant existence booleans when the path is always the same.

3. **Help text (src/lib/constants.js):** Add `--compact` to the help text for the `init` command entry: `--compact  Return essential-only fields (38-50% smaller)`
  </action>
  <verify>
    - `npm run build` succeeds
    - `node bin/gsd-tools.cjs init progress --raw` returns full output (backward compat)
    - `node bin/gsd-tools.cjs init progress --compact --raw` returns fewer keys
    - `node bin/gsd-tools.cjs init plan-phase 7 --compact --raw` returns compact output
    - `node bin/gsd-tools.cjs init execute-phase 7 --compact --raw` returns compact output
  </verify>
  <done>All 12 init commands return smaller payloads with --compact while full output is unchanged without the flag</done>
</task>

<task type="auto">
  <name>Task 2: Tests for --compact flag and size reduction verification</name>
  <files>bin/gsd-tools.test.cjs</files>
  <action>
Add tests in the existing `describe('init commands', ...)` block in `bin/gsd-tools.test.cjs`:

1. **Backward compatibility test:** `test('init commands return full output without --compact', ...)` — Run `init progress` without `--compact`, verify it has all original keys (`executor_model`, `planner_model`, `state_path`, `roadmap_path`, etc.).

2. **Compact output test:** `test('init progress --compact returns essential-only fields', ...)` — Run `init progress --compact --raw`, parse JSON, verify:
   - Has essential keys: `milestone_version`, `phases`, `phase_count`
   - Does NOT have: `executor_model`, `planner_model`, `state_path`, `roadmap_path`

3. **Compact size reduction test:** `test('--compact reduces init output by 38-50%', ...)` — For at least 3 init commands (progress, plan-phase, execute-phase), measure JSON byte size with and without `--compact`. Assert compact size is ≤62% of full size (i.e., ≥38% reduction).

4. **Combined flags test:** `test('--compact and --fields can be used together', ...)` — Run `init progress --compact --fields milestone_version,phase_count --raw`, verify only those 2 fields returned.

5. **All 12 compact test:** `test('all init commands accept --compact without error', ...)` — Loop through all 12 init subcommands with `--compact --raw`, verify each returns valid JSON (no errors).

Follow existing test patterns: use `execSync` with `node bin/gsd-tools.cjs`, parse JSON output, assert on specific keys.
  </action>
  <verify>
    - `npm test` passes (all new tests + existing tests, expect 1 pre-existing DEBT-01 failure only)
    - Compact size reduction test confirms ≥38% reduction for progress, plan-phase, execute-phase
  </verify>
  <done>Tests prove backward compatibility, compact output correctness, and 38-50% size reduction target met</done>
</task>

</tasks>

<verification>
- `npm run build` succeeds
- `npm test` passes (1 pre-existing failure only: DEBT-01)
- `node bin/gsd-tools.cjs init progress --raw` returns full output identical to pre-change
- `node bin/gsd-tools.cjs init progress --compact --raw` returns essential-only output
- All 12 init commands accept `--compact` without error
- Size reduction is measurable: compact output is 38-50% smaller than full output
</verification>

<success_criteria>
- All 12 init commands accept `--compact` flag
- Compact output drops model names, commit_docs, static file paths, redundant existence booleans
- Full output (without `--compact`) is byte-identical to current behavior
- Tests verify backward compat, compact correctness, and size reduction target
</success_criteria>

<output>
After completion, create `.planning/phases/07-init-command-compaction/07-01-SUMMARY.md`
</output>
