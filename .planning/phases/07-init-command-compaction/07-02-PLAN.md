---
phase: 07-init-command-compaction
plan: 02
type: execute
wave: 2
depends_on: [07-01]
files_modified:
  - src/commands/init.js
  - src/lib/constants.js
  - bin/gsd-tools.test.cjs
autonomous: true
requirements: [CLIP-03]

must_haves:
  truths:
    - "Compact init output includes a _manifest object telling agents which files and sections to load"
    - "Manifests reference specific file paths and optional section headers for selective loading"
    - "Agents can use manifest to load only what they need instead of reading everything"
  artifacts:
    - path: "src/commands/init.js"
      provides: "Context manifests for all 12 init commands in compact mode"
      contains: "_manifest"
    - path: "bin/gsd-tools.test.cjs"
      provides: "Tests for manifest structure and content"
  key_links:
    - from: "src/commands/init.js"
      to: "compact output"
      via: "_manifest field in compact result"
      pattern: "_manifest.*files|_manifest.*sections"
---

<objective>
Add context manifests to compact init output, telling agents exactly which files and sections to load.

Purpose: Even with smaller init payloads, agents still blindly load entire files (STATE.md, ROADMAP.md, etc.) when they often only need specific sections. Manifests make this explicit: "load STATE.md section 'Current Position'" instead of the whole file. This is the guidance layer that makes compact mode actionable.

Output: All 12 init commands in `--compact` mode include a `_manifest` field with file paths and optional section selectors.
</objective>

<execution_context>
@/home/cam/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/cam/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-init-command-compaction/07-01-SUMMARY.md
@src/commands/init.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add context manifests to all 12 compact init outputs</name>
  <files>src/commands/init.js</files>
  <action>
For each of the 12 `cmdInit*` functions, add a `_manifest` field to the compact output path (created in Plan 01). The manifest structure:

```js
_manifest: {
  files: [
    { path: "relative/file.md", sections: ["Section Header"], required: true },
    { path: "relative/other.md", required: false },
  ]
}
```

- `path`: Relative path from project root
- `sections`: Optional array of markdown header names to load selectively (omit to load entire file)
- `required`: Whether the file is critical (true) or optional context (false)

**Manifest definitions per command:**

- **cmdInitExecutePhase**: 
  - `{path}/*-PLAN.md` files (from `plans` array) — required, full files
  - `.planning/STATE.md` sections: `["Current Position"]` — required
  - `.planning/ROADMAP.md` sections: `["Phase {N}"]` (specific phase) — required

- **cmdInitPlanPhase**:
  - `.planning/STATE.md` sections: `["Current Position", "Accumulated Context"]` — required
  - `.planning/ROADMAP.md` sections: `["Phase {N}"]` — required
  - `.planning/REQUIREMENTS.md` — required, full file (small)
  - Context/research/verification paths if they exist (from phase dir scan) — optional

- **cmdInitNewProject**:
  - `.planning/PROJECT.md` — optional (may not exist yet)
  - `./CLAUDE.md` — optional (project instructions)

- **cmdInitNewMilestone**:
  - `.planning/PROJECT.md` — required
  - `.planning/ROADMAP.md` sections: `["Milestones", "Progress"]` — required
  - `.planning/STATE.md` sections: `["Accumulated Context"]` — required

- **cmdInitQuick**:
  - `.planning/STATE.md` sections: `["Current Position"]` — optional
  - No other files needed (quick tasks are self-contained)

- **cmdInitResume**:
  - `.planning/STATE.md` — required, full file (need everything for resume)
  - `.planning/ROADMAP.md` sections: `["Progress"]` — required

- **cmdInitVerifyWork**:
  - `{phase_dir}/*-PLAN.md` — required (need plans to verify against)
  - `{phase_dir}/*-SUMMARY.md` — required (need summaries to check)
  - `.planning/ROADMAP.md` sections: `["Phase {N}"]` — required

- **cmdInitPhaseOp**:
  - `.planning/STATE.md` sections: `["Current Position"]` — required
  - `.planning/ROADMAP.md` sections: `["Phase {N}"]` — required
  - `.planning/REQUIREMENTS.md` — optional
  - Context/research paths if they exist — optional

- **cmdInitTodos**:
  - Pending todo files from `todos` array — required
  - No other files needed

- **cmdInitMilestoneOp**:
  - `.planning/ROADMAP.md` sections: `["Milestones", "Progress"]` — required
  - `.planning/STATE.md` sections: `["Current Position"]` — required

- **cmdInitMapCodebase**:
  - `.planning/codebase/*.md` (existing maps) — optional
  - `.planning/PROJECT.md` sections: `["Tech Stack"]` — optional

- **cmdInitProgress**:
  - `.planning/STATE.md` sections: `["Current Position"]` — optional
  - `.planning/ROADMAP.md` sections: `["Progress"]` — optional

**Implementation notes:**
- Build manifest dynamically — only include files that actually exist (use the existence checks already in each function)
- For phase-specific commands, use the `phaseInfo.directory` to construct plan/summary paths
- The `sections` field uses exact markdown header text (e.g., `"## Current Position"` → `"Current Position"`)
- Keep manifests small — this is guidance, not a schema. 3-6 entries per command max.
  </action>
  <verify>
    - `npm run build` succeeds
    - `node bin/gsd-tools.cjs init progress --compact --raw | python3 -c "import json,sys; d=json.load(sys.stdin); print(d.get('_manifest',{}).get('files',[]))"` shows file entries
    - `node bin/gsd-tools.cjs init plan-phase 7 --compact --raw | python3 -c "import json,sys; d=json.load(sys.stdin); m=d.get('_manifest',{}); print(len(m.get('files',[])), 'files in manifest')"` shows 3+ entries
    - `node bin/gsd-tools.cjs init execute-phase 7 --compact --raw | python3 -c "import json,sys; d=json.load(sys.stdin); print('_manifest' in d)"` returns True
  </verify>
  <done>All 12 init commands in --compact mode include a _manifest with file paths and optional section selectors</done>
</task>

<task type="auto">
  <name>Task 2: Tests for context manifests and token reduction measurement</name>
  <files>bin/gsd-tools.test.cjs, src/lib/constants.js</files>
  <action>
1. **Manifest structure tests** in `describe('init commands', ...)`:

   - `test('compact output includes _manifest with files array', ...)` — Run `init progress --compact --raw`, verify `_manifest` exists, has `files` array, each entry has `path` (string) and `required` (boolean).

   - `test('plan-phase manifest includes requirements and state', ...)` — Run `init plan-phase 7 --compact --raw`, verify manifest includes entries for STATE.md, ROADMAP.md, and REQUIREMENTS.md with appropriate `sections` arrays.

   - `test('execute-phase manifest includes plan files', ...)` — Run `init execute-phase 6 --compact --raw` (Phase 6 has plans), verify manifest references PLAN.md files.

   - `test('manifest only references files that exist', ...)` — Run `init plan-phase 7 --compact --raw` (Phase 7 has no context/research files), verify manifest does NOT include context_path or research_path entries.

   - `test('non-compact output does not include _manifest', ...)` — Run `init progress --raw` (no --compact), verify `_manifest` key is absent.

2. **Token reduction measurement test:**

   - `test('compact + manifest meets 38-50% reduction target across all init commands', ...)` — For each of the 12 init commands, measure JSON byte size with and without `--compact`. Calculate average reduction percentage. Assert average reduction is ≥38%. Log individual reductions to stderr for visibility.

3. **Update help text (src/lib/constants.js):** Ensure the init help text mentions that `--compact` includes context manifests: `--compact  Return essential-only fields with context manifest (38-50% smaller)`
  </action>
  <verify>
    - `npm test` passes (1 pre-existing failure only)
    - Token reduction test confirms ≥38% average reduction across all 12 commands
    - Manifest structure tests pass for progress, plan-phase, and execute-phase
  </verify>
  <done>Tests prove manifests are structurally correct, only reference existing files, and compact mode meets the 38-50% reduction target</done>
</task>

</tasks>

<verification>
- `npm run build` succeeds
- `npm test` passes (1 pre-existing failure only: DEBT-01)
- All 12 init commands in `--compact` mode return `_manifest` with file references
- Manifests include `sections` arrays for selective loading where applicable
- Manifests only reference files that exist on disk
- Non-compact output has no `_manifest` (backward compat)
- Average token reduction across all 12 commands is ≥38%
</verification>

<success_criteria>
- Every compact init output includes `_manifest.files` array
- Manifest entries have `path`, optional `sections`, and `required` fields
- Manifests guide agents to load specific files and sections, not everything
- Combined with Plan 01's field reduction, total compact output is 38-50% smaller
- All existing tests continue to pass unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/07-init-command-compaction/07-02-SUMMARY.md`
</output>
