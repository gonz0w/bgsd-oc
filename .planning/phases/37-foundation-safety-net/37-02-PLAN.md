---
phase: 37-foundation-safety-net
plan: 02
type: execute
wave: 2
depends_on: [37-01]
files_modified:
  - src/lib/profiler.js
  - src/router.js
  - src/lib/constants.js
  - bin/gsd-tools.test.cjs
autonomous: true
requirements: [SAFE-01, SAFE-02]

must_haves:
  truths:
    - "Renaming a field in init phase-op JSON output fails the contract test suite"
    - "Renaming a field in state read JSON output fails the contract test suite"
    - "Adding a new field to any init/state output does NOT fail contract tests (field-level contracts allow additions)"
    - "Removing a required field from any init/state output DOES fail contract tests"
    - "Contract test failures show expected vs actual with visual diff"
    - "GSD_PROFILE=1 gsd-tools <command> produces timing JSON in .planning/baselines/"
    - "Running any command without GSD_PROFILE set produces no .planning/baselines/ directory or files"
    - "All existing 574+ tests pass with zero regressions"
  artifacts:
    - path: "src/lib/profiler.js"
      provides: "Opt-in performance profiler using node:perf_hooks"
      exports: ["startProfile", "endProfile", "measure", "writeBaseline"]
    - path: "bin/gsd-tools.test.cjs"
      provides: "Contract tests for init and state JSON outputs"
      contains: "contract tests"
    - path: "test/__snapshots__/"
      provides: "Full snapshot fixtures for init phase-op and state read outputs"
  key_links:
    - from: "bin/gsd-tools.test.cjs"
      to: "test/__snapshots__/"
      via: "snapshot comparison in contract tests"
      pattern: "__snapshots__"
    - from: "src/router.js"
      to: "src/lib/profiler.js"
      via: "opt-in profiler wrapping command execution"
      pattern: "GSD_PROFILE"
---

<objective>
Build consumer contract tests for all init/state JSON outputs and an opt-in performance profiler.

Purpose: SAFE-01 creates a regression safety net — snapshot tests for critical outputs (`init phase-op`, `state read`) and field-level contracts for all other init/state outputs, so any field rename/removal is caught before shipping. SAFE-02 adds a zero-overhead opt-in profiler that captures timing baselines to `.planning/baselines/` when `GSD_PROFILE=1` is set.

Output: Contract test suite in `gsd-tools.test.cjs`, snapshot fixtures in `test/__snapshots__/`, profiler module `src/lib/profiler.js`, profiler CLI integration.
</objective>

<execution_context>
@/home/cam/.config/opencode/get-shit-done/workflows/execute-plan.md
@/home/cam/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/37-foundation-safety-net/37-CONTEXT.md
@.planning/phases/37-foundation-safety-net/37-01-SUMMARY.md
@src/router.js
@src/lib/output.js
@bin/gsd-tools.test.cjs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Consumer contract tests with hybrid snapshot approach</name>
  <files>bin/gsd-tools.test.cjs, test/__snapshots__/init-phase-op.json, test/__snapshots__/state-read.json</files>
  <action>
Add a new test section at the end of `bin/gsd-tools.test.cjs`:

```
// ─── consumer contract tests ─────────────────────────────────────────────────
```

**Snapshot infrastructure:**

Create `test/__snapshots__/` directory. Add two helper functions at the top of the contract test section:

1. `snapshotCompare(actual, fixturePath)` — Reads fixture JSON, deep-compares with actual. On mismatch, produces diff-style output showing `expected` vs `actual` for each differing field (per user decision: diff-style output). If `GSD_UPDATE_SNAPSHOTS=1` env is set, writes actual as new fixture instead of failing.

2. `contractCheck(actual, requiredFields)` — For each entry in `requiredFields` array (format: `{ key: 'dotted.path', type: 'string|number|boolean|array|object|any' }`), verifies the field exists in actual and has correct type. New fields in actual that aren't in requiredFields are ALLOWED (additive-safe). Missing/wrong-type fields FAIL with clear message: `"Contract violation: field 'phase_number' expected type 'string', got undefined"`.

**Full snapshot tests (critical outputs):**

`describe('contract: init phase-op (full snapshot)', ...)`:
- Set up temp project with complete `.planning/` structure (ROADMAP.md with a phase, STATE.md, config.json, CONTEXT.md in a phase dir)
- Run `gsd-tools init execute-phase 1` (this is the phase-op init)
- First run: if fixture `test/__snapshots__/init-phase-op.json` doesn't exist, write it and skip (bootstrap mode)
- Subsequent runs: compare full output against fixture using `snapshotCompare`
- Fixture should store the full JSON output structure

`describe('contract: state read (full snapshot)', ...)`:
- Set up temp project with STATE.md containing all standard sections
- Run `gsd-tools state read`
- Same snapshot pattern: compare against `test/__snapshots__/state-read.json`

**Field-level contract tests (all other init/state outputs):**

`describe('contract: init plan-phase fields', ...)`:
- Set up temp project, run `gsd-tools init plan-phase 1`
- Use `contractCheck` to verify required fields: `phase_found` (boolean), `phase_dir` (string), `phase_number` (string), `phase_name` (string), `has_research` (boolean), `has_context` (boolean), `has_plans` (boolean), `plan_count` (number), `research_enabled` (boolean), `plan_checker_enabled` (boolean)

`describe('contract: init new-project fields', ...)`:
- Run `gsd-tools init new-project`
- Contract: `has_planning` (boolean), `has_roadmap` (boolean), `has_state` (boolean)

`describe('contract: init execute-phase fields', ...)`:
- Set up project with a phase + plan, run `gsd-tools init execute-phase 1`
- Contract: `phase_found` (boolean), `phase_dir` (string), `phase_number` (string), `phase_name` (string), `total_plans` (number), `plans` (array)

`describe('contract: state read fields', ...)`:
- Run `gsd-tools state read`
- Contract: `current_phase` (any), `progress` (any), `decisions` (any), `blockers` (any)

`describe('contract: init progress fields', ...)`:
- Run `gsd-tools init progress`
- Contract: `milestone` (object), `phases` (array)

**Test failure output (per user decision):**
When `contractCheck` or `snapshotCompare` fails, the assertion message includes:
```
Contract violation in init-plan-phase:
  - phase_found: expected boolean, got undefined
  - plan_count: expected number, got string
```

Generate initial snapshot fixtures by running the tests once with `GSD_UPDATE_SNAPSHOTS=1` in the test setup (beforeEach can set this for the first-time bootstrap, or manually run once).
  </action>
  <verify>
Run `npm run build && npm test`. All contract tests pass. Manually verify: temporarily rename a field in a command's output (e.g., change `phase_found` to `phase_exists` in init.js), run tests, confirm the contract test fails with a clear diff message, then revert.
  </verify>
  <done>
Contract tests exist for all init and state JSON outputs. Full snapshots for init-phase-op and state-read. Field-level contracts for init-plan-phase, init-new-project, init-execute-phase, state-read fields, init-progress. Adding fields passes. Removing/renaming fields fails with diff output. Snapshots updatable via GSD_UPDATE_SNAPSHOTS=1.
  </done>
</task>

<task type="auto">
  <name>Task 2: Performance profiler module with baseline capture</name>
  <files>src/lib/profiler.js, src/router.js, src/lib/constants.js, bin/gsd-tools.test.cjs</files>
  <action>
**New module: `src/lib/profiler.js`**

Create `src/lib/profiler.js` following project conventions (`'use strict';`, section dividers, camelCase, JSDoc).

Uses `node:perf_hooks` (`performance.now()` and `PerformanceMeasure`). Zero-cost when disabled: check `process.env.GSD_PROFILE` once at module load, export no-op functions when not set.

Exports:
- `isProfilingEnabled()` — returns boolean
- `mark(label)` — calls `performance.mark(label)` if enabled, no-op otherwise
- `measure(label, startMark, endMark)` — calls `performance.measure()` if enabled
- `startTimer(label)` — returns a timer object `{ label, start }` if enabled, null otherwise
- `endTimer(timer)` — records elapsed time, returns `{ label, duration_ms }` if enabled
- `getTimings()` — returns all recorded timings as `[{ label, duration_ms }]`
- `writeBaseline(cwd, commandName)` — writes timing data to `.planning/baselines/{commandName}-{timestamp}.json` containing `{ command, timestamp, node_version, timings: [...], total_ms }`. Creates `.planning/baselines/` if missing. Only writes if profiling is enabled.

Implementation pattern:
```javascript
const enabled = process.env.GSD_PROFILE === '1';
const timings = [];

function mark(label) { if (!enabled) return; /* ... */ }
// etc.
```

**Router integration (src/router.js):**

At the top of `main()`, after argv parsing but before the switch:
```javascript
const { startTimer, endTimer, writeBaseline, isProfilingEnabled } = require('./lib/profiler');
const cmdTimer = startTimer('command:' + command);
```

At the end of `main()` (before return/exit), after the switch completes:
```javascript
endTimer(cmdTimer);
if (isProfilingEnabled()) {
  writeBaseline(cwd, command + (sub ? '-' + sub : ''));
}
```

This wraps the entire command execution. Individual commands can add their own `mark()`/`measure()` calls internally for fine-grained timing (but that's for later phases to add — this plan just wires the harness).

**Constants update (src/lib/constants.js):**

Add help text for profiler:
```
'profile': 'Set GSD_PROFILE=1 to enable performance profiling. Baselines written to .planning/baselines/'
```

**Tests (bin/gsd-tools.test.cjs):**

Add section:
```
// ─── profiler ────────────────────────────────────────────────────────────────
```

Tests:
- `profiler disabled by default` — run any command without GSD_PROFILE, verify no `.planning/baselines/` created
- `profiler enabled writes baseline` — run `gsd-tools init progress` with `env: { ...process.env, GSD_PROFILE: '1' }` passed to execSync, verify `.planning/baselines/` dir created and contains a JSON file, parse it and verify it has `command`, `timestamp`, `timings` (array), `total_ms` (number) fields
- `profiler baseline JSON structure` — verify the baseline file has expected shape: `{ command: string, timestamp: string, node_version: string, timings: array, total_ms: number }`
- `profiler zero-cost when disabled` — this is a design assertion; test that `require('./lib/profiler').isProfilingEnabled()` returns false when GSD_PROFILE unset (unit-test the module directly in the test)

For subprocess tests, use `execSync` with explicit `env` option to set/unset `GSD_PROFILE`.
  </action>
  <verify>
Run `npm run build && npm test`. All tests pass. Run `GSD_PROFILE=1 node bin/gsd-tools.cjs init progress` and verify a baseline JSON file appears in `.planning/baselines/`. Inspect the file for valid structure.
  </verify>
  <done>
`src/lib/profiler.js` exists with opt-in profiling via GSD_PROFILE=1. Router wraps command execution with profiler timing. Baselines written to `.planning/baselines/` as JSON with command, timestamp, timings, total_ms. Zero overhead when disabled. All tests pass including new profiler tests.
  </done>
</task>

</tasks>

<verification>
1. `npm test` — all existing 574+ tests pass, all new contract + profiler tests pass
2. Temporarily rename `phase_found` to `phase_exists` in init.js → contract test fails with diff → revert
3. Add a new field to init output → contract tests still pass (additive-safe)
4. `GSD_PROFILE=1 node bin/gsd-tools.cjs state read` → baseline JSON created in `.planning/baselines/`
5. Without GSD_PROFILE → no baselines directory created, zero overhead
</verification>

<success_criteria>
- Contract tests cover all init and state JSON outputs consumed by agents
- Full snapshots for init-phase-op and state-read, field-level for others
- Field removal/rename breaks tests; field addition does not
- Contract failures show diff-style expected vs actual output
- Snapshots updatable via GSD_UPDATE_SNAPSHOTS=1
- Profiler is zero-cost when GSD_PROFILE unset
- GSD_PROFILE=1 produces baseline JSON files in .planning/baselines/
- Baseline files contain command, timestamp, timings array, total_ms
- Zero regressions in existing test suite
</success_criteria>

<output>
After completion, create `.planning/phases/37-foundation-safety-net/37-02-SUMMARY.md`
</output>
